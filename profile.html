<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>Профиль — AEGISVPN</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <!-- QR для рефералки -->
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>

  <style>
    :root {
      --bg: #0f0f17;
      --card: rgba(30, 30, 50, 0.38);
      --card-border: rgba(120, 120, 160, 0.22);
      --accent: #8b5cf6;
      --accent-dark: #7c3aed;
      --text: #f1f5f9;
      --text-sec: #94a3b8;
      --blur: blur(24px);
      --nav-bg: rgba(15, 15, 23, 0.82);
      --success: #34d399;
    }

    /* Глобальное убирание подчёркивания для всех ссылок */
    a {
      text-decoration: none !important;
      color: inherit;
    }

    a:hover, a:active, a:visited {
      text-decoration: none !important;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background: linear-gradient(145deg, #0f0f17 0%, #1a1a2e 100%);
      color: var(--text);
      margin: 0;
      padding: 0;
      min-height: 100vh;
      overflow-x: hidden;
    }

    .container {
      max-width: 580px;
      margin: 0 auto;
      padding: 16px;
      padding-bottom: 100px;
    }

    .profile-header {
      text-align: center;
      margin: 40px 0 48px;
    }

    .avatar-wrap {
      position: relative;
      display: inline-block;
    }

    .avatar {
      width: 108px;
      height: 108px;
      border-radius: 50%;
      object-fit: cover;
      border: 5px solid var(--accent);
      box-shadow: 0 0 32px rgba(139,92,246,0.35);
    }

    .online-dot {
      position: absolute;
      bottom: 8px;
      right: 8px;
      width: 24px;
      height: 24px;
      background: var(--success);
      border: 4px solid var(--bg);
      border-radius: 50%;
      box-shadow: 0 0 16px var(--success);
    }

    .username {
      font-size: 2rem;
      font-weight: 800;
      margin: 20px 0 6px;
      background: linear-gradient(90deg, #a78bfa, #c084fc);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .status {
      font-size: 1.05rem;
      color: var(--text-sec);
      margin: 0;
    }

    .card-glass {
      background: var(--card);
      backdrop-filter: var(--blur);
      -webkit-backdrop-filter: var(--blur);
      border: 1px solid var(--card-border);
      border-radius: 28px;
      padding: 24px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.38), inset 0 1px 1px rgba(255,255,255,0.06);
      margin-bottom: 24px;
      transition: all 0.32s cubic-bezier(0.34, 1.56, 0.64, 1);
      opacity: 0;
      animation: fadeUp 0.7s forwards;
    }

    .card-glass:nth-child(1) { animation-delay: 0.1s; }
    .card-glass:nth-child(2) { animation-delay: 0.2s; }
    .card-glass:nth-child(3) { animation-delay: 0.3s; }

    @keyframes fadeUp {
      from { opacity: 0; transform: translateY(24px); }
      to   { opacity: 1; transform: translateY(0); }
    }

    .card-glass:hover,
    .card-glass:active {
      transform: translateY(-6px);
      box-shadow: 0 20px 60px rgba(0,0,0,0.45), inset 0 1px 1px rgba(255,255,255,0.08);
      border-color: rgba(139,92,246,0.35);
    }

    .progress-bar {
      height: 12px;
      background: rgba(255,255,255,0.1);
      border-radius: 6px;
      overflow: hidden;
      margin: 16px 0;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #8b5cf6, #c084fc);
      width: 0;
      transition: width 1s ease;
    }

    .btn {
      width: 100%;
      padding: 16px;
      font-size: 1.1rem;
      font-weight: 700;
      border-radius: 16px;
      border: none;
      cursor: pointer;
      transition: all 0.2s;
      margin: 10px 0;
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--accent), var(--accent-dark));
      color: white;
    }

    .btn-outline {
      background: transparent;
      border: 2px solid var(--accent);
      color: var(--accent);
    }

    .btn-danger {
      background: #ef4444;
      color: white;
    }

    .ref-link {
      background: #111827;
      padding: 16px;
      border-radius: 12px;
      font-family: monospace;
      word-break: break-all;
      font-size: 0.95rem;
      margin: 16px 0;
    }

    #qrcode {
      margin: 24px auto;
      text-align: center;
      background: #fff;
      padding: 12px;
      border-radius: 12px;
      display: inline-block;
    }

    .bottom-nav {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      height: 78px;
      background: var(--nav-bg);
      backdrop-filter: var(--blur);
      border-top: 1px solid var(--card-border);
      display: flex;
      justify-content: space-around;
      align-items: center;
      z-index: 999;
    }

    .nav-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      color: var(--text-sec);
      font-size: 0.76rem;
      font-weight: 500;
      padding: 6px 12px;
      border-radius: 12px;
      transition: all 0.18s;
    }

    .nav-item.active {
      color: var(--accent);
      background: rgba(139,92,246,0.14);
    }

    .nav-item svg { width: 26px; height: 26px; margin-bottom: 3px; stroke: currentColor; stroke-width: 2; }

    .nav-item a, .nav-item a:visited, .nav-item a:hover, .nav-item a:active { text-decoration: none !important; color: inherit; }

    /* Для статуса */
    #status {
      text-align: center;
      padding: 16px;
      border-radius: 12px;
      background: #1a1a2e;
      margin: 24px 0;
      font-size: 1.1rem;
      font-weight: 600;
    }
  </style>
</head>
<body>

<div class="container">

  <div class="profile-header">
    <div class="avatar-wrap">
      <img id="userAvatar" src="https://via.placeholder.com/108/1a1a2e/ffffff?text=@" alt="Аватар" class="avatar">
      <div class="online-dot"></div>
    </div>
    <div id="username" class="username">Загрузка...</div>
    <div id="status" class="status">Загрузка статуса...</div>
  </div>

  <div class="card-glass">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
      <span style="font-weight:600;">Подписка активна до</span>
      <span style="color:var(--success); font-weight:700;" id="expires">Загрузка...</span>
    </div>
    <div class="progress-bar">
      <div id="progressFill" class="progress-fill" style="width:0%;"></div>
    </div>
    <div style="margin-top:8px; font-size:0.98rem; color:var(--text-sec);">
      Остаток трафика: <strong id="traffic">Загрузка...</strong>
    </div>
  </div>

  <div class="card-glass">
    <h3 style="margin-bottom:16px; font-size:1.3rem;">Действия</h3>
    <button class="btn btn-primary">Обновить конфиг</button>
    <button class="btn btn-outline">История платежей</button>
    <button class="btn btn-danger">Выйти</button>
  </div>

  <div class="card-glass">
    <h3 style="margin-bottom:12px; font-size:1.3rem;">Реферальная программа</h3>
    <p style="color:var(--text-sec); margin-bottom:16px;">
      Приведи друга → оба получаете +7 дней бесплатно!<br>
      <small>За активных пользователей — Stars</small>
    </p>
    <div id="refLink" class="ref-link">Загрузка...</div>
    <div id="qrcode"></div>
    <button id="copyRefBtn" class="btn btn-primary">Скопировать ссылку</button>
  </div>

</div>

<div class="bottom-nav">
  <a href="index.html" class="nav-item">
    <svg viewBox="0 0 24 24"><path d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2z"/></svg>
    Главный
  </a>
  <a href="guide.html" class="nav-item">
    <svg viewBox="0 0 24 24"><path d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"/></svg>
    Как подключить
  </a>
  <div class="nav-item active">
    <svg viewBox="0 0 24 24"><path d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 0 00-7-7z"/></svg>
    Профиль
  </div>
</div>

<script>
const tg = Telegram.WebApp;
tg.ready();
tg.expand();

const user = tg.initDataUnsafe.user;

// Аватар
if (user && user.photo_url) {
  document.getElementById('userAvatar').src = user.photo_url;
}

document.getElementById('username').textContent = user ? `@${user.username || user.first_name}` : 'Гость';

// Реферальная ссылка + QR
const botUsername = 'AegisVPNBot'; // заменить на реальный
const refLink = `https://t.me/${botUsername}?start=ref_${user?.id || 'guest'}`;
document.getElementById('refLink').textContent = refLink;

QRCode.toCanvas(document.getElementById('qrcode'), refLink, { width: 200 }, (err) => {
  if (err) console.error(err);
});

// Копирование
document.getElementById('copyRefBtn').addEventListener('click', () => {
  navigator.clipboard.writeText(refLink).then(() => {
    tg.showAlert('Ссылка скопирована!');
  });
});

// Запрос статуса подписки
tg.sendData(JSON.stringify({ action: 'get_profile' }));

// Обработка ответа от бота
tg.onEvent('web_app_data', (event) => {
  try {
    const data = JSON.parse(event.data);
    if (data.action === 'profile_data') {
      document.getElementById('expires').textContent = data.expires || 'Нет подписки';
      document.getElementById('traffic').textContent = data.traffic || '0 ГБ';
      document.getElementById('progressFill').style.width = data.progress + '%'; // пример '75'
      document.getElementById('status').textContent = data.status || 'Загружено';
    }
  } catch (e) {
    document.getElementById('status').textContent = 'Ошибка загрузки профиля';
    document.getElementById('status').style.color = '#ff4444';
  }
});
</script>

</body>
</html>