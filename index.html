<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>ZEUSVPN</title>

  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>

  <style>
    :root{
      --bg:#070A10;
      --panel:#0C101A;
      --panel2:#0A0E17;
      --line:rgba(255,255,255,.09);

      --text:#F4F6FF;
      --muted:rgba(244,246,255,.62);

      --blue:#2F6BFF;
      --blue2:#1D4ED8;

      --ok:#22C55E;
      --warn:#F59E0B;
      --bad:#EF4444;

      --r12:12px;
      --r16:16px;
      --r20:20px;

      --shadow: 0 10px 30px rgba(0,0,0,.42);
      --ease: cubic-bezier(.2,.8,.2,1);
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, "SF Pro Text","SF Pro Display", Segoe UI, Roboto, Arial;
      background: radial-gradient(900px 500px at 50% -20%, rgba(47,107,255,.08), transparent 60%), var(--bg);
      color: var(--text);
      -webkit-tap-highlight-color: transparent;
    }

    .app{
      max-width:520px;
      margin:0 auto;
      padding: 12px 14px 104px;
    }

    /* top */
    .top{
      position: sticky;
      top:0;
      padding: 10px 0;
      background: linear-gradient(180deg, rgba(7,10,16,.96), rgba(7,10,16,.72), rgba(7,10,16,0));
      backdrop-filter: blur(10px);
      z-index:20;
    }
    .topRow{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .brand{
      display:flex;
      align-items:center;
      gap:10px;
      min-width:0;
    }
    .logo{
      width:34px; height:34px;
      border-radius: 12px;
      background: rgba(255,255,255,.05);
      border:1px solid var(--line);
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .brand b{
      font-size: 13px;
      letter-spacing:.4px;
      display:block;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .brand span{
      display:block;
      margin-top:4px;
      font-size: 12px;
      color: var(--muted);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .pill{
      display:flex;
      align-items:center;
      gap:8px;
      padding: 8px 10px;
      border-radius: 999px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      font-size: 12px;
      color: var(--muted);
      white-space:nowrap;
    }
    .dot{ width:8px; height:8px; border-radius:999px; background: rgba(255,255,255,.3); }

    /* cards */
    .card{
      background: rgba(255,255,255,.03);
      border:1px solid var(--line);
      border-radius: var(--r20);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .cardHead{
      padding: 12px 14px 10px;
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap:10px;
    }
    .cardHead h2{
      margin:0;
      font-size: 12px;
      letter-spacing:.32px;
      text-transform:uppercase;
      color: rgba(244,246,255,.86);
    }
    .cardHead small{
      font-size:12px;
      color: var(--muted);
      text-align:right;
    }
    .hr{
      height:1px;
      background: var(--line);
      margin: 0 14px;
    }
    .cardBody{ padding: 12px 14px 14px; }

    .hero{
      margin-top: 10px;
      padding: 14px;
    }
    .heroTitle{
      margin:0;
      font-size: 18px;
      font-weight: 800;
      letter-spacing:.1px;
    }
    .heroSub{
      margin: 8px 0 0;
      font-size: 13px;
      line-height: 1.5;
      color: var(--muted);
    }
    .row3{
      margin-top: 12px;
      display:flex;
      gap:10px;
    }
    .mini{
      flex:1;
      border-radius: var(--r16);
      border:1px solid var(--line);
      background: rgba(0,0,0,.12);
      padding: 10px;
      min-width:0;
    }
    .mini b{
      display:block;
      font-size: 12px;
      color: rgba(244,246,255,.9);
      margin-bottom: 6px;
    }
    .mini span{
      font-size: 12px;
      color: var(--muted);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    /* form */
    .label{ font-size:12px; color: var(--muted); margin-bottom:8px; }
    .input{
      width:100%;
      padding: 12px 12px;
      border-radius: var(--r16);
      border:1px solid var(--line);
      background: rgba(0,0,0,.16);
      color: var(--text);
      outline:none;
      font-size: 14px;
    }
    .input::placeholder{ color: rgba(244,246,255,.35); }

    /* buttons */
    .btn{
      width:100%;
      border:0;
      border-radius: var(--r16);
      padding: 13px 14px;
      font-weight: 800;
      letter-spacing:.2px;
      cursor:pointer;
      transition: transform .12s var(--ease), opacity .12s var(--ease);
    }
    .btn:active{ transform: translateY(1px); }
    .btn[disabled]{ opacity:.55; cursor:not-allowed; }
    .btnPrimary{
      background: linear-gradient(180deg, var(--blue), var(--blue2));
      color:#fff;
    }
    .btnGhost{
      background: rgba(255,255,255,.04);
      border:1px solid var(--line);
      color: rgba(244,246,255,.88);
    }

    /* badges */
    .badge{
      display:inline-flex;
      align-items:center;
      padding: 5px 9px;
      border-radius: 999px;
      font-size: 12px;
      border:1px solid var(--line);
      background: rgba(0,0,0,.14);
      color: rgba(244,246,255,.78);
      font-weight: 800;
    }
    .bOk{ color: var(--ok); border-color: rgba(34,197,94,.25); }
    .bWarn{ color: var(--warn); border-color: rgba(245,158,11,.25); }
    .bBad{ color: var(--bad); border-color: rgba(239,68,68,.25); }

    /* config */
    .config{
      margin-top: 12px;
      border-radius: var(--r20);
      border:1px solid var(--line);
      background: rgba(0,0,0,.14);
      padding: 12px;
    }
    .configTop{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom: 10px;
    }
    .miniBtn{
      border:1px solid var(--line);
      background: rgba(255,255,255,.04);
      color: rgba(244,246,255,.9);
      border-radius: 12px;
      padding: 9px 10px;
      font-weight: 800;
      cursor:pointer;
    }
    .mono{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 12px;
      line-height: 1.35;
      color: rgba(244,246,255,.92);
      word-break: break-all;
    }
    .qrRow{
      margin-top: 12px;
      display:flex;
      gap:12px;
      align-items:flex-start;
    }
    .qrBox{
      width:110px;
      border-radius: var(--r16);
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      padding: 10px;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    canvas{ border-radius: 10px; }

    /* toast */
    .toast{
      position:fixed;
      left:50%;
      transform: translateX(-50%);
      bottom: 90px;
      padding: 10px 12px;
      border-radius: 999px;
      border:1px solid var(--line);
      background: rgba(0,0,0,.55);
      backdrop-filter: blur(10px);
      color: rgba(244,246,255,.92);
      font-size: 12px;
      font-weight: 800;
      opacity:0;
      pointer-events:none;
      transition: opacity .18s var(--ease), transform .18s var(--ease);
      z-index:60;
    }
    .toast.show{
      opacity:1;
      transform: translateX(-50%) translateY(-6px);
    }

    /* nav */
    .nav{
      position:fixed;
      left:0; right:0; bottom:0;
      padding: 10px 12px calc(10px + env(safe-area-inset-bottom));
      border-top:1px solid var(--line);
      background: rgba(7,10,16,.84);
      backdrop-filter: blur(10px);
      z-index:30;
    }
    .navInner{
      max-width:520px;
      margin:0 auto;
      display:flex;
      gap:10px;
    }
    .tab{
      flex:1;
      padding: 12px 10px;
      border-radius: var(--r16);
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      color: rgba(244,246,255,.70);
      font-weight: 800;
      cursor:pointer;
    }
    .tab.active{
      background: rgba(47,107,255,.12);
      border-color: rgba(47,107,255,.30);
      color: rgba(244,246,255,.92);
    }

    /* screens */
    .screens{ position:relative; min-height: 760px; margin-top: 10px; }
    .screen{
      position:absolute; inset:0;
      opacity:0;
      transform: translateX(12px);
      pointer-events:none;
      transition: opacity .20s var(--ease), transform .20s var(--ease);
    }
    .screen.active{
      opacity:1;
      transform: translateX(0);
      pointer-events:auto;
    }
    .screen.fromLeft{ transform: translateX(-12px); }

    /* modal */
    .overlay{
      position:fixed; inset:0;
      background: rgba(0,0,0,.55);
      backdrop-filter: blur(10px);
      opacity:0;
      pointer-events:none;
      transition: opacity .18s var(--ease);
      z-index:50;
      padding: 16px 14px calc(16px + env(safe-area-inset-bottom));
      display:flex;
      align-items:flex-end;
      justify-content:center;
    }
    .overlay.show{ opacity:1; pointer-events:auto; }
    .sheet{
      width:min(520px, 100%);
      border-radius: var(--r20);
      border:1px solid var(--line);
      background: var(--panel);
      box-shadow: var(--shadow);
      transform: translateY(14px);
      opacity:0;
      transition: transform .20s var(--ease), opacity .20s var(--ease);
      overflow:hidden;
    }
    .overlay.show .sheet{ transform: translateY(0); opacity:1; }
    .sheetTop{
      padding: 12px 14px 10px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      background: rgba(255,255,255,.02);
    }
    .sheetTitle b{ display:block; font-size: 13px; font-weight: 900; }
    .sheetTitle span{ display:block; margin-top:6px; font-size: 12px; color: var(--muted); }
    .xbtn{
      width:40px; height:40px;
      border-radius: 12px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      color: rgba(244,246,255,.9);
      cursor:pointer;
      font-weight: 900;
    }
    .sheetBody{ padding: 12px 14px 14px; }

    .planGrid{ display:grid; gap:10px; }
    .plan{
      border-radius: var(--r16);
      border:1px solid var(--line);
      background: rgba(255,255,255,.02);
      padding: 12px;
      cursor:pointer;
      transition: border-color .12s var(--ease), background .12s var(--ease);
    }
    .plan.selected{
      border-color: rgba(47,107,255,.38);
      background: rgba(47,107,255,.08);
    }
    .planTop{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
    }
    .planName{
      margin:0;
      font-size: 14px;
      font-weight: 900;
      letter-spacing:.1px;
    }
    .planSub{
      margin:6px 0 0;
      font-size: 12px;
      color: var(--muted);
      line-height: 1.4;
    }
    .price{
      font-size: 13px;
      font-weight: 900;
      white-space:nowrap;
      color: rgba(244,246,255,.92);
    }
    .tag{
      margin-top: 8px;
      display:flex;
      gap:8px;
      flex-wrap:wrap;
    }
    .chip{
      font-size: 11px;
      padding: 5px 9px;
      border-radius: 999px;
      border:1px solid var(--line);
      background: rgba(0,0,0,.14);
      color: rgba(244,246,255,.72);
      font-weight: 800;
    }
    .chip.pop{ border-color: rgba(47,107,255,.30); color: rgba(180,205,255,.95); }
    .chip.best{ border-color: rgba(245,158,11,.22); color: rgba(255,220,160,.95); }

    .paySwitch{
      margin-top: 12px;
      display:flex;
      gap:8px;
      padding: 6px;
      border-radius: 999px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.02);
    }
    .payPill{
      flex:1;
      border-radius: 999px;
      border:1px solid transparent;
      background: transparent;
      padding: 9px 10px;
      color: rgba(244,246,255,.72);
      font-weight: 900;
      cursor:pointer;
    }
    .payPill.active{
      border-color: var(--line);
      background: rgba(255,255,255,.03);
      color: rgba(244,246,255,.92);
    }

    .sheetFooter{
      border-top:1px solid var(--line);
      background: rgba(0,0,0,.14);
      padding: 12px 14px 14px;
    }
    .footRow{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom: 10px;
    }
    .footRow b{
      font-size: 12px;
      color: rgba(244,246,255,.90);
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }
    .footRow span{
      font-size: 12px;
      color: var(--muted);
      white-space:nowrap;
    }

    .err{
      display:none;
      margin-top: 10px;
      border-radius: var(--r16);
      border:1px solid rgba(239,68,68,.26);
      background: rgba(239,68,68,.06);
      padding: 10px 12px;
      font-size: 12px;
      color: rgba(244,246,255,.82);
    }

    /* guide carousel minimal */
    .carousel{
      display:flex;
      gap:10px;
      overflow:auto;
      scroll-snap-type:x mandatory;
      -webkit-overflow-scrolling:touch;
      padding: 12px 14px 14px;
    }
    .carousel::-webkit-scrollbar{display:none}
    .slide{
      min-width: 86%;
      scroll-snap-align:start;
      border-radius: var(--r16);
      border:1px solid var(--line);
      background: rgba(0,0,0,.12);
      padding: 12px;
    }
    .slideTop{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom: 10px;
    }
    .steps{
      font-size: 13px;
      color: rgba(244,246,255,.72);
      line-height: 1.6;
    }
  </style>
</head>

<body>
  <div class="toast" id="toast">Скопировано</div>

  <!-- MODAL -->
  <div class="overlay" id="overlay">
    <div class="sheet" role="dialog" aria-modal="true">
      <div class="sheetTop">
        <div class="sheetTitle">
          <b>Тариф</b>
          <span>Выбери — затем одна кнопка оплаты</span>
        </div>
        <button class="xbtn" id="modalClose">✕</button>
      </div>

      <div class="sheetBody">
        <div class="planGrid" id="planGrid"></div>

        <div class="paySwitch">
          <button class="payPill active" id="payStars">Stars</button>
          <button class="payPill" id="payUsdt">USDT</button>
        </div>

        <div class="err" id="errModal"></div>
      </div>

      <div class="sheetFooter">
        <div class="footRow">
          <b id="selTitle">—</b>
          <span id="selPrice">—</span>
        </div>
        <button class="btn btnPrimary" id="btnPayModal">Оплатить</button>

        <div class="card" id="orderBox" style="display:none; margin-top:12px;">
          <div class="cardHead">
            <h2>Заказ</h2>
            <small><span class="badge bWarn" id="orderStatus">pending</span></small>
          </div>
          <div class="hr"></div>
          <div class="cardBody">
            <div class="label" style="margin:0;">Статус проверяется каждые ~1.2 сек</div>
            <div class="label" id="orderMeta" style="margin-top:8px;">—</div>
          </div>
        </div>

      </div>
    </div>
  </div>

  <div class="app">
    <div class="top">
      <div class="topRow">
        <div class="brand">
          <div class="logo" aria-hidden="true">
            <svg width="16" height="20" viewBox="0 0 22 28" fill="none">
              <path d="M12.9 2H21L12 14.4H18.9L7.3 26L9.8 15.1H3L12.9 2Z" fill="rgba(244,246,255,.9)"/>
            </svg>
          </div>
          <div style="min-width:0;">
            <b>ZEUSVPN</b>
            <span>Minimal • Dark • Fast</span>
          </div>
        </div>

        <div class="pill">
          <span class="dot" id="apiDot"></span>
          <span id="apiText">API…</span>
        </div>
      </div>
    </div>

    <div class="card hero">
      <h1 class="heroTitle">Премиум без лишнего.</h1>
      <p class="heroSub">Нажми “Получить конфиг” → выбери тариф → оплата → конфиг + Copy.</p>

      <div class="row3">
        <div class="mini">
          <b>Подписка</b>
          <span id="heroSubStat">—</span>
        </div>
        <div class="mini">
          <b>Устройства</b>
          <span id="heroDevices">—</span>
        </div>
        <div class="mini">
          <b>API</b>
          <span id="heroApi">—</span>
        </div>
      </div>
    </div>

    <div class="screens">
      <!-- HOME -->
      <div class="screen active" id="screenHome">
        <div class="card">
          <div class="cardHead">
            <h2>Конфиг</h2>
            <small>после оплаты</small>
          </div>
          <div class="hr"></div>
          <div class="cardBody">
            <div class="label">ID пользователя (позже Telegram ID)</div>
            <input class="input" id="userKey" placeholder="например: zeus-1234" />
            <div class="label" style="margin-top:10px;">Если пусто — создадим автоматически.</div>

            <div style="height:10px;"></div>
            <button class="btn btnPrimary" id="btnOpenPlans">Получить конфиг</button>

            <div class="config" id="configBox" style="display:none;">
              <div class="configTop">
                <span class="badge bOk">VLESS</span>
                <button class="miniBtn" id="btnCopy">Copy</button>
              </div>
              <div class="mono" id="configText"></div>

              <div class="qrRow">
                <div class="qrBox">
                  <canvas id="qrCanvas" width="96" height="96"></canvas>
                </div>
                <div style="min-width:0;">
                  <div class="label" style="margin:0;">QR для импорта (по желанию)</div>
                  <div class="label" style="margin-top:8px;">Если не нужен — просто Copy.</div>
                </div>
              </div>
            </div>

            <div class="err" id="errHome"></div>
          </div>
        </div>
      </div>

      <!-- GUIDE -->
      <div class="screen" id="screenGuide">
        <div class="card">
          <div class="cardHead">
            <h2>Инструкции</h2>
            <small>свайп</small>
          </div>
          <div class="hr"></div>

          <div class="carousel">
            <div class="slide">
              <div class="slideTop">
                <b>iOS</b>
                <span class="pill" style="padding:6px 10px;">V2Box</span>
              </div>
              <div class="steps">
                1) Оплати тариф<br/>
                2) Copy конфиг<br/>
                3) Import from Clipboard<br/>
                4) Connect
              </div>
            </div>

            <div class="slide">
              <div class="slideTop">
                <b>Android</b>
                <span class="pill" style="padding:6px 10px;">v2rayNG</span>
              </div>
              <div class="steps">
                1) Оплати тариф<br/>
                2) Copy конфиг<br/>
                3) Import from Clipboard<br/>
                4) Connect
              </div>
            </div>

            <div class="slide">
              <div class="slideTop">
                <b>Desktop</b>
                <span class="pill" style="padding:6px 10px;">v2rayN</span>
              </div>
              <div class="steps">
                1) Copy конфиг<br/>
                2) Import<br/>
                3) Connect
              </div>
            </div>
          </div>

          <div class="cardBody" style="padding-top:0;">
            <div class="label" style="margin:0;">Сделано под мобилки: свайп карточек.</div>
          </div>
        </div>
      </div>

      <!-- PROFILE -->
      <div class="screen" id="screenProfile">
        <div class="card">
          <div class="cardHead">
            <h2>Профиль</h2>
            <small>минимально</small>
          </div>
          <div class="hr"></div>
          <div class="cardBody">
            <div class="label">Твой ID</div>
            <div style="display:flex; gap:10px; align-items:center;">
              <div class="badge" id="profileId">—</div>
              <button class="miniBtn" id="btnNewId">Новый</button>
            </div>

            <div style="height:12px;"></div>

            <div class="label">Подписка</div>
            <div style="display:flex; align-items:center; justify-content:space-between; gap:10px; padding:12px; border:1px solid var(--line); border-radius: var(--r16); background: rgba(0,0,0,.12);">
              <span class="label" style="margin:0;">Статус</span>
              <span class="badge bWarn" id="subStatus">Не оплачено</span>
            </div>
            <div class="label" id="activeUntil" style="margin-top:10px;">Активна до: —</div>

            <div style="height:14px;"></div>

            <div class="label">Рефералка (UI)</div>
            <button class="btn btnGhost" id="btnRefCreate">Создать реф-код</button>
            <div class="label" id="refOut" style="margin-top:10px;"></div>

          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="nav">
    <div class="navInner">
      <button class="tab active" id="tabHome">Главная</button>
      <button class="tab" id="tabGuide">Инструкции</button>
      <button class="tab" id="tabProfile">Профиль</button>
    </div>
  </div>

<script>
  // ===== CONFIG =====
  const API_BASE = "https://api.45.133.251.210.nip.io:8443"; // твой nginx 8443

  // тарифы (цены UI) — подстрой как хочешь
  const PLANS = [
    { id:"p30_1",  days:30,  devices:1,  title:"1 устройство",  sub:"30 дней",  stars:199, usdt:3.0, tag:"" },
    { id:"p30_5",  days:30,  devices:5,  title:"5 устройств",  sub:"30 дней",  stars:199, usdt:3.0, tag:"pop" },
    { id:"p30_10", days:30,  devices:10, title:"10 устройств", sub:"30 дней",  stars:199, usdt:3.0, tag:"best" },

    { id:"p90_1",  days:90,  devices:1,  title:"1 устройство",  sub:"90 дней",  stars:399, usdt:7.0, tag:"" },
    { id:"p90_5",  days:90,  devices:5,  title:"5 устройств",  sub:"90 дней",  stars:399, usdt:7.0, tag:"pop" },
    { id:"p90_10", days:90,  devices:10, title:"10 устройств", sub:"90 дней",  stars:399, usdt:7.0, tag:"best" },

    { id:"p180_1",  days:180, devices:1,  title:"1 устройство",  sub:"180 дней", stars:599, usdt:12.0, tag:"" },
    { id:"p180_5",  days:180, devices:5,  title:"5 устройств",  sub:"180 дней", stars:599, usdt:12.0, tag:"pop" },
    { id:"p180_10", days:180, devices:10, title:"10 устройств", sub:"180 дней", stars:599, usdt:12.0, tag:"best" }
  ];

  const tg = window.Telegram?.WebApp;
  if (tg) { try { tg.ready(); tg.expand(); } catch(e){} }

  const $ = (id)=>document.getElementById(id);

  // toast
  function toast(msg){
    const t = $("toast");
    t.textContent = msg || "OK";
    t.classList.add("show");
    setTimeout(()=>t.classList.remove("show"), 900);
  }

  function setErr(where, msg){
    const el = $(where);
    el.textContent = msg || "Ошибка";
    el.style.display = "block";
  }
  function clearErr(where){
    const el = $(where);
    el.textContent = "";
    el.style.display = "none";
  }

  // user_key
  function genUserKey(){
    const n = Math.floor(Math.random()*9000)+1000;
    return "zeus-" + n;
  }
  function getUserKey(){
    return ($("userKey").value || "").trim();
  }
  function setUserKey(v){
    $("userKey").value = v || "";
    $("profileId").textContent = v || "—";
    localStorage.setItem("zeus_user_key", v || "");
  }
  async function ensureUserKey(){
    let u = getUserKey();
    if(!u){
      u = genUserKey();
      setUserKey(u);
    } else {
      setUserKey(u);
    }
    return u;
  }

  // api ping
  async function pingApi(){
    try{
      const r = await fetch(API_BASE + "/health", { method:"GET" });
      if(!r.ok) throw new Error("health");
      await r.json();
      $("apiDot").style.background = "rgba(34,197,94,.9)";
      $("apiText").textContent = "online";
      $("heroApi").textContent = "online";
      return true;
    }catch(e){
      $("apiDot").style.background = "rgba(239,68,68,.9)";
      $("apiText").textContent = "offline";
      $("heroApi").textContent = "offline";
      return false;
    }
  }

  // screens
  const screens = {
    home: $("screenHome"),
    guide: $("screenGuide"),
    profile: $("screenProfile")
  };
  let current = "home";

  function setScreen(name){
    if(name === current) return;

    const dirLeft = (name === "home" && current !== "home");
    Object.entries(screens).forEach(([k, el])=>{
      el.classList.remove("active","fromLeft");
      el.style.pointerEvents = "none";
    });

    if(dirLeft) screens[name].classList.add("fromLeft");
    screens[name].classList.add("active");
    screens[name].style.pointerEvents = "auto";

    current = name;
    if (tg?.HapticFeedback) tg.HapticFeedback.impactOccurred("light");
  }

  function setTab(tab){
    $("tabHome").classList.toggle("active", tab==="home");
    $("tabGuide").classList.toggle("active", tab==="guide");
    $("tabProfile").classList.toggle("active", tab==="profile");
    setScreen(tab);
  }
  $("tabHome").onclick = ()=>setTab("home");
  $("tabGuide").onclick = ()=>setTab("guide");
  $("tabProfile").onclick = ()=>setTab("profile");

  // subscription ui
  function setSubscriptionUI({status, active_until, devices}){
    if(status === "paid" || status === "active"){
      $("subStatus").textContent = "Активна";
      $("subStatus").className = "badge bOk";
      $("heroSubStat").textContent = "активна";
    } else {
      $("subStatus").textContent = "Не оплачено";
      $("subStatus").className = "badge bWarn";
      $("heroSubStat").textContent = "не оплачено";
    }
    $("heroDevices").textContent = devices ? `${devices}` : "—";

    if(active_until){
      const dt = new Date(active_until);
      $("activeUntil").textContent = "Активна до: " + dt.toLocaleString();
    } else {
      $("activeUntil").textContent = "Активна до: —";
    }
  }

  // QR
  let lastConfig = "";
  async function renderQR(text){
    try{
      const canvas = $("qrCanvas");
      await QRCode.toCanvas(canvas, text, {
        errorCorrectionLevel:"M",
        margin:1,
        width:96,
        color:{ dark:"#F4F6FF", light:"#00000000" }
      });
    }catch(e){}
  }

  // ===== MODAL =====
  let payProvider = "stars";
  let selectedPlanId = "p30_5";
  let pollTimer = null;

  function openModal(){
    clearErr("errModal");
    $("overlay").classList.add("show");
    if (tg?.HapticFeedback) tg.HapticFeedback.impactOccurred("light");
  }
  function closeModal(){
    $("overlay").classList.remove("show");
  }
  $("modalClose").onclick = closeModal;
  $("overlay").addEventListener("click", (e)=>{
    if(e.target === $("overlay")) closeModal();
  });

  function setProvider(p){
    payProvider = p;
    $("payStars").classList.toggle("active", p==="stars");
    $("payUsdt").classList.toggle("active", p==="usdt");
    updateFooter();
  }
  $("payStars").onclick = ()=>setProvider("stars");
  $("payUsdt").onclick = ()=>setProvider("usdt");

  function getPlan(id){
    return PLANS.find(x=>x.id===id) || PLANS[0];
  }

  function planTag(tag){
    if(tag==="pop") return `<span class="chip pop">Популярно</span>`;
    if(tag==="best") return `<span class="chip best">Выгоднее</span>`;
    return ``;
  }

  function renderPlans(){
    const g = $("planGrid");
    g.innerHTML = PLANS.map(p=>{
      const sel = p.id===selectedPlanId ? "selected" : "";
      const price = (payProvider==="stars") ? `${p.stars} XTR` : `${p.usdt} USDT`;
      return `
        <div class="plan ${sel}" data-id="${p.id}">
          <div class="planTop">
            <div style="min-width:0;">
              <p class="planName">${p.title} • ${p.devices}</p>
              <p class="planSub">${p.sub}</p>
            </div>
            <div class="price">${price}</div>
          </div>
          <div class="tag">
            ${planTag(p.tag)}
            <span class="chip">VLESS</span>
            <span class="chip">Copy + QR</span>
          </div>
        </div>
      `;
    }).join("");

    g.querySelectorAll(".plan").forEach(el=>{
      el.onclick = ()=>{
        selectedPlanId = el.dataset.id;
        renderPlans();
        updateFooter();
        const p = getPlan(selectedPlanId);
        $("heroDevices").textContent = `${p.devices}`;
        if (tg?.HapticFeedback) tg.HapticFeedback.impactOccurred("light");
      };
    });
  }

  function updateFooter(){
    const p = getPlan(selectedPlanId);
    $("selTitle").textContent = `${p.sub} • ${p.devices} устройств`;
    $("selPrice").textContent = (payProvider==="stars") ? `${p.stars} XTR` : `${p.usdt} USDT`;
    $("btnPayModal").textContent = (payProvider==="stars")
      ? `Оплатить Stars • ${p.stars} XTR`
      : `Оплатить USDT • ${p.usdt} USDT`;
  }

  // ===== API calls =====
  async function createStarsOrder(plan){
    const user_key = await ensureUserKey();
    const r = await fetch(API_BASE + "/pay/stars/create", {
      method:"POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify({ user_key, days: plan.days, devices: plan.devices })
    });
    const j = await r.json();
    if(!r.ok) throw new Error(j?.detail || "Stars create error");
    return j; // {order_id, invoice_link}
  }

  async function createUsdtOrder(plan){
    const user_key = await ensureUserKey();
    const r = await fetch(API_BASE + "/pay/crypto/create", {
      method:"POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify({ user_key, days: plan.days, devices: plan.devices })
    });
    const j = await r.json();
    if(!r.ok) throw new Error(j?.detail || "Crypto create error");
    return j; // {order_id, invoice_url}
  }

  async function getOrder(orderId){
    const r = await fetch(API_BASE + "/pay/order/" + orderId, { method:"GET" });
    const j = await r.json();
    if(!r.ok) throw new Error(j?.detail || "Order read error");
    return j;
  }

  async function issueConfig(plan){
    const user_key = await ensureUserKey();
    const inbound_id = 1; // если хочешь — потом подтянем с бэка, сейчас фикс
    const r = await fetch(API_BASE + "/issue-config", {
      method:"POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify({ inbound_id, user_key, days: plan.days, limit_ip: 0 })
    });
    const j = await r.json();
    if(!r.ok) throw new Error(j?.detail || "Issue config error");
    if(!j.link) throw new Error("Ответ без link");
    return j.link;
  }

  function stopPoll(){
    if(pollTimer) clearInterval(pollTimer);
    pollTimer = null;
  }

  function setOrderBox(showBox){
    $("orderBox").style.display = showBox ? "block" : "none";
  }

  function setOrderUI(status, meta){
    setOrderBox(true);
    $("orderStatus").textContent = status || "pending";
    $("orderStatus").className = "badge " + (status==="paid" ? "bOk" : (status==="error" ? "bBad" : "bWarn"));
    $("orderMeta").textContent = meta || "—";
  }

  async function pollOrder(orderId, plan){
    stopPoll();
    setOrderUI("pending", `order: ${orderId}`);

    pollTimer = setInterval(async ()=>{
      try{
        const o = await getOrder(orderId);
        const amount = (o.amount != null) ? `${o.amount} ${o.currency || ""}` : "";
        setOrderUI(o.status || "pending", `order: ${o.id} • ${amount}`);

        if(o.status === "paid"){
          stopPoll();

          setSubscriptionUI({
            status: "paid",
            active_until: o.active_until,
            devices: o.devices
          });

          let link = o.config_link;
          if(!link) link = await issueConfig(plan);

          lastConfig = link;
          $("configText").textContent = lastConfig;
          await renderQR(lastConfig);
          $("configBox").style.display = "block";

          toast("Оплата успешна");
          closeModal();
          if (tg?.HapticFeedback) tg.HapticFeedback.notificationOccurred("success");
        }
      }catch(e){
        // тихо, чтобы не спамило
      }
    }, 1200);
  }

  async function paySelected(){
    clearErr("errModal");
    clearErr("errHome");

    const plan = getPlan(selectedPlanId);

    $("btnPayModal").disabled = true;
    $("btnPayModal").textContent = "Создаю invoice…";

    try{
      const created = (payProvider === "stars")
        ? await createStarsOrder(plan)
        : await createUsdtOrder(plan);

      setOrderUI("pending", `order: ${created.order_id}`);

      if(payProvider === "stars"){
        if(tg && tg.openInvoice){
          tg.openInvoice(created.invoice_link, ()=>{});
        } else {
          window.open(created.invoice_link, "_blank");
        }
      } else {
        if(created.invoice_url) window.open(created.invoice_url, "_blank");
      }

      $("btnPayModal").textContent = "Ожидаю оплату…";
      $("btnPayModal").disabled = true;

      pollOrder(created.order_id, plan);
    }catch(e){
      setErr("errModal", e?.message || String(e));
      $("btnPayModal").disabled = false;
      updateFooter();
      if (tg?.HapticFeedback) tg.HapticFeedback.notificationOccurred("error");
    }
  }

  $("btnPayModal").onclick = paySelected;

  // copy
  $("btnCopy").onclick = async ()=>{
    try{
      await navigator.clipboard.writeText(lastConfig);
      toast("Скопировано");
      if (tg?.HapticFeedback) tg.HapticFeedback.impactOccurred("light");
    }catch(e){
      alert("Скопируй вручную:\n\n" + lastConfig);
    }
  };

  // open modal
  $("btnOpenPlans").onclick = async ()=>{
    await ensureUserKey();
    openModal();
  };

  // profile
  $("btnNewId").onclick = ()=>{
    const id = genUserKey();
    setUserKey(id);
    toast("Новый ID");
  };

  // referral
  $("btnRefCreate").onclick = async ()=>{
    clearErr("errHome");
    $("refOut").textContent = "создаю…";
    const user_key = await ensureUserKey();
    try{
      const r = await fetch(API_BASE + "/ref/create", {
        method:"POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({ user_key })
      });
      const j = await r.json();
      if(!r.ok) throw new Error(j?.detail || "ref create error");
      $("refOut").textContent = "Твой код: " + j.code;
      toast("Готово");
    }catch(e){
      $("refOut").textContent = "";
      setErr("errHome", e?.message || String(e));
    }
  };

  // init
  (async ()=>{
    const saved = localStorage.getItem("zeus_user_key") || "";
    if(saved) setUserKey(saved);

    $("userKey").addEventListener("change", ()=>{
      setUserKey(getUserKey());
    });

    selectedPlanId = "p30_5";
    setProvider("stars");
    renderPlans();
    updateFooter();

    setSubscriptionUI({ status:"none", active_until:null, devices:null });

    await pingApi();
    setInterval(pingApi, 12000);
  })();
</script>
</body>
</html>
