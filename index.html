<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>ZEUSVPN</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root{
      --ink:#0B1221;
      --ink2:#1B2743;
      --muted:rgba(11,18,33,.62);

      --blue:#0B2A6A;
      --blue2:#1547B6;

      --gold:#C9A24A;
      --gold2:#E1C06A;

      --marble:#F6F6F7;
      --card:#FFFFFF;
      --stroke:rgba(11,18,33,.10);
      --shadow: 0 18px 55px rgba(11,18,33,.10);
      --shadow2: 0 10px 28px rgba(11,18,33,.08);

      --ok:#0FAF76;
      --warn:#C08A18;
      --bad:#D84242;

      --r14:14px;
      --r18:18px;
      --r22:22px;
      --r28:28px;
    }

    *{box-sizing:border-box}
    html,body{height:100%}

    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      color:var(--ink);
      background: var(--marble);
      overflow-x:hidden;
    }

    /* Marble texture */
    body:before{
      content:"";
      position:fixed; inset:0;
      pointer-events:none;
      background:
        radial-gradient(1200px 600px at 20% 0%, rgba(11,42,106,.07), transparent 55%),
        radial-gradient(900px 520px at 90% 12%, rgba(201,162,74,.07), transparent 60%),
        linear-gradient(135deg,
          rgba(0,0,0,.03) 0%,
          rgba(0,0,0,.00) 18%,
          rgba(0,0,0,.02) 36%,
          rgba(0,0,0,.00) 54%,
          rgba(0,0,0,.02) 72%,
          rgba(0,0,0,.00) 100%),
        radial-gradient(900px 800px at 10% 70%, rgba(0,0,0,.03), transparent 65%);
      opacity:1;
    }

    .app{
      max-width:520px;
      margin:0 auto;
      padding: 14px 14px 92px;
      position:relative;
      z-index:1;
    }

    /* Top hero (temple feel) */
    .hero{
      border-radius: var(--r28);
      background:
        linear-gradient(180deg, rgba(11,42,106,.92), rgba(11,42,106,.85));
      color:#fff;
      box-shadow: 0 28px 70px rgba(11,42,106,.22);
      padding: 16px 16px 14px;
      overflow:hidden;
      position:relative;
    }

    /* Greek key lines */
    .hero:before{
      content:"";
      position:absolute; inset:0;
      background:
        radial-gradient(600px 260px at 12% 0%, rgba(255,255,255,.16), transparent 60%),
        radial-gradient(520px 240px at 92% 30%, rgba(201,162,74,.18), transparent 62%),
        linear-gradient(90deg, rgba(255,255,255,.10), rgba(255,255,255,0));
      opacity:.9;
      pointer-events:none;
    }

    .topRow{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      position:relative;
      z-index:2;
    }

    .brand{
      display:flex;
      align-items:center;
      gap:12px;
      min-width:0;
    }

    .mark{
      width:44px; height:44px;
      border-radius: 16px;
      background: rgba(255,255,255,.10);
      border: 1px solid rgba(255,255,255,.18);
      backdrop-filter: blur(10px);
      display:flex;
      align-items:center;
      justify-content:center;
      box-shadow: 0 16px 40px rgba(0,0,0,.20);
    }
    .mark svg{display:block}

    .brandText{min-width:0}
    .brandText .name{
      font-weight: 900;
      letter-spacing: .6px;
      margin:0;
      font-size: 16px;
      line-height: 1.1;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }
    .brandText .tag{
      margin:6px 0 0;
      font-size: 12px;
      color: rgba(255,255,255,.76);
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }

    .apiChip{
      flex:0 0 auto;
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 9px 10px;
      border-radius:999px;
      background: rgba(255,255,255,.10);
      border:1px solid rgba(255,255,255,.16);
      font-size: 12px;
      color: rgba(255,255,255,.86);
      white-space:nowrap;
    }
    .apiDot{
      width:8px; height:8px;
      border-radius:50%;
      background: rgba(255,255,255,.70);
    }

    .heroMain{
      position:relative;
      z-index:2;
      margin-top: 14px;
      display:grid;
      gap:10px;
    }
    .heroTitle{
      margin:0;
      font-size: 18px;
      font-weight: 900;
      letter-spacing:.2px;
      line-height:1.2;
    }
    .heroSub{
      margin:0;
      font-size: 12.6px;
      color: rgba(255,255,255,.78);
      line-height:1.45;
      max-width: 48ch;
    }

    .heroStats{
      display:flex;
      gap:10px;
      margin-top: 10px;
    }
    .hStat{
      flex:1;
      border-radius: 16px;
      background: rgba(255,255,255,.10);
      border: 1px solid rgba(255,255,255,.14);
      padding: 10px 10px;
    }
    .hStat b{
      display:block;
      font-size: 12px;
      letter-spacing:.2px;
      margin-bottom: 6px;
    }
    .hStat span{
      font-size: 12px;
      color: rgba(255,255,255,.76);
    }

    /* Cards */
    .card{
      margin-top: 12px;
      background: var(--card);
      border:1px solid var(--stroke);
      border-radius: var(--r28);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .cardHead{
      padding: 14px 14px 10px;
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap:10px;
    }
    .cardHead h2{
      margin:0;
      font-size: 12px;
      letter-spacing:.32px;
      text-transform:uppercase;
      color: var(--ink2);
      font-weight: 900;
    }
    .cardHead small{
      color: var(--muted);
      font-size: 12px;
    }

    .divider{
      height:1px;
      background: linear-gradient(90deg, transparent, rgba(11,18,33,.12), transparent);
      margin: 0 14px;
    }

    .cardBody{
      padding: 12px 14px 14px;
    }

    .field{
      display:grid;
      gap:8px;
      margin-bottom: 10px;
    }
    .label{
      font-size: 12px;
      color: var(--muted);
    }
    .input{
      width:100%;
      padding: 13px 12px;
      border-radius: 16px;
      border:1px solid rgba(11,18,33,.14);
      background: #FBFBFC;
      outline:none;
      font-size: 14px;
      color: var(--ink);
      box-shadow: inset 0 1px 0 rgba(255,255,255,.8);
    }

    .btn{
      width:100%;
      padding: 14px 14px;
      border-radius: 18px;
      border: 0;
      cursor:pointer;
      font-weight: 900;
      letter-spacing:.2px;
      transition: transform .06s ease, filter .12s ease;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
    }
    .btn:active{ transform: translateY(1px); }
    .btn[disabled]{opacity:.55; cursor:not-allowed;}

    /* Zeus primary: carved + royal */
    .btnPrimary{
      color:#fff;
      background:
        linear-gradient(180deg, rgba(255,255,255,.16), rgba(255,255,255,0) 28%),
        linear-gradient(180deg, var(--blue2), var(--blue));
      box-shadow: 0 16px 34px rgba(11,42,106,.22);
    }

    /* Gold payment */
    .btnGold{
      color:#2a1a00;
      background:
        linear-gradient(180deg, rgba(255,255,255,.30), rgba(255,255,255,0) 35%),
        linear-gradient(180deg, var(--gold2), var(--gold));
      box-shadow: 0 16px 34px rgba(201,162,74,.20);
    }

    /* Neutral outline */
    .btnOutline{
      background:#FBFBFC;
      color: var(--ink2);
      border:1px solid rgba(11,18,33,.16);
      box-shadow: var(--shadow2);
    }

    .row{
      display:flex;
      gap:10px;
      margin-top: 10px;
    }
    .row .btn{flex:1}

    .notice{
      margin-top: 10px;
      padding: 12px;
      border-radius: 18px;
      border:1px solid rgba(11,18,33,.12);
      background: #FBFBFC;
    }
    .noticeTop{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom: 10px;
    }
    .badge{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 6px 10px;
      border-radius:999px;
      font-size: 12px;
      font-weight: 900;
      border:1px solid rgba(11,18,33,.12);
      background: #fff;
      color: var(--ink2);
      white-space:nowrap;
    }
    .badge.ok{border-color: rgba(15,175,118,.25); color: var(--ok);}
    .badge.warn{border-color: rgba(192,138,24,.25); color: var(--warn);}
    .badge.bad{border-color: rgba(216,66,66,.25); color: var(--bad);}

    .mono{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 12px;
      line-height:1.35;
      word-break:break-all;
      color: rgba(11,18,33,.92);
    }

    .muted{
      color: var(--muted);
      font-size: 12px;
      line-height: 1.45;
    }

    .hidden{display:none !important;}

    /* Screens */
    .screen{ margin-top: 12px; }
    .screen.hidden{display:none}

    /* Instructions carousel */
    .carousel{
      display:flex;
      gap:12px;
      overflow:auto;
      scroll-snap-type:x mandatory;
      -webkit-overflow-scrolling:touch;
      padding: 12px 14px 14px;
    }
    .carousel::-webkit-scrollbar{display:none}
    .slide{
      min-width: 86%;
      scroll-snap-align:start;
      border-radius: 22px;
      border:1px solid rgba(11,18,33,.12);
      background:
        radial-gradient(520px 260px at 20% 0%, rgba(11,42,106,.06), transparent 60%),
        linear-gradient(180deg, #FFFFFF, #FBFBFC);
      padding: 14px;
      box-shadow: var(--shadow2);
    }
    .slideTop{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom: 10px;
    }
    .chip{
      font-size: 12px;
      padding: 6px 10px;
      border-radius: 999px;
      border:1px solid rgba(11,18,33,.12);
      background:#fff;
      color: rgba(11,18,33,.70);
      white-space:nowrap;
    }
    .steps{
      font-size: 12.8px;
      color: rgba(11,18,33,.72);
      line-height: 1.55;
    }

    /* Bottom nav (stone tabs) */
    .nav{
      position:fixed;
      left:0; right:0; bottom:0;
      padding: 10px 12px calc(10px + env(safe-area-inset-bottom));
      background: rgba(246,246,247,.92);
      border-top: 1px solid rgba(11,18,33,.10);
      backdrop-filter: blur(10px);
      z-index:10;
    }
    .navInner{
      max-width:520px;
      margin:0 auto;
      display:flex;
      gap:10px;
    }
    .tab{
      flex:1;
      padding: 12px 10px;
      border-radius: 18px;
      border:1px solid rgba(11,18,33,.12);
      background: #FFFFFF;
      color: rgba(11,18,33,.66);
      font-weight: 900;
      letter-spacing:.15px;
      cursor:pointer;
      box-shadow: var(--shadow2);
    }
    .tab.active{
      color: #fff;
      border-color: rgba(11,42,106,.30);
      background:
        linear-gradient(180deg, rgba(255,255,255,.16), rgba(255,255,255,0) 28%),
        linear-gradient(180deg, var(--blue2), var(--blue));
      box-shadow: 0 16px 34px rgba(11,42,106,.18);
    }
  </style>
</head>

<body>
  <div class="app">
    <div class="hero">
      <div class="topRow">
        <div class="brand">
          <div class="mark" aria-hidden="true">
            <!-- Clean Zeus lightning -->
            <svg width="22" height="26" viewBox="0 0 22 26" fill="none">
              <path d="M12.8 1.5H21L12.2 13.2H18.8L7.6 24.5L9.8 14.1H3L12.8 1.5Z"
                    fill="rgba(255,255,255,.92)"/>
            </svg>
          </div>
          <div class="brandText">
            <p class="name">ZEUSVPN</p>
            <p class="tag">Marble • Royal Blue • VLESS</p>
          </div>
        </div>

        <div class="apiChip" id="apiPill">
          <span class="apiDot" id="apiDot"></span>
          <span id="apiText">API: checking…</span>
        </div>
      </div>

      <div class="heroMain">
        <p class="heroTitle">Премиум-конфиг за 1 тап</p>
        <p class="heroSub">
          Оплата Stars / USDT → после подтверждения показываем конфиг и “Активна до…”.
        </p>

        <div class="heroStats">
          <div class="hStat">
            <b>Подписка</b>
            <span id="heroSubStat">не оплачено</span>
          </div>
          <div class="hStat">
            <b>Устройства</b>
            <span>1 / 5 / 10 (UI)</span>
          </div>
          <div class="hStat">
            <b>API</b>
            <span id="heroApi">—</span>
          </div>
        </div>
      </div>
    </div>

    <!-- HOME -->
    <div class="screen" id="screenHome">
      <div class="card">
        <div class="cardHead">
          <h2>Конфиг</h2>
          <small>индивидуально</small>
        </div>
        <div class="divider"></div>

        <div class="cardBody">
          <div class="field">
            <div class="label">ID пользователя (можно пусто)</div>
            <input class="input" id="userKey" placeholder="например: zeus-1234" />
            <div class="muted">Позже это станет Telegram ID автоматически.</div>
          </div>

          <button class="btn btnPrimary" id="btnGetConfig">Получить конфиг</button>

          <div class="notice hidden" id="configBox">
            <div class="noticeTop">
              <span class="badge ok">VLESS</span>
              <button class="btn btnOutline" id="btnCopy" style="width:auto; padding:10px 12px; border-radius:14px;">Скопировать</button>
            </div>
            <div class="mono" id="configText"></div>
          </div>

          <div class="notice hidden" id="errBox" style="border-color: rgba(216,66,66,.25);">
            <div class="noticeTop">
              <span class="badge bad">Ошибка</span>
              <span class="muted" id="errText" style="text-align:right"></span>
            </div>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="cardHead">
          <h2>Оплата</h2>
          <small>Stars / USDT</small>
        </div>
        <div class="divider"></div>

        <div class="cardBody">
          <div class="row">
            <button class="btn btnGold" id="btnPayStars">Оплатить Stars</button>
            <button class="btn btnOutline" id="btnPayUsdt">Оплатить USDT</button>
          </div>

          <div class="notice hidden" id="payBox" style="margin-top:12px;">
            <div class="noticeTop">
              <span class="muted">Статус заказа</span>
              <span class="badge warn" id="payStatus">pending</span>
            </div>
            <div class="muted" id="payMeta"></div>
            <div class="muted" style="margin-top:10px;">
              Авто-проверка каждые ~1.2 сек. Когда станет <b>paid</b> — покажем конфиг и активность.
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- GUIDE -->
    <div class="screen hidden" id="screenGuide">
      <div class="card">
        <div class="cardHead">
          <h2>Инструкции</h2>
          <small>свайп</small>
        </div>
        <div class="divider"></div>

        <div class="carousel">
          <div class="slide">
            <div class="slideTop">
              <b>iOS</b>
              <span class="chip">V2Box / Shadowrocket</span>
            </div>
            <div class="steps">
              1) Нажми “Получить конфиг”<br/>
              2) Скопируй VLESS ссылку<br/>
              3) Import → From Clipboard<br/>
              4) Connect
            </div>
          </div>

          <div class="slide">
            <div class="slideTop">
              <b>Android</b>
              <span class="chip">v2rayNG</span>
            </div>
            <div class="steps">
              1) Получи конфиг<br/>
              2) Скопируй ссылку<br/>
              3) “+” → Import from Clipboard<br/>
              4) Connect
            </div>
          </div>

          <div class="slide">
            <div class="slideTop">
              <b>Desktop</b>
              <span class="chip">Nekoray / v2rayN</span>
            </div>
            <div class="steps">
              1) Скопируй конфиг<br/>
              2) Импорт по ссылке/буферу<br/>
              3) Подключись
            </div>
          </div>
        </div>

        <div class="cardBody" style="padding-top:0">
          <div class="muted">Свайпай карточки влево/вправо.</div>
        </div>
      </div>
    </div>

    <!-- PROFILE -->
    <div class="screen hidden" id="screenProfile">
      <div class="card">
        <div class="cardHead">
          <h2>Профиль</h2>
          <small>Telegram позже</small>
        </div>
        <div class="divider"></div>

        <div class="cardBody">
          <div class="notice" style="margin-top:0">
            <div class="noticeTop">
              <span class="muted">ID</span>
              <span class="badge" id="profileId">—</span>
            </div>

            <div class="noticeTop" style="margin:0">
              <span class="muted">Подписка</span>
              <span class="badge warn" id="subStatus">Не оплачено</span>
            </div>
            <div class="muted" id="activeUntil" style="margin-top:8px;">Активна до: —</div>

            <div class="row" style="margin-top:12px;">
              <button class="btn btnOutline" id="btnResetId">Новый ID</button>
              <button class="btn btnOutline" id="btnHistory" disabled>История (скоро)</button>
            </div>
          </div>

          <div class="notice">
            <div class="noticeTop">
              <span class="muted"><b>Рефералка</b>: +7 дней (UI)</span>
              <span class="badge">ZEUS</span>
            </div>
            <button class="btn btnOutline" id="btnRefCreate">Создать реф-код</button>
            <div class="muted" id="refOut" style="margin-top:10px;"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Bottom navigation -->
  <div class="nav">
    <div class="navInner">
      <button class="tab active" id="tabHome">Главная</button>
      <button class="tab" id="tabGuide">Инструкции</button>
      <button class="tab" id="tabProfile">Профиль</button>
    </div>
  </div>

<script>
  // ===== CONFIG =====
  const API_BASE = "https://api.45.133.251.210.nip.io:8443";

  const tg = window.Telegram?.WebApp;
  if (tg) { try { tg.ready(); tg.expand(); } catch(e){} }

  const $ = (id)=>document.getElementById(id);
  const show = (el)=>el.classList.remove("hidden");
  const hide = (el)=>el.classList.add("hidden");

  function clearError(){
    hide($("errBox"));
    $("errText").textContent = "";
  }
  function setError(msg){
    $("errText").textContent = msg || "Неизвестная ошибка";
    show($("errBox"));
  }
  function genUserKey(){
    const n = Math.floor(Math.random()*9000)+1000;
    return "zeus-" + n;
  }
  function setProfileId(id){
    $("profileId").textContent = id || "—";
    localStorage.setItem("zeus_user_key", id || "");
  }

  async function pingApi(){
    try{
      const r = await fetch(API_BASE + "/health", { method:"GET" });
      if(!r.ok) throw new Error("health not ok");
      await r.json();

      $("apiText").textContent = "API: online";
      $("apiDot").style.background = "#22D09A";
      $("heroApi").textContent = "online";
      return true;
    }catch(e){
      $("apiText").textContent = "API: offline";
      $("apiDot").style.background = "#FF6262";
      $("heroApi").textContent = "offline";
      return false;
    }
  }

  // ===== CONFIG ISSUE =====
  let lastConfig = "";

  $("btnGetConfig").addEventListener("click", async ()=>{
    clearError();
    hide($("configBox"));

    let user_key = $("userKey").value.trim();
    if(!user_key){
      user_key = genUserKey();
      $("userKey").value = user_key;
    }
    setProfileId(user_key);

    $("btnGetConfig").disabled = true;
    $("btnGetConfig").textContent = "Генерирую…";

    try{
      const r = await fetch(API_BASE + "/issue-config", {
        method:"POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({
          inbound_id: 1,
          user_key,
          days: 30,
          limit_ip: 0
        })
      });

      const txt = await r.text();
      let data;
      try { data = JSON.parse(txt); } catch(e){ data = { raw: txt }; }

      if(!r.ok) throw new Error(data?.detail || ("HTTP " + r.status));

      lastConfig = data.link || "";
      if(!lastConfig) throw new Error("Ответ без link");

      $("configText").textContent = lastConfig;
      show($("configBox"));
    }catch(e){
      setError(e?.message || String(e));
    }finally{
      $("btnGetConfig").disabled = false;
      $("btnGetConfig").textContent = "Получить конфиг";
    }
  });

  $("btnCopy").addEventListener("click", async ()=>{
    try{
      await navigator.clipboard.writeText(lastConfig);
      const old = $("btnCopy").textContent;
      $("btnCopy").textContent = "Скопировано";
      setTimeout(()=> $("btnCopy").textContent = old, 900);
    }catch(e){
      alert("Скопируй вручную:\n\n" + lastConfig);
    }
  });

  // ===== PAYMENTS + POLLING =====
  let pollTimer = null;

  async function ensureUserKey(){
    let user_key = $("userKey").value.trim();
    if(!user_key){
      user_key = genUserKey();
      $("userKey").value = user_key;
    }
    setProfileId(user_key);
    return user_key;
  }

  async function pollOrder(orderId){
    if(pollTimer) clearInterval(pollTimer);

    pollTimer = setInterval(async ()=>{
      try{
        const r = await fetch(API_BASE + "/pay/order/" + orderId, { method:"GET" });
        const j = await r.json();

        $("payStatus").textContent = j.status || "pending";
        $("payStatus").className = "badge " + ((j.status === "paid") ? "ok" : (j.status === "error" ? "bad" : "warn"));

        const amount = (j.amount != null) ? `${j.amount} ${j.currency || ""}` : "";
        $("payMeta").textContent = `order: ${j.id} • ${amount} • days: ${j.plan_days || ""} • devices: ${j.devices || ""}`;

        if(j.status === "paid"){
          clearInterval(pollTimer);
          pollTimer = null;

          $("subStatus").textContent = "Активна";
          $("subStatus").className = "badge ok";
          $("heroSubStat").textContent = "активна";

          if(j.active_until){
            $("activeUntil").textContent = "Активна до: " + new Date(j.active_until).toLocaleString();
          }

          if(j.config_link){
            lastConfig = j.config_link;
            $("configText").textContent = lastConfig;
            show($("configBox"));
          }
        }
      }catch(e){
        // тихо, чтобы не шуметь
      }
    }, 1200);
  }

  $("btnPayStars").addEventListener("click", async ()=>{
    clearError();
    show($("payBox"));
    $("payStatus").textContent = "creating…";
    $("payStatus").className = "badge warn";
    $("payMeta").textContent = "";

    const user_key = await ensureUserKey();

    try{
      const r = await fetch(API_BASE + "/pay/stars/create", {
        method:"POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({ user_key, days:30, devices:1 })
      });
      const j = await r.json();
      if(!r.ok) throw new Error(j?.detail || "Stars create error");

      $("payStatus").textContent = "pending";
      $("payMeta").textContent = `order: ${j.order_id}`;

      if(tg && tg.openInvoice){
        tg.openInvoice(j.invoice_link, ()=>{});
      } else {
        window.open(j.invoice_link, "_blank");
      }

      pollOrder(j.order_id);
    }catch(e){
      setError(e?.message || String(e));
      $("payStatus").textContent = "error";
      $("payStatus").className = "badge bad";
    }
  });

  $("btnPayUsdt").addEventListener("click", async ()=>{
    clearError();
    show($("payBox"));
    $("payStatus").textContent = "creating…";
    $("payStatus").className = "badge warn";
    $("payMeta").textContent = "";

    const user_key = await ensureUserKey();

    try{
      const r = await fetch(API_BASE + "/pay/crypto/create", {
        method:"POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({ user_key, days:30, devices:1 })
      });
      const j = await r.json();
      if(!r.ok) throw new Error(j?.detail || "Crypto create error");

      $("payStatus").textContent = "pending";
      $("payMeta").textContent = `order: ${j.order_id}`;

      if(j.invoice_url){
        window.open(j.invoice_url, "_blank");
      }

      pollOrder(j.order_id);
    }catch(e){
      setError(e?.message || String(e));
      $("payStatus").textContent = "error";
      $("payStatus").className = "badge bad";
    }
  });

  // ===== REF =====
  $("btnRefCreate").addEventListener("click", async ()=>{
    clearError();
    $("refOut").textContent = "создаю…";

    const user_key = await ensureUserKey();

    try{
      const r = await fetch(API_BASE + "/ref/create", {
        method:"POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({ user_key })
      });
      const j = await r.json();
      if(!r.ok) throw new Error(j?.detail || "ref create error");

      $("refOut").textContent = "Твой код: " + j.code;
    }catch(e){
      $("refOut").textContent = "";
      setError(e?.message || String(e));
    }
  });

  $("btnResetId").addEventListener("click", ()=>{
    const id = genUserKey();
    $("userKey").value = id;
    setProfileId(id);
  });

  // ===== Tabs =====
  function setTab(tab){
    const map = [
      ["tabHome","screenHome"],
      ["tabGuide","screenGuide"],
      ["tabProfile","screenProfile"]
    ];
    map.forEach(([t,s])=>{
      $(t).classList.toggle("active", t === tab);
      $(s).classList.toggle("hidden", t !== tab);
    });
  }
  $("tabHome").onclick = ()=>setTab("tabHome");
  $("tabGuide").onclick = ()=>setTab("tabGuide");
  $("tabProfile").onclick = ()=>setTab("tabProfile");

  // ===== Init =====
  (async ()=>{
    const saved = localStorage.getItem("zeus_user_key") || "";
    if(saved){
      $("userKey").value = saved;
      $("profileId").textContent = saved;
    }
    $("userKey").addEventListener("change", ()=>{
      const v = $("userKey").value.trim();
      localStorage.setItem("zeus_user_key", v);
      $("profileId").textContent = v || "—";
    });

    await pingApi();
    setInterval(pingApi, 12000);
  })();
</script>
</body>
</html>
