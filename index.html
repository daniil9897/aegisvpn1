<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>ZEUSVPN</title>
  <style>
    :root{
      --bg0:#070709;
      --bg1:#0b0b0f;
      --card:#0f1014;
      --card2:#12131a;
      --stroke:rgba(255,255,255,.08);
      --stroke2:rgba(255,255,255,.12);
      --txt:#f2f3f5;
      --muted:rgba(255,255,255,.62);
      --muted2:rgba(255,255,255,.46);
      --good:#42ffb6;
      --warn:#ffd36b;
      --bad:#ff5c77;

      --shadow: 0 20px 70px rgba(0,0,0,.55);
      --shadow2: 0 10px 30px rgba(0,0,0,.45);

      --r:22px;
      --r2:18px;

      --ease:cubic-bezier(.2,.8,.2,1);
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      color:var(--txt);
      background:
        radial-gradient(1200px 700px at 50% -10%, rgba(255,255,255,.08), transparent 55%),
        radial-gradient(900px 500px at 85% 10%, rgba(255,255,255,.06), transparent 60%),
        radial-gradient(900px 500px at 15% 10%, rgba(255,255,255,.05), transparent 60%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      overflow-x:hidden;
    }

    /* subtle premium grain */
    body:before{
      content:"";
      position:fixed;
      inset:-20%;
      pointer-events:none;
      background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='210' height='210'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.8' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='210' height='210' filter='url(%23n)' opacity='.16'/%3E%3C/svg%3E");
      mix-blend-mode: overlay;
      opacity:.22;
      transform:translateZ(0);
    }

    .app{
      max-width:520px;
      margin:0 auto;
      padding:18px 16px 100px;
    }

    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding-top:10px;
    }

    .brand{
      display:flex;
      align-items:center;
      gap:12px;
      min-width:0;
    }

    .logo{
      width:46px;height:46px;border-radius:16px;
      background:linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.04));
      border:1px solid var(--stroke);
      box-shadow: var(--shadow2);
      display:grid;place-items:center;
      overflow:hidden;
      position:relative;
    }

    /* embed YOUR logo as inline SVG (black/white only) */
    .logo svg{width:38px;height:38px;opacity:.98}
    .logo:after{
      content:"";
      position:absolute;inset:-40%;
      background:radial-gradient(closest-side, rgba(255,255,255,.16), transparent 60%);
      transform:translate(20%, -10%);
      opacity:.35;
      pointer-events:none;
    }

    .brandText{min-width:0}
    .title{
      font-weight:800;
      letter-spacing:.06em;
      font-size:15px;
      text-transform:uppercase;
      line-height:1.05;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .subtitle{
      margin-top:4px;
      color:var(--muted);
      font-size:12px;
      letter-spacing:.01em;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    .chipRow{
      display:flex;
      gap:8px;
      align-items:center;
    }
    .chip{
      padding:8px 10px;
      border-radius:999px;
      border:1px solid var(--stroke);
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      color:var(--muted);
      font-size:12px;
      display:inline-flex;
      align-items:center;
      gap:6px;
      user-select:none;
    }
    .dot{
      width:7px;height:7px;border-radius:99px;
      background:rgba(255,255,255,.35);
      box-shadow:0 0 0 2px rgba(255,255,255,.06);
    }

    .section{
      margin-top:16px;
      border-radius: var(--r);
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      border:1px solid var(--stroke);
      box-shadow: var(--shadow);
      overflow:hidden;
      position:relative;
    }
    .sectionInner{
      padding:14px;
    }

    .divider{
      height:1px;
      background:linear-gradient(90deg, transparent, rgba(255,255,255,.12), transparent);
      margin:12px 0;
      opacity:.9;
    }

    .hero{
      display:flex;
      flex-direction:column;
      gap:12px;
    }
    .hero h1{
      margin:0;
      font-size:20px;
      letter-spacing:-.02em;
    }
    .hero p{
      margin:0;
      color:var(--muted);
      font-size:13px;
      line-height:1.5;
    }

    .primary{
      width:100%;
      border-radius:16px;
      padding:14px 14px;
      border:1px solid rgba(255,255,255,.16);
      background:linear-gradient(180deg, rgba(255,255,255,.14), rgba(255,255,255,.06));
      color:var(--txt);
      font-weight:700;
      letter-spacing:.01em;
      box-shadow:0 14px 36px rgba(0,0,0,.55);
      transform:translateZ(0);
      cursor:pointer;
      transition:transform .18s var(--ease), filter .18s var(--ease);
    }
    .primary:active{transform:scale(.985)}
    .primary:hover{filter:brightness(1.05)}

    .ghost{
      width:100%;
      border-radius:16px;
      padding:12px 14px;
      border:1px solid var(--stroke);
      background:rgba(0,0,0,.15);
      color:var(--muted);
      font-weight:650;
      cursor:pointer;
      transition:transform .18s var(--ease), border-color .18s var(--ease);
    }
    .ghost:active{transform:scale(.99)}
    .ghost:hover{border-color:rgba(255,255,255,.14);}

    .grid2{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:10px;
    }

    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 10px;
      border-radius:999px;
      border:1px solid var(--stroke);
      color:var(--muted);
      font-size:12px;
      background:rgba(0,0,0,.18);
      user-select:none;
    }

    .tag{
      display:inline-flex;
      align-items:center;
      gap:6px;
      font-size:11px;
      padding:6px 9px;
      border-radius:999px;
      border:1px solid var(--stroke);
      background:rgba(255,255,255,.04);
      color:rgba(255,255,255,.74);
    }
    .tag strong{font-weight:800}
    .tag.pop{border-color:rgba(255,255,255,.14)}
    .tag.best{border-color:rgba(255,255,255,.20)}

    .muted{color:var(--muted)}
    .small{font-size:12px}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;}

    /* bottom nav */
    .nav{
      position:fixed;
      left:0; right:0;
      bottom:0;
      padding:12px 14px calc(12px + env(safe-area-inset-bottom));
      background:linear-gradient(180deg, rgba(10,10,12,0), rgba(10,10,12,.88) 30%, rgba(10,10,12,.96));
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      border-top:1px solid rgba(255,255,255,.08);
      display:flex;
      justify-content:center;
      z-index:50;
    }
    .navInner{
      max-width:520px;
      width:100%;
      display:grid;
      grid-template-columns:1fr 1fr 1fr;
      gap:10px;
    }
    .navBtn{
      border-radius:18px;
      border:1px solid rgba(255,255,255,.08);
      background:rgba(0,0,0,.22);
      padding:12px 10px;
      color:rgba(255,255,255,.70);
      font-weight:700;
      font-size:12px;
      letter-spacing:.01em;
      cursor:pointer;
      transition:transform .18s var(--ease), background .18s var(--ease), color .18s var(--ease), border-color .18s var(--ease);
    }
    .navBtn:active{transform:scale(.985)}
    .navBtn.active{
      color:var(--txt);
      border-color:rgba(255,255,255,.18);
      background:linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.03));
    }

    /* screens with iOS-like transitions */
    .screen{
      display:none;
      animation: none;
    }
    .screen.active{display:block}
    .animIn{
      animation: fadeSlideIn .28s var(--ease) both;
    }
    .animOut{
      animation: fadeSlideOut .22s var(--ease) both;
    }
    @keyframes fadeSlideIn{
      from{opacity:0; transform:translateY(12px)}
      to{opacity:1; transform:translateY(0)}
    }
    @keyframes fadeSlideOut{
      from{opacity:1; transform:translateY(0)}
      to{opacity:0; transform:translateY(10px)}
    }

    /* modal */
    .modalWrap{
      position:fixed;
      inset:0;
      display:none;
      align-items:flex-end;
      justify-content:center;
      background:rgba(0,0,0,.55);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      z-index:80;
      padding:14px 12px calc(14px + env(safe-area-inset-bottom));
    }
    .modalWrap.show{display:flex}
    .modal{
      width:100%;
      max-width:520px;
      border-radius:26px;
      background:linear-gradient(180deg, rgba(22,22,28,.96), rgba(14,14,18,.96));
      border:1px solid rgba(255,255,255,.12);
      box-shadow:0 30px 120px rgba(0,0,0,.65);
      overflow:hidden;
      transform-origin:50% 100%;
      animation: modalIn .24s var(--ease) both;
    }
    @keyframes modalIn{
      from{transform:translateY(18px) scale(.98); opacity:0}
      to{transform:translateY(0) scale(1); opacity:1}
    }
    .modalHeader{
      padding:14px 14px 10px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      border-bottom:1px solid rgba(255,255,255,.08);
    }
    .modalHeader strong{letter-spacing:.02em}
    .xBtn{
      width:36px;height:36px;border-radius:14px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(0,0,0,.18);
      color:rgba(255,255,255,.72);
      cursor:pointer;
      transition:transform .18s var(--ease);
    }
    .xBtn:active{transform:scale(.97)}
    .modalBody{padding:14px}
    .row{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
    }
    .selectGroup{
      margin-bottom:14px;
    }
    .label{
      display:flex;align-items:center;justify-content:space-between;
      margin:0 0 8px 0;
      color:rgba(255,255,255,.75);
      font-size:12px;
      letter-spacing:.02em;
    }

    .opt{
      padding:10px 12px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(0,0,0,.18);
      color:rgba(255,255,255,.72);
      font-weight:750;
      font-size:12px;
      cursor:pointer;
      user-select:none;
      transition:transform .18s var(--ease), border-color .18s var(--ease), background .18s var(--ease), color .18s var(--ease);
    }
    .opt:active{transform:scale(.985)}
    .opt.active{
      color:var(--txt);
      border-color:rgba(255,255,255,.22);
      background:linear-gradient(180deg, rgba(255,255,255,.09), rgba(255,255,255,.03));
    }

    /* 3D choice card */
    .choiceCard{
      margin-top:10px;
      border-radius:22px;
      background:linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.02));
      border:1px solid rgba(255,255,255,.14);
      box-shadow: 0 20px 70px rgba(0,0,0,.55);
      padding:14px;
      position:relative;
      overflow:hidden;
      transform: perspective(900px) rotateX(10deg);
    }
    .choiceCard:before{
      content:"";
      position:absolute; inset:-40%;
      background:radial-gradient(closest-side, rgba(255,255,255,.16), transparent 60%);
      transform:translate(-10%, -10%);
      opacity:.28;
      pointer-events:none;
    }
    /* ultra light shimmer */
    .choiceCard:after{
      content:"";
      position:absolute;
      inset:-60%;
      background:linear-gradient(90deg, transparent, rgba(255,255,255,.10), transparent);
      transform:translateX(-40%) rotate(10deg);
      animation: shimmer 2.8s var(--ease) infinite;
      opacity:.20;
      pointer-events:none;
    }
    @keyframes shimmer{
      0%{transform:translateX(-45%) rotate(10deg)}
      50%{transform:translateX(45%) rotate(10deg)}
      100%{transform:translateX(45%) rotate(10deg)}
    }
    .choiceTop{
      display:flex; align-items:flex-start; justify-content:space-between; gap:10px;
    }
    .choiceTop h3{
      margin:0;
      font-size:15px;
      letter-spacing:.01em;
    }
    .price{
      font-weight:900;
      letter-spacing:.02em;
      font-size:16px;
      white-space:nowrap;
    }
    .choiceMeta{
      margin-top:6px;
      color:rgba(255,255,255,.68);
      font-size:12px;
      line-height:1.4;
    }

    .payRow{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:10px;
      margin-top:12px;
    }
    .payBtn{
      border-radius:16px;
      padding:12px 12px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(0,0,0,.18);
      color:rgba(255,255,255,.78);
      font-weight:850;
      cursor:pointer;
      transition:transform .18s var(--ease), border-color .18s var(--ease), background .18s var(--ease), color .18s var(--ease);
    }
    .payBtn:active{transform:scale(.985)}
    .payBtn.primaryPay{
      background:linear-gradient(180deg, rgba(255,255,255,.14), rgba(255,255,255,.06));
      border-color:rgba(255,255,255,.18);
      color:var(--txt);
    }
    .payBtn[disabled]{
      opacity:.45;
      cursor:not-allowed;
      transform:none!important;
    }

    .statusLine{
      margin-top:10px;
      padding:10px 12px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(0,0,0,.16);
      color:rgba(255,255,255,.70);
      font-size:12px;
      line-height:1.35;
    }

    .codeBox{
      margin-top:10px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(0,0,0,.28);
      padding:12px;
      overflow:hidden;
    }
    .codeBox pre{
      margin:0;
      white-space:pre-wrap;
      word-break:break-all;
      font-size:12px;
      color:rgba(255,255,255,.86);
    }
    .copyBtn{
      margin-top:10px;
      width:100%;
      border-radius:16px;
      padding:12px 14px;
      border:1px solid rgba(255,255,255,.16);
      background:linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.04));
      color:var(--txt);
      font-weight:900;
      cursor:pointer;
      transition:transform .18s var(--ease);
    }
    .copyBtn:active{transform:scale(.985)}

    /* instructions swipe */
    .swipe{
      display:flex;
      gap:10px;
      overflow:auto;
      scroll-snap-type:x mandatory;
      -webkit-overflow-scrolling: touch;
      padding:12px 14px 14px;
    }
    .swipe::-webkit-scrollbar{display:none}
    .swCard{
      min-width:84%;
      scroll-snap-align:center;
      border-radius:22px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(0,0,0,.18);
      padding:14px;
      box-shadow:0 16px 45px rgba(0,0,0,.45);
    }
    .swCard h3{margin:0 0 6px 0; font-size:15px}
    .swCard ol{margin:0; padding-left:18px; color:rgba(255,255,255,.74); font-size:13px; line-height:1.5}
    .swHint{
      text-align:center;
      color:rgba(255,255,255,.45);
      font-size:11px;
      padding:0 14px 14px;
    }

    /* small badges */
    .badge{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      padding:5px 9px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.05);
      color:rgba(255,255,255,.75);
      font-size:11px;
      font-weight:850;
      letter-spacing:.01em;
    }

    /* toast */
    .toast{
      position:fixed;
      left:50%;
      bottom:90px;
      transform:translateX(-50%);
      background:rgba(18,18,22,.92);
      border:1px solid rgba(255,255,255,.14);
      color:rgba(255,255,255,.82);
      padding:10px 12px;
      border-radius:14px;
      box-shadow:0 20px 70px rgba(0,0,0,.6);
      font-size:12px;
      opacity:0;
      pointer-events:none;
      transition:opacity .2s var(--ease), transform .2s var(--ease);
      z-index:90;
      max-width:92%;
      text-align:center;
    }
    .toast.show{opacity:1; transform:translateX(-50%) translateY(-4px);}
  </style>
</head>
<body>
  <div class="app">

    <div class="topbar">
      <div class="brand">
        <div class="logo" aria-label="ZEUSVPN Logo">
          <!-- Simple Zeus profile (black/white) inside a rounded tile -->
          <svg viewBox="0 0 64 64" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
            <path fill="#fff" d="M42.7 10.2c-6.7 1.2-12.9 5.8-16.1 11.7-2.3 4.3-3 9.3-1.8 13.9 1 3.7 3.2 7 6.4 9.3 2.1 1.5 4.5 2.6 6.9 3.2 1.6.4 3.4.7 5 .7 2.7 0 4.9-.5 7.2-1.6 4.5-2.2 7.8-6.1 9.3-10.8.9-2.8 1-6.1.2-8.9-.9-3.1-2.6-5.9-5-8.1-3-2.8-6.8-4.4-11.1-4.4-.4 0-.8 0-1.2.1ZM49.1 27.4c.8.8.8 2 0 2.8l-3.2 3.2c-.7.7-1.8.8-2.6.2-.3-.2-.5-.4-.7-.7-.5-.8-.4-1.9.2-2.6l3.2-3.2c.8-.8 2-.8 2.8 0Z"/>
            <path fill="#fff" d="M20.3 52.2c-.9 0-1.6.7-1.6 1.6 0 .9.7 1.6 1.6 1.6h23.4c.9 0 1.6-.7 1.6-1.6 0-.9-.7-1.6-1.6-1.6H20.3Z"/>
          </svg>
        </div>
        <div class="brandText">
          <div class="title">ZEUSVPN</div>
          <div class="subtitle">Premium • Dark • Minimal</div>
        </div>
      </div>

      <div class="chipRow">
        <div class="chip" title="Backend status">
          <span class="dot" id="apiDot"></span>
          <span id="apiText">API</span>
        </div>
      </div>
    </div>

    <!-- HOME -->
    <div class="screen active animIn" id="screen-home">
      <div class="section">
        <div class="sectionInner hero">
          <h1>Быстрый доступ к конфигу</h1>
          <p>Выбираешь срок и устройства → оплачиваешь → получаешь персональный VLESS конфиг.</p>

          <div class="divider"></div>

          <div class="grid2">
            <div class="pill"><span class="badge">Популярно</span> 30 дней</div>
            <div class="pill"><span class="badge">Выгоднее</span> 180 дней</div>
          </div>

          <button class="primary" id="btnGetConfig">Получить конфиг</button>
          <button class="ghost" id="btnQuickCheck">Проверить активность</button>

          <div class="statusLine" id="homeStatus">
            Статус: <b id="subStatus">не активна</b><br/>
            Активна до: <b id="activeUntilText">—</b>
          </div>
        </div>
      </div>

      <div class="section" style="margin-top:14px;">
        <div class="sectionInner">
          <div style="display:flex; justify-content:space-between; align-items:center; gap:10px;">
            <strong>Тарифы</strong>
            <span class="small muted">выбор внутри “Получить конфиг”</span>
          </div>
          <div class="divider"></div>
          <div class="small muted" style="line-height:1.45">
            • 30 дней — <b>199</b> (Stars)<br/>
            • 90 дней — <b>399</b> (Stars)<br/>
            • 180 дней — <b>599</b> (Stars)<br/>
            <span class="muted2">USDT через CryptoPay включается отдельно.</span>
          </div>
        </div>
      </div>
    </div>

    <!-- PROFILE -->
    <div class="screen" id="screen-profile">
      <div class="section">
        <div class="sectionInner">
          <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:10px;">
            <div>
              <strong>Профиль</strong><br/>
              <span class="small muted">твоя учётка на сайте (потом заменим на Telegram ID)</span>
            </div>
            <span class="tag pop">ID</span>
          </div>

          <div class="divider"></div>

          <div class="pill" style="justify-content:space-between;width:100%;">
            <span class="small muted">User Key</span>
            <span class="mono" id="userKeyText">—</span>
          </div>

          <div style="margin-top:10px" class="pill">
            <span class="small muted">Активна до</span>&nbsp;—&nbsp;<b id="profileActiveUntil">—</b>
          </div>

          <div class="grid2" style="margin-top:10px;">
            <button class="ghost" id="btnResetId">Сбросить / новый ID</button>
            <button class="ghost" id="btnClearHistory">Очистить историю</button>
          </div>

          <div class="divider"></div>

          <strong class="small">История заказов (локально)</strong>
          <div class="small muted" id="ordersList" style="margin-top:8px;line-height:1.5;">
            — пусто —
          </div>
        </div>
      </div>
    </div>

    <!-- INSTRUCTIONS -->
    <div class="screen" id="screen-instructions">
      <div class="section">
        <div style="padding:14px 14px 0;">
          <strong>Инструкции</strong>
          <div class="small muted" style="margin-top:6px;">Листай карточки → выбери свою платформу.</div>
        </div>

        <div class="swipe" id="swipe">
          <div class="swCard">
            <h3>iOS</h3>
            <ol>
              <li>Установи клиент: V2Box / Shadowrocket (если есть).</li>
              <li>Нажми “Скопировать” конфиг в ZEUSVPN.</li>
              <li>В приложении импортируй ссылку (Import from clipboard).</li>
              <li>Подключись.</li>
            </ol>
          </div>
          <div class="swCard">
            <h3>Android</h3>
            <ol>
              <li>Установи v2rayNG.</li>
              <li>Скопируй конфиг-ссылку.</li>
              <li>В v2rayNG → “+” → Import from clipboard.</li>
              <li>Подключись.</li>
            </ol>
          </div>
          <div class="swCard">
            <h3>Desktop</h3>
            <ol>
              <li>Windows: v2rayN / Nekoray.</li>
              <li>macOS: V2RayU / Nekoray.</li>
              <li>Импортируй ссылку VLESS.</li>
              <li>Подключись.</li>
            </ol>
          </div>
        </div>
        <div class="swHint">↔ свайп</div>
      </div>
    </div>

  </div>

  <!-- Bottom nav -->
  <div class="nav">
    <div class="navInner">
      <button class="navBtn active" data-go="home">Главная</button>
      <button class="navBtn" data-go="instructions">Инструкции</button>
      <button class="navBtn" data-go="profile">Профиль</button>
    </div>
  </div>

  <!-- Modal: choose plan & pay -->
  <div class="modalWrap" id="modalWrap">
    <div class="modal" role="dialog" aria-modal="true">
      <div class="modalHeader">
        <strong>Получить конфиг</strong>
        <button class="xBtn" id="modalClose" aria-label="Close">✕</button>
      </div>
      <div class="modalBody">
        <div class="selectGroup">
          <div class="label">
            <span>Устройства</span>
            <span class="small muted" id="devicesHint">выбери слот</span>
          </div>
          <div class="row" id="devicesRow">
            <div class="opt active" data-dev="1">1</div>
            <div class="opt" data-dev="3">3</div>
            <div class="opt" data-dev="5">5</div>
            <div class="opt" data-dev="10">10</div>
          </div>
        </div>

        <div class="selectGroup">
          <div class="label">
            <span>Срок</span>
            <span class="small muted" id="daysHint">выбери период</span>
          </div>
          <div class="row" id="daysRow">
            <div class="opt active" data-days="30">30 дней <span class="tag pop" style="margin-left:8px;">Популярно</span></div>
            <div class="opt" data-days="90">90 дней</div>
            <div class="opt" data-days="180">180 дней <span class="tag best" style="margin-left:8px;">Выгоднее</span></div>
          </div>
        </div>

        <div class="choiceCard" id="choiceCard">
          <div class="choiceTop">
            <div>
              <h3 id="choiceTitle">Твой выбор</h3>
              <div class="choiceMeta" id="choiceMeta">—</div>
            </div>
            <div class="price" id="choicePrice">—</div>
          </div>

          <div class="payRow">
            <button class="payBtn primaryPay" id="payStarsBtn">Оплатить Stars</button>
            <button class="payBtn" id="payCryptoBtn">Оплатить USDT</button>
          </div>

          <div class="statusLine" id="payStatus">
            Выбери параметры → нажми оплату. После оплаты конфиг появится автоматически.
          </div>

          <div id="configArea" style="display:none;">
            <div class="codeBox">
              <pre id="configText"></pre>
            </div>
            <button class="copyBtn" id="copyConfigBtn">Скопировать конфиг</button>
          </div>
        </div>

      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

<script>
/** ============================
 *  CONFIG
 *  ============================ */
const API_BASE = "https://api.45.133.251.210.nip.io:8443"; // <-- твой backend через nginx
const DEFAULT_INBOUND_ID = 1;

// Stars prices (в идеале подтягивать с backend, но пока локально)
const PRICE_STARS = { 30:199, 90:399, 180:599 };

/** ============================
 *  TELEGRAM WEBAPP
 *  ============================ */
const TG = window.Telegram && window.Telegram.WebApp ? window.Telegram.WebApp : null;
if (TG) {
  TG.ready();
  try { TG.expand(); } catch(e){}
}

function haptic(type="light") {
  try {
    if (TG && TG.HapticFeedback) TG.HapticFeedback.impactOccurred(type);
  } catch(e){}
}

/** ============================
 *  STATE / STORAGE
 *  ============================ */
function uid(n=8){
  const chars="abcdefghijklmnopqrstuvwxyz0123456789";
  let s="";
  for(let i=0;i<n;i++) s += chars[Math.floor(Math.random()*chars.length)];
  return s;
}

const store = {
  get(key, fallback=null){
    try{
      const v = localStorage.getItem(key);
      return v ? JSON.parse(v) : fallback;
    } catch(e){ return fallback; }
  },
  set(key, val){
    try{ localStorage.setItem(key, JSON.stringify(val)); } catch(e){}
  }
};

let userKey = store.get("zeus_user_key");
if (!userKey) {
  userKey = "user-" + uid(10);
  store.set("zeus_user_key", userKey);
}

let lastActiveUntil = store.get("zeus_active_until", null);
let orderHistory = store.get("zeus_orders", []); // [{id, provider, days, devices, status, ts, active_until}]

/** ============================
 *  UI HELPERS
 *  ============================ */
const $ = (id) => document.getElementById(id);
function toast(msg){
  const t = $("toast");
  t.textContent = msg;
  t.classList.add("show");
  setTimeout(()=>t.classList.remove("show"), 1600);
}

function fmtDate(iso){
  if(!iso) return "—";
  try{
    const d = new Date(iso);
    return d.toLocaleString("ru-RU", { year:"numeric", month:"2-digit", day:"2-digit", hour:"2-digit", minute:"2-digit" });
  }catch(e){ return iso; }
}

/** ============================
 *  SCREEN NAV
 *  ============================ */
const screens = {
  home: $("screen-home"),
  profile: $("screen-profile"),
  instructions: $("screen-instructions"),
};

let current = "home";

function go(to){
  if (to === current) return;
  const fromEl = screens[current];
  const toEl = screens[to];

  fromEl.classList.remove("animIn");
  fromEl.classList.add("animOut");

  setTimeout(()=>{
    fromEl.classList.remove("active","animOut");
    toEl.classList.add("active","animIn");
    current = to;

    document.querySelectorAll(".navBtn").forEach(b=>{
      b.classList.toggle("active", b.dataset.go === to);
    });
  }, 190);
}

document.querySelectorAll(".navBtn").forEach(b=>{
  b.addEventListener("click", ()=>{ haptic("light"); go(b.dataset.go); });
});

/** ============================
 *  API
 *  ============================ */
async function apiGet(path){
  const r = await fetch(API_BASE + path, { method:"GET" });
  if(!r.ok) throw new Error("HTTP "+r.status);
  return await r.json();
}
async function apiPost(path, body){
  const r = await fetch(API_BASE + path, {
    method:"POST",
    headers: { "Content-Type":"application/json" },
    body: JSON.stringify(body||{})
  });
  if(!r.ok) {
    const txt = await r.text().catch(()=> "");
    throw new Error("HTTP "+r.status + (txt?(" "+txt):""));
  }
  return await r.json();
}

async function checkApi(){
  try{
    const j = await apiGet("/health");
    $("apiDot").style.background = "rgba(255,255,255,.55)";
    $("apiText").textContent = j && j.ok ? "API online" : "API";
  }catch(e){
    $("apiDot").style.background = "rgba(255,255,255,.22)";
    $("apiText").textContent = "API offline";
  }
}

/** ============================
 *  PROFILE RENDER
 *  ============================ */
function renderProfile(){
  $("userKeyText").textContent = userKey;
  $("profileActiveUntil").textContent = fmtDate(lastActiveUntil);

  if (!orderHistory.length) {
    $("ordersList").textContent = "— пусто —";
  } else {
    const lines = orderHistory
      .slice().reverse().slice(0,8)
      .map(o=>{
        const when = new Date(o.ts).toLocaleString("ru-RU",{month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"});
        const au = o.active_until ? (" • до " + fmtDate(o.active_until)) : "";
        return `• ${when} • ${o.provider.toUpperCase()} • ${o.days}д • ${o.devices} dev • ${o.status}${au} • id=${o.id}`;
      });
    $("ordersList").textContent = lines.join("\n");
    $("ordersList").classList.add("mono");
  }
}

function renderHome(){
  $("activeUntilText").textContent = fmtDate(lastActiveUntil);
  $("subStatus").textContent = lastActiveUntil ? "активна" : "не активна";
}

$("btnResetId").addEventListener("click", ()=>{
  haptic("medium");
  userKey = "user-" + uid(10);
  store.set("zeus_user_key", userKey);
  toast("Новый ID создан");
  renderProfile();
});

$("btnClearHistory").addEventListener("click", ()=>{
  haptic("light");
  orderHistory = [];
  store.set("zeus_orders", orderHistory);
  toast("История очищена");
  renderProfile();
});

/** ============================
 *  MODAL: PLAN SELECT
 *  ============================ */
let selectedDevices = 1;
let selectedDays = 30;
let currentOrderId = null;
let pollTimer = null;

function calcPriceStars(days){ return PRICE_STARS[days] ?? 0; }

function updateChoiceCard(){
  const price = calcPriceStars(selectedDays);
  $("choiceMeta").textContent = `${selectedDays} дней • ${selectedDevices} устройств • привязка к ID: ${userKey}`;
  $("choicePrice").textContent = price ? `${price} XTR` : "—";
}

function setActiveOpt(rowEl, attr, val){
  rowEl.querySelectorAll(".opt").forEach(o=>{
    o.classList.toggle("active", o.getAttribute(attr) === String(val));
  });
}

$("devicesRow").addEventListener("click", (e)=>{
  const opt = e.target.closest(".opt");
  if(!opt) return;
  haptic("light");
  selectedDevices = parseInt(opt.dataset.dev,10);
  setActiveOpt($("devicesRow"), "data-dev", selectedDevices);
  updateChoiceCard();
});

$("daysRow").addEventListener("click", (e)=>{
  const opt = e.target.closest(".opt");
  if(!opt) return;
  haptic("light");
  selectedDays = parseInt(opt.dataset.days,10);
  setActiveOpt($("daysRow"), "data-days", selectedDays);
  updateChoiceCard();
});

function openModal(){
  $("modalWrap").classList.add("show");
  updateChoiceCard();
  $("payStatus").innerHTML = "Выбери параметры → нажми оплату. После оплаты конфиг появится автоматически.";
  $("configArea").style.display = "none";
  $("configText").textContent = "";
  currentOrderId = null;
  stopPoll();
}

function closeModal(){
  $("modalWrap").classList.remove("show");
  stopPoll();
}

$("btnGetConfig").addEventListener("click", ()=>{
  haptic("medium");
  openModal();
});

$("modalClose").addEventListener("click", ()=>{ haptic("light"); closeModal(); });
$("modalWrap").addEventListener("click", (e)=>{
  if(e.target === $("modalWrap")) closeModal();
});

/** ============================
 *  PAYMENTS + POLL
 *  ============================ */
function saveOrderToHistory(order){
  const item = {
    id: order.id || order.order_id || currentOrderId,
    provider: order.provider || "stars",
    days: order.plan_days || selectedDays,
    devices: order.devices || selectedDevices,
    status: order.status || "pending",
    ts: Date.now(),
    active_until: order.active_until || null
  };
  // avoid duplicates
  orderHistory = orderHistory.filter(x=>x.id !== item.id);
  orderHistory.push(item);
  store.set("zeus_orders", orderHistory);
  renderProfile();
}

function stopPoll(){
  if(pollTimer) clearInterval(pollTimer);
  pollTimer = null;
}

async function pollOrder(orderId){
  stopPoll();
  pollTimer = setInterval(async ()=>{
    try{
      const j = await apiGet(`/pay/order/${orderId}`);
      // update history + subscription
      if (j.active_until) {
        lastActiveUntil = j.active_until;
        store.set("zeus_active_until", lastActiveUntil);
        renderHome();
        renderProfile();
      }
      saveOrderToHistory({ id: j.id, provider:j.provider, plan_days:j.plan_days, devices:j.devices, status:j.status, active_until:j.active_until });

      if (j.status === "paid") {
        haptic("medium");
        $("payStatus").innerHTML = `Оплата подтверждена ✅<br/>Активна до: <b>${fmtDate(j.active_until)}</b><br/>Получаю конфиг…`;
        // выдаём конфиг
        const cfg = await apiPost("/issue-config", {
          inbound_id: DEFAULT_INBOUND_ID,
          user_key: userKey,
          days: selectedDays,
          limit_ip: 0
        });
        $("configText").textContent = cfg.link || "";
        $("configArea").style.display = "block";
        $("payStatus").innerHTML = `Готово ✅<br/>Активна до: <b>${fmtDate(j.active_until)}</b>`;
        stopPoll();
      }
    }catch(e){
      // keep polling quietly
    }
  }, 1200);
}

async function payStars(){
  $("payStatus").textContent = "Создаю инвойс Stars…";
  try{
    const j = await apiPost("/pay/stars/create", {
      user_key: userKey,
      days: selectedDays,
      devices: selectedDevices
    });
    const orderId = j.order_id;
    currentOrderId = orderId;

    $("payStatus").innerHTML = `Инвойс создан. Открой оплату → затем ждём подтверждение…<br/><span class="muted mono">order: ${orderId}</span>`;

    // Save initial order
    saveOrderToHistory({ id: orderId, provider:"stars", plan_days:selectedDays, devices:selectedDevices, status:"pending" });

    // Open invoice:
    const link = j.invoice_link;

    // If inside Telegram Mini App, prefer openInvoice
    if (TG && typeof TG.openInvoice === "function") {
      TG.openInvoice(link, (status)=>{
        // status может быть "paid", "cancelled", "failed", но мы всё равно поллим бекенд
      });
    } else {
      // In browser: open link (оплата произойдёт в Telegram)
      window.open(link, "_blank");
    }

    // start polling
    pollOrder(orderId);

  }catch(e){
    $("payStatus").innerHTML = `Ошибка создания инвойса ❌<br/><span class="muted mono">${String(e.message || e)}</span>`;
  }
}

async function payCrypto(){
  $("payStatus").textContent = "Создаю инвойс USDT…";
  try{
    const j = await apiPost("/pay/crypto/create", {
      user_key: userKey,
      days: selectedDays,
      devices: selectedDevices
    });
    const orderId = j.order_id;
    currentOrderId = orderId;

    $("payStatus").innerHTML = `Инвойс создан. Открой оплату → затем ждём подтверждение…<br/><span class="muted mono">order: ${orderId}</span>`;
    saveOrderToHistory({ id: orderId, provider:"cryptopay", plan_days:selectedDays, devices:selectedDevices, status:"pending" });

    const url = j.invoice_url || j.invoice_link || j.pay_url;
    if (url) window.open(url, "_blank");
    pollOrder(orderId);

  }catch(e){
    $("payStatus").innerHTML = `Ошибка создания инвойса ❌<br/><span class="muted mono">${String(e.message || e)}</span>`;
  }
}

$("payStarsBtn").addEventListener("click", ()=>{ haptic("medium"); payStars(); });
$("payCryptoBtn").addEventListener("click", ()=>{ haptic("medium"); payCrypto(); });

$("copyConfigBtn").addEventListener("click", async ()=>{
  const txt = $("configText").textContent.trim();
  if(!txt) return;
  try{
    await navigator.clipboard.writeText(txt);
    haptic("light");
    toast("Скопировано");
  }catch(e){
    toast("Не удалось скопировать");
  }
});

/** ============================
 *  QUICK CHECK
 *  ============================ */
$("btnQuickCheck").addEventListener("click", async ()=>{
  haptic("light");
  // просто дернем последний заказ, если он есть
  const last = orderHistory.length ? orderHistory[orderHistory.length-1] : null;
  if(!last){
    toast("Нет заказов");
    return;
  }
  try{
    const j = await apiGet(`/pay/order/${last.id}`);
    if (j.active_until) {
      lastActiveUntil = j.active_until;
      store.set("zeus_active_until", lastActiveUntil);
    }
    toast(j.status === "paid" ? "Оплачено" : "Ожидает оплаты");
    renderHome();
    renderProfile();
  }catch(e){
    toast("Не удалось проверить");
  }
});

/** ============================
 *  INIT
 *  ============================ */
renderHome();
renderProfile();
checkApi();
setInterval(checkApi, 12000);
</script>
</body>
</html>
