<!doctype html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>ZEUSVPN</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <style>
    :root{
      --bg:#05070C;
      --bg2:#070B12;

      /* тот самый “темно-сине/черный” как на скрине */
      --glow: rgba(40, 90, 255, .18);
      --glow2: rgba(60, 120, 255, .12);

      --card: rgba(255,255,255,.06);
      --card2: rgba(255,255,255,.085);
      --stroke: rgba(255,255,255,.12);
      --stroke2: rgba(255,255,255,.16);

      --text:#F3F6FF;
      --muted: rgba(243,246,255,.62);

      --blue1:#2C67FF;
      --blue2:#214EE0;

      --ok:#22c55e;
      --warn:#fbbf24;
      --bad:#ef4444;

      --r:18px;
      --shadow: 0 22px 70px rgba(0,0,0,.55);
      --shadow2: 0 18px 60px rgba(0,0,0,.45);
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      color:var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background:
        radial-gradient(900px 520px at 75% -10%, var(--glow), transparent 60%),
        radial-gradient(780px 520px at -20% 10%, var(--glow2), transparent 60%),
        linear-gradient(180deg, var(--bg2), var(--bg));
      overflow-x:hidden;
    }

    .wrap{
      max-width:520px;
      margin:0 auto;
      padding: 16px 14px 22px;
      padding-bottom: calc(22px + 74px + env(safe-area-inset-bottom));
    }

    /* ===== Header pill (как на скрине) ===== */
    .headerPill{
      margin-top: 6px;
      border-radius: 22px;
      border: 1px solid rgba(255,255,255,.10);
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.045));
      box-shadow: var(--shadow2);
      padding: 12px 12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      position:relative;
      overflow:hidden;
    }
    .headerPill:before{
      content:"";
      position:absolute; inset:-1px;
      background:
        radial-gradient(800px 220px at 25% 0%, rgba(45,105,255,.18), transparent 55%),
        radial-gradient(700px 260px at 90% 20%, rgba(255,255,255,.06), transparent 55%);
      opacity:.9;
      pointer-events:none;
    }
    .headerPill > *{position:relative}

    .brand{
      display:flex;
      align-items:center;
      gap:10px;
      min-width:0;
    }
    .bolt{
      width:42px;height:42px;border-radius: 16px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.05);
      display:grid; place-items:center;
      box-shadow: 0 14px 38px rgba(0,0,0,.35);
      flex:0 0 auto;
    }
    .bolt svg{width:18px;height:18px;opacity:.95}
    .btxt{min-width:0}
    .btitle{
      margin:0;
      font-weight:900;
      font-size:14px;
      letter-spacing:.2px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .bsub{
      margin:4px 0 0;
      font-size:12px;
      color:var(--muted);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    .statusChip{
      display:flex;
      align-items:center;
      gap:10px;
      padding:10px 12px;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.24);
      color: rgba(243,246,255,.7);
      font-size:12px;
      flex:0 0 auto;
      user-select:none;
    }
    .dot{
      width:10px;height:10px;border-radius: 99px;
      background: rgba(255,255,255,.18);
      border:1px solid rgba(255,255,255,.20);
    }
    .dot.ok{background:rgba(34,197,94,.85);border-color:rgba(34,197,94,.9)}
    .dot.warn{background:rgba(251,191,36,.85);border-color:rgba(251,191,36,.9)}
    .dot.bad{background:rgba(239,68,68,.85);border-color:rgba(239,68,68,.9)}

    /* ===== Main card (как на скрине) ===== */
    .card{
      margin-top: 12px;
      border-radius: 22px;
      border:1px solid rgba(255,255,255,.10);
      background: linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.045));
      box-shadow: var(--shadow);
      overflow:hidden;
      position:relative;
    }
    .card:before{
      content:"";
      position:absolute; inset:0;
      background:
        radial-gradient(800px 220px at 18% 0%, rgba(45,105,255,.16), transparent 55%),
        radial-gradient(700px 260px at 90% 15%, rgba(255,255,255,.06), transparent 55%);
      pointer-events:none;
      opacity:.95;
    }
    .card > *{position:relative}

    .cardBody{
      padding: 16px 16px 16px;
    }

    .h1{
      margin:0;
      font-size: 28px;
      font-weight: 950;
      letter-spacing: -.2px;
    }
    .lead{
      margin:10px 0 0;
      color: rgba(243,246,255,.62);
      font-size:14px;
      line-height:1.35;
    }

    .stats{
      margin-top: 14px;
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 12px;
    }
    .stat{
      border-radius: 18px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.20);
      padding: 12px 12px;
      min-height: 68px;
    }
    .stat .k{
      margin:0;
      font-size:14px;
      font-weight: 900;
      letter-spacing:.2px;
      color: rgba(243,246,255,.92);
    }
    .stat .v{
      margin:8px 0 0;
      font-size:14px;
      color: rgba(243,246,255,.58);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    .section{
      margin-top: 14px;
      border-radius: 22px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      overflow:hidden;
    }
    .secHead{
      padding: 12px 14px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:12px;
      border-bottom: 1px solid rgba(255,255,255,.08);
    }
    .secTitle{
      margin:0;
      font-weight: 950;
      font-size: 16px;
      letter-spacing:.18px;
      text-transform: uppercase;
      opacity:.9;
    }
    .secRight{
      margin:0;
      font-size:12px;
      color: rgba(243,246,255,.55);
    }
    .secBody{
      padding: 14px;
    }

    .label{
      margin:0 0 8px;
      font-size:12px;
      color: rgba(243,246,255,.58);
      font-weight: 850;
      letter-spacing:.2px;
    }

    .input{
      width:100%;
      border-radius: 16px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.05);
      padding: 14px 14px;
      color: rgba(243,246,255,.9);
      font-size:14px;
      outline:none;
    }

    .hint{
      margin: 10px 0 0;
      font-size:12px;
      color: rgba(243,246,255,.50);
    }

    .primaryBtn{
      width:100%;
      margin-top: 14px;
      border:0;
      border-radius: 18px;
      padding: 14px 14px;
      font-size: 16px;
      font-weight: 950;
      letter-spacing:.2px;
      color:#fff;
      background: linear-gradient(180deg, var(--blue1), var(--blue2));
      box-shadow: 0 18px 50px rgba(33, 78, 224, .28);
      cursor:pointer;
      transition: transform .12s ease;
      -webkit-tap-highlight-color: transparent;
    }
    .primaryBtn:active{transform: scale(.985)}

    /* ===== Config shown after paid ===== */
    .configBox{
      margin-top: 12px;
      display:none;
    }
    .configBox.show{display:block}
    .ta{
      width:100%;
      min-height: 96px;
      border-radius: 16px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      color: rgba(243,246,255,.92);
      padding: 12px 12px;
      font-size:12px;
      line-height:1.45;
      outline:none;
      resize:none;
    }
    .rowBtns{
      display:flex;
      gap:10px;
      margin-top: 10px;
    }
    .ghostBtn{
      flex:1;
      border-radius: 18px;
      padding: 12px 12px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      color: rgba(243,246,255,.88);
      font-weight: 900;
      cursor:pointer;
      transition: transform .12s ease;
      -webkit-tap-highlight-color: transparent;
    }
    .ghostBtn:active{transform: scale(.985)}

    /* ===== Bottom nav (как на скрине) ===== */
    .navWrap{
      position:fixed;
      left:0; right:0;
      bottom: 14px;
      padding: 0 14px;
      padding-bottom: calc(0px + env(safe-area-inset-bottom));
      z-index: 20;
    }
    .nav{
      max-width:520px;
      margin: 0 auto;
      border-radius: 18px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.28);
      backdrop-filter: blur(18px);
      display:flex;
      overflow:hidden;
    }
    .tab{
      flex:1;
      text-align:center;
      padding: 12px 10px;
      font-weight: 950;
      font-size: 13px;
      color: rgba(243,246,255,.55);
      cursor:pointer;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
    }
    .tab.active{
      color: rgba(243,246,255,.92);
      background: rgba(45,105,255,.12);
      border-right:1px solid rgba(255,255,255,.06);
      border-left:1px solid rgba(255,255,255,.06);
    }

    .screen{display:none}
    .screen.show{display:block}

    /* ===== Instructions swipe ===== */
    .swipe{
      display:flex;
      gap:12px;
      overflow:auto;
      scroll-snap-type: x mandatory;
      -webkit-overflow-scrolling: touch;
      padding-bottom: 8px;
    }
    .swipe::-webkit-scrollbar{display:none}
    .instCard{
      flex: 0 0 86%;
      scroll-snap-align: start;
      border-radius: 18px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.22);
      padding: 14px;
      min-height: 150px;
    }
    .instCard h3{margin:0;font-size:14px;font-weight:950}
    .instCard p{margin:10px 0 0;font-size:13px;color:rgba(243,246,255,.65);line-height:1.45}
    .dots{display:flex;justify-content:center;gap:8px;margin-top: 8px}
    .dots span{width:6px;height:6px;border-radius:99px;background:rgba(255,255,255,.18);border:1px solid rgba(255,255,255,.18)}
    .dots span.on{background:rgba(255,255,255,.65);border-color:rgba(255,255,255,.55)}

    /* ===== Modal (НЕ прозрачная, фикс. высота, не режет текст) ===== */
    .modal{
      position:fixed; inset:0;
      display:none;
      align-items:flex-end;
      justify-content:center;
      padding: 14px 14px;
      padding-bottom: calc(14px + env(safe-area-inset-bottom));
      background: rgba(0,0,0,.62);
      z-index: 50;
    }
    .modal.show{display:flex}
    .sheet{
      width:100%;
      max-width:520px;
      height: min(78vh, 580px);
      border-radius: 22px;
      border:1px solid rgba(255,255,255,.12);
      background: linear-gradient(180deg, rgba(10,14,22,.96), rgba(6,8,12,.98));
      box-shadow: 0 28px 90px rgba(0,0,0,.75);
      overflow:hidden;
      display:flex;
      flex-direction:column;
    }
    .sheetHead{
      padding: 12px 14px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      border-bottom:1px solid rgba(255,255,255,.08);
      flex:0 0 auto;
    }
    .sheetTitle{margin:0;font-weight:950;font-size:14px}
    .xbtn{
      width:38px;height:38px;border-radius: 14px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      color:rgba(243,246,255,.9);
      display:grid;place-items:center;
      cursor:pointer;
    }
    .sheetBody{
      padding: 12px 14px 14px;
      overflow:auto;
      flex:1 1 auto;
    }
    .row{
      display:flex;justify-content:space-between;align-items:flex-end;gap:12px;
      margin-bottom:10px;
    }
    .row h4{margin:0;font-size:12px;color:rgba(243,246,255,.62);font-weight:950}
    .chips{display:flex;flex-wrap:wrap;gap:10px;margin-top:10px}
    .chipBtn{
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.05);
      color: rgba(243,246,255,.86);
      padding: 10px 12px;
      border-radius: 999px;
      font-size:13px;
      font-weight: 950;
      cursor:pointer;
      transition: transform .12s ease;
      -webkit-tap-highlight-color: transparent;
      position:relative;
      white-space:nowrap;
      user-select:none;
    }
    .chipBtn:active{transform: scale(.985)}
    .chipBtn.selected{
      background: rgba(45,105,255,.14);
      border-color: rgba(255,255,255,.18);
      color: rgba(243,246,255,.96);
    }
    .badge{
      position:absolute;
      top:-8px; right:-6px;
      font-size:10px;
      padding:4px 7px;
      border-radius: 999px;
      background: rgba(255,255,255,.12);
      border:1px solid rgba(255,255,255,.16);
      color: rgba(243,246,255,.9);
      backdrop-filter: blur(10px);
    }

    .choiceCard{
      margin-top: 12px;
      border-radius: 18px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      padding: 14px;
    }
    .choiceTop{display:flex;align-items:center;justify-content:space-between;gap:10px}
    .choiceName{margin:0;font-weight:950;font-size:14px}
    .choicePrice{margin:0;font-weight:950;font-size:14px}
    .choiceDesc{margin:8px 0 0;font-size:12px;color:rgba(243,246,255,.62);line-height:1.35}

    .payGrid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:12px}
    .payBtn{
      border-radius: 16px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      padding: 13px 12px;
      text-align:left;
      cursor:pointer;
      transition: transform .12s ease;
      -webkit-tap-highlight-color: transparent;
    }
    .payBtn:active{transform: scale(.985)}
    .payBtn strong{display:block;font-size:13px;font-weight:950}
    .payBtn span{display:block;font-size:12px;color:rgba(243,246,255,.58);margin-top:4px}
    .payBtn.primary{
      background: linear-gradient(180deg, rgba(44,103,255,.35), rgba(33,78,224,.35));
      border-color: rgba(255,255,255,.14);
    }

    .statusLine{
      margin-top: 12px;
      font-size:12px;
      color: rgba(243,246,255,.62);
      display:flex;
      justify-content:space-between;
      gap:10px;
      align-items:center;
    }
    .spin{
      width:14px;height:14px;border-radius:50%;
      border:2px solid rgba(255,255,255,.18);
      border-top-color: rgba(255,255,255,.75);
      animation: rot .85s linear infinite;
      display:none;
    }
    .spin.show{display:inline-block}
    @keyframes rot{to{transform:rotate(360deg)}}

    .errBox{
      margin-top: 12px;
      border-radius: 14px;
      border:1px solid rgba(239,68,68,.25);
      background: rgba(239,68,68,.08);
      padding: 10px 10px;
      color: rgba(255,210,210,.92);
      font-size:12px;
      line-height:1.35;
      display:none;
      white-space:pre-wrap;
      word-break:break-word;
    }
    .errBox.show{display:block}
    .errTitle{font-weight:950;margin-bottom:6px;color:rgba(255,220,220,.96)}

    .toast{
      position:fixed;
      left:50%;
      bottom: 88px;
      transform: translateX(-50%);
      background: rgba(0,0,0,.72);
      color: rgba(243,246,255,.92);
      border:1px solid rgba(255,255,255,.12);
      padding: 10px 12px;
      border-radius: 999px;
      box-shadow: 0 18px 60px rgba(0,0,0,.55);
      display:none;
      z-index: 99;
      max-width: 92vw;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      font-size:12px;
    }
    .toast.show{display:block}

    .logoRow{
      display:flex; align-items:center; gap:10px;
      margin-top: 10px;
    }
    .logoBox{
      width:44px;height:44px;border-radius:16px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.05);
      overflow:hidden;
      box-shadow: 0 14px 38px rgba(0,0,0,.35);
      flex:0 0 auto;
    }
    .logoBox img{width:100%;height:100%;object-fit:cover}
  </style>
</head>

<body>
  <div class="wrap">

    <!-- Header pill -->
    <div class="headerPill">
      <div class="brand">
        <div class="bolt" aria-hidden="true">
          <svg viewBox="0 0 24 24" fill="none">
            <path d="M13 2L3 14h8l-1 8 11-14h-8l0-6z" fill="rgba(243,246,255,.92)"/>
          </svg>
        </div>
        <div class="btxt">
          <p class="btitle">ZEUSVPN</p>
          <p class="bsub">Minimal • Dark • Fast</p>
        </div>
      </div>

      <div class="statusChip">
        <span class="dot warn" id="apiDot"></span>
        <span id="apiText">offline</span>
      </div>
    </div>

    <!-- Screens -->
    <div class="screen show" id="home">
      <div class="card">
        <div class="cardBody">
          <h1 class="h1">Премиум без лишнего.</h1>
          <p class="lead" id="leadText">
            Нажми “Получить конфиг” → выбери тариф → оплата → конфиг + Copy.
          </p>

          <div class="stats">
            <div class="stat">
              <p class="k">Подписка</p>
              <p class="v" id="subText">не оплачено</p>
            </div>
            <div class="stat">
              <p class="k">Устройства</p>
              <p class="v" id="devText">—</p>
            </div>
            <div class="stat">
              <p class="k">API</p>
              <p class="v" id="apiMini">offline</p>
            </div>
          </div>

          <div class="section">
            <div class="secHead">
              <p class="secTitle">КОНФИГ</p>
              <p class="secRight">после оплаты</p>
            </div>
            <div class="secBody">
              <p class="label">ID пользователя (позже Telegram ID)</p>
              <input class="input" id="userIdInput" value="" />
              <p class="hint">Если пусто — создадим автоматически.</p>

              <button class="primaryBtn" id="btnGetConfig">Получить конфиг</button>

              <div class="configBox" id="configBox">
                <p class="label" style="margin-top:12px">Ваш конфиг</p>
                <textarea class="ta" id="configText" readonly></textarea>
                <div class="rowBtns">
                  <button class="ghostBtn" id="btnCopy">Copy</button>
                  <button class="ghostBtn" id="btnHide">Скрыть</button>
                </div>
              </div>

            </div>
          </div>

          <!-- Logo small (optional, based on your logo) -->
          <div class="logoRow">
            <div class="logoBox"><img id="logoImg" alt="logo"></div>
            <div style="min-width:0">
              <div style="font-weight:950;letter-spacing:.2px">ZEUSVPN</div>
              <div style="color:rgba(243,246,255,.55);font-size:12px">Профиль берём из Telegram</div>
            </div>
          </div>

        </div>
      </div>
    </div>

    <div class="screen" id="instructions">
      <div class="card">
        <div class="cardBody">
          <h1 class="h1" style="font-size:22px">Инструкции</h1>
          <p class="lead">Свайпни карточки →</p>

          <div class="swipe" id="swipe">
            <div class="instCard">
              <h3>iOS (V2Box / Streisand)</h3>
              <p>
                1) Установи клиент из App Store.<br>
                2) Нажми “Add / Import”.<br>
                3) Вставь VLESS-ссылку из ZEUSVPN.<br>
                4) Сохрани и включи.
              </p>
            </div>
            <div class="instCard">
              <h3>Android (v2rayNG)</h3>
              <p>
                1) Установи v2rayNG.<br>
                2) Нажми “+” → Import from clipboard.<br>
                3) Вставь ссылку → включи.
              </p>
            </div>
            <div class="instCard">
              <h3>Desktop (Windows/macOS)</h3>
              <p>
                1) Установи Nekoray / v2rayN.<br>
                2) Импортируй ссылку VLESS.<br>
                3) Выбери профиль и включи.
              </p>
            </div>
          </div>

          <div class="dots" id="dots"><span class="on"></span><span></span><span></span></div>
        </div>
      </div>
    </div>

    <div class="screen" id="profile">
      <div class="card">
        <div class="cardBody">
          <h1 class="h1" style="font-size:22px">Профиль</h1>
          <p class="lead" id="pLine">—</p>
          <div class="section" style="margin-top:12px">
            <div class="secHead">
              <p class="secTitle">Данные</p>
              <p class="secRight">Telegram</p>
            </div>
            <div class="secBody">
              <p class="label">Telegram ID</p>
              <input class="input" id="tgId" readonly>
              <p class="label" style="margin-top:10px">Username</p>
              <input class="input" id="tgUser" readonly>
            </div>
          </div>
        </div>
      </div>
    </div>

  </div>

  <!-- Bottom nav -->
  <div class="navWrap">
    <div class="nav">
      <div class="tab active" data-tab="home">Главная</div>
      <div class="tab" data-tab="instructions">Инструкции</div>
      <div class="tab" data-tab="profile">Профиль</div>
    </div>
  </div>

  <!-- Modal тарифы -->
  <div class="modal" id="modal">
    <div class="sheet">
      <div class="sheetHead">
        <p class="sheetTitle">Выбор тарифа</p>
        <div class="xbtn" id="closeModal">✕</div>
      </div>
      <div class="sheetBody">

        <div class="row">
          <h4>Устройства</h4>
          <div style="font-size:12px;color:rgba(243,246,255,.5)">слоты</div>
        </div>
        <div class="chips" id="devChips">
          <div class="chipBtn selected" data-dev="1">1</div>
          <div class="chipBtn" data-dev="3">3</div>
          <div class="chipBtn" data-dev="5">5</div>
          <div class="chipBtn" data-dev="10">10</div>
        </div>

        <div style="height:10px"></div>

        <div class="row">
          <h4>Срок</h4>
          <div style="font-size:12px;color:rgba(243,246,255,.5)">дней</div>
        </div>
        <div class="chips" id="dayChips">
          <div class="chipBtn selected" data-days="30">30 <span class="badge">Популярно</span></div>
          <div class="chipBtn" data-days="90">90</div>
          <div class="chipBtn" data-days="180">180 <span class="badge">Выгоднее</span></div>
        </div>

        <div class="choiceCard">
          <div class="choiceTop">
            <p class="choiceName" id="choiceName">30 дней • 1 устройство</p>
            <p class="choicePrice" id="choicePrice">199 XTR</p>
          </div>
          <p class="choiceDesc">
            После оплаты статус обновится, затем можно получить конфиг.
          </p>
        </div>

        <div class="payGrid">
          <button class="payBtn primary" id="payStars">
            <strong>Оплатить Stars</strong>
            <span>в Telegram</span>
          </button>
          <button class="payBtn" id="payUSDT">
            <strong>Оплатить USDT</strong>
            <span>[Crypto Bot](chatgpt://generic-entity?number=1)</span>
          </button>
        </div>

        <div class="statusLine">
          <div style="display:flex;gap:10px;align-items:center;min-width:0">
            <span class="spin" id="spin"></span>
            <span id="statusText">Выбери параметры и способ оплаты</span>
          </div>
          <span style="font-size:12px;color:rgba(243,246,255,.5)" id="orderHint"></span>
        </div>

        <div class="errBox" id="errBox">
          <div class="errTitle">Ошибка запроса</div>
          <div id="errText"></div>
        </div>

      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script>
    // ==== НАСТРОЙКИ ====
    const API_BASE = "https://api.45.133.251.210.nip.io:8443"; // твой API
    const LOGO_URL = "./logo.png"; // положи logo.png рядом с index.html
    const DEFAULT_INBOUND_ID = 1;

    // ==== STATE ====
    const S = {
      tg: { id:null, username:"", name:"", photo:null },
      user_key: "zeus-guest",
      devices: 1,
      days: 30,
      order_id: null,
      poll: null,
      paid: false
    };

    // ==== DOM short ====
    const $ = (id)=>document.getElementById(id);

    const apiDot = $("apiDot"), apiText = $("apiText"), apiMini = $("apiMini");
    const subText = $("subText"), devText = $("devText");
    const userIdInput = $("userIdInput");

    const configBox = $("configBox"), configText = $("configText");
    const toast = $("toast");

    const modal = $("modal"), closeModal = $("closeModal");
    const devChips = $("devChips"), dayChips = $("dayChips");
    const choiceName = $("choiceName"), choicePrice = $("choicePrice");
    const payStars = $("payStars"), payUSDT = $("payUSDT");
    const spin = $("spin"), statusText = $("statusText"), orderHint = $("orderHint");

    const errBox = $("errBox"), errText = $("errText");

    // logo
    $("logoImg").src = LOGO_URL;

    // ==== UX helpers ====
    function showToast(msg){
      toast.textContent = msg;
      toast.classList.add("show");
      setTimeout(()=>toast.classList.remove("show"), 2200);
    }

    function haptic(type="light"){
      try{
        const t = window.Telegram?.WebApp;
        if(!t?.HapticFeedback) return;
        if(type==="light") t.HapticFeedback.impactOccurred("light");
        if(type==="success") t.HapticFeedback.notificationOccurred("success");
        if(type==="error") t.HapticFeedback.notificationOccurred("error");
      }catch(e){}
    }

    function priceFor(days){
      if(days==30) return 199;
      if(days==90) return 399;
      if(days==180) return 599;
      return 0;
    }

    function clearError(){
      errBox.classList.remove("show");
      errText.textContent = "";
    }
    function showError(err, url){
      errBox.classList.add("show");
      const msg = err?.message ? err.message : String(err);
      errText.textContent =
        `URL: ${url}\n` +
        `Ошибка: ${msg}\n\n` +
        `Если тут "Load failed/Failed to fetch" — это SSL на API:8443.`;
    }

    async function apiGet(path){
      const url = API_BASE + path;
      const r = await fetch(url, { method:"GET", mode:"cors" });
      if(!r.ok){
        const t = await r.text().catch(()=> "");
        throw new Error(`HTTP ${r.status}: ${t}`);
      }
      return r.json();
    }

    async function apiPost(path, body){
      const url = API_BASE + path;
      const r = await fetch(url, {
        method:"POST",
        mode:"cors",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify(body)
      });
      if(!r.ok){
        const t = await r.text().catch(()=> "");
        throw new Error(`HTTP ${r.status}: ${t}`);
      }
      return r.json();
    }

    async function health(){
      try{
        await apiGet("/health");
        apiDot.className = "dot ok";
        apiText.textContent = "online";
        apiMini.textContent = "online";
      }catch(e){
        apiDot.className = "dot bad";
        apiText.textContent = "offline";
        apiMini.textContent = "offline";
      }
    }

    function updateChoice(){
      [...devChips.querySelectorAll(".chipBtn")].forEach(b=>{
        b.classList.toggle("selected", Number(b.dataset.dev)===S.devices);
      });
      [...dayChips.querySelectorAll(".chipBtn")].forEach(b=>{
        b.classList.toggle("selected", Number(b.dataset.days)===S.days);
      });
      choiceName.textContent = `${S.days} дней • ${S.devices} устройство${S.devices===1?"":"(а)"}`;
      const p = priceFor(S.days);
      choicePrice.textContent = p ? `${p} XTR` : "—";
    }

    function openModal(){
      clearError();
      modal.classList.add("show");
      document.body.style.overflow = "hidden";
      updateChoice();
    }
    function hideModal(){
      modal.classList.remove("show");
      document.body.style.overflow = "";
      spin.classList.remove("show");
      statusText.textContent = "Выбери параметры и способ оплаты";
      orderHint.textContent = "";
      clearInterval(S.poll);
      clearError();
    }

    function bindSwipeDots(){
      const swipe = $("swipe");
      const dots = [...$("dots").children];
      function update(){
        const cards = swipe.children;
        let best = 0, bestDist = Infinity;
        for(let i=0;i<cards.length;i++){
          const rect = cards[i].getBoundingClientRect();
          const dist = Math.abs(rect.left - 14);
          if(dist < bestDist){ bestDist = dist; best = i; }
        }
        dots.forEach((d,i)=>d.classList.toggle("on", i===best));
      }
      swipe.addEventListener("scroll", ()=>requestAnimationFrame(update), {passive:true});
      update();
    }

    function navTo(id){
      document.querySelectorAll(".screen").forEach(s=>s.classList.remove("show"));
      $(id).classList.add("show");
      document.querySelectorAll(".tab").forEach(t=>{
        t.classList.toggle("active", t.dataset.tab===id);
      });
      haptic("light");
    }

    // ==== Telegram user ====
    function loadTG(){
      const tg = window.Telegram?.WebApp;
      try{ tg?.ready(); tg?.expand(); }catch(e){}
      const u = tg?.initDataUnsafe?.user;

      if(u){
        S.tg.id = u.id;
        S.tg.username = u.username ? "@"+u.username : "";
        S.tg.name = [u.first_name, u.last_name].filter(Boolean).join(" ").trim() || "Пользователь";
        S.user_key = String(u.id);
      }else{
        // browser
        S.tg.name = "Гость (browser)";
        S.user_key = "zeus-guest";
      }

      // Home input default
      userIdInput.value = S.user_key;

      // Profile fill
      $("pLine").textContent = `${S.tg.name}${S.tg.username ? " • "+S.tg.username : ""}`;
      $("tgId").value = S.tg.id ?? "—";
      $("tgUser").value = S.tg.username || "—";
    }

    // ==== Payment ====
    function openInvoice(url){
      if(window.Telegram?.WebApp?.openInvoice){
        return new Promise((resolve)=>{
          window.Telegram.WebApp.openInvoice(url, (status)=> resolve(status));
        });
      }
      // browser fallback
      window.open(url, "_blank");
      return Promise.resolve("opened");
    }

    function startPoll(order_id){
      clearInterval(S.poll);
      S.poll = setInterval(async ()=>{
        try{
          const o = await apiGet(`/pay/order/${order_id}`);
          if(o.status==="paid" || o.status==="active"){
            clearInterval(S.poll);
            spin.classList.remove("show");
            statusText.textContent = "Оплата подтверждена ✅";
            haptic("success");

            // UI on home
            subText.textContent = o.active_until ? `активна до ${o.active_until}` : "оплачено";
            devText.textContent = String(o.devices ?? S.devices);

            // сразу выдаем конфиг после оплаты
            try{
              const issue = await apiPost("/issue-config", {
                inbound_id: DEFAULT_INBOUND_ID,
                user_key: userIdInput.value || S.user_key,
                days: S.days,
                limit_ip: 0
              });
              configText.value = issue.link || "";
              configBox.classList.add("show");
              showToast("Конфиг готов");
              hideModal();
            }catch(e2){
              showToast("Оплата ок, но конфиг не выдался");
            }
          }else{
            statusText.textContent = `Ожидаю оплату… (${o.status})`;
          }
        }catch(e){
          // тихо
        }
      }, 1200);
    }

    // ==== Actions ====
    $("btnGetConfig").addEventListener("click", ()=>{
      // логика как в твоем тексте: нажал → тарифы → оплата → конфиг
      openModal();
    });

    $("btnCopy").addEventListener("click", async ()=>{
      try{
        await navigator.clipboard.writeText(configText.value || "");
        showToast("Скопировано");
        haptic("success");
      }catch(e){
        showToast("Не удалось скопировать");
        haptic("error");
      }
    });
    $("btnHide").addEventListener("click", ()=>configBox.classList.remove("show"));

    closeModal.addEventListener("click", hideModal);
    modal.addEventListener("click", (e)=>{ if(e.target===modal) hideModal(); });

    devChips.addEventListener("click",(e)=>{
      const b = e.target.closest(".chipBtn"); if(!b) return;
      S.devices = Number(b.dataset.dev);
      updateChoice(); haptic("light");
    });
    dayChips.addEventListener("click",(e)=>{
      const b = e.target.closest(".chipBtn"); if(!b) return;
      S.days = Number(b.dataset.days);
      updateChoice(); haptic("light");
    });

    payStars.addEventListener("click", async ()=>{
      clearError();
      spin.classList.add("show");
      statusText.textContent = "Создаю заказ (Stars)…";
      orderHint.textContent = "";

      const url = API_BASE + "/pay/stars/create";
      try{
        const res = await apiPost("/pay/stars/create", {
          user_key: userIdInput.value || S.user_key,
          days: S.days,
          devices: S.devices
        });
        orderHint.textContent = `#${res.order_id}`;
        statusText.textContent = "Открываю оплату…";

        await openInvoice(res.invoice_link);

        statusText.textContent = "Ожидаю оплату…";
        startPoll(res.order_id);
      }catch(err){
        spin.classList.remove("show");
        statusText.textContent = "Не удалось создать заказ";
        showError(err, url);
        haptic("error");
      }
    });

    payUSDT.addEventListener("click", async ()=>{
      clearError();
      spin.classList.add("show");
      statusText.textContent = "Создаю инвойс (USDT)…";
      orderHint.textContent = "";

      const url = API_BASE + "/pay/crypto/create";
      try{
        const res = await apiPost("/pay/crypto/create", {
          user_key: userIdInput.value || S.user_key,
          days: S.days,
          devices: S.devices
        });

        orderHint.textContent = `#${res.order_id}`;
        statusText.textContent = "Открываю оплату…";

        const invUrl = res.invoice_url || res.invoice_link || res.url;
        if(!invUrl) throw new Error("invoice_url missing");

        window.open(invUrl, "_blank");

        statusText.textContent = "Ожидаю оплату…";
        startPoll(res.order_id);
      }catch(err){
        spin.classList.remove("show");
        statusText.textContent = "Не удалось создать инвойс";
        showError(err, url);
        haptic("error");
      }
    });

    // bottom nav
    document.querySelectorAll(".tab").forEach(t=>{
      t.addEventListener("click", ()=>navTo(t.dataset.tab));
    });

    // init
    loadTG();
    bindSwipeDots();
    updateChoice();
    health();
    setInterval(health, 8000);
  </script>
</body>
</html>
