<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>ZEUSVPN</title>

  <style>
    :root{
      --bg:#07090d;
      --card:#0b0f16;
      --card2:#0d121b;
      --line:rgba(255,255,255,.08);
      --text:rgba(255,255,255,.92);
      --muted:rgba(255,255,255,.62);
      --muted2:rgba(255,255,255,.42);
      --blue1:#0f2a57;
      --blue2:#1a4fb8;
      --blue3:#2a6cff;
      --danger:#ff4d4d;
      --ok:#2ecc71;
      --shadow: 0 18px 60px rgba(0,0,0,.55);
      --r:22px;
      --r2:16px;
      --tap: 0.98;
      --ease: cubic-bezier(.2,.8,.2,1);
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background:
        radial-gradient(1200px 700px at 50% -10%, rgba(42,108,255,.22), transparent 55%),
        radial-gradient(700px 700px at 15% 10%, rgba(26,79,184,.14), transparent 55%),
        radial-gradient(900px 700px at 90% 15%, rgba(15,42,87,.20), transparent 60%),
        var(--bg);
      color:var(--text);
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      overflow-x:hidden;
    }

    /* Safe-area helpers */
    .safeTop{ padding-top: max(10px, env(safe-area-inset-top)); }
    .safeBottom{ padding-bottom: max(10px, env(safe-area-inset-bottom)); }

    .wrap{
      max-width:520px;
      margin:0 auto;
      padding: 14px 14px calc(98px + env(safe-area-inset-bottom));
    }

    /* Top bar */
    .top{
      display:flex;
      gap:12px;
      align-items:center;
      justify-content:space-between;
      margin-top: 8px;
      padding: 12px 12px;
      border:1px solid var(--line);
      border-radius: 24px;
      background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      box-shadow: 0 8px 30px rgba(0,0,0,.35);
      backdrop-filter: blur(10px);
    }
    .brand{
      display:flex;
      gap:10px;
      align-items:center;
      min-width:0;
    }
    .bolt{
      width:34px;height:34px;
      border-radius: 12px;
      display:grid;place-items:center;
      background: radial-gradient(80% 80% at 30% 25%, rgba(42,108,255,.35), rgba(0,0,0,0)),
                  linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      border:1px solid rgba(255,255,255,.10);
    }
    .bolt svg{opacity:.9}
    .btxt{min-width:0}
    .bname{
      font-weight:800;
      letter-spacing:.6px;
      font-size: 14px;
      line-height: 1.05;
      text-transform: uppercase;
    }
    .bsub{
      margin-top:3px;
      font-size: 12px;
      color: var(--muted2);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .statusPill{
      display:flex;
      align-items:center;
      gap:8px;
      padding:8px 10px;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.25);
      color: var(--muted);
      font-size: 12px;
      flex-shrink:0;
    }
    .dot{
      width:8px;height:8px;border-radius:99px;
      background: var(--danger);
      box-shadow: 0 0 0 4px rgba(255,77,77,.16);
    }
    .dot.ok{
      background: var(--ok);
      box-shadow: 0 0 0 4px rgba(46,204,113,.14);
    }

    /* Cards */
    .card{
      margin-top: 14px;
      border-radius: var(--r);
      border: 1px solid var(--line);
      background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .cardInner{ padding: 16px; }

    h1{
      margin:0;
      font-size: 26px;
      line-height:1.08;
      letter-spacing: -.2px;
    }
    .lead{
      margin-top:10px;
      color: var(--muted);
      font-size: 14px;
      line-height: 1.45;
    }

    .miniRow{
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap:10px;
      margin-top: 14px;
    }
    .mini{
      padding: 12px;
      border-radius: 16px;
      border:1px solid rgba(255,255,255,.09);
      background: rgba(0,0,0,.22);
      min-height: 70px;
    }
    .mini .t{ color: var(--muted2); font-size: 12px; letter-spacing:.2px; }
    .mini .v{ margin-top:6px; font-weight:750; font-size: 14px; }

    .sectionTitle{
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      padding: 14px 16px;
      border-bottom: 1px solid rgba(255,255,255,.06);
      background: rgba(0,0,0,.18);
    }
    .sectionTitle .left{
      font-weight: 800;
      letter-spacing: .8px;
      text-transform: uppercase;
      font-size: 13px;
      color: rgba(255,255,255,.78);
    }
    .sectionTitle .right{
      font-size: 12px;
      color: var(--muted2);
    }

    .fieldLabel{
      font-size: 12px;
      color: var(--muted2);
      margin: 10px 0 8px;
    }
    .input{
      width:100%;
      padding: 14px 14px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.28);
      color: rgba(255,255,255,.92);
      font-size: 14px;
      outline:none;
    }
    .hint{
      margin-top:8px;
      color: var(--muted2);
      font-size: 12px;
      line-height:1.35;
    }

    .btn{
      width:100%;
      margin-top: 14px;
      padding: 14px 16px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.10);
      background: linear-gradient(180deg, rgba(42,108,255,.95), rgba(26,79,184,.85));
      color: white;
      font-weight: 850;
      font-size: 15px;
      letter-spacing:.2px;
      box-shadow: 0 14px 40px rgba(42,108,255,.24);
      cursor:pointer;
      user-select:none;
      transition: transform .12s var(--ease), filter .12s var(--ease);
    }
    .btn:active{ transform: scale(var(--tap)); }
    .btn.secondary{
      background: rgba(255,255,255,.05);
      box-shadow:none;
      color: rgba(255,255,255,.86);
    }
    .btn.disabled{
      opacity:.55;
      pointer-events:none;
      filter: grayscale(20%);
    }

    .copyRow{
      display:flex;
      gap:10px;
      align-items:center;
      margin-top: 10px;
    }
    .copyRow .btn{ margin-top:0; }
    .copyRow .btn{ padding: 12px 12px; font-size: 14px; }
    .copyRow .btn.secondary{ flex: 0 0 42%; }
    .copyRow .btn.primary{ flex: 1; }

    /* Screens without absolute (no cutting) */
    .screens{ margin-top: 14px; }
    .screen{ display:none; opacity:0; transform: translateY(10px); }
    .screen.active{ display:block; animation: fadeSlide 260ms ease both; }
    @keyframes fadeSlide{ from{opacity:0;transform:translateY(10px)} to{opacity:1;transform:translateY(0)} }

    /* Bottom nav (safe area) */
    .bottomNav{
      position: fixed;
      left:0; right:0; bottom:0;
      padding: 10px 14px calc(10px + env(safe-area-inset-bottom));
      background: linear-gradient(180deg, rgba(7,9,13,0), rgba(7,9,13,.82) 22%, rgba(7,9,13,.95));
      backdrop-filter: blur(10px);
    }
    .navBar{
      max-width:520px;
      margin:0 auto;
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap:10px;
      border-radius: 18px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.28);
      padding: 10px;
    }
    .navBtn{
      padding: 12px 10px;
      border-radius: 14px;
      border:1px solid transparent;
      background: transparent;
      color: rgba(255,255,255,.70);
      font-weight: 800;
      font-size: 13px;
      cursor:pointer;
      transition: background .18s var(--ease), transform .12s var(--ease);
    }
    .navBtn:active{ transform: scale(.98); }
    .navBtn.active{
      background: rgba(42,108,255,.16);
      border-color: rgba(42,108,255,.26);
      color: rgba(255,255,255,.92);
    }

    /* Modal sheet (fixed, readable, scrollable) */
    .overlay{
      position:fixed; inset:0;
      display:none;
      background: rgba(0,0,0,.58);
      backdrop-filter: blur(10px);
      z-index: 50;
    }
    .overlay.show{ display:block; }

    .sheet{
      position:fixed;
      left:0; right:0; bottom:0;
      max-width:520px;
      margin:0 auto;
      border-radius: 22px 22px 0 0;
      background: linear-gradient(180deg, rgba(10,14,22,.96), rgba(8,10,14,.98));
      border:1px solid rgba(255,255,255,.10);
      box-shadow: 0 -18px 70px rgba(0,0,0,.65);
      transform: translateY(18px);
      opacity: 0;
      transition: transform .18s var(--ease), opacity .18s var(--ease);
      overflow:hidden;
    }
    .overlay.show .sheet{ transform: translateY(0); opacity: 1; }

    .sheetHead{
      padding: 12px 16px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      border-bottom:1px solid rgba(255,255,255,.06);
      background: rgba(0,0,0,.20);
    }
    .sheetHead .title{
      font-weight: 900;
      letter-spacing:.4px;
      font-size: 14px;
      text-transform: uppercase;
      color: rgba(255,255,255,.82);
    }
    .xbtn{
      width:38px;height:38px;border-radius:12px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.05);
      color: rgba(255,255,255,.82);
      cursor:pointer;
      display:grid;place-items:center;
    }
    .xbtn:active{ transform: scale(.98); }

    .sheetBody{
      padding: 14px 16px calc(18px + env(safe-area-inset-bottom));
      max-height: min(78vh, 640px);
      overflow:auto;
    }

    .chips{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      margin-top: 10px;
    }
    .chip{
      padding: 10px 12px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      color: rgba(255,255,255,.86);
      font-weight: 800;
      font-size: 13px;
      cursor:pointer;
      transition: transform .12s var(--ease), background .15s var(--ease), border-color .15s var(--ease);
      user-select:none;
    }
    .chip:active{ transform: scale(.98); }
    .chip.active{
      background: rgba(42,108,255,.18);
      border-color: rgba(42,108,255,.30);
      box-shadow: 0 10px 26px rgba(42,108,255,.10);
    }

    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 6px 10px;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.22);
      color: rgba(255,255,255,.76);
      font-size: 12px;
      font-weight: 800;
      letter-spacing:.2px;
      margin-left:8px;
    }
    .pill.pop{ border-color: rgba(46,204,113,.22); background: rgba(46,204,113,.10); }
    .pill.save{ border-color: rgba(42,108,255,.22); background: rgba(42,108,255,.12); }

    .choiceCard{
      margin-top: 14px;
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,.10);
      background:
        radial-gradient(500px 260px at 20% 20%, rgba(42,108,255,.16), transparent 60%),
        linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      box-shadow: 0 18px 55px rgba(0,0,0,.55);
      padding: 14px;
      position:relative;
      overflow:hidden;
    }
    .choiceCard::after{
      content:"";
      position:absolute; inset:-60px;
      background: linear-gradient(110deg, transparent 30%, rgba(255,255,255,.08) 45%, transparent 60%);
      transform: translateX(-40%);
      animation: shimmer 2.8s ease-in-out infinite;
      opacity:.35;
      pointer-events:none;
    }
    @keyframes shimmer{
      0%{ transform: translateX(-45%); }
      50%{ transform: translateX(45%); }
      100%{ transform: translateX(45%); }
    }
    .choiceTop{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
    }
    .choiceTitle{
      font-weight: 950;
      font-size: 16px;
      letter-spacing:.2px;
    }
    .choiceSub{ margin-top:6px; color: var(--muted); font-size: 13px; line-height:1.35; }
    .price{
      font-weight: 950;
      font-size: 18px;
      white-space:nowrap;
    }
    .price small{ font-size: 12px; color: var(--muted2); font-weight:800; }

    /* Instructions swipe */
    .swipe{
      display:flex;
      gap:12px;
      overflow:auto;
      scroll-snap-type:x mandatory;
      padding-bottom: 10px;
      -webkit-overflow-scrolling: touch;
    }
    .swipe::-webkit-scrollbar{ display:none; }
    .how{
      flex: 0 0 88%;
      scroll-snap-align: start;
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.22);
      padding: 14px;
      min-height: 160px;
    }
    .how h3{ margin:0; font-size: 15px; font-weight: 950; letter-spacing:.2px; }
    .how ol{ margin:10px 0 0 18px; color: var(--muted); font-size: 13px; line-height:1.5; }
    .dots{
      display:flex;
      justify-content:center;
      gap:8px;
      margin-top: 10px;
    }
    .dot2{
      width:7px;height:7px;border-radius:99px;
      background: rgba(255,255,255,.18);
    }
    .dot2.active{ background: rgba(42,108,255,.60); }

    /* Profile header */
    .pHead{
      display:flex;
      align-items:center;
      gap:12px;
    }
    .avatar{
      width:46px;height:46px;border-radius:16px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.05);
      overflow:hidden;
      display:grid;place-items:center;
      flex-shrink:0;
    }
    .avatar img{ width:100%; height:100%; object-fit:cover; display:block; }
    .initials{
      font-weight: 950;
      letter-spacing:.6px;
      color: rgba(255,255,255,.88);
    }
    .pName{ font-weight: 950; font-size: 15px; }
    .pNick{ color: var(--muted2); font-size: 12px; margin-top: 2px; }

    /* Tiny toast */
    .toast{
      position: fixed;
      left: 50%;
      transform: translateX(-50%);
      bottom: calc(98px + env(safe-area-inset-bottom));
      background: rgba(0,0,0,.70);
      border:1px solid rgba(255,255,255,.10);
      color: rgba(255,255,255,.92);
      padding: 10px 12px;
      border-radius: 14px;
      font-weight: 850;
      font-size: 13px;
      opacity:0;
      pointer-events:none;
      transition: opacity .18s var(--ease), transform .18s var(--ease);
      z-index: 99;
    }
    .toast.show{ opacity:1; transform: translateX(-50%) translateY(-6px); }

    /* Logo block */
    .logoLine{
      display:flex;
      align-items:center;
      gap:10px;
      margin-top: 12px;
    }
    .logo{
      width:46px;height:46px;border-radius:16px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.25);
      display:grid;place-items:center;
      overflow:hidden;
      box-shadow: 0 12px 30px rgba(0,0,0,.45);
      flex-shrink:0;
    }
    .logo img{ width:100%; height:100%; object-fit:cover; display:block; }
    .logoText{
      display:flex;
      flex-direction:column;
      gap:2px;
      min-width:0;
    }
    .logoText .big{
      font-weight: 950;
      letter-spacing:.6px;
      font-size: 16px;
    }
    .logoText .small{
      color: var(--muted2);
      font-size: 12px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
  </style>
</head>

<body class="safeTop">
  <div class="wrap">
    <!-- top -->
    <div class="top">
      <div class="brand">
        <div class="bolt" aria-hidden="true">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
            <path d="M13 2L3 14h8l-1 8 10-12h-8l1-8Z" fill="white" opacity=".9"/>
          </svg>
        </div>
        <div class="btxt">
          <div class="bname">ZEUSVPN</div>
          <div class="bsub" id="topSub">Minimal • Dark • Fast</div>
        </div>
      </div>
      <div class="statusPill" id="apiPill">
        <span class="dot" id="apiDot"></span>
        <span id="apiText">offline</span>
      </div>
    </div>

    <div class="screens">
      <!-- HOME -->
      <div class="screen active" id="screen-home">
        <div class="card">
          <div class="cardInner">
            <div class="logoLine">
              <div class="logo"><img src="logo.png" alt="ZEUSVPN logo" onerror="this.style.display='none'"></div>
              <div class="logoText">
                <div class="big">ZEUSVPN</div>
                <div class="small">Премиум без лишнего. Быстро. Тихо. Надёжно.</div>
              </div>
            </div>

            <h1 style="margin-top:14px;">Премиум без лишнего.</h1>
            <div class="lead" id="homeLead">
              Нажми “Приобрести подписку” → выбери устройства и срок → оплата → конфиг + Copy.
            </div>

            <div class="miniRow">
              <div class="mini">
                <div class="t">Подписка</div>
                <div class="v" id="subState">не оплачено</div>
              </div>
              <div class="mini">
                <div class="t">Активна до</div>
                <div class="v" id="activeUntil">—</div>
              </div>
              <div class="mini">
                <div class="t">API</div>
                <div class="v" id="apiMini">offline</div>
              </div>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="sectionTitle">
            <div class="left">КОНФИГ</div>
            <div class="right" id="cfgNote">после оплаты</div>
          </div>
          <div class="cardInner">
            <div class="fieldLabel">ID пользователя (позже Telegram ID)</div>
            <input class="input" id="userKey" placeholder="например: zeus-7935" />

            <div class="hint">Если пусто — создадим автоматически. В Telegram позже будет автоматически tg_id / username.</div>

            <button class="btn" id="buyBtn">Приобрести подписку</button>

            <div id="configBlock" style="display:none;">
              <div class="fieldLabel" style="margin-top:12px;">Твой конфиг</div>
              <input class="input" id="configLink" readonly />
              <div class="copyRow">
                <button class="btn secondary" id="copyBtn">Скопировать</button>
                <button class="btn" id="openModalBtn2">Продлить</button>
              </div>
              <div class="hint">Скопируй ссылку и вставь в V2Box / Shadowrocket / Streisand / v2rayNG и т.д.</div>
            </div>

          </div>
        </div>
      </div>

      <!-- INSTRUCTIONS -->
      <div class="screen" id="screen-how">
        <div class="card">
          <div class="sectionTitle">
            <div class="left">ИНСТРУКЦИИ</div>
            <div class="right">свайпай →</div>
          </div>
          <div class="cardInner">
            <div class="swipe" id="swipe">
              <div class="how">
                <h3>iOS (iPhone)</h3>
                <ol>
                  <li>Установи: <b>V2Box</b> или <b>Streisand</b> (любой удобный).</li>
                  <li>Нажми “Скан/Import” → вставь ссылку <b>vless://…</b>.</li>
                  <li>Сохрани → включи подключение.</li>
                  <li>Если нужно: включи “Allow insecure” только если у тебя такой режим в клиентах (обычно не требуется).</li>
                </ol>
              </div>

              <div class="how">
                <h3>Android</h3>
                <ol>
                  <li>Установи: <b>v2rayNG</b>.</li>
                  <li>Открой приложение → “+” → “Import from clipboard”.</li>
                  <li>Вставь ссылку <b>vless://…</b> → сохрани.</li>
                  <li>Нажми “Подключить”.</li>
                </ol>
              </div>

              <div class="how">
                <h3>Desktop (Windows/macOS)</h3>
                <ol>
                  <li>Установи клиент: <b>v2rayN</b> (Windows) / <b>V2RayU</b> или аналоги.</li>
                  <li>Импортируй ссылку <b>vless://…</b> в “Import/Subscribe”.</li>
                  <li>Выбери сервер → подключи.</li>
                  <li>Если клиент просит “transport” — у нас <b>TCP</b>, encryption <b>none</b>.</li>
                </ol>
              </div>
            </div>

            <div class="dots" id="dots">
              <div class="dot2 active"></div>
              <div class="dot2"></div>
              <div class="dot2"></div>
            </div>

            <div class="hint" style="text-align:center;margin-top:8px;">
              Если хочешь — потом добавим “проверку подключения” и подсказки под твой конкретный клиент.
            </div>
          </div>
        </div>
      </div>

      <!-- PROFILE -->
      <div class="screen" id="screen-profile">
        <div class="card">
          <div class="sectionTitle">
            <div class="left">ПРОФИЛЬ</div>
            <div class="right" id="profileRight">в Telegram</div>
          </div>
          <div class="cardInner">
            <div class="pHead">
              <div class="avatar" id="avatar">
                <div class="initials" id="initials">Z</div>
              </div>
              <div style="min-width:0;">
                <div class="pName" id="pName">ZEUS User</div>
                <div class="pNick" id="pNick">@username</div>
              </div>
            </div>

            <div style="margin-top:14px;">
              <div class="fieldLabel">Telegram ID</div>
              <input class="input" id="tgId" readonly value="—" />

              <div class="fieldLabel">Ваш ID (для выдачи конфига)</div>
              <input class="input" id="pUserKey" />

              <div class="hint">В Telegram позже можем автоматически использовать tg_id как user_key.</div>

              <button class="btn secondary" id="saveProfileBtn">Сохранить</button>
              <button class="btn secondary" id="resetIdBtn">Сбросить / новый ID</button>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="sectionTitle">
            <div class="left">ИСТОРИЯ</div>
            <div class="right">заглушка</div>
          </div>
          <div class="cardInner">
            <div class="hint">
              Позже сюда добавим список: “дата оплаты / срок / устройства / конфиг”.
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal -->
  <div class="overlay" id="overlay">
    <div class="sheet">
      <div class="sheetHead">
        <div class="title">Подписка</div>
        <button class="xbtn" id="closeSheet" aria-label="close">✕</button>
      </div>
      <div class="sheetBody">
        <div style="color:rgba(255,255,255,.86);font-weight:900;font-size:14px;">
          Выбери устройства и срок
          <span class="pill pop" id="pillPop">Популярно</span>
          <span class="pill save" id="pillSave">Выгоднее</span>
        </div>

        <div style="margin-top:12px;color:var(--muted2);font-weight:850;font-size:12px;letter-spacing:.2px;">Устройства</div>
        <div class="chips" id="devicesChips"></div>

        <div style="margin-top:14px;color:var(--muted2);font-weight:850;font-size:12px;letter-spacing:.2px;">Срок</div>
        <div class="chips" id="daysChips"></div>

        <div class="choiceCard" id="choiceCard">
          <div class="choiceTop">
            <div>
              <div class="choiceTitle" id="choiceTitle">ZEUSVPN • 1 устройство</div>
              <div class="choiceSub" id="choiceSub">Срок: 30 дней • Безлимитный трафик • Быстрые сервера</div>
            </div>
            <div class="price" id="choicePrice">199 <small>XTR</small></div>
          </div>
        </div>

        <button class="btn" id="payStarsBtn">Оплатить Stars</button>
        <button class="btn secondary disabled" id="payCryptoBtn">USDT (скоро)</button>

        <div class="hint" id="payHint" style="margin-top:10px;">
          После оплаты мы автоматически покажем конфиг и кнопку “Скопировать”.
        </div>
      </div>
    </div>
  </div>

  <!-- Bottom nav -->
  <div class="bottomNav safeBottom">
    <div class="navBar">
      <button class="navBtn active" data-screen="home">Главная</button>
      <button class="navBtn" data-screen="how">Инструкции</button>
      <button class="navBtn" data-screen="profile">Профиль</button>
    </div>
  </div>

  <div class="toast" id="toast">Скопировано</div>

  <script>
    // =========================
    // CONFIG
    // =========================
    const API_BASE = "https://api.45.133.251.210.nip.io:8443"; // твой API через nginx:8443
    const DEFAULT_INBOUND_ID = 1;

    // цены (под stars). Совпадают с backend env STARS_PRICE_*
    const PRICE_BY_DAYS = { 30: 199, 90: 399, 180: 599 };

    // =========================
    // Helpers
    // =========================
    const $ = (id)=>document.getElementById(id);

    function toast(msg){
      const t = $("toast");
      t.textContent = msg;
      t.classList.add("show");
      setTimeout(()=>t.classList.remove("show"), 1300);
    }

    function hapticLight(){
      try{
        if(window.Telegram?.WebApp?.HapticFeedback){
          Telegram.WebApp.HapticFeedback.impactOccurred("light");
        }
      }catch(e){}
    }

    function fmtDate(isoOrMs){
      if(!isoOrMs) return "—";
      try{
        const d = typeof isoOrMs==="number" ? new Date(isoOrMs) : new Date(isoOrMs);
        if(isNaN(d.getTime())) return "—";
        const dd = String(d.getDate()).padStart(2,"0");
        const mm = String(d.getMonth()+1).padStart(2,"0");
        const yy = d.getFullYear();
        return `${dd}.${mm}.${yy}`;
      }catch(e){ return "—"; }
    }

    function randKey(){
      const n = Math.floor(1000 + Math.random()*9000);
      return `zeus-${n}`;
    }

    function isActive(activeUntil){
      if(!activeUntil) return false;
      const t = new Date(activeUntil).getTime();
      return Date.now() < t;
    }

    // =========================
    // Telegram user
    // =========================
    function getTGUser(){
      try{
        const tg = window.Telegram?.WebApp;
        if(!tg) return null;
        tg.ready?.();
        return tg.initDataUnsafe?.user || null;
      }catch(e){ return null; }
    }

    function applyTGProfile(){
      const u = getTGUser();
      const inTelegram = !!u;
      $("profileRight").textContent = inTelegram ? "Telegram WebApp" : "браузер";

      let name = "ZEUS User";
      let uname = "@username";
      let tgId = "—";
      let photo = null;

      if(u){
        const fn = u.first_name || "";
        const ln = u.last_name || "";
        name = (fn + " " + ln).trim() || "ZEUS User";
        uname = u.username ? ("@" + u.username) : "—";
        tgId = u.id ? String(u.id) : "—";
        photo = u.photo_url || null;
      }

      $("pName").textContent = name;
      $("pNick").textContent = uname;
      $("tgId").value = tgId;

      // Avatar
      const av = $("avatar");
      av.innerHTML = "";
      if(photo){
        const img = document.createElement("img");
        img.src = photo;
        img.alt = "avatar";
        img.onerror = ()=> {
          av.innerHTML = `<div class="initials" id="initials">${(name[0]||"Z").toUpperCase()}</div>`;
        };
        av.appendChild(img);
      }else{
        av.innerHTML = `<div class="initials" id="initials">${(name[0]||"Z").toUpperCase()}</div>`;
      }
    }

    // =========================
    // API status
    // =========================
    async function checkAPI(){
      try{
        const r = await fetch(API_BASE + "/health", { method:"GET" });
        if(!r.ok) throw new Error("bad");
        $("apiDot").classList.add("ok");
        $("apiText").textContent = "online";
        $("apiMini").textContent = "online";
      }catch(e){
        $("apiDot").classList.remove("ok");
        $("apiText").textContent = "offline";
        $("apiMini").textContent = "offline";
      }
    }

    // =========================
    // State (local)
    // =========================
    const state = {
      user_key: localStorage.getItem("zeus_user_key") || "",
      last_order: localStorage.getItem("zeus_last_order") || "",
      active_until: localStorage.getItem("zeus_active_until") || "",
      config_link: localStorage.getItem("zeus_config_link") || "",
      devices: Number(localStorage.getItem("zeus_devices") || "1"),
      days: Number(localStorage.getItem("zeus_days") || "30"),
    };

    function saveState(){
      localStorage.setItem("zeus_user_key", state.user_key);
      localStorage.setItem("zeus_last_order", state.last_order);
      localStorage.setItem("zeus_active_until", state.active_until);
      localStorage.setItem("zeus_config_link", state.config_link);
      localStorage.setItem("zeus_devices", String(state.devices));
      localStorage.setItem("zeus_days", String(state.days));
    }

    function syncUI(){
      // user key
      $("userKey").value = state.user_key;
      $("pUserKey").value = state.user_key;

      // subscription
      const active = isActive(state.active_until);
      $("subState").textContent = active ? "активна" : "не оплачено";
      $("activeUntil").textContent = active ? fmtDate(state.active_until) : "—";

      // button label
      $("buyBtn").textContent = active ? "Продлить подписку" : "Приобрести подписку";
      $("openModalBtn2").textContent = "Продлить";

      // config
      if(state.config_link){
        $("configBlock").style.display = "block";
        $("configLink").value = state.config_link;
        $("cfgNote").textContent = "готово";
      }else{
        $("configBlock").style.display = "none";
        $("cfgNote").textContent = "после оплаты";
      }
    }

    // =========================
    // Screens
    // =========================
    function setScreen(name){
      document.querySelectorAll(".screen").forEach(s=>s.classList.remove("active"));
      $("screen-"+name).classList.add("active");
      document.querySelectorAll(".navBtn").forEach(b=>{
        b.classList.toggle("active", b.dataset.screen===name);
      });
      hapticLight();
    }

    // =========================
    // Instructions dots
    // =========================
    function initSwipe(){
      const swipe = $("swipe");
      const dots = Array.from($("dots").children);
      swipe.addEventListener("scroll", ()=>{
        const w = swipe.clientWidth;
        const i = Math.round(swipe.scrollLeft / (w*0.88 + 12));
        dots.forEach((d,idx)=>d.classList.toggle("active", idx===Math.max(0,Math.min(2,i))));
      }, {passive:true});
    }

    // =========================
    // Modal selection
    // =========================
    function openSheet(){
      $("overlay").classList.add("show");
      document.body.style.overflow="hidden";
      renderChoice();
      hapticLight();
    }
    function closeSheet(){
      $("overlay").classList.remove("show");
      document.body.style.overflow="";
      hapticLight();
    }

    function makeChips(el, values, current, onPick){
      el.innerHTML="";
      values.forEach(v=>{
        const c = document.createElement("button");
        c.className = "chip" + (v===current ? " active":"");
        c.textContent = (typeof v==="number") ? String(v) : v;
        c.onclick = ()=>{
          onPick(v);
          hapticLight();
          // micro scale
          c.style.transform="scale(.98)";
          setTimeout(()=>c.style.transform="", 110);
        };
        el.appendChild(c);
      });
    }

    function renderChoice(){
      // “Популярно” на 30, “Выгоднее” на 180
      $("pillPop").style.display = "inline-flex";
      $("pillSave").style.display = "inline-flex";

      makeChips($("devicesChips"), [1,3,5,10], state.devices, (v)=>{ state.devices=v; saveState(); renderChoice(); });
      makeChips($("daysChips"), [30,90,180], state.days, (v)=>{ state.days=v; saveState(); renderChoice(); });

      // Active labels
      Array.from($("daysChips").children).forEach(btn=>{
        const n = Number(btn.textContent);
        if(n===30) btn.innerHTML = `30 дней <span class="pill pop" style="margin-left:6px;font-size:11px;padding:4px 8px;">Популярно</span>`;
        if(n===180) btn.innerHTML = `180 дней <span class="pill save" style="margin-left:6px;font-size:11px;padding:4px 8px;">Выгоднее</span>`;
      });

      const price = PRICE_BY_DAYS[state.days] ?? 199;
      $("choiceTitle").textContent = `ZEUSVPN • ${state.devices} устройство${state.devices===1?"":"(а)"}`;
      $("choiceSub").textContent = `Срок: ${state.days} дней • Безлимит • Выделенный профиль • Быстрые сервера`;
      $("choicePrice").innerHTML = `${price} <small>XTR</small>`;
    }

    // =========================
    // Payment flow (Stars)
    // =========================
    let pollTimer = null;

    async function createStarsOrder(){
      // ensure user_key
      if(!state.user_key){
        state.user_key = randKey();
        saveState();
        syncUI();
      }

      const body = { user_key: state.user_key, days: state.days, devices: state.devices };
      const r = await fetch(API_BASE + "/pay/stars/create", {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify(body)
      });
      if(!r.ok){
        const t = await r.text().catch(()=> "");
        throw new Error("create failed: " + t);
      }
      return await r.json(); // { order_id, invoice_link }
    }

    function openInvoiceUniversal(url){
      const tg = window.Telegram?.WebApp;
      if(tg && typeof tg.openInvoice === "function"){
        tg.openInvoice(url, (status)=>{
          // status может быть "paid", "cancelled", "failed" — мы всё равно поллим order
        });
      }else{
        window.open(url, "_blank");
      }
    }

    async function pollOrder(order_id){
      if(pollTimer) clearInterval(pollTimer);

      pollTimer = setInterval(async ()=>{
        try{
          const r = await fetch(API_BASE + "/pay/order/" + encodeURIComponent(order_id));
          if(!r.ok) return;
          const data = await r.json();

          // обновим UI
          if(data.active_until) state.active_until = data.active_until;
          if(data.config_link) state.config_link = data.config_link;
          saveState();
          syncUI();

          if(data.status === "paid"){
            clearInterval(pollTimer);
            pollTimer = null;
            closeSheet();
            toast("Оплачено ✅");
          }
        }catch(e){}
      }, 1200);
    }

    // =========================
    // Copy
    // =========================
    async function copyConfig(){
      const v = $("configLink").value || "";
      if(!v) return;
      try{
        await navigator.clipboard.writeText(v);
        toast("Скопировано");
        hapticLight();
      }catch(e){
        // fallback
        $("configLink").focus();
        $("configLink").select();
        document.execCommand("copy");
        toast("Скопировано");
      }
    }

    // =========================
    // Init
    // =========================
    function init(){
      applyTGProfile();
      checkAPI();
      initSwipe();

      // user key
      if(!state.user_key){
        state.user_key = localStorage.getItem("zeus_user_key") || "";
      }
      if(!state.user_key){
        // если мы в Telegram — можно сразу сделать user_key = tg_id (позже)
        const u = getTGUser();
        if(u?.id) state.user_key = "tg" + String(u.id);
      }
      if(!state.user_key) state.user_key = randKey();
      saveState();
      syncUI();

      // nav
      document.querySelectorAll(".navBtn").forEach(b=>{
        b.onclick = ()=> setScreen(b.dataset.screen);
      });

      // sync profile input
      $("userKey").addEventListener("input", (e)=>{
        state.user_key = e.target.value.trim();
        saveState();
        $("pUserKey").value = state.user_key;
      });
      $("pUserKey").addEventListener("input", (e)=>{
        state.user_key = e.target.value.trim();
        saveState();
        $("userKey").value = state.user_key;
      });

      $("saveProfileBtn").onclick = ()=>{
        saveState();
        toast("Сохранено");
        hapticLight();
      };

      $("resetIdBtn").onclick = ()=>{
        state.user_key = randKey();
        saveState();
        syncUI();
        toast("Новый ID готов");
        hapticLight();
      };

      // open modal
      $("buyBtn").onclick = openSheet;
      $("openModalBtn2").onclick = openSheet;
      $("closeSheet").onclick = closeSheet;
      $("overlay").onclick = (e)=>{ if(e.target.id==="overlay") closeSheet(); };

      // pay stars
      $("payStarsBtn").onclick = async ()=>{
        try{
          hapticLight();
          $("payStarsBtn").textContent = "Создаём счёт…";
          $("payStarsBtn").classList.add("disabled");

          const res = await createStarsOrder();
          state.last_order = res.order_id;
          saveState();

          $("payStarsBtn").textContent = "Открываем оплату…";
          openInvoiceUniversal(res.invoice_link);

          // начинаем polling
          pollOrder(res.order_id);

          // вернуть кнопку
          setTimeout(()=>{
            $("payStarsBtn").textContent = "Оплатить Stars";
            $("payStarsBtn").classList.remove("disabled");
          }, 600);

        }catch(err){
          $("payStarsBtn").textContent = "Оплатить Stars";
          $("payStarsBtn").classList.remove("disabled");
          alert("Ошибка оплаты: " + (err?.message || err));
        }
      };

      // copy
      $("copyBtn").onclick = copyConfig;

      // if last order exists, resume polling a bit
      if(state.last_order && !isActive(state.active_until)){
        pollOrder(state.last_order);
        setTimeout(()=>{ if(pollTimer){ clearInterval(pollTimer); pollTimer=null; } }, 15000);
      }
    }

    init();
  </script>

  <!-- Telegram WebApp JS (не ломает браузер, если не Telegram) -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
</body>
</html>
