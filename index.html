<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>ZEUSVPN</title>

  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>

  <style>
    :root{
      /* Darker, more premium */
      --bg0:#01030B;
      --bg1:#020617;
      --bg2:#050B20;

      --text:#EEF3FF;
      --text2:rgba(238,243,255,.78);
      --muted:rgba(238,243,255,.55);

      --line:rgba(255,255,255,.10);
      --line2:rgba(255,255,255,.14);

      --blue:#2D6BFF;
      --blue2:#0D2F87;

      --gold:#D7B46A;
      --gold2:#F4E0AE;

      --ok:#20E6B2;
      --warn:#FFC457;
      --bad:#FF5B6B;

      --glass: rgba(255,255,255,.05);
      --glass2: rgba(255,255,255,.08);

      --shadow: 0 22px 70px rgba(0,0,0,.68);
      --shadow2: 0 14px 42px rgba(0,0,0,.48);

      --r14:14px;
      --r18:18px;
      --r22:22px;
      --r26:26px;

      --pad:14px;
      --ease: cubic-bezier(.22,.9,.22,1);
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, "SF Pro Display","SF Pro Text", Segoe UI, Roboto, Arial;
      color:var(--text);
      background:
        radial-gradient(980px 700px at 15% -10%, rgba(45,107,255,.22), transparent 60%),
        radial-gradient(820px 600px at 92% 6%, rgba(215,180,106,.10), transparent 62%),
        radial-gradient(800px 650px at 18% 95%, rgba(255,255,255,.05), transparent 70%),
        linear-gradient(180deg, var(--bg0), var(--bg2) 52%, var(--bg0));
      overflow-x:hidden;
    }

    /* micro grain (very subtle) */
    body::before{
      content:"";
      position:fixed; inset:0;
      background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='180' height='180'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.85' numOctaves='2' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='180' height='180' filter='url(%23n)' opacity='.14'/%3E%3C/svg%3E");
      opacity:.06;
      pointer-events:none;
      mix-blend-mode: overlay;
    }

    .app{
      max-width:520px;
      margin:0 auto;
      padding: 10px var(--pad) 118px;
      position:relative;
      z-index:1;
    }

    /* topbar more compact */
    .topbar{
      position:sticky;
      top: 0;
      z-index:30;
      padding-top: 10px;
      padding-bottom: 10px;
      background: linear-gradient(180deg, rgba(1,3,11,.92), rgba(1,3,11,.55), rgba(1,3,11,0));
      backdrop-filter: blur(14px);
    }
    .topbarInner{
      border-radius: var(--r26);
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.05);
      box-shadow: 0 12px 28px rgba(0,0,0,.34);
      padding: 10px 10px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      backdrop-filter: blur(14px);
    }
    .brand{
      display:flex;
      align-items:center;
      gap:10px;
      min-width:0;
    }
    .mark{
      width:38px; height:38px;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.12);
      background:
        radial-gradient(18px 18px at 28% 30%, rgba(45,107,255,.32), transparent 60%),
        radial-gradient(24px 24px at 72% 22%, rgba(215,180,106,.14), transparent 65%),
        rgba(255,255,255,.04);
      box-shadow: 0 16px 46px rgba(0,0,0,.40);
      display:flex;
      align-items:center;
      justify-content:center;
      overflow:hidden;
      position:relative;
    }
    .mark::before{
      content:"";
      position:absolute; inset:-50%;
      background: conic-gradient(from 180deg,
        rgba(45,107,255,0),
        rgba(45,107,255,.26),
        rgba(255,255,255,.10),
        rgba(215,180,106,.12),
        rgba(45,107,255,0));
      opacity:.45;
      filter: blur(7px);
      animation: spin 10s linear infinite;
    }
    @keyframes spin{ to{ transform: rotate(360deg); } }
    .mark svg{ position:relative; z-index:2; }

    .brandText{ min-width:0; }
    .name{
      margin:0;
      font-weight: 950;
      letter-spacing:.9px;
      font-size: 13px;
      line-height: 1.05;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }
    .tag{
      margin:6px 0 0;
      font-size: 12px;
      color: var(--muted);
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }

    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 7px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.18);
      color: rgba(255,255,255,.86);
      font-size: 12px;
      white-space:nowrap;
      backdrop-filter: blur(12px);
    }
    .dot{
      width:8px; height:8px;
      border-radius:50%;
      background: rgba(255,255,255,.55);
      box-shadow: 0 0 16px rgba(45,107,255,.42);
    }

    /* hero more compact (less empty) */
    .hero{
      margin-top: 8px;
      border-radius: var(--r26);
      border:1px solid rgba(255,255,255,.10);
      background:
        radial-gradient(860px 360px at 16% -10%, rgba(45,107,255,.18), transparent 62%),
        radial-gradient(700px 360px at 100% 0%, rgba(215,180,106,.08), transparent 58%),
        linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.025));
      box-shadow: var(--shadow2);
      padding: 14px;
      backdrop-filter: blur(14px);
    }
    .heroTitle{
      margin:0;
      font-size: 17px;
      font-weight: 950;
      letter-spacing:.2px;
      line-height:1.18;
    }
    .heroSub{
      margin:8px 0 0;
      font-size: 12.5px;
      line-height:1.55;
      color: var(--muted);
    }

    .miniStats{
      margin-top: 10px;
      display:flex;
      gap:10px;
    }
    .stat{
      flex:1;
      border-radius: 18px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.04);
      padding: 10px;
      min-width:0;
    }
    .stat b{
      display:block;
      font-size: 12px;
      letter-spacing:.2px;
      margin-bottom: 6px;
      color: rgba(255,255,255,.92);
    }
    .stat span{
      font-size: 12px;
      color: rgba(255,255,255,.66);
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }

    .card{
      margin-top: 10px;
      border-radius: var(--r26);
      border:1px solid rgba(255,255,255,.10);
      background: linear-gradient(180deg, rgba(255,255,255,.055), rgba(255,255,255,.028));
      box-shadow: var(--shadow2);
      overflow:hidden;
      backdrop-filter: blur(14px);
    }
    .head{
      padding: 12px 14px 10px;
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap:10px;
    }
    .head h2{
      margin:0;
      font-size: 12px;
      letter-spacing:.38px;
      text-transform:uppercase;
      font-weight: 950;
      color: rgba(255,255,255,.90);
    }
    .head small{
      color: rgba(255,255,255,.55);
      font-size: 12px;
      text-align:right;
    }
    .divider{
      height:1px;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,.14), transparent);
      margin: 0 14px;
    }
    .body{ padding: 12px 14px 14px; }
    .muted{ color: rgba(255,255,255,.60); font-size: 12px; line-height:1.5; }
    .hidden{ display:none !important; }

    /* buttons */
    .btn{
      width:100%;
      padding: 14px 14px;
      border-radius: 18px;
      border: 0;
      cursor:pointer;
      font-weight: 950;
      letter-spacing:.25px;
      transition: transform .10s var(--ease), filter .16s var(--ease), box-shadow .16s var(--ease);
      user-select:none;
      -webkit-tap-highlight-color: transparent;
    }
    .btn:active{ transform: translateY(1px) scale(.995); }
    .btn[disabled]{ opacity:.55; cursor:not-allowed; }

    .btnPrimary{
      color:#fff;
      background:
        linear-gradient(180deg, rgba(255,255,255,.16), rgba(255,255,255,0) 34%),
        linear-gradient(180deg, var(--blue), var(--blue2));
      box-shadow: 0 18px 44px rgba(45,107,255,.20);
    }
    .btnGold{
      color:#1A1406;
      background:
        linear-gradient(180deg, rgba(255,255,255,.28), rgba(255,255,255,0) 35%),
        linear-gradient(180deg, var(--gold2), var(--gold));
      box-shadow: 0 18px 44px rgba(215,180,106,.12);
    }
    .btnGhost{
      color: rgba(255,255,255,.86);
      background: rgba(0,0,0,.18);
      border:1px solid rgba(255,255,255,.12);
      box-shadow: 0 12px 26px rgba(0,0,0,.24);
    }

    .field{ display:grid; gap:8px; margin-bottom: 10px; }
    .label{ font-size: 12px; color: rgba(255,255,255,.62); }

    .input{
      width:100%;
      padding: 13px 12px;
      border-radius: 16px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.22);
      color: rgba(255,255,255,.92);
      outline:none;
      font-size: 14px;
      box-shadow: inset 0 1px 0 rgba(255,255,255,.06);
    }
    .input::placeholder{ color: rgba(255,255,255,.40); }

    .badge{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 6px 10px;
      border-radius:999px;
      font-size: 12px;
      font-weight: 950;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: rgba(255,255,255,.84);
      white-space:nowrap;
    }
    .badge.ok{ border-color: rgba(32,230,178,.28); color: var(--ok); }
    .badge.warn{ border-color: rgba(255,196,87,.28); color: var(--warn); }
    .badge.bad{ border-color: rgba(255,91,107,.30); color: var(--bad); }
    .badge.blue{ border-color: rgba(45,107,255,.30); color: rgba(169,199,255,.95); }

    /* compact config box */
    .configCard{
      margin-top: 10px;
      border-radius: 22px;
      border:1px solid rgba(255,255,255,.12);
      background:
        radial-gradient(520px 220px at 22% 0%, rgba(45,107,255,.12), transparent 64%),
        radial-gradient(520px 220px at 96% 20%, rgba(215,180,106,.07), transparent 66%),
        linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.03));
      padding: 12px;
      box-shadow: 0 14px 36px rgba(0,0,0,.34);
    }
    .configTop{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom: 8px;
    }
    .miniBtn{
      width:auto;
      padding: 10px 12px;
      border-radius: 14px;
      font-weight: 950;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.18);
      color: rgba(255,255,255,.88);
      cursor:pointer;
    }
    .mono{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 12px;
      line-height:1.35;
      word-break:break-all;
      color: rgba(255,255,255,.92);
    }
    .qrWrap{
      display:flex;
      gap:12px;
      align-items:flex-start;
      margin-top: 10px;
    }
    .qrBox{
      width:110px;
      border-radius: 16px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.16);
      padding: 10px;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    canvas{ border-radius: 12px; }

    /* ===== COMPACT TARIFFS WITH ONE PAY BUTTON ===== */
    .segRow{
      display:flex;
      gap:10px;
      margin-top: 6px;
    }
    .seg{
      flex:1;
      padding: 10px 10px;
      border-radius: 16px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.04);
      color: rgba(255,255,255,.70);
      font-weight: 950;
      cursor:pointer;
      text-align:center;
      -webkit-tap-highlight-color: transparent;
      transition: transform .12s var(--ease);
    }
    .seg:active{ transform: scale(.99); }
    .seg.active{
      color:#fff;
      border-color: rgba(45,107,255,.35);
      background:
        linear-gradient(180deg, rgba(255,255,255,.14), rgba(255,255,255,0) 34%),
        linear-gradient(180deg, var(--blue), var(--blue2));
      box-shadow: 0 16px 34px rgba(45,107,255,.14);
    }

    /* tariff list */
    .planList{ display:grid; gap:10px; margin-top: 10px; }
    .planRow{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding: 12px 12px;
      border-radius: 20px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.04);
      cursor:pointer;
      -webkit-tap-highlight-color: transparent;
      transition: transform .12s var(--ease), border-color .12s var(--ease), background .12s var(--ease);
      position:relative;
      overflow:hidden;
    }
    .planRow:active{ transform: scale(.995); }
    .planRow.selected{
      border-color: rgba(45,107,255,.36);
      background:
        radial-gradient(520px 240px at 20% 0%, rgba(45,107,255,.14), transparent 64%),
        linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      box-shadow: 0 16px 38px rgba(0,0,0,.28);
    }
    .planLeft{ min-width:0; }
    .planTitle{
      margin:0;
      font-weight: 950;
      font-size: 13px;
      letter-spacing:.2px;
      color: rgba(255,255,255,.92);
    }
    .planDesc{
      margin:6px 0 0;
      font-size: 12px;
      color: rgba(255,255,255,.60);
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }
    .planRight{
      text-align:right;
      white-space:nowrap;
      display:flex;
      flex-direction:column;
      gap:6px;
      align-items:flex-end;
    }
    .pPrice{
      font-weight: 950;
      font-size: 14px;
      color: rgba(255,255,255,.95);
    }
    .hint{
      font-size: 11px;
      padding: 5px 8px;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.14);
      color: rgba(255,255,255,.70);
    }
    .hint.pop{ border-color: rgba(45,107,255,.26); color: rgba(169,199,255,.95); }
    .hint.best{ border-color: rgba(215,180,106,.22); color: rgba(244,224,174,.95); }

    /* pay bar inside card (one button) */
    .payBar{
      margin-top: 12px;
      border-radius: 22px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.18);
      padding: 12px;
      box-shadow: 0 14px 36px rgba(0,0,0,.26);
    }
    .payTop{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom: 10px;
    }
    .payInfo{
      min-width:0;
    }
    .payInfo b{
      display:block;
      font-size: 13px;
      letter-spacing:.15px;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }
    .payInfo span{
      display:block;
      margin-top: 6px;
      font-size: 12px;
      color: rgba(255,255,255,.60);
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }

    .paySwitch{
      display:flex;
      gap:8px;
      padding: 6px;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.04);
    }
    .payPill{
      padding: 8px 10px;
      border-radius: 999px;
      border:1px solid transparent;
      background: transparent;
      color: rgba(255,255,255,.72);
      font-weight: 950;
      cursor:pointer;
      -webkit-tap-highlight-color: transparent;
    }
    .payPill.active{
      border-color: rgba(255,255,255,.12);
      background:
        linear-gradient(180deg, rgba(255,255,255,.14), rgba(255,255,255,0) 40%),
        rgba(0,0,0,.22);
      color: rgba(255,255,255,.92);
    }

    /* toast */
    .toast{
      position: fixed;
      left: 50%;
      transform: translateX(-50%);
      bottom: 96px;
      background: rgba(0,0,0,.42);
      border:1px solid rgba(255,255,255,.12);
      backdrop-filter: blur(12px);
      color: rgba(255,255,255,.92);
      padding: 10px 12px;
      border-radius: 999px;
      box-shadow: 0 16px 44px rgba(0,0,0,.38);
      opacity:0;
      pointer-events:none;
      transition: opacity .18s var(--ease), transform .18s var(--ease);
      z-index:60;
      font-weight: 950;
      font-size: 12px;
    }
    .toast.show{
      opacity:1;
      transform: translateX(-50%) translateY(-6px);
    }

    /* iOS-like screen transitions */
    .screens{
      position:relative;
      min-height: 780px;
    }
    .screen{
      position:absolute;
      inset:0;
      opacity:0;
      transform: translateX(16px);
      filter: blur(2px);
      pointer-events:none;
      transition: opacity .22s var(--ease), transform .22s var(--ease), filter .22s var(--ease);
      will-change: opacity, transform, filter;
    }
    .screen.active{
      opacity:1;
      transform: translateX(0);
      filter: blur(0);
      pointer-events:auto;
    }
    .screen.fromLeft{ transform: translateX(-16px); }

    /* bottom nav */
    .nav{
      position:fixed;
      left:0; right:0; bottom:0;
      padding: 10px 12px calc(10px + env(safe-area-inset-bottom));
      background: rgba(1,3,11,.72);
      border-top: 1px solid rgba(255,255,255,.10);
      backdrop-filter: blur(14px);
      z-index:40;
    }
    .navInner{
      max-width:520px;
      margin:0 auto;
      display:flex;
      gap:10px;
    }
    .tab{
      flex:1;
      padding: 12px 10px;
      border-radius: 18px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.04);
      color: rgba(255,255,255,.68);
      font-weight: 950;
      letter-spacing:.15px;
      cursor:pointer;
      -webkit-tap-highlight-color: transparent;
      transition: transform .12s var(--ease);
    }
    .tab:active{ transform: scale(.99); }
    .tab.active{
      color:#fff;
      border-color: rgba(45,107,255,.35);
      background:
        linear-gradient(180deg, rgba(255,255,255,.14), rgba(255,255,255,0) 34%),
        linear-gradient(180deg, var(--blue), var(--blue2));
      box-shadow: 0 16px 36px rgba(45,107,255,.14);
    }

    /* guide carousel */
    .carousel{
      display:flex;
      gap:12px;
      overflow:auto;
      scroll-snap-type:x mandatory;
      -webkit-overflow-scrolling:touch;
      padding: 12px 14px 14px;
    }
    .carousel::-webkit-scrollbar{display:none}
    .slide{
      min-width: 86%;
      scroll-snap-align:start;
      border-radius: 22px;
      border:1px solid rgba(255,255,255,.12);
      background:
        radial-gradient(520px 240px at 18% 0%, rgba(45,107,255,.14), transparent 64%),
        linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.03));
      padding: 14px;
      box-shadow: 0 14px 34px rgba(0,0,0,.30);
    }
    .slideTop{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom: 10px;
    }
    .chip{
      font-size: 12px;
      padding: 6px 10px;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.14);
      color: rgba(255,255,255,.70);
      white-space:nowrap;
    }
    .steps{
      font-size: 13px;
      color: rgba(255,255,255,.74);
      line-height: 1.65;
    }

    /* error box */
    .errCard{
      display:none;
      margin-top: 10px;
      border-radius: var(--r22);
      border:1px solid rgba(255,91,107,.26);
      background: rgba(255,91,107,.06);
      padding: 12px;
    }
    .errCard b{ color: var(--bad); }
    .errCard span{ display:block; margin-top:6px; color: rgba(255,255,255,.74); font-size: 12px; }
  </style>
</head>

<body>
  <div class="toast" id="toast">Скопировано</div>

  <div class="app">
    <div class="topbar">
      <div class="topbarInner">
        <div class="brand">
          <div class="mark" aria-hidden="true">
            <svg width="18" height="24" viewBox="0 0 22 28" fill="none">
              <path d="M12.9 2H21L12 14.4H18.9L7.3 26L9.8 15.1H3L12.9 2Z" fill="rgba(255,255,255,.92)"/>
            </svg>
          </div>
          <div class="brandText">
            <p class="name">ZEUSVPN</p>
            <p class="tag">Thunder-class • Premium VLESS</p>
          </div>
        </div>

        <div class="pill" id="apiPill">
          <span class="dot" id="apiDot"></span>
          <span id="apiText">API: checking…</span>
        </div>
      </div>
    </div>

    <div class="hero">
      <p class="heroTitle">Премиум VPN. Темнее. Чище. Дороже.</p>
      <p class="heroSub">Выбираешь тариф → нажимаешь “Оплатить” → после paid показываем конфиг + “Активна до…”.</p>

      <div class="miniStats">
        <div class="stat">
          <b>Подписка</b>
          <span id="heroSubStat">не оплачено</span>
        </div>
        <div class="stat">
          <b>Устройства</b>
          <span id="heroDevicesStat">—</span>
        </div>
        <div class="stat">
          <b>API</b>
          <span id="heroApi">—</span>
        </div>
      </div>
    </div>

    <div class="screens">
      <!-- HOME -->
      <div class="screen active" id="screenHome">

        <div class="card">
          <div class="head">
            <h2>Конфиг</h2>
            <small>личный</small>
          </div>
          <div class="divider"></div>

          <div class="body">
            <div class="field">
              <div class="label">ID пользователя (позже будет Telegram ID)</div>
              <input class="input" id="userKey" placeholder="например: zeus-1234" />
              <div class="muted">Можно пусто — сделаем ID автоматически.</div>
            </div>

            <button class="btn btnPrimary" id="btnGetConfig">Получить конфиг</button>

            <div class="errCard" id="errBox">
              <b>Ошибка</b>
              <span id="errText"></span>
            </div>

            <div class="configCard hidden" id="configBox">
              <div class="configTop">
                <span class="badge ok">VLESS</span>
                <div style="display:flex; gap:10px;">
                  <button class="miniBtn" id="btnCopy">Copy</button>
                  <button class="miniBtn" id="btnOpenApp" disabled>Open</button>
                </div>
              </div>
              <div class="mono" id="configText"></div>

              <div class="qrWrap">
                <div class="qrBox">
                  <canvas id="qrCanvas" width="96" height="96"></canvas>
                </div>
                <div style="flex:1; min-width:0;">
                  <div class="muted" style="margin-bottom:6px;">QR для импорта (удобно на другом устройстве).</div>
                  <div class="muted">Если QR не нужен — просто Copy.</div>
                </div>
              </div>
            </div>

          </div>
        </div>

        <!-- TARIFFS COMPACT + ONE PAY BUTTON -->
        <div class="card">
          <div class="head">
            <h2>Тариф</h2>
            <small>выбор → оплата</small>
          </div>
          <div class="divider"></div>

          <div class="body">
            <div class="label">Срок</div>
            <div class="segRow">
              <div class="seg active" data-days="30" id="seg30">30</div>
              <div class="seg" data-days="90" id="seg90">90</div>
              <div class="seg" data-days="180" id="seg180">180</div>
            </div>

            <div class="label" style="margin-top:12px;">Устройства</div>
            <div class="planList" id="planList"></div>

            <div class="payBar" id="payBar">
              <div class="payTop">
                <div class="payInfo">
                  <b id="payTitle">—</b>
                  <span id="paySub">—</span>
                </div>

                <div class="paySwitch">
                  <button class="payPill active" id="payStars">Stars</button>
                  <button class="payPill" id="payUsdt">USDT</button>
                </div>
              </div>

              <button class="btn btnGold" id="btnPay">Оплатить</button>

              <div class="card hidden" id="orderBox" style="margin-top:12px;">
                <div class="head">
                  <h2>Заказ</h2>
                  <small><span class="badge warn" id="orderStatus">pending</span></small>
                </div>
                <div class="divider"></div>
                <div class="body">
                  <div class="muted" id="orderMeta"></div>
                  <div class="muted" style="margin-top:10px;">
                    Авто-проверка каждые ~1.2 сек. Когда <b>paid</b> — покажем “Активна до…” и конфиг (если бэк отдаст).
                  </div>
                </div>
              </div>

            </div>

            <div class="muted" style="margin-top:10px;">
              * Сейчас “устройства” — UI. Потом подключим реальные лимиты.
            </div>
          </div>
        </div>
      </div>

      <!-- GUIDE -->
      <div class="screen" id="screenGuide">
        <div class="card">
          <div class="head">
            <h2>Инструкции</h2>
            <small>свайп</small>
          </div>
          <div class="divider"></div>

          <div class="carousel">
            <div class="slide">
              <div class="slideTop">
                <b>iOS</b>
                <span class="chip">V2Box / Shadowrocket</span>
              </div>
              <div class="steps">
                1) Получи конфиг<br/>
                2) Copy<br/>
                3) Import → From Clipboard<br/>
                4) Connect
              </div>
            </div>

            <div class="slide">
              <div class="slideTop">
                <b>Android</b>
                <span class="chip">v2rayNG</span>
              </div>
              <div class="steps">
                1) Получи конфиг<br/>
                2) Copy<br/>
                3) “+” → Import from Clipboard<br/>
                4) Connect
              </div>
            </div>

            <div class="slide">
              <div class="slideTop">
                <b>Desktop</b>
                <span class="chip">Nekoray / v2rayN</span>
              </div>
              <div class="steps">
                1) Copy конфиг<br/>
                2) Импорт по ссылке/буферу<br/>
                3) Подключись
              </div>
            </div>
          </div>

          <div class="body" style="padding-top:0">
            <div class="muted">Всё сделано под телефон. Свайпай карточки.</div>
          </div>
        </div>
      </div>

      <!-- PROFILE -->
      <div class="screen" id="screenProfile">
        <div class="card">
          <div class="head">
            <h2>Профиль</h2>
            <small>Telegram позже</small>
          </div>
          <div class="divider"></div>

          <div class="body">
            <div class="card" style="margin-top:0;">
              <div class="head">
                <h2>ID</h2>
                <small><span class="badge blue" id="profileId">—</span></small>
              </div>
              <div class="divider"></div>
              <div class="body">
                <div style="display:flex; gap:10px;">
                  <button class="btn btnGhost" id="btnResetId">Новый ID</button>
                  <button class="btn btnGhost" id="btnHistory" disabled>История</button>
                </div>

                <div style="margin-top:12px;">
                  <div class="label">Статус подписки</div>
                  <div style="margin-top:8px; border-radius:18px; border:1px solid rgba(255,255,255,.12); background: rgba(0,0,0,.16); padding:12px;">
                    <div style="display:flex; align-items:center; justify-content:space-between; gap:10px;">
                      <span class="muted">Состояние</span>
                      <span class="badge warn" id="subStatus">Не оплачено</span>
                    </div>
                    <div class="muted" id="activeUntil" style="margin-top:10px;">Активна до: —</div>
                  </div>
                </div>
              </div>
            </div>

            <div class="card">
              <div class="head">
                <h2>Рефералка</h2>
                <small>+7 дней (UI)</small>
              </div>
              <div class="divider"></div>
              <div class="body">
                <button class="btn btnGhost" id="btnRefCreate">Создать реф-код</button>
                <div class="muted" id="refOut" style="margin-top:10px;"></div>
              </div>
            </div>

          </div>
        </div>
      </div>
    </div>

  </div>

  <div class="nav">
    <div class="navInner">
      <button class="tab active" id="tabHome">Главная</button>
      <button class="tab" id="tabGuide">Инструкции</button>
      <button class="tab" id="tabProfile">Профиль</button>
    </div>
  </div>

<script>
  // ===== CONFIG =====
  const API_BASE = "https://api.45.133.251.210.nip.io:8443";

  // UI prices (подстрой под свои)
  const PRICES = {
    30:  { stars: 199, usdt: 3.0 },
    90:  { stars: 399, usdt: 7.0 },
    180: { stars: 599, usdt: 12.0 }
  };

  const tg = window.Telegram?.WebApp;
  if (tg) { try { tg.ready(); tg.expand(); } catch(e){} }

  const $ = (id)=>document.getElementById(id);
  const show = (el)=>el.classList.remove("hidden");
  const hide = (el)=>el.classList.add("hidden");

  function toast(msg){
    const t = $("toast");
    t.textContent = msg || "Готово";
    t.classList.add("show");
    setTimeout(()=>t.classList.remove("show"), 900);
  }

  function clearError(){
    $("errBox").style.display = "none";
    $("errText").textContent = "";
  }
  function setError(msg){
    $("errText").textContent = msg || "Неизвестная ошибка";
    $("errBox").style.display = "block";
  }

  function genUserKey(){
    const n = Math.floor(Math.random()*9000)+1000;
    return "zeus-" + n;
  }
  function getUserKey(){
    return ($("userKey").value || "").trim();
  }
  function setUserKey(v){
    $("userKey").value = v || "";
    $("profileId").textContent = v || "—";
    localStorage.setItem("zeus_user_key", v || "");
  }
  async function ensureUserKey(){
    let u = getUserKey();
    if(!u){
      u = genUserKey();
      setUserKey(u);
    } else {
      setUserKey(u);
    }
    return u;
  }

  async function pingApi(){
    try{
      const r = await fetch(API_BASE + "/health", { method:"GET" });
      if(!r.ok) throw new Error("health not ok");
      await r.json();
      $("apiText").textContent = "API: online";
      $("apiDot").style.background = "#20E6B2";
      $("heroApi").textContent = "online";
      return true;
    }catch(e){
      $("apiText").textContent = "API: offline";
      $("apiDot").style.background = "#FF5B6B";
      $("heroApi").textContent = "offline";
      return false;
    }
  }

  // ===== iOS-like screen transitions =====
  const screens = {
    home: $("screenHome"),
    guide: $("screenGuide"),
    profile: $("screenProfile")
  };
  let current = "home";

  function setScreen(name){
    if(name === current) return;

    const next = name;
    const dirLeft = (next === "home" && current !== "home");
    Object.entries(screens).forEach(([key, el])=>{
      el.classList.remove("active","fromLeft");
      if(key !== next) el.style.pointerEvents = "none";
    });
    if(dirLeft) screens[next].classList.add("fromLeft");
    screens[next].classList.add("active");
    screens[next].style.pointerEvents = "auto";
    if(!dirLeft) screens[current].classList.add("fromLeft");
    current = next;

    if (tg?.HapticFeedback) tg.HapticFeedback.impactOccurred("light");
  }

  function setTab(tab){
    $("tabHome").classList.toggle("active", tab==="home");
    $("tabGuide").classList.toggle("active", tab==="guide");
    $("tabProfile").classList.toggle("active", tab==="profile");
    setScreen(tab);
  }
  $("tabHome").onclick = ()=>setTab("home");
  $("tabGuide").onclick = ()=>setTab("guide");
  $("tabProfile").onclick = ()=>setTab("profile");

  // ===== CONFIG ISSUE =====
  let lastConfig = "";
  async function renderQR(text){
    try{
      const canvas = $("qrCanvas");
      const opts = { errorCorrectionLevel:"M", margin:1, width:96,
        color:{ dark:"#EEF3FF", light:"#00000000" }
      };
      await QRCode.toCanvas(canvas, text, opts);
    }catch(e){}
  }

  async function issueConfig(){
    clearError();
    hide($("configBox"));

    const user_key = await ensureUserKey();

    $("btnGetConfig").disabled = true;
    $("btnGetConfig").textContent = "Генерирую…";

    try{
      const r = await fetch(API_BASE + "/issue-config", {
        method:"POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({ inbound_id: 1, user_key, days: 30, limit_ip: 0 })
      });

      const txt = await r.text();
      let data;
      try { data = JSON.parse(txt); } catch(e){ data = { raw: txt }; }

      if(!r.ok) throw new Error(data?.detail || ("HTTP " + r.status));
      lastConfig = data.link || "";
      if(!lastConfig) throw new Error("Ответ без link");

      $("configText").textContent = lastConfig;
      await renderQR(lastConfig);
      show($("configBox"));

      if (tg?.HapticFeedback) tg.HapticFeedback.notificationOccurred("success");
    }catch(e){
      setError(e?.message || String(e));
      if (tg?.HapticFeedback) tg.HapticFeedback.notificationOccurred("error");
    }finally{
      $("btnGetConfig").disabled = false;
      $("btnGetConfig").textContent = "Получить конфиг";
    }
  }

  $("btnGetConfig").addEventListener("click", issueConfig);

  $("btnCopy").addEventListener("click", async ()=>{
    try{
      await navigator.clipboard.writeText(lastConfig);
      toast("Скопировано");
      if (tg?.HapticFeedback) tg.HapticFeedback.impactOccurred("light");
    }catch(e){
      alert("Скопируй вручную:\n\n" + lastConfig);
    }
  });

  // ===== SUBS UI =====
  function setSubscriptionUI({status, active_until, devices}){
    if(status === "paid" || status === "active"){
      $("subStatus").textContent = "Активна";
      $("subStatus").className = "badge ok";
      $("heroSubStat").textContent = "активна";
    } else {
      $("subStatus").textContent = "Не оплачено";
      $("subStatus").className = "badge warn";
      $("heroSubStat").textContent = "не оплачено";
    }
    $("heroDevicesStat").textContent = devices ? (devices + " устройств") : "—";

    if(active_until){
      const dt = new Date(active_until);
      $("activeUntil").textContent = "Активна до: " + dt.toLocaleString();
    } else {
      $("activeUntil").textContent = "Активна до: —";
    }
  }

  // ===== PAYMENTS (ONE BUTTON) =====
  let selectedDays = 30;
  let selectedDevices = 5;  // default more logical
  let payProvider = "stars"; // "stars" or "usdt"
  let pollTimer = null;

  function formatPlanTitle(){
    const d = selectedDays;
    const dev = selectedDevices;
    const name = (dev === 1) ? "Solo" : (dev === 5 ? "Family" : "Squad");
    return `${name} • ${dev} устройств • ${d} дней`;
  }

  function currentPrice(){
    const p = PRICES[selectedDays] || PRICES[30];
    return payProvider === "stars"
      ? { value: p.stars, unit: "XTR" }
      : { value: p.usdt, unit: "USDT" };
  }

  function updatePayBar(){
    const price = currentPrice();
    $("payTitle").textContent = formatPlanTitle();
    $("paySub").textContent = `К оплате: ${price.value} ${price.unit}`;
    $("btnPay").textContent = payProvider === "stars"
      ? `Оплатить Stars • ${price.value} ${price.unit}`
      : `Оплатить USDT • ${price.value} ${price.unit}`;
  }

  function setProvider(p){
    payProvider = p;
    $("payStars").classList.toggle("active", p==="stars");
    $("payUsdt").classList.toggle("active", p==="usdt");
    updatePayBar();
    if (tg?.HapticFeedback) tg.HapticFeedback.impactOccurred("light");
  }

  $("payStars").onclick = ()=>setProvider("stars");
  $("payUsdt").onclick = ()=>setProvider("usdt");

  function segSet(days){
    selectedDays = days;
    ["seg30","seg90","seg180"].forEach(id=>{
      $(id).classList.toggle("active", Number($(id).dataset.days) === days);
    });
    renderPlans();
    updatePayBar();
  }
  $("seg30").onclick = ()=>segSet(30);
  $("seg90").onclick = ()=>segSet(90);
  $("seg180").onclick = ()=>segSet(180);

  function renderPlans(){
    const list = $("planList");
    const p = PRICES[selectedDays] || PRICES[30];

    // compact rows
    const rows = [
      { dev: 1,  title:"Solo",   desc:"1 устройство • максимум приватности", hint:"" },
      { dev: 5,  title:"Family", desc:"5 устройств • оптимально", hint:"pop" },
      { dev: 10, title:"Squad",  desc:"10 устройств • максимальная выгода", hint:"best" }
    ];

    list.innerHTML = rows.map(r=>{
      const selected = (r.dev === selectedDevices) ? "selected" : "";
      const hint =
        (r.hint==="pop") ? `<span class="hint pop">Популярно</span>` :
        (r.hint==="best") ? `<span class="hint best">Выгоднее</span>` : `<span class="hint">Выбор</span>`;

      // показываем цену в Stars как "основную", а USDT будет в payBar
      return `
        <div class="planRow ${selected}" data-dev="${r.dev}">
          <div class="planLeft">
            <p class="planTitle">${r.title} • ${r.dev} устройств</p>
            <p class="planDesc">${r.desc}</p>
          </div>
          <div class="planRight">
            <div class="pPrice">${p.stars} XTR</div>
            ${hint}
          </div>
        </div>
      `;
    }).join("");

    list.querySelectorAll(".planRow").forEach(el=>{
      el.onclick = ()=>{
        selectedDevices = Number(el.dataset.dev);
        renderPlans();
        updatePayBar();
        $("heroDevicesStat").textContent = selectedDevices + " устройств";
        if (tg?.HapticFeedback) tg.HapticFeedback.impactOccurred("light");
      }
    });
  }

  async function payStars(days, devices){
    clearError();
    show($("orderBox"));
    $("orderStatus").textContent = "creating…";
    $("orderStatus").className = "badge warn";
    $("orderMeta").textContent = "";

    const user_key = await ensureUserKey();

    try{
      const r = await fetch(API_BASE + "/pay/stars/create", {
        method:"POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({ user_key, days, devices })
      });
      const j = await r.json();
      if(!r.ok) throw new Error(j?.detail || "Stars create error");

      $("orderMeta").textContent = `order: ${j.order_id}`;

      if(tg && tg.openInvoice){
        tg.openInvoice(j.invoice_link, ()=>{});
      } else {
        window.open(j.invoice_link, "_blank");
      }

      pollOrder(j.order_id);
      if (tg?.HapticFeedback) tg.HapticFeedback.impactOccurred("medium");
    }catch(e){
      setError(e?.message || String(e));
      $("orderStatus").textContent = "error";
      $("orderStatus").className = "badge bad";
      if (tg?.HapticFeedback) tg.HapticFeedback.notificationOccurred("error");
    }
  }

  async function payUsdt(days, devices){
    clearError();
    show($("orderBox"));
    $("orderStatus").textContent = "creating…";
    $("orderStatus").className = "badge warn";
    $("orderMeta").textContent = "";

    const user_key = await ensureUserKey();

    try{
      const r = await fetch(API_BASE + "/pay/crypto/create", {
        method:"POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({ user_key, days, devices })
      });
      const j = await r.json();
      if(!r.ok) throw new Error(j?.detail || "Crypto create error");

      $("orderMeta").textContent = `order: ${j.order_id}`;
      if(j.invoice_url) window.open(j.invoice_url, "_blank");

      pollOrder(j.order_id);
      if (tg?.HapticFeedback) tg.HapticFeedback.impactOccurred("medium");
    }catch(e){
      setError(e?.message || String(e));
      $("orderStatus").textContent = "error";
      $("orderStatus").className = "badge bad";
      if (tg?.HapticFeedback) tg.HapticFeedback.notificationOccurred("error");
    }
  }

  async function pollOrder(orderId){
    if(pollTimer) clearInterval(pollTimer);

    show($("orderBox"));
    $("orderStatus").textContent = "pending";
    $("orderStatus").className = "badge warn";

    pollTimer = setInterval(async ()=>{
      try{
        const r = await fetch(API_BASE + "/pay/order/" + orderId, { method:"GET" });
        const j = await r.json();

        $("orderStatus").textContent = j.status || "pending";
        $("orderStatus").className = "badge " + ((j.status === "paid") ? "ok" : (j.status === "error" ? "bad" : "warn"));

        const amount = (j.amount != null) ? `${j.amount} ${j.currency || ""}` : "";
        $("orderMeta").textContent = `order: ${j.id} • ${amount} • days: ${j.plan_days || ""} • devices: ${j.devices || ""}`;

        if(j.status === "paid"){
          clearInterval(pollTimer);
          pollTimer = null;

          setSubscriptionUI({ status: "paid", active_until: j.active_until, devices: j.devices });

          // если бэк отдаст config_link — покажем
          if(j.config_link){
            lastConfig = j.config_link;
            $("configText").textContent = lastConfig;
            await renderQR(lastConfig);
            show($("configBox"));
          }

          toast("Оплата успешна");
          if (tg?.HapticFeedback) tg.HapticFeedback.notificationOccurred("success");
        }
      }catch(e){}
    }, 1200);
  }

  $("btnPay").onclick = async ()=>{
    const days = selectedDays;
    const devices = selectedDevices;
    if(payProvider === "stars") return payStars(days, devices);
    return payUsdt(days, devices);
  };

  // ===== REF =====
  $("btnRefCreate").addEventListener("click", async ()=>{
    clearError();
    $("refOut").textContent = "создаю…";
    const user_key = await ensureUserKey();

    try{
      const r = await fetch(API_BASE + "/ref/create", {
        method:"POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({ user_key })
      });
      const j = await r.json();
      if(!r.ok) throw new Error(j?.detail || "ref create error");

      $("refOut").textContent = "Твой код: " + j.code;
      toast("Реф-код готов");
      if (tg?.HapticFeedback) tg.HapticFeedback.impactOccurred("light");
    }catch(e){
      $("refOut").textContent = "";
      setError(e?.message || String(e));
      if (tg?.HapticFeedback) tg.HapticFeedback.notificationOccurred("error");
    }
  });

  $("btnResetId").addEventListener("click", ()=>{
    const id = genUserKey();
    setUserKey(id);
    toast("Новый ID");
  });

  // ===== Init =====
  (async ()=>{
    const saved = localStorage.getItem("zeus_user_key") || "";
    if(saved) setUserKey(saved);

    $("userKey").addEventListener("change", ()=>{
      const v = getUserKey();
      setUserKey(v);
    });

    renderPlans();
    updatePayBar();
    segSet(30);
    setProvider("stars");

    await pingApi();
    setInterval(pingApi, 12000);

    setSubscriptionUI({ status: "none", active_until: null, devices: null });
  })();
</script>
</body>
</html>
