<!doctype html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>ZEUSVPN</title>

  <!-- Telegram WebApp (внутри Telegram будет доступен объект Telegram) -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <style>
    :root{
      --bg0:#07090d;
      --bg1:#0a0f18;
      --card:rgba(255,255,255,.06);
      --card2:rgba(255,255,255,.08);
      --stroke:rgba(255,255,255,.10);
      --stroke2:rgba(255,255,255,.14);
      --text:#f3f6ff;
      --muted:rgba(243,246,255,.65);

      /* черно-синий, НЕ ярко-синий */
      --blue:#1b2a4a;
      --blue2:#0f1a33;

      --ok:#22c55e;
      --warn:#fbbf24;
      --bad:#ef4444;

      --r:18px;
      --shadow: 0 18px 60px rgba(0,0,0,.55);
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      color:var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background:
        radial-gradient(1200px 700px at 80% -10%, rgba(27,42,74,.35), transparent 55%),
        radial-gradient(900px 600px at -20% 20%, rgba(27,42,74,.25), transparent 60%),
        linear-gradient(180deg, var(--bg1), var(--bg0));
      overflow-x:hidden;
    }

    .wrap{
      max-width: 520px;
      margin: 0 auto;
      padding: 18px 16px 32px;
      padding-bottom: calc(32px + env(safe-area-inset-bottom));
    }

    /* верх */
    .top{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:14px;
      margin-top: 6px;
    }
    .brand{
      display:flex;
      align-items:center;
      gap:12px;
      min-width:0;
    }
    .logo{
      width:44px;height:44px;border-radius:14px;
      background: linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.04));
      border:1px solid var(--stroke);
      display:grid;place-items:center;
      overflow:hidden;
      box-shadow: 0 10px 28px rgba(0,0,0,.35);
      flex:0 0 auto;
    }
    .logo img{width:100%;height:100%;object-fit:cover}
    .titlebox{min-width:0}
    .title{
      font-size:16px;
      font-weight:800;
      letter-spacing:.2px;
      margin:0;
      line-height:1.1;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .subtitle{
      margin:4px 0 0;
      font-size:12px;
      color:var(--muted);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    .chip{
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.04);
      padding:10px 12px;
      border-radius: 999px;
      font-size:12px;
      color: var(--muted);
      display:flex;
      align-items:center;
      gap:8px;
      user-select:none;
    }
    .dot{
      width:8px;height:8px;border-radius:99px;
      background: rgba(255,255,255,.18);
      border:1px solid rgba(255,255,255,.18);
    }
    .dot.ok{background:rgba(34,197,94,.8); border-color:rgba(34,197,94,.9)}
    .dot.warn{background:rgba(251,191,36,.85); border-color:rgba(251,191,36,.9)}
    .dot.bad{background:rgba(239,68,68,.85); border-color:rgba(239,68,68,.9)}

    /* карточки */
    .card{
      margin-top: 14px;
      border-radius: var(--r);
      border:1px solid var(--stroke);
      background: linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.045));
      box-shadow: var(--shadow);
      overflow:hidden;
      position:relative;
    }
    .card::before{
      content:"";
      position:absolute; inset:0;
      background:
        radial-gradient(800px 180px at 20% 0%, rgba(27,42,74,.25), transparent 60%),
        radial-gradient(700px 200px at 90% 10%, rgba(255,255,255,.06), transparent 55%);
      pointer-events:none;
      opacity:.9;
    }
    .card > *{position:relative}
    .cardHead{
      padding: 16px 16px 12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }
    .cardTitle{
      font-size:14px;
      font-weight:800;
      margin:0;
      letter-spacing:.2px;
    }
    .small{
      font-size:12px;
      color:var(--muted);
    }
    .divider{
      height:1px;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,.10), transparent);
      margin:0 16px;
    }
    .cardBody{
      padding: 12px 16px 16px;
    }

    /* профиль */
    .profileRow{
      display:flex;
      align-items:center;
      gap:12px;
    }
    .avatar{
      width:46px;height:46px;border-radius:16px;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.06);
      overflow:hidden;
      flex:0 0 auto;
    }
    .avatar img{width:100%;height:100%;object-fit:cover}
    .pmeta{min-width:0}
    .pname{
      font-weight:800;
      font-size:14px;
      margin:0;
      white-space:nowrap;
      overflow:hidden;text-overflow:ellipsis;
    }
    .pid{
      margin:4px 0 0;
      font-size:12px;
      color:var(--muted);
      white-space:nowrap;
      overflow:hidden;text-overflow:ellipsis;
    }

    .subStatus{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      margin-top:12px;
      padding: 12px 12px;
      border:1px solid var(--stroke);
      border-radius: 14px;
      background: rgba(255,255,255,.05);
    }
    .subLeft{min-width:0}
    .subLabel{font-size:12px;color:var(--muted);margin:0}
    .subValue{font-size:14px;font-weight:900;margin:4px 0 0}
    .pill{
      padding:8px 10px;
      border-radius: 999px;
      font-size:12px;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.05);
      color: var(--muted);
      white-space:nowrap;
    }
    .pill.active{border-color: rgba(34,197,94,.35); color: rgba(180,255,210,.92)}
    .pill.none{border-color: rgba(251,191,36,.25); color: rgba(255,235,180,.92)}

    /* CTA */
    .cta{
      display:flex;
      gap:10px;
      margin-top: 14px;
    }
    .btn{
      width:100%;
      appearance:none;
      border:none;
      border-radius: 16px;
      padding: 14px 14px;
      font-weight:900;
      font-size:14px;
      letter-spacing:.2px;
      color: var(--text);
      background: linear-gradient(180deg, rgba(27,42,74,.90), rgba(15,26,51,.92));
      border:1px solid rgba(255,255,255,.10);
      box-shadow: 0 16px 46px rgba(0,0,0,.45);
      cursor:pointer;
      transform: translateZ(0);
      transition: transform .12s ease, filter .12s ease;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
    }
    .btn:active{transform: scale(.985)}
    .btn.secondary{
      background: rgba(255,255,255,.06);
      border:1px solid var(--stroke);
      box-shadow:none;
      color: rgba(243,246,255,.86);
    }

    /* модалка */
    .modal{
      position:fixed; inset:0;
      background: rgba(0,0,0,.55);
      display:none;
      align-items:flex-end;
      justify-content:center;
      padding: 18px 14px;
      padding-bottom: calc(18px + env(safe-area-inset-bottom));
      z-index: 50;
    }
    .modal.show{display:flex}
    .sheet{
      width:100%;
      max-width:520px;
      border-radius: 22px;
      border:1px solid rgba(255,255,255,.12);
      background: linear-gradient(180deg, rgba(10,15,24,.92), rgba(7,9,13,.96));
      box-shadow: 0 26px 90px rgba(0,0,0,.7);
      overflow:hidden;
    }
    .sheetHead{
      padding: 14px 14px 10px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .sheetTitle{font-size:14px;font-weight:900;margin:0}
    .xbtn{
      width:38px;height:38px;border-radius: 14px;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.06);
      color:var(--text);
      display:grid;place-items:center;
      cursor:pointer;
    }

    .sheetBody{
      padding: 12px 14px 14px;
    }

    .row{
      display:flex;
      justify-content:space-between;
      align-items:flex-end;
      gap:12px;
      margin-bottom:10px;
    }
    .row h4{margin:0;font-size:12px;color:var(--muted);font-weight:800}
    .hint{font-size:12px;color:rgba(243,246,255,.50)}

    .chips{
      display:flex; flex-wrap:wrap;
      gap:10px;
      margin-top: 10px;
    }
    .chipBtn{
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.05);
      color: rgba(243,246,255,.85);
      padding: 10px 12px;
      border-radius: 999px;
      font-size:13px;
      font-weight:850;
      cursor:pointer;
      transition: transform .12s ease, background .12s ease, border-color .12s ease;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
      position:relative;
    }
    .chipBtn:active{transform: scale(.985)}
    .chipBtn.selected{
      background: rgba(27,42,74,.38);
      border-color: rgba(255,255,255,.18);
      color: rgba(243,246,255,.96);
    }
    .badge{
      position:absolute;
      top:-8px; right:-6px;
      font-size:10px;
      padding:4px 7px;
      border-radius: 999px;
      background: rgba(255,255,255,.12);
      border:1px solid rgba(255,255,255,.16);
      color: rgba(243,246,255,.9);
      backdrop-filter: blur(10px);
    }

    /* карточка выбора */
    .choiceCard{
      margin-top: 14px;
      border-radius: 18px;
      border:1px solid rgba(255,255,255,.12);
      background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.05));
      padding: 14px;
      position:relative;
      overflow:hidden;
    }
    .choiceCard::before{
      content:"";
      position:absolute; inset:-40px;
      background: radial-gradient(220px 120px at 22% 20%, rgba(255,255,255,.07), transparent 60%),
                  radial-gradient(260px 150px at 85% 30%, rgba(27,42,74,.25), transparent 62%);
      animation: shimmer 3.6s ease-in-out infinite;
      opacity:.8;
      pointer-events:none;
    }
    @keyframes shimmer{
      0%{transform: translateX(-8px)}
      50%{transform: translateX(8px)}
      100%{transform: translateX(-8px)}
    }
    .choiceCard > *{position:relative}

    .choiceTop{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .choiceName{
      font-weight:950;
      font-size:14px;
      margin:0;
    }
    .price{
      font-weight:950;
      font-size:14px;
      margin:0;
      color: rgba(243,246,255,.95);
    }
    .choiceDesc{
      margin:8px 0 0;
      font-size:12px;
      color: rgba(243,246,255,.70);
      line-height:1.35;
    }

    .payGrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      margin-top: 14px;
    }

    .payBtn{
      border-radius: 16px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      padding: 13px 12px;
      text-align:left;
      cursor:pointer;
      transition: transform .12s ease;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
    }
    .payBtn:active{transform: scale(.985)}
    .payBtn strong{display:block;font-size:13px}
    .payBtn span{display:block;font-size:12px;color:rgba(243,246,255,.60);margin-top:4px}

    .payBtn.primary{
      background: linear-gradient(180deg, rgba(27,42,74,.78), rgba(15,26,51,.88));
      border-color: rgba(255,255,255,.14);
    }

    .statusLine{
      margin-top: 12px;
      font-size:12px;
      color: rgba(243,246,255,.62);
      display:flex;
      justify-content:space-between;
      gap:10px;
      align-items:center;
    }
    .spin{
      width:14px;height:14px;border-radius:50%;
      border:2px solid rgba(255,255,255,.18);
      border-top-color: rgba(255,255,255,.75);
      animation: rot .85s linear infinite;
      display:none;
    }
    .spin.show{display:inline-block}
    @keyframes rot{to{transform:rotate(360deg)}}

    /* инструкции swipe */
    .instWrap{
      margin-top: 10px;
    }
    .swipe{
      display:flex;
      gap:12px;
      overflow:auto;
      scroll-snap-type: x mandatory;
      -webkit-overflow-scrolling: touch;
      padding-bottom: 10px;
    }
    .swipe::-webkit-scrollbar{display:none}
    .instCard{
      flex: 0 0 86%;
      scroll-snap-align: start;
      border-radius: 18px;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.06);
      padding: 14px;
      min-height: 140px;
    }
    .instCard h3{
      margin:0;
      font-size:13px;
      font-weight:950;
      letter-spacing:.2px;
    }
    .instCard p{
      margin:10px 0 0;
      font-size:12px;
      color: rgba(243,246,255,.70);
      line-height:1.45;
    }
    .dots{
      display:flex;
      justify-content:center;
      gap:8px;
      margin: 2px 0 0;
    }
    .dots span{
      width:6px;height:6px;border-radius:99px;
      background: rgba(255,255,255,.18);
      border:1px solid rgba(255,255,255,.18);
    }
    .dots span.on{
      background: rgba(255,255,255,.62);
      border-color: rgba(255,255,255,.55);
    }

    /* вывод конфига */
    .configBox{
      margin-top: 12px;
      border-radius: 18px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.30);
      padding: 12px;
      display:none;
    }
    .configBox.show{display:block}
    .configBox .label{
      font-size:12px;color:rgba(243,246,255,.65);font-weight:850;margin:0 0 8px
    }
    .configBox textarea{
      width:100%;
      min-height: 92px;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      color: rgba(243,246,255,.92);
      padding: 10px;
      font-size:12px;
      line-height:1.4;
      outline:none;
      resize:none;
    }
    .copyRow{
      display:flex; gap:10px; margin-top:10px;
    }

    /* снизу менюшка */
    .nav{
      position:sticky;
      bottom: 12px;
      margin-top: 16px;
      border-radius: 18px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(10,15,24,.55);
      backdrop-filter: blur(14px);
      display:flex;
      overflow:hidden;
    }
    .tab{
      flex:1;
      padding: 12px 10px;
      text-align:center;
      font-size:12px;
      font-weight:900;
      color: rgba(243,246,255,.62);
      cursor:pointer;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
    }
    .tab.active{
      color: rgba(243,246,255,.95);
      background: rgba(255,255,255,.06);
    }

    .screen{display:none}
    .screen.show{display:block}

    /* iOS-like переход */
    .fadeSlideIn{
      animation: fsi .22s ease both;
    }
    @keyframes fsi{
      from{opacity:0; transform: translateY(8px)}
      to{opacity:1; transform: translateY(0)}
    }

    /* toast */
    .toast{
      position:fixed;
      left:50%;
      bottom: 20px;
      transform: translateX(-50%);
      background: rgba(0,0,0,.72);
      color: rgba(243,246,255,.92);
      border:1px solid rgba(255,255,255,.12);
      padding: 10px 12px;
      border-radius: 999px;
      font-size:12px;
      box-shadow: 0 18px 60px rgba(0,0,0,.55);
      display:none;
      z-index: 99;
      max-width: 92vw;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .toast.show{display:block}
  </style>
</head>

<body>
  <div class="wrap">

    <div class="top">
      <div class="brand">
        <div class="logo" id="logoBox">
          <img id="logoImg" alt="ZEUSVPN" />
        </div>
        <div class="titlebox">
          <p class="title">ZEUSVPN</p>
          <p class="subtitle" id="subtitle">Премиум-доступ • быстрые сервера</p>
        </div>
      </div>

      <div class="chip" id="apiChip">
        <span class="dot warn" id="apiDot"></span>
        <span id="apiText">API проверка…</span>
      </div>
    </div>

    <!-- HOME -->
    <div class="screen show fadeSlideIn" id="screenHome">
      <div class="card">
        <div class="cardHead">
          <p class="cardTitle">Аккаунт</p>
          <span class="pill none" id="subPill">Подписки нет</span>
        </div>
        <div class="divider"></div>
        <div class="cardBody">

          <div class="profileRow">
            <div class="avatar"><img id="avatarImg" alt="avatar" /></div>
            <div class="pmeta">
              <p class="pname" id="pName">Гость</p>
              <p class="pid" id="pId">TG ID: —</p>
            </div>
          </div>

          <div class="subStatus">
            <div class="subLeft">
              <p class="subLabel">Подписка активна до</p>
              <p class="subValue" id="activeUntilText">—</p>
            </div>
            <div class="pill" id="planMini">—</div>
          </div>

          <div class="cta">
            <button class="btn" id="btnSubscribe">Приобрести подписку</button>
            <button class="btn secondary" id="btnSupport">Поддержка</button>
          </div>

          <div class="configBox" id="configBox">
            <p class="label">Ваш конфиг</p>
            <textarea id="configText" readonly></textarea>
            <div class="copyRow">
              <button class="btn" id="btnCopy">Скопировать</button>
              <button class="btn secondary" id="btnCloseConfig">Скрыть</button>
            </div>
          </div>

        </div>
      </div>

      <div class="card">
        <div class="cardHead">
          <p class="cardTitle">Инструкции</p>
          <span class="small">свайпни →</span>
        </div>
        <div class="divider"></div>
        <div class="cardBody instWrap">
          <div class="swipe" id="swipe">
            <div class="instCard">
              <h3>iOS (V2Box / Streisand)</h3>
              <p>1) Установи клиент из App Store.<br>
                 2) Нажми “Добавить конфиг”.<br>
                 3) Вставь ссылку VLESS и сохрани.<br>
                 4) Подключи профиль.</p>
            </div>
            <div class="instCard">
              <h3>Android (v2rayNG)</h3>
              <p>1) Установи v2rayNG.<br>
                 2) Нажми “+” → Import from clipboard.<br>
                 3) Вставь ссылку и включи подключение.</p>
            </div>
            <div class="instCard">
              <h3>Desktop (Windows/macOS)</h3>
              <p>1) Установи Nekoray / v2rayN.<br>
                 2) Импортируй ссылку VLESS.<br>
                 3) Выбери профиль и включи.</p>
            </div>
          </div>
          <div class="dots" id="dots">
            <span class="on"></span><span></span><span></span>
          </div>
        </div>
      </div>
    </div>

    <!-- PROFILE (упрощенный, без лишнего) -->
    <div class="screen" id="screenProfile">
      <div class="card">
        <div class="cardHead">
          <p class="cardTitle">Профиль</p>
          <span class="small">минимум лишнего</span>
        </div>
        <div class="divider"></div>
        <div class="cardBody">
          <div class="profileRow">
            <div class="avatar"><img id="avatarImg2" alt="avatar2" /></div>
            <div class="pmeta">
              <p class="pname" id="pName2">—</p>
              <p class="pid" id="pId2">TG ID: —</p>
            </div>
          </div>

          <div style="height:12px"></div>

          <button class="btn secondary" id="btnOpenBot">Открыть бота</button>
        </div>
      </div>
    </div>

    <!-- NAV -->
    <div class="nav">
      <div class="tab active" data-tab="home">Главная</div>
      <div class="tab" data-tab="profile">Профиль</div>
    </div>
  </div>

  <!-- MODAL -->
  <div class="modal" id="modal">
    <div class="sheet">
      <div class="sheetHead">
        <p class="sheetTitle">Выбор подписки</p>
        <div class="xbtn" id="closeModal">✕</div>
      </div>
      <div class="divider"></div>
      <div class="sheetBody">

        <div class="row">
          <h4>Устройства</h4>
          <div class="hint">выбери слот</div>
        </div>
        <div class="chips" id="deviceChips">
          <div class="chipBtn selected" data-dev="1">1</div>
          <div class="chipBtn" data-dev="3">3</div>
          <div class="chipBtn" data-dev="5">5</div>
          <div class="chipBtn" data-dev="10">10</div>
        </div>

        <div style="height:12px"></div>

        <div class="row">
          <h4>Срок</h4>
          <div class="hint">дней</div>
        </div>
        <div class="chips" id="dayChips">
          <div class="chipBtn selected" data-days="30">
            30 <span class="badge">Популярно</span>
          </div>
          <div class="chipBtn" data-days="90">90</div>
          <div class="chipBtn" data-days="180">
            180 <span class="badge">Выгоднее</span>
          </div>
        </div>

        <div class="choiceCard" id="choiceCard">
          <div class="choiceTop">
            <p class="choiceName" id="choiceName">30 дней • 1 устройство</p>
            <p class="price" id="choicePrice">199 XTR</p>
          </div>
          <p class="choiceDesc" id="choiceDesc">
            Доступ активируется после оплаты. После оплаты появится конфиг + “Активна до …”.
          </p>
        </div>

        <div class="payGrid">
          <button class="payBtn primary" id="payStars">
            <strong>Оплатить Stars</strong>
            <span>моментально в Telegram</span>
          </button>
          <button class="payBtn" id="payCrypto">
            <strong>Оплатить USDT</strong>
            <span>через Crypto Bot</span>
          </button>
        </div>

        <div class="statusLine">
          <div style="display:flex;gap:10px;align-items:center;min-width:0">
            <span class="spin" id="spin"></span>
            <span id="statusText">Выбери параметры и способ оплаты</span>
          </div>
          <span class="small" id="orderHint"></span>
        </div>

      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script>
    // ========= НАСТРОЙКИ =========
    const API_BASE = "https://api.45.133.251.210.nip.io:8443"; // твой nginx:8443
    const LOGO_URL = "./logo.png"; // положи logo.png рядом с index.html
    const SUPPORT_URL = "https://t.me/"; // потом поставишь свой саппорт
    const BOT_URL = "https://t.me/"; // потом поставишь бота

    // ========= STATE =========
    const state = {
      user_key: "site-guest",
      tg: { id:null, username:null, name:"Гость", photo:null },
      devices: 1,
      days: 30,
      lastOrderId: null,
      lastOrder: null,
      pollTimer: null,
      paidActiveUntil: null
    };

    // ========= DOM =========
    const $ = (id)=>document.getElementById(id);
    const apiDot = $("apiDot");
    const apiText = $("apiText");
    const subPill = $("subPill");
    const activeUntilText = $("activeUntilText");
    const planMini = $("planMini");

    const pName = $("pName"), pId = $("pId"), avatarImg = $("avatarImg");
    const pName2 = $("pName2"), pId2 = $("pId2"), avatarImg2 = $("avatarImg2");

    const btnSubscribe = $("btnSubscribe");
    const btnSupport = $("btnSupport");

    const modal = $("modal");
    const closeModal = $("closeModal");

    const deviceChips = $("deviceChips");
    const dayChips = $("dayChips");

    const choiceName = $("choiceName");
    const choicePrice = $("choicePrice");

    const payStars = $("payStars");
    const payCrypto = $("payCrypto");

    const statusText = $("statusText");
    const orderHint = $("orderHint");
    const spin = $("spin");

    const configBox = $("configBox");
    const configText = $("configText");
    const btnCopy = $("btnCopy");
    const btnCloseConfig = $("btnCloseConfig");

    const toast = $("toast");

    // ========= HELPERS =========
    function showToast(msg){
      toast.textContent = msg;
      toast.classList.add("show");
      setTimeout(()=>toast.classList.remove("show"), 2200);
    }

    function haptic(type="light"){
      try{
        if(window.Telegram?.WebApp?.HapticFeedback){
          const h = window.Telegram.WebApp.HapticFeedback;
          if(type==="success") h.notificationOccurred("success");
          else if(type==="error") h.notificationOccurred("error");
          else h.impactOccurred("light");
        }
      }catch(e){}
    }

    function fmtDate(isoOrMs){
      if(!isoOrMs) return "—";
      const d = typeof isoOrMs === "number" ? new Date(isoOrMs) : new Date(isoOrMs);
      if(isNaN(d)) return "—";
      const dd = String(d.getDate()).padStart(2,"0");
      const mm = String(d.getMonth()+1).padStart(2,"0");
      const yy = d.getFullYear();
      return `${dd}.${mm}.${yy}`;
    }

    function priceFor(days){
      // подставь реальные цены если надо.
      // сейчас: 30=199, 90=399, 180=599 (как у тебя в env)
      if(days==30) return 199;
      if(days==90) return 399;
      if(days==180) return 599;
      return 0;
    }

    function updateChoiceUI(){
      // chips select
      [...deviceChips.querySelectorAll(".chipBtn")].forEach(b=>{
        b.classList.toggle("selected", Number(b.dataset.dev)===state.devices);
      });
      [...dayChips.querySelectorAll(".chipBtn")].forEach(b=>{
        b.classList.toggle("selected", Number(b.dataset.days)===state.days);
      });

      choiceName.textContent = `${state.days} дней • ${state.devices} устройств`;
      const p = priceFor(state.days);
      choicePrice.textContent = p ? `${p} XTR` : "—";

      // main button text
      const hasActive = !!state.paidActiveUntil;
      btnSubscribe.textContent = hasActive ? "Продлить подписку" : "Приобрести подписку";
    }

    function setSubUI(order){
      // order: {status, active_until, plan_days, devices, config_link}
      const isActive = order?.active_until && (order.status==="paid" || order.status==="active");
      if(isActive){
        subPill.classList.remove("none");
        subPill.classList.add("active");
        subPill.textContent = "Подписка активна";
        activeUntilText.textContent = fmtDate(order.active_until);
        planMini.textContent = `${order.plan_days}д • ${order.devices}устр`;
        state.paidActiveUntil = order.active_until;
      }else{
        subPill.classList.remove("active");
        subPill.classList.add("none");
        subPill.textContent = "Подписки нет";
        activeUntilText.textContent = "—";
        planMini.textContent = "—";
        state.paidActiveUntil = null;
      }
      updateChoiceUI();
    }

    async function apiHealth(){
      try{
        const r = await fetch(`${API_BASE}/health`, { method:"GET" });
        if(!r.ok) throw new Error("health not ok");
        apiDot.className = "dot ok";
        apiText.textContent = "API online";
        return true;
      }catch(e){
        apiDot.className = "dot bad";
        apiText.textContent = "API/SSL ошибка";
        // в браузере “Failed to fetch” часто из-за сертификата
        return false;
      }
    }

    async function apiPost(path, body){
      const r = await fetch(`${API_BASE}${path}`,{
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify(body),
        mode:"cors"
      });
      // если SSL/блок — тут прилетит TypeError, поймаем выше
      if(!r.ok){
        const t = await r.text().catch(()=> "");
        throw new Error(`HTTP ${r.status}: ${t}`);
      }
      return r.json();
    }

    async function apiGet(path){
      const r = await fetch(`${API_BASE}${path}`,{ method:"GET", mode:"cors" });
      if(!r.ok){
        const t = await r.text().catch(()=> "");
        throw new Error(`HTTP ${r.status}: ${t}`);
      }
      return r.json();
    }

    function openInvoice(url){
      // Telegram: openInvoice (правильно)
      if(window.Telegram?.WebApp?.openInvoice){
        statusText.textContent = "Открываю инвойс в Telegram…";
        return new Promise((resolve)=>{
          window.Telegram.WebApp.openInvoice(url, (status)=>{
            // status: paid / cancelled / failed / pending (зависит от Telegram)
            resolve(status);
          });
        });
      }
      // Browser
      window.open(url, "_blank");
      return Promise.resolve("opened");
    }

    function startPolling(order_id){
      clearInterval(state.pollTimer);
      state.pollTimer = setInterval(async ()=>{
        try{
          const o = await apiGet(`/pay/order/${order_id}`);
          state.lastOrder = o;

          if(o.status === "paid" || o.status === "active"){
            clearInterval(state.pollTimer);
            spin.classList.remove("show");
            statusText.textContent = "Оплата подтверждена ✅";
            orderHint.textContent = "";

            setSubUI(o);

            if(o.config_link){
              configText.value = o.config_link;
              configBox.classList.add("show");
            }else{
              // если backend пока не пишет config_link автоматически
              showToast("Оплата ок. Конфиг появится после выдачи.");
            }
            haptic("success");
          }else{
            statusText.textContent = `Ожидаю оплату… (${o.status})`;
          }
        }catch(e){
          // если временно упало — не убиваем, просто показываем
          statusText.textContent = "Проверяю оплату…";
        }
      }, 1200);
    }

    function showModal(){
      modal.classList.add("show");
      document.body.style.overflow = "hidden";
      updateChoiceUI();
    }
    function hideModal(){
      modal.classList.remove("show");
      document.body.style.overflow = "";
      spin.classList.remove("show");
      statusText.textContent = "Выбери параметры и способ оплаты";
      orderHint.textContent = "";
      clearInterval(state.pollTimer);
    }

    // ========= Telegram user =========
    function loadTelegramUser(){
      const tg = window.Telegram?.WebApp;
      if(tg){
        try{ tg.ready(); }catch(e){}
        try{ tg.expand(); }catch(e){}
      }

      const u = tg?.initDataUnsafe?.user;
      if(u){
        state.tg.id = u.id;
        state.tg.username = u.username ? "@"+u.username : "";
        state.tg.name = [u.first_name, u.last_name].filter(Boolean).join(" ").trim() || "Пользователь";
        state.tg.photo = u.photo_url || null;
        state.user_key = String(u.id); // ключ в backend (потом можно поменять)
      }else{
        // Browser fallback
        state.user_key = "site-guest";
        state.tg = { id:null, username:"", name:"Гость (browser)", photo:null };
      }

      // render
      pName.textContent = state.tg.name + (state.tg.username ? ` • ${state.tg.username}` : "");
      pId.textContent = `TG ID: ${state.tg.id ?? "—"}`;

      pName2.textContent = pName.textContent;
      pId2.textContent = pId.textContent;

      const img = state.tg.photo || "data:image/svg+xml;charset=utf-8,"+encodeURIComponent(`
        <svg xmlns='http://www.w3.org/2000/svg' width='120' height='120'>
          <rect width='100%' height='100%' fill='rgba(255,255,255,.08)'/>
          <circle cx='60' cy='52' r='22' fill='rgba(255,255,255,.22)'/>
          <rect x='24' y='80' width='72' height='24' rx='12' fill='rgba(255,255,255,.16)'/>
        </svg>
      `);
      avatarImg.src = img;
      avatarImg2.src = img;
    }

    // ========= UI nav =========
    function showScreen(name){
      const home = $("screenHome");
      const prof = $("screenProfile");
      home.classList.remove("show","fadeSlideIn");
      prof.classList.remove("show","fadeSlideIn");
      if(name==="home"){ home.classList.add("show","fadeSlideIn"); }
      else { prof.classList.add("show","fadeSlideIn"); }

      document.querySelectorAll(".tab").forEach(t=>{
        t.classList.toggle("active", t.dataset.tab===name);
      });
    }

    // ========= instructions dots =========
    function bindSwipeDots(){
      const swipe = $("swipe");
      const dots = [...$("dots").children];
      function update(){
        const cards = swipe.children;
        let best = 0;
        let bestDist = Infinity;
        for(let i=0;i<cards.length;i++){
          const rect = cards[i].getBoundingClientRect();
          const dist = Math.abs(rect.left - 16); // приблизительно
          if(dist<bestDist){ bestDist=dist; best=i; }
        }
        dots.forEach((d,i)=>d.classList.toggle("on", i===best));
      }
      swipe.addEventListener("scroll", ()=>requestAnimationFrame(update), {passive:true});
      update();
    }

    // ========= init =========
    (function init(){
      // logo
      $("logoImg").src = LOGO_URL;

      loadTelegramUser();
      bindSwipeDots();

      // check API
      apiHealth();

      // nav
      document.querySelectorAll(".tab").forEach(t=>{
        t.addEventListener("click", ()=>showScreen(t.dataset.tab));
      });

      // buttons
      btnSupport.addEventListener("click", ()=>{ window.open(SUPPORT_URL, "_blank"); });
      $("btnOpenBot").addEventListener("click", ()=>{ window.open(BOT_URL, "_blank"); });

      btnSubscribe.addEventListener("click", ()=>{
        haptic();
        showModal();
      });

      closeModal.addEventListener("click", hideModal);
      modal.addEventListener("click", (e)=>{
        if(e.target === modal) hideModal();
      });

      // chips
      deviceChips.addEventListener("click", (e)=>{
        const b = e.target.closest(".chipBtn"); if(!b) return;
        state.devices = Number(b.dataset.dev);
        updateChoiceUI();
        haptic();
      });
      dayChips.addEventListener("click", (e)=>{
        const b = e.target.closest(".chipBtn"); if(!b) return;
        state.days = Number(b.dataset.days);
        updateChoiceUI();
        haptic();
      });

      // copy
      btnCopy.addEventListener("click", async ()=>{
        try{
          await navigator.clipboard.writeText(configText.value || "");
          showToast("Скопировано");
          haptic("success");
        }catch(e){
          showToast("Не удалось скопировать");
          haptic("error");
        }
      });
      btnCloseConfig.addEventListener("click", ()=>configBox.classList.remove("show"));

      // pay stars
      payStars.addEventListener("click", async ()=>{
        try{
          spin.classList.add("show");
          statusText.textContent = "Создаю заказ (Stars)…";
          orderHint.textContent = "";

          const res = await apiPost("/pay/stars/create", {
            user_key: state.user_key,
            days: state.days,
            devices: state.devices
          });

          state.lastOrderId = res.order_id;
          orderHint.textContent = `#${res.order_id}`;
          statusText.textContent = "Открываю оплату…";

          // открыть invoice
          const invStatus = await openInvoice(res.invoice_link);

          // стартуем polling в любом случае (после оплаты Telegram пришлет webhook)
          statusText.textContent = "Ожидаю оплату…";
          spin.classList.add("show");
          startPolling(res.order_id);

          // если Telegram вернул failed
          if(invStatus === "failed"){
            showToast("Invoice: failed (проверь SSL/API или Stars)");
            haptic("error");
          }
        }catch(err){
          spin.classList.remove("show");
          statusText.textContent = "Ошибка создания заказа";
          // самая частая причина: SSL/сертификат — браузер режет fetch
          showToast("Failed to fetch / SSL / CORS. Проверь HTTPS сертификат API.");
          haptic("error");
        }
      });

      // pay crypto (USDT)
      payCrypto.addEventListener("click", async ()=>{
        try{
          spin.classList.add("show");
          statusText.textContent = "Создаю инвойс (USDT)…";
          orderHint.textContent = "";

          const res = await apiPost("/pay/crypto/create", {
            user_key: state.user_key,
            days: state.days,
            devices: state.devices
          });

          state.lastOrderId = res.order_id;
          orderHint.textContent = `#${res.order_id}`;
          statusText.textContent = "Открываю оплату USDT…";

          // res.invoice_url (или invoice_link — зависит как ты отдаешь)
          const url = res.invoice_url || res.invoice_link || res.url;
          if(!url) throw new Error("invoice_url missing");

          // в Telegram можно тоже открыть ссылку обычным способом
          window.open(url, "_blank");

          statusText.textContent = "Ожидаю оплату…";
          spin.classList.add("show");
          startPolling(res.order_id);

        }catch(err){
          spin.classList.remove("show");
          statusText.textContent = "Ошибка создания инвойса";
          showToast("Failed to fetch / SSL / CORS или не настроен CryptoPay");
          haptic("error");
        }
      });

      // Попробуем подтянуть последнюю подписку (если хочешь — позже сделаем /me)
      // Пока просто выставим UI "нет подписки"
      setSubUI(null);

      updateChoiceUI();
    })();
  </script>
</body>
</html>
