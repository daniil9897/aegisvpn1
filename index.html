<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>ZEUSVPN</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <style>
    :root{
      /* ===== iOS Light palette ===== */
      --bg: #F2F2F7;                 /* iOS grouped background */
      --card: rgba(255,255,255,.78); /* glass */
      --stroke: rgba(0,0,0,.08);
      --stroke2: rgba(0,0,0,.12);
      --text: #0B0B0F;
      --muted: rgba(60,60,67,.60);   /* iOS secondary label */
      --muted2: rgba(60,60,67,.36);  /* iOS tertiary label */
      --blue: #007AFF;               /* iOS system blue */
      --green:#34C759;
      --red:#FF3B30;
      --shadow: 0 18px 50px rgba(0,0,0,.12);
      --shadow2: 0 10px 24px rgba(0,0,0,.10);
      --r: 20px;
      --r2: 26px;

      /* spring-ish timings */
      --ease: cubic-bezier(.2,.9,.2,1);
      --ease2: cubic-bezier(.16,1,.3,1);
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, -apple-system, BlinkMacSystemFont, "SF Pro Display","SF Pro Text", Inter, Segoe UI, Roboto, Arial, sans-serif;
      color:var(--text);
      background:
        radial-gradient(1200px 600px at 50% -10%, rgba(0,122,255,.14), rgba(0,122,255,0) 60%),
        radial-gradient(900px 500px at 90% 10%, rgba(52,199,89,.10), rgba(52,199,89,0) 65%),
        linear-gradient(180deg, var(--bg), #fff);
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      overflow-x:hidden;
    }

    .wrap{
      max-width:520px;
      margin:0 auto;
      padding:
        calc(14px + env(safe-area-inset-top))
        14px
        calc(18px + env(safe-area-inset-bottom))
        14px;
    }

    /* ===== Top bar (iOS-like) ===== */
    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      margin-bottom:12px;
    }
    .brand{
      display:flex; align-items:center; gap:10px;
      min-width:0;
    }
    .logo{
      width:40px;height:40px;border-radius:14px;
      background: rgba(255,255,255,.85);
      border:1px solid var(--stroke);
      box-shadow: var(--shadow2);
      overflow:hidden;
      display:grid; place-items:center;
      flex:0 0 auto;
    }
    .logo img{width:100%;height:100%;object-fit:cover;display:block}
    .logo .fallback{
      font-weight:900;
      color: rgba(0,0,0,.55);
    }
    .brandText{min-width:0}
    .brandTitle{
      font-weight:900;
      font-size:15px;
      line-height:1.1;
      letter-spacing:.2px;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }
    .brandSub{
      margin-top:2px;
      font-size:12.5px;
      color: var(--muted);
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }

    .apiPill{
      display:flex; align-items:center; gap:8px;
      padding:8px 10px;
      border-radius:999px;
      background: rgba(255,255,255,.70);
      border:1px solid var(--stroke);
      box-shadow: var(--shadow2);
      font-size:12.5px;
      color: rgba(60,60,67,.82);
      user-select:none;
    }
    .dot{
      width:8px;height:8px;border-radius:99px;
      background: rgba(0,0,0,.25);
    }

    /* ===== iOS Segmented control ===== */
    .seg{
      background: rgba(255,255,255,.82);
      border:1px solid var(--stroke);
      border-radius: 14px;
      padding:4px;
      display:flex;
      gap:4px;
      box-shadow: var(--shadow2);
      margin-bottom:12px;
      position:sticky;
      top: calc(10px + env(safe-area-inset-top));
      z-index:10;
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
    }
    .seg button{
      flex:1;
      border:0;
      background:transparent;
      padding:10px 10px;
      border-radius: 11px;
      font-weight:800;
      font-size:12.5px;
      color: rgba(60,60,67,.78);
      cursor:pointer;
      transition: transform .12s var(--ease), background .2s var(--ease), color .2s var(--ease);
      -webkit-tap-highlight-color: transparent;
    }
    .seg button:active{transform: scale(.99)}
    .seg button.active{
      background: rgba(255,255,255,.95);
      color: var(--text);
      box-shadow: 0 6px 16px rgba(0,0,0,.10);
    }

    /* ===== iOS card (glass) ===== */
    .card{
      background: var(--card);
      border:1px solid var(--stroke);
      border-radius: var(--r2);
      box-shadow: var(--shadow);
      backdrop-filter: blur(18px);
      -webkit-backdrop-filter: blur(18px);
      overflow:hidden;
      margin-bottom:12px;
    }
    .cardInner{padding:16px}
    .row{display:flex; align-items:center; justify-content:space-between; gap:12px}
    .title{
      font-weight:950;
      font-size:16px;
      letter-spacing:.2px;
    }
    .muted{color:var(--muted); font-size:13px; line-height:1.45}
    .divider{
      height:1px;
      background: linear-gradient(90deg, rgba(0,0,0,0), rgba(0,0,0,.10), rgba(0,0,0,0));
      margin:12px 0;
    }

    /* ===== Profile line ===== */
    .userBox{display:flex; align-items:center; gap:12px; min-width:0}
    .avatar{
      width:46px;height:46px;border-radius:16px;
      background: rgba(255,255,255,.90);
      border:1px solid var(--stroke);
      overflow:hidden;
      box-shadow: var(--shadow2);
      flex:0 0 auto;
      display:grid; place-items:center;
    }
    .avatar img{width:100%;height:100%;object-fit:cover;display:block}
    .avatar .fallback{
      font-weight:900;
      color: rgba(0,0,0,.45);
    }
    .userMeta{min-width:0}
    .userName{
      font-weight:900;
      font-size:14px;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }
    .userId{
      margin-top:2px;
      font-size:12px;
      color: var(--muted);
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
    }

    /* ===== iOS Buttons ===== */
    .btn{
      width:100%;
      border:0;
      border-radius: 16px;
      padding:14px 14px;
      font-weight:900;
      letter-spacing:.15px;
      font-size:15px;
      cursor:pointer;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
      transition: transform .12s var(--ease), filter .2s var(--ease), opacity .2s var(--ease);
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:10px;
    }
    .btn:active{transform: scale(.985)}
    .btnPrimary{
      background: var(--blue);
      color: white;
      box-shadow: 0 12px 26px rgba(0,122,255,.25);
    }
    .btnSecondary{
      background: rgba(255,255,255,.92);
      border:1px solid var(--stroke);
      color: var(--text);
      box-shadow: 0 10px 22px rgba(0,0,0,.10);
    }
    .btnGhost{
      background: rgba(255,255,255,.0);
      border:1px solid var(--stroke);
      color: var(--text);
    }
    .btnSmallRow{display:flex; gap:10px}
    .btnSmallRow .btn{flex:1; padding:12px 12px; font-size:14px}

    /* ===== selection chips (iOS pill) ===== */
    .chips{display:flex; flex-wrap:wrap; gap:10px}
    .chip{
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.86);
      border-radius:999px;
      padding:10px 12px;
      font-size:13px;
      font-weight:900;
      cursor:pointer;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
      transition: transform .12s var(--ease), box-shadow .2s var(--ease), border-color .2s var(--ease);
      display:inline-flex;
      align-items:center;
      gap:8px;
    }
    .chip:active{transform: scale(.99)}
    .chip.selected{
      border-color: rgba(0,122,255,.40);
      box-shadow: 0 0 0 6px rgba(0,122,255,.10);
    }
    .chipTag{
      font-size:11px;
      font-weight:950;
      background: rgba(0,122,255,.12);
      color: rgba(0,122,255,.95);
      padding:3px 8px;
      border-radius:999px;
    }

    /* ===== screens (iOS transitions) ===== */
    .screen{display:none}
    .screen.active{display:block}
    .in{animation: in .34s var(--ease2) both}
    .out{animation: out .22s var(--ease) both}
    @keyframes in{from{opacity:0; transform: translateY(10px)} to{opacity:1; transform: translateY(0)}}
    @keyframes out{from{opacity:1; transform: translateY(0)} to{opacity:0; transform: translateY(8px)}}

    /* ===== bottom sheet modal (iOS) ===== */
    .backdrop{
      position:fixed; inset:0;
      background: rgba(0,0,0,.32);
      display:none;
      justify-content:center;
      align-items:flex-end;
      padding: 12px 12px calc(12px + env(safe-area-inset-bottom)) 12px;
      z-index:50;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }
    .backdrop.show{display:flex}

    .sheet{
      width:min(520px, 100%);
      background: rgba(255,255,255,.88);
      border:1px solid var(--stroke);
      border-radius: 28px;
      box-shadow: 0 40px 120px rgba(0,0,0,.24);
      overflow:hidden;
      transform: translateY(18px);
      opacity:0;
    }
    .sheet.show{
      animation: sheetIn .42s var(--ease2) forwards;
    }
    @keyframes sheetIn{
      0%{transform: translateY(26px); opacity:0}
      60%{transform: translateY(-2px); opacity:1}
      100%{transform: translateY(0); opacity:1}
    }
    .sheetHeader{
      padding:12px 14px;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      border-bottom:1px solid rgba(0,0,0,.08);
    }
    .grab{
      width:40px;height:5px;border-radius:99px;
      background: rgba(60,60,67,.22);
      margin: 8px auto 0 auto;
    }
    .sheetTitle{font-weight:950; font-size:15px}
    .close{
      width:36px;height:36px;border-radius:12px;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.85);
      cursor:pointer;
      display:grid; place-items:center;
      font-weight:950;
      transition: transform .12s var(--ease);
      -webkit-tap-highlight-color: transparent;
    }
    .close:active{transform: scale(.98)}
    .sheetBody{
      padding:14px;
      max-height: 74vh;
      overflow:auto;
    }

    /* ===== price card ===== */
    .priceCard{
      border-radius: 22px;
      border:1px solid rgba(0,0,0,.08);
      background:
        radial-gradient(900px 260px at 20% 0%, rgba(0,122,255,.14), rgba(0,122,255,0) 58%),
        linear-gradient(180deg, rgba(255,255,255,.92), rgba(255,255,255,.78));
      box-shadow: 0 16px 40px rgba(0,0,0,.14);
      padding:14px;
      position:relative;
      overflow:hidden;
    }
    .priceTop{display:flex; align-items:flex-start; justify-content:space-between; gap:10px}
    .pName{font-weight:950; font-size:14px}
    .pMeta{margin-top:3px; color:var(--muted); font-size:12.5px}
    .pPrice{
      font-weight:1000;
      font-size:20px;
      letter-spacing:.2px;
      line-height:1;
      white-space:nowrap;
    }
    .pPrice small{font-size:12px; color:var(--muted); font-weight:900}

    /* subtle shimmer */
    .priceCard::after{
      content:"";
      position:absolute; inset:-50% -70%;
      background: linear-gradient(90deg, rgba(255,255,255,0) 0%, rgba(255,255,255,.55) 50%, rgba(255,255,255,0) 100%);
      transform: translateX(-40%);
      animation: shimmer 1.6s infinite;
      opacity:.20;
      pointer-events:none;
    }
    @keyframes shimmer { to{ transform: translateX(60%);} }

    /* ===== toast ===== */
    .toast{
      position:fixed;
      left:50%;
      bottom: calc(18px + env(safe-area-inset-bottom));
      transform: translateX(-50%) translateY(8px);
      background: rgba(255,255,255,.92);
      border:1px solid var(--stroke);
      box-shadow: 0 18px 46px rgba(0,0,0,.18);
      padding:10px 12px;
      border-radius: 999px;
      font-size:12.5px;
      color: rgba(60,60,67,.90);
      opacity:0;
      pointer-events:none;
      transition: opacity .18s var(--ease), transform .18s var(--ease);
      z-index:100;
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
    }
    .toast.show{opacity:1; transform: translateX(-50%) translateY(0)}

    /* ===== instruction swipe ===== */
    .swipeWrap{overflow:hidden}
    .track{
      display:flex; gap:12px;
      transform: translateX(0);
      transition: transform .34s var(--ease2);
      will-change: transform;
    }
    .miniCard{
      min-width:100%;
      background: rgba(255,255,255,.78);
      border:1px solid var(--stroke);
      border-radius: var(--r2);
      box-shadow: var(--shadow);
      backdrop-filter: blur(18px);
      -webkit-backdrop-filter: blur(18px);
      overflow:hidden;
    }
    .miniCard .cardInner{padding:16px}
  </style>
</head>

<body>
  <div class="toast" id="toast">Скопировано</div>

  <div class="wrap">
    <!-- Topbar -->
    <div class="topbar">
      <div class="brand">
        <div class="logo" id="logoBox">
          <img src="logo.png" alt="ZEUSVPN" onerror="this.remove(); const s=document.createElement('div'); s.className='fallback'; s.textContent='Z'; document.getElementById('logoBox').appendChild(s);">
        </div>
        <div class="brandText">
          <div class="brandTitle">ZEUSVPN</div>
          <div class="brandSub">iOS Premium • Minimal</div>
        </div>
      </div>
      <div class="apiPill">
        <span class="dot" id="apiDot"></span>
        <span id="apiText">API</span>
      </div>
    </div>

    <!-- Segmented -->
    <div class="seg">
      <button class="active" data-screen="home">Главная</button>
      <button data-screen="profile">Профиль</button>
      <button data-screen="instructions">Инструкция</button>
    </div>

    <!-- HOME -->
    <div class="screen active in" id="screen-home">
      <div class="card">
        <div class="cardInner">
          <div class="row">
            <div class="userBox">
              <div class="avatar" id="avatar"><div class="fallback" id="avatarFallback">Z</div></div>
              <div class="userMeta">
                <div class="userName" id="userName">Гость</div>
                <div class="userId" id="tgLine">tg_id: —</div>
              </div>
            </div>
            <div style="text-align:right">
              <div class="muted" style="font-weight:900; color:rgba(60,60,67,.70)">Подписка</div>
              <div style="font-weight:950" id="activeUntil">нет</div>
            </div>
          </div>

          <div class="divider"></div>

          <div class="muted" style="margin-bottom:12px">
            Выбери срок и устройства → оплати Stars или USDT → получишь конфиг.
          </div>

          <button class="btn btnPrimary" id="btnSubscribe">Приобрести подписку</button>
        </div>
      </div>

      <div class="card">
        <div class="cardInner">
          <div class="title">Быстрые действия</div>
          <div class="muted" style="margin-top:6px">Инвойс и конфиг появятся в модальном окне.</div>

          <div class="divider"></div>

          <button class="btn btnSecondary" id="btnOpenSheet">Открыть выбор подписки</button>
        </div>
      </div>
    </div>

    <!-- PROFILE (минимально как ты просил) -->
    <div class="screen" id="screen-profile">
      <div class="card">
        <div class="cardInner">
          <div class="title">Профиль</div>
          <div class="muted" style="margin-top:6px">Минимум: Telegram + твой ID.</div>

          <div class="divider"></div>

          <div class="row" style="align-items:flex-start">
            <div style="flex:1; min-width:0">
              <div class="muted" style="font-weight:900">Telegram</div>
              <div style="margin-top:6px; font-weight:950" id="profileName">—</div>
              <div class="userId" style="margin-top:6px" id="profileTgId">tg_id: —</div>
            </div>
          </div>

          <div class="divider"></div>

          <div class="muted" style="font-weight:900">user_key</div>
          <div class="userId" style="margin-top:6px; font-size:13px" id="profileUserKey">—</div>

          <div style="height:10px"></div>
          <button class="btn btnSecondary" id="btnNewKey">Сбросить / новый ID</button>
        </div>
      </div>
    </div>

    <!-- INSTRUCTIONS -->
    <div class="screen" id="screen-instructions">
      <div class="card">
        <div class="cardInner">
          <div class="title">Инструкция</div>
          <div class="muted" style="margin-top:6px">Свайпай карточки (как iOS).</div>

          <div class="divider"></div>

          <div class="swipeWrap">
            <div class="track" id="track">
              <div class="miniCard">
                <div class="cardInner">
                  <div class="title">iOS (V2Box / Streisand)</div>
                  <div class="muted" style="margin-top:8px; line-height:1.6">
                    1) Скопируй конфиг<br>
                    2) Import from Clipboard / Add Profile<br>
                    3) Connect
                  </div>
                </div>
              </div>

              <div class="miniCard">
                <div class="cardInner">
                  <div class="title">Android (v2rayNG)</div>
                  <div class="muted" style="margin-top:8px; line-height:1.6">
                    1) Скопируй конфиг<br>
                    2) + → Import from Clipboard<br>
                    3) Подключись
                  </div>
                </div>
              </div>

              <div class="miniCard">
                <div class="cardInner">
                  <div class="title">Desktop</div>
                  <div class="muted" style="margin-top:8px; line-height:1.6">
                    1) Скопируй VLESS ссылку<br>
                    2) Import / Add profile<br>
                    3) Connect
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div style="height:12px"></div>
          <div class="btnSmallRow">
            <button class="btn btnSecondary" id="prev">Назад</button>
            <button class="btn btnSecondary" id="next">Далее</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Bottom Sheet -->
  <div class="backdrop" id="backdrop">
    <div class="sheet" id="sheet">
      <div class="grab"></div>
      <div class="sheetHeader">
        <div class="sheetTitle">Подписка ZEUSVPN</div>
        <div class="close" id="close">✕</div>
      </div>

      <div class="sheetBody">
        <div class="muted">Выбери срок и устройства. Цена и кнопка оплаты обновятся.</div>

        <div class="divider"></div>

        <div class="muted" style="font-weight:900">Срок</div>
        <div style="height:8px"></div>
        <div class="chips" id="chipsDays"></div>

        <div style="height:14px"></div>

        <div class="muted" style="font-weight:900">Устройства</div>
        <div style="height:8px"></div>
        <div class="chips" id="chipsDevices"></div>

        <div class="divider"></div>

        <div class="priceCard" id="priceCard">
          <div class="priceTop">
            <div>
              <div class="pName" id="choiceTitle">Выбор</div>
              <div class="pMeta" id="choiceMeta">—</div>
            </div>
            <div class="pPrice" id="priceText">—</div>
          </div>

          <div style="height:12px"></div>

          <button class="btn btnPrimary" id="payStars">Оплатить Stars</button>
          <div style="height:10px"></div>
          <button class="btn btnSecondary" id="payUsdt">Оплатить USDT (CryptoPay)</button>
        </div>

        <div class="divider"></div>

        <div class="muted" style="font-weight:900">Статус</div>
        <div class="muted" id="orderLine" style="margin-top:6px">Нет активного заказа</div>

        <div style="height:10px"></div>
        <button class="btn btnSecondary" id="copyBtn" style="display:none">Скопировать конфиг</button>
      </div>
    </div>
  </div>

  <script>
    /* =========================
       CONFIG
    ========================= */
    const API_BASE = "https://api.45.133.251.210.nip.io:8443";
    const DEFAULT_INBOUND_ID = 1;

    const PRICES = { 30:199, 90:399, 180:599 };
    const DEVICE_CHOICES = [1,3,5,10];

    const state = {
      screen: "home",
      slide: 0,
      user: { tg_id:null, name:"Гость", photo_url:null, user_key:null },
      plan: { days:30, devices:1, price:PRICES[30] },
      orderId: null,
      config: null,
      pollTimer: null
    };

    /* =========================
       HAPTIC
    ========================= */
    function haptic(type="light"){
      try{
        if (window.Telegram?.WebApp?.HapticFeedback){
          Telegram.WebApp.HapticFeedback.impactOccurred(type);
        } else if (navigator.vibrate) {
          navigator.vibrate(8);
        }
      }catch(e){}
    }

    /* =========================
       Toast
    ========================= */
    const toastEl = document.getElementById("toast");
    let toastT=null;
    function toast(msg){
      toastEl.textContent = msg;
      toastEl.classList.add("show");
      clearTimeout(toastT);
      toastT=setTimeout(()=>toastEl.classList.remove("show"), 1400);
    }

    /* =========================
       Utils
    ========================= */
    function clamp(n,min,max){ return Math.max(min, Math.min(max,n)); }
    function formatDate(ts){
      if(!ts) return null;
      const d = new Date(ts);
      if(Number.isNaN(d.getTime())) return null;
      const dd=String(d.getDate()).padStart(2,"0");
      const mm=String(d.getMonth()+1).padStart(2,"0");
      const yy=d.getFullYear();
      return `${dd}.${mm}.${yy}`;
    }
    function randKey(){
      const c="abcdefghjkmnpqrstuvwxyz23456789";
      let s="";
      for(let i=0;i<8;i++) s+=c[Math.floor(Math.random()*c.length)];
      return s;
    }

    /* =========================
       Telegram user
    ========================= */
    function initTelegram(){
      const tg = window.Telegram?.WebApp;
      if(!tg) return;
      try{ tg.expand(); }catch(e){}
      const u = tg.initDataUnsafe?.user;
      if(u){
        state.user.tg_id = u.id ?? null;
        const name = [u.first_name, u.last_name].filter(Boolean).join(" ").trim();
        state.user.name = name || (u.username ? "@"+u.username : "Пользователь");
        state.user.photo_url = u.photo_url || null;
      }
    }

    /* =========================
       Local storage
    ========================= */
    function loadLocal(){
      const k = localStorage.getItem("zeus_user_key");
      state.user.user_key = k || randKey();
      if(!k) localStorage.setItem("zeus_user_key", state.user.user_key);

      const oid = localStorage.getItem("zeus_last_order");
      if(oid) state.orderId = oid;
    }
    function saveKey(){ localStorage.setItem("zeus_user_key", state.user.user_key); }
    function saveOrder(id){ state.orderId=id; localStorage.setItem("zeus_last_order", id); }

    /* =========================
       UI refs
    ========================= */
    const apiDot=document.getElementById("apiDot");
    const apiText=document.getElementById("apiText");

    const userName=document.getElementById("userName");
    const tgLine=document.getElementById("tgLine");
    const avatar=document.getElementById("avatar");

    const activeUntil=document.getElementById("activeUntil");
    const btnSubscribe=document.getElementById("btnSubscribe");
    const btnOpenSheet=document.getElementById("btnOpenSheet");

    const profileName=document.getElementById("profileName");
    const profileTgId=document.getElementById("profileTgId");
    const profileUserKey=document.getElementById("profileUserKey");
    const btnNewKey=document.getElementById("btnNewKey");

    const backdrop=document.getElementById("backdrop");
    const sheet=document.getElementById("sheet");
    const close=document.getElementById("close");

    const chipsDays=document.getElementById("chipsDays");
    const chipsDevices=document.getElementById("chipsDevices");
    const choiceTitle=document.getElementById("choiceTitle");
    const choiceMeta=document.getElementById("choiceMeta");
    const priceText=document.getElementById("priceText");

    const payStars=document.getElementById("payStars");
    const payUsdt=document.getElementById("payUsdt");
    const orderLine=document.getElementById("orderLine");
    const copyBtn=document.getElementById("copyBtn");

    const track=document.getElementById("track");
    const prev=document.getElementById("prev");
    const next=document.getElementById("next");

    /* =========================
       Screen switching
    ========================= */
    function setScreen(name){
      if(state.screen===name) return;
      const old=document.getElementById("screen-"+state.screen);
      const neu=document.getElementById("screen-"+name);

      old.classList.remove("in");
      old.classList.add("out");

      setTimeout(()=>{
        old.classList.remove("active","out");
        neu.classList.add("active","in");
        state.screen=name;

        document.querySelectorAll(".seg button").forEach(b=>{
          b.classList.toggle("active", b.dataset.screen===name);
        });
      }, 160);
    }
    document.querySelectorAll(".seg button").forEach(b=>{
      b.addEventListener("click", ()=>{
        haptic("light");
        setScreen(b.dataset.screen);
      });
    });

    /* =========================
       Bottom sheet
    ========================= */
    function openSheet(){
      haptic("light");
      copyBtn.style.display="none";
      state.config=null;
      backdrop.classList.add("show");
      // trigger animation
      requestAnimationFrame(()=>sheet.classList.add("show"));
      updateChoice();
    }
    function hideSheet(){
      sheet.classList.remove("show");
      // small delay to let it disappear smoothly
      setTimeout(()=>backdrop.classList.remove("show"), 120);
    }
    btnSubscribe.addEventListener("click", openSheet);
    btnOpenSheet.addEventListener("click", openSheet);
    close.addEventListener("click", hideSheet);
    backdrop.addEventListener("click",(e)=>{ if(e.target===backdrop) hideSheet(); });

    /* =========================
       Chips
    ========================= */
    function makeChip(label, tagText){
      const el=document.createElement("div");
      el.className="chip";
      el.textContent=label;
      if(tagText){
        const t=document.createElement("span");
        t.className="chipTag";
        t.textContent=tagText;
        el.appendChild(t);
      }
      return el;
    }

    function renderChips(){
      chipsDays.innerHTML="";
      chipsDevices.innerHTML="";

      [30,90,180].forEach(d=>{
        const tag = d===30 ? "Популярно" : (d===180 ? "Выгоднее" : "");
        const c=makeChip(`${d} дней`, tag);
        c.dataset.days=d;
        c.addEventListener("click", ()=>{
          haptic("light");
          state.plan.days=d;
          state.plan.price=PRICES[d];
          updateSelected();
          updateChoice(true);
        });
        chipsDays.appendChild(c);
      });

      DEVICE_CHOICES.forEach(n=>{
        const c=makeChip(`${n} устройство(а)`);
        c.dataset.devices=n;
        c.addEventListener("click", ()=>{
          haptic("light");
          state.plan.devices=n;
          updateSelected();
          updateChoice();
        });
        chipsDevices.appendChild(c);
      });

      updateSelected();
      updateChoice();
    }

    function updateSelected(){
      chipsDays.querySelectorAll(".chip").forEach(c=>{
        c.classList.toggle("selected", Number(c.dataset.days)===state.plan.days);
      });
      chipsDevices.querySelectorAll(".chip").forEach(c=>{
        c.classList.toggle("selected", Number(c.dataset.devices)===state.plan.devices);
      });
    }

    function animatePrice(from,to,ms=220){
      const start=performance.now();
      function tick(now){
        const p=Math.min(1,(now-start)/ms);
        const eased=1-Math.pow(1-p,3);
        const v=Math.round(from+(to-from)*eased);
        priceText.textContent = `${v} `;
        const sm=document.createElement("small");
        sm.textContent="Stars";
        priceText.appendChild(sm);
        if(p<1) requestAnimationFrame(tick);
      }
      requestAnimationFrame(tick);
    }

    function updateChoice(morph=false){
      choiceTitle.textContent="Выбранный план";
      choiceMeta.textContent=`${state.plan.days} дней • ${state.plan.devices} устройство(а)`;

      const current = parseInt((priceText.textContent||"0").replace(/\D/g,"")) || state.plan.price;
      if(morph) animatePrice(current, state.plan.price);
      else{
        priceText.textContent = `${state.plan.price} `;
        const sm=document.createElement("small");
        sm.textContent="Stars";
        priceText.appendChild(sm);
      }
    }

    /* =========================
       Render profile
    ========================= */
    function renderProfile(){
      // avatar
      avatar.innerHTML="";
      if(state.user.photo_url){
        const img=document.createElement("img");
        img.src=state.user.photo_url;
        img.alt="avatar";
        avatar.appendChild(img);
      }else{
        const f=document.createElement("div");
        f.className="fallback";
        f.textContent=(state.user.name||"Z").trim().slice(0,1).toUpperCase();
        avatar.appendChild(f);
      }

      userName.textContent=state.user.name||"Гость";
      tgLine.textContent=`tg_id: ${state.user.tg_id ?? "—"}`;

      profileName.textContent=state.user.name||"—";
      profileTgId.textContent=`tg_id: ${state.user.tg_id ?? "—"}`;
      profileUserKey.textContent=state.user.user_key||"—";
    }

    /* =========================
       API
    ========================= */
    async function apiHealth(){
      try{
        const r=await fetch(`${API_BASE}/health`);
        if(!r.ok) throw 0;
        apiDot.style.background = "rgba(52,199,89,.9)";
        apiText.textContent="API OK";
      }catch(e){
        apiDot.style.background = "rgba(255,59,48,.85)";
        apiText.textContent="API OFF";
      }
    }

    async function createStars(){
      const body={ user_key: state.user.user_key, days: state.plan.days, devices: state.plan.devices };
      const r=await fetch(`${API_BASE}/pay/stars/create`,{
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify(body)
      });
      const data=await r.json();
      if(!r.ok) throw new Error(data?.detail || "Stars error");
      return data;
    }

    async function createCrypto(){
      const body={ user_key: state.user.user_key, days: state.plan.days, devices: state.plan.devices };
      const r=await fetch(`${API_BASE}/pay/crypto/create`,{
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify(body)
      });
      const data=await r.json();
      if(!r.ok) throw new Error(data?.detail || "Crypto error");
      return data;
    }

    async function getOrder(id){
      const r=await fetch(`${API_BASE}/pay/order/${id}`);
      const data=await r.json();
      if(!r.ok) throw new Error(data?.detail || "Order error");
      return data;
    }

    async function issueConfig(){
      const body={ inbound_id: DEFAULT_INBOUND_ID, user_key: state.user.user_key, days: state.plan.days, limit_ip: 0 };
      const r=await fetch(`${API_BASE}/issue-config`,{
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify(body)
      });
      const data=await r.json();
      if(!r.ok) throw new Error(data?.detail || "Config error");
      return data; // {link}
    }

    function openInvoice(url){
      try{
        if(window.Telegram?.WebApp?.openInvoice){
          Telegram.WebApp.openInvoice(url, ()=>{});
          return;
        }
      }catch(e){}
      window.open(url, "_blank", "noopener,noreferrer");
    }

    function stopPolling(){
      if(state.pollTimer){
        clearInterval(state.pollTimer);
        state.pollTimer=null;
      }
    }

    function startPolling(orderId){
      stopPolling();
      orderLine.textContent=`Заказ: ${orderId} • pending`;
      state.pollTimer=setInterval(async ()=>{
        try{
          const o=await getOrder(orderId);
          orderLine.textContent=`Заказ: ${o.id} • статус: ${o.status}`;

          // active_until -> only on MAIN
          if(o.active_until){
            const d=formatDate(o.active_until);
            activeUntil.textContent = d ? d : "активна";
            btnSubscribe.textContent = "Продлить подписку";
          }else{
            activeUntil.textContent = "нет";
            btnSubscribe.textContent = "Приобрести подписку";
          }

          if(o.config_link){
            state.config=o.config_link;
            copyBtn.style.display="inline-flex";
            copyBtn.textContent="Скопировать конфиг";
          }

          if(o.status==="paid"){
            // if no config from backend yet, allow fallback
            copyBtn.style.display="inline-flex";
            copyBtn.textContent = state.config ? "Скопировать конфиг" : "Получить и скопировать конфиг";
          }
        }catch(e){
          // no spam
        }
      }, 1200);
    }

    /* =========================
       Actions
    ========================= */
    payStars.addEventListener("click", async ()=>{
      try{
        haptic("medium");
        orderLine.textContent="Создаём инвойс Stars…";
        const {order_id, invoice_link}=await createStars();
        saveOrder(order_id);
        orderLine.textContent=`Инвойс готов • ${order_id}`;
        openInvoice(invoice_link);
        startPolling(order_id);
      }catch(e){
        orderLine.textContent="Ошибка Stars: " + (e.message || e);
      }
    });

    payUsdt.addEventListener("click", async ()=>{
      try{
        haptic("medium");
        orderLine.textContent="Создаём инвойс USDT…";
        const data=await createCrypto();
        const oid=data.order_id;
        saveOrder(oid);
        orderLine.textContent=`Инвойс готов • ${oid}`;
        openInvoice(data.invoice_url || data.invoice_link || "");
        startPolling(oid);
      }catch(e){
        orderLine.textContent="Ошибка USDT: " + (e.message || e);
      }
    });

    copyBtn.addEventListener("click", async ()=>{
      try{
        haptic("light");
        let link = state.config;
        if(!link){
          orderLine.textContent="Получаем конфиг…";
          const d=await issueConfig();
          link=d.link;
          state.config=link;
        }
        await navigator.clipboard.writeText(link);
        toast("Конфиг скопирован");
      }catch(e){
        toast("Не удалось скопировать");
      }
    });

    btnNewKey.addEventListener("click", ()=>{
      haptic("light");
      state.user.user_key=randKey();
      saveKey();
      renderProfile();
      toast("Новый ID создан");
    });

    /* =========================
       Instructions swipe
    ========================= */
    function updateSlide(){
      track.style.transform = `translateX(${-state.slide*100}%)`;
    }
    prev.addEventListener("click", ()=>{
      haptic("light");
      state.slide=clamp(state.slide-1,0,2);
      updateSlide();
    });
    next.addEventListener("click", ()=>{
      haptic("light");
      state.slide=clamp(state.slide+1,0,2);
      updateSlide();
    });

    (function bindSwipe(){
      let startX=0, curX=0, dragging=false;
      track.addEventListener("touchstart",(e)=>{
        dragging=true;
        startX=e.touches[0].clientX;
        curX=startX;
      },{passive:true});
      track.addEventListener("touchmove",(e)=>{
        if(!dragging) return;
        curX=e.touches[0].clientX;
      },{passive:true});
      track.addEventListener("touchend",()=>{
        if(!dragging) return;
        dragging=false;
        const dx=curX-startX;
        if(Math.abs(dx)>40){
          if(dx<0) state.slide=clamp(state.slide+1,0,2);
          else state.slide=clamp(state.slide-1,0,2);
          haptic("light");
          updateSlide();
        }
      });
    })();

    /* =========================
       Load active from last order
    ========================= */
    async function refreshActive(){
      if(!state.orderId) return;
      try{
        const o=await getOrder(state.orderId);
        if(o.active_until){
          const d=formatDate(o.active_until);
          activeUntil.textContent = d || "активна";
          btnSubscribe.textContent = "Продлить подписку";
        }else{
          activeUntil.textContent = "нет";
          btnSubscribe.textContent = "Приобрести подписку";
        }
      }catch(e){}
    }

    /* =========================
       Boot
    ========================= */
    (async function boot(){
      initTelegram();
      loadLocal();
      renderChips();
      renderProfile();

      await apiHealth();
      await refreshActive();

      if(state.orderId) startPolling(state.orderId);
    })();
  </script>
</body>
</html>
