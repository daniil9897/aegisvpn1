<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Porsche VPN</title>

  <style>
    :root{
      /* Porsche-like minimal palette */
      --bg:#06070a;
      --bg2:#0b0d12;
      --surface:#10131a;
      --surface2:#0c0f15;
      --line: rgba(255,255,255,.08);
      --line2: rgba(255,255,255,.05);
      --text: rgba(255,255,255,.94);
      --muted: rgba(255,255,255,.65);
      --muted2: rgba(255,255,255,.50);

      --red:#d5001c;
      --red2:#ff233d;
      --ok:#22c55e;
      --warn:#fbbf24;

      --r:18px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background:
        radial-gradient(900px 520px at 30% -20%, rgba(213,0,28,.18), transparent 60%),
        radial-gradient(680px 420px at 85% 5%, rgba(255,35,61,.10), transparent 55%),
        linear-gradient(180deg, var(--bg), var(--bg2));
      color:var(--text);
      overflow-x:hidden;
    }

    /* subtle “speed lines” (very light) */
    body:before{
      content:"";
      position:fixed; inset:0;
      pointer-events:none;
      opacity:.10;
      background:
        repeating-linear-gradient(90deg, rgba(255,255,255,.06) 0 1px, transparent 1px 26px);
      mask-image: radial-gradient(70% 50% at 50% 0%, black, transparent 70%);
    }

    .app{
      max-width: 520px;
      margin: 0 auto;
      padding: 12px 14px 84px;
    }

    /* Top bar */
    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding: 10px 2px 12px;
      position:sticky;
      top:0;
      z-index:5;
      background: linear-gradient(180deg, rgba(6,7,10,.92), rgba(6,7,10,.72), transparent);
      backdrop-filter: blur(10px);
    }

    .brand{
      display:flex;
      align-items:flex-end;
      gap:10px;
      min-width:0;
    }
    .brand .title{
      font-weight: 900;
      letter-spacing: .8px;
      text-transform: uppercase;
      font-size: 15px;
      white-space:nowrap;
    }
    .brand .title span{color:var(--red)}
    .brand .sub{
      font-size: 11px;
      color: var(--muted2);
      border:1px solid var(--line2);
      background: rgba(255,255,255,.02);
      padding: 4px 10px;
      border-radius: 999px;
      white-space:nowrap;
    }

    .status{
      display:flex;
      align-items:center;
      gap:8px;
      border:1px solid var(--line2);
      background: rgba(255,255,255,.02);
      padding: 8px 10px;
      border-radius: 999px;
      color: var(--muted);
      font-size: 12px;
      flex-shrink:0;
    }
    .dot{
      width:8px;height:8px;border-radius:50%;
      background: var(--warn);
      box-shadow: 0 0 0 4px rgba(251,191,36,.12);
    }
    .dot.ok{
      background: var(--ok);
      box-shadow: 0 0 0 4px rgba(34,197,94,.12);
    }

    /* Page container */
    .page{
      display:none;
      animation: fade .18s ease;
    }
    .page.active{display:block}
    @keyframes fade{from{opacity:.4; transform: translateY(4px)} to{opacity:1; transform:none}}

    /* Surfaces */
    .card{
      border:1px solid var(--line2);
      background: rgba(255,255,255,.03);
      border-radius: calc(var(--r) + 4px);
      padding: 14px;
      position:relative;
      overflow:hidden;
    }
    .card:before{
      content:"";
      position:absolute; inset:-2px;
      background: linear-gradient(90deg, transparent, rgba(213,0,28,.10), transparent);
      opacity:.6;
      transform: translateX(-70%);
      animation: sweep 7.2s ease-in-out infinite;
      pointer-events:none;
    }
    @keyframes sweep{0%{transform:translateX(-80%)} 55%{transform:translateX(20%)} 100%{transform:translateX(130%)}}

    .section{
      margin-top: 12px;
      display:flex;
      flex-direction:column;
      gap:12px;
    }

    .h1{
      margin:0;
      font-size: 24px;
      line-height: 1.05;
      letter-spacing:.2px;
      font-weight: 900;
    }
    .p{
      margin:10px 0 0;
      color: var(--muted);
      font-size: 13px;
      line-height: 1.5;
    }

    .kv{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      margin-top: 12px;
    }
    .kv .mini{
      border:1px solid var(--line2);
      border-radius: 16px;
      padding: 12px;
      background: rgba(0,0,0,.16);
    }
    .k{font-size:12px;color:var(--muted2)}
    .v{margin-top:6px;font-weight:900;font-size:13px; letter-spacing:.2px}
    code.pill{
      font-family: var(--mono);
      font-size: 12px;
      padding: 3px 9px;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,.08);
      background: rgba(255,255,255,.04);
      color: rgba(255,255,255,.88);
      display:inline-block;
      max-width: 100%;
      overflow:hidden;
      text-overflow: ellipsis;
      vertical-align: middle;
    }

    /* Plans */
    .plans{
      display:flex;
      gap:10px;
      margin-top: 10px;
    }
    .plan{
      flex:1;
      border:1px solid var(--line2);
      background: rgba(0,0,0,.14);
      border-radius: 16px;
      padding: 12px;
      cursor:pointer;
      transition: transform .12s ease, border-color .12s ease, background .12s ease;
      position:relative;
      min-width:0;
    }
    .plan:active{transform: scale(.99)}
    .plan.active{
      border-color: rgba(213,0,28,.55);
      background: rgba(213,0,28,.08);
      box-shadow: 0 0 0 4px rgba(213,0,28,.10);
    }
    .plan .t{font-weight: 950; font-size: 13px}
    .plan .s{margin-top:6px; color: var(--muted2); font-size: 11px; line-height:1.35}
    .tag{
      position:absolute; top:10px; right:10px;
      font-size: 10px;
      padding: 4px 8px;
      border-radius: 999px;
      border:1px solid rgba(213,0,28,.38);
      background: rgba(213,0,28,.10);
      color: rgba(255,255,255,.92);
    }

    /* Buttons */
    .btn{
      width:100%;
      border:0;
      border-radius: 16px;
      padding: 14px 14px;
      font-weight: 950;
      letter-spacing: .4px;
      color: #fff;
      background: linear-gradient(135deg, var(--red), var(--red2));
      box-shadow: 0 14px 30px rgba(213,0,28,.22);
      cursor:pointer;
      transition: transform .12s ease, filter .12s ease, opacity .12s ease;
    }
    .btn:active{transform: translateY(1px) scale(.995)}
    .btn:disabled{opacity:.6; cursor:not-allowed}

    .btn2{
      width:100%;
      border-radius: 16px;
      padding: 12px 14px;
      font-weight: 900;
      letter-spacing:.2px;
      color: rgba(255,255,255,.92);
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      cursor:pointer;
      transition: transform .12s ease, background .12s ease, opacity .12s ease;
    }
    .btn2:active{transform: translateY(1px)}
    .btn2:disabled{opacity:.55; cursor:not-allowed}

    .row{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      margin-top: 10px;
    }

    textarea{
      width:100%;
      height: 150px;
      margin-top: 10px;
      border-radius: 16px;
      border:1px solid var(--line2);
      background: rgba(0,0,0,.22);
      color: rgba(255,255,255,.88);
      padding: 12px;
      resize:none;
      outline:none;
      font-family: var(--mono);
      font-size: 12px;
      line-height: 1.55;
    }

    .note{
      color: var(--muted2);
      font-size: 12px;
      line-height: 1.55;
      margin-top: 10px;
    }

    /* Instructions (swipe cards) */
    .swipeWrap{
      border:1px solid var(--line2);
      background: rgba(0,0,0,.16);
      border-radius: calc(var(--r) + 6px);
      overflow:hidden;
      position:relative;
    }
    .swipeTrack{
      display:flex;
      width:300%;
      transform: translateX(0%);
      transition: transform .22s ease;
      will-change: transform;
    }
    .slide{
      width:100%;
      flex: 0 0 100%;
      padding: 14px;
    }
    .slideCard{
      border:1px solid var(--line2);
      background: rgba(255,255,255,.03);
      border-radius: 18px;
      padding: 14px;
      min-height: 250px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .slideTitle{
      font-weight: 950;
      font-size: 16px;
      letter-spacing:.2px;
    }
    .steps{
      display:flex;
      flex-direction:column;
      gap:8px;
      color: rgba(255,255,255,.86);
      font-size: 13px;
      line-height: 1.5;
    }
    .step{
      display:flex;
      gap:10px;
      align-items:flex-start;
    }
    .num{
      flex:0 0 auto;
      width: 22px; height: 22px;
      border-radius: 999px;
      background: rgba(213,0,28,.14);
      border:1px solid rgba(213,0,28,.30);
      color:#fff;
      font-weight:900;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size: 12px;
      margin-top:1px;
    }
    .hint{
      color: var(--muted2);
      font-size: 12px;
      line-height: 1.5;
      margin-top: 2px;
    }
    .dots{
      display:flex;
      justify-content:center;
      gap:8px;
      padding: 10px 0 12px;
    }
    .d{
      width:6px; height:6px;
      border-radius: 50%;
      background: rgba(255,255,255,.25);
    }
    .d.on{background: rgba(213,0,28,.95)}
    .swipeActions{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      margin-top: 10px;
    }

    /* Profile / history */
    .list{
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .item{
      border:1px solid var(--line2);
      background: rgba(0,0,0,.16);
      border-radius: 16px;
      padding: 12px;
    }
    .itemTop{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .itemTitle{
      font-weight: 950;
      font-size: 12px;
      letter-spacing:.2px;
      color: rgba(255,255,255,.92);
      min-width:0;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }
    .itemMeta{
      color: var(--muted2);
      font-size: 11px;
      white-space:nowrap;
    }
    .itemLink{
      margin-top:8px;
      font-family: var(--mono);
      font-size: 11px;
      color: rgba(255,255,255,.75);
      word-break: break-all;
      border-top: 1px solid var(--line2);
      padding-top: 8px;
    }

    /* Bottom nav */
    .nav{
      position:fixed;
      left:50%;
      bottom: 10px;
      transform: translateX(-50%);
      width: min(520px, calc(100% - 28px));
      border:1px solid rgba(255,255,255,.10);
      background: rgba(10,12,18,.72);
      backdrop-filter: blur(12px);
      border-radius: 22px;
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      overflow:hidden;
    }
    .tab{
      padding: 12px 10px;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      gap:6px;
      cursor:pointer;
      color: var(--muted2);
      user-select:none;
    }
    .tab svg{width:18px;height:18px;opacity:.85}
    .tab .lbl{font-size:11px; letter-spacing:.2px}
    .tab.on{
      color: rgba(255,255,255,.92);
      background: linear-gradient(180deg, rgba(213,0,28,.18), rgba(255,255,255,0));
    }
    .tab.on svg{opacity:1}
    .tab.on .underline{
      width: 22px;
      height: 2px;
      border-radius:999px;
      background: rgba(213,0,28,.95);
      margin-top:2px;
    }
    .underline{width:22px;height:2px;border-radius:999px;background:transparent}

    /* Toast */
    .toast{
      position:fixed;
      left:50%;
      bottom: 92px;
      transform: translateX(-50%);
      background: rgba(15,18,26,.92);
      border:1px solid rgba(255,255,255,.10);
      border-radius: 999px;
      padding: 10px 14px;
      color: rgba(255,255,255,.92);
      font-size: 12px;
      opacity:0;
      pointer-events:none;
      transition: opacity .18s ease, transform .18s ease;
    }
    .toast.show{
      opacity:1;
      transform: translateX(-50%) translateY(-3px);
    }
  </style>
</head>

<body>
  <div class="app">

    <div class="topbar">
      <div class="brand">
        <div class="title">Porsche <span>VPN</span></div>
        <div class="sub">mobile</div>
      </div>

      <div class="status" title="Статус API">
        <span class="dot" id="dot"></span>
        <span id="statusTxt">checking…</span>
      </div>
    </div>

    <!-- HOME -->
    <div class="page active" id="page-home">
      <div class="card">
        <h1 class="h1">Подключение<br/>в один клик</h1>
        <p class="p">
          Сейчас работает <b>заглушка вместо Telegram</b>: уникальный ID хранится в браузере.
          Потом заменим на Telegram ID — дизайн останется.
        </p>

        <div class="kv">
          <div class="mini">
            <div class="k">Ваш ID</div>
            <div class="v"><code class="pill" id="uid">…</code></div>
          </div>
          <div class="mini">
            <div class="k">API</div>
            <div class="v"><code class="pill" id="apiPill">…</code></div>
          </div>
        </div>

        <div class="plans" id="plans">
          <div class="plan active" data-days="30">
            <div class="t">30 дней</div>
            <div class="s">Быстрый старт</div>
          </div>
          <div class="plan" data-days="90">
            <div class="tag">best</div>
            <div class="t">90 дней</div>
            <div class="s">Оптимально</div>
          </div>
          <div class="plan" data-days="180">
            <div class="t">180 дней</div>
            <div class="s">Максимум</div>
          </div>
        </div>

        <div class="section">
          <button class="btn" id="btnIssue">Получить конфиг</button>
          <textarea id="out" readonly placeholder="vless://..."></textarea>
          <div class="row">
            <button class="btn2" id="btnCopy" disabled>Скопировать</button>
            <button class="btn2" id="btnOpen" disabled>Открыть в приложении</button>
          </div>
          <div class="note">
            Если “Открыть…” не сработало — нажми “Скопировать” и импортируй в V2Box / v2rayNG.
          </div>
        </div>
      </div>
    </div>

    <!-- INSTRUCTIONS -->
    <div class="page" id="page-instr">
      <div class="card">
        <h1 class="h1">Инструкции</h1>
        <p class="p">Свайпай карточки. Всё только под мобилки.</p>

        <div class="swipeWrap" id="swipeWrap">
          <div class="swipeTrack" id="swipeTrack">
            <!-- iOS -->
            <div class="slide">
              <div class="slideCard">
                <div class="slideTitle">iOS (V2Box)</div>

                <div class="steps">
                  <div class="step"><div class="num">1</div><div>Нажми “Получить конфиг” на главном экране.</div></div>
                  <div class="step"><div class="num">2</div><div>Нажми “Скопировать”.</div></div>
                  <div class="step"><div class="num">3</div><div>Открой V2Box → Import → From Clipboard.</div></div>
                  <div class="step"><div class="num">4</div><div>Connect. Готово.</div></div>
                </div>

                <div class="hint">Если в приложении есть “Import URL” — вставь ссылку напрямую.</div>
              </div>
            </div>

            <!-- Android -->
            <div class="slide">
              <div class="slideCard">
                <div class="slideTitle">Android (v2rayNG / Nekobox)</div>

                <div class="steps">
                  <div class="step"><div class="num">1</div><div>Нажми “Получить конфиг”.</div></div>
                  <div class="step"><div class="num">2</div><div>Нажми “Скопировать”.</div></div>
                  <div class="step"><div class="num">3</div><div>v2rayNG → “+” → Import from Clipboard.</div></div>
                  <div class="step"><div class="num">4</div><div>Подключись (Start).</div></div>
                </div>

                <div class="hint">Если видишь “timeout” — проверь интернет/режим сети (Wi-Fi/LTE).</div>
              </div>
            </div>

            <!-- Universal -->
            <div class="slide">
              <div class="slideCard">
                <div class="slideTitle">Универсально (любой клиент)</div>

                <div class="steps">
                  <div class="step"><div class="num">1</div><div>Скопируй <b>vless://…</b> ссылку.</div></div>
                  <div class="step"><div class="num">2</div><div>В приложении найди Import / Add URL.</div></div>
                  <div class="step"><div class="num">3</div><div>Вставь ссылку и сохрани.</div></div>
                  <div class="step"><div class="num">4</div><div>Подключись.</div></div>
                </div>

                <div class="hint">Если надо — мы позже добавим кнопку “Показать QR”.</div>
              </div>
            </div>

          </div>

          <div class="dots" id="dots">
            <div class="d on"></div><div class="d"></div><div class="d"></div>
          </div>
        </div>

        <div class="swipeActions">
          <button class="btn2" id="prev">Назад</button>
          <button class="btn2" id="next">Дальше</button>
        </div>

      </div>
    </div>

    <!-- PROFILE -->
    <div class="page" id="page-prof">
      <div class="card">
        <h1 class="h1">Профиль</h1>
        <p class="p">ID — это ключ пользователя (заглушка). История хранится в браузере.</p>

        <div class="kv">
          <div class="mini">
            <div class="k">Ваш ID</div>
            <div class="v"><code class="pill" id="uid2">…</code></div>
          </div>
          <div class="mini">
            <div class="k">Тариф</div>
            <div class="v"><code class="pill" id="planPill">…</code></div>
          </div>
        </div>

        <div class="row" style="margin-top:12px">
          <button class="btn2" id="copyId">Скопировать ID</button>
          <button class="btn2" id="newId">Новый ID</button>
        </div>

        <div class="row">
          <button class="btn2" id="copyLast" disabled>Скопировать последний конфиг</button>
          <button class="btn2" id="clearHist">Очистить историю</button>
        </div>

        <div class="section">
          <div class="k">История выдач</div>
          <div class="list" id="hist"></div>
          <div class="note" id="histNote"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- bottom nav -->
  <div class="nav">
    <div class="tab on" data-go="home">
      <svg viewBox="0 0 24 24" fill="none"><path d="M4 10.5 12 4l8 6.5V20a1 1 0 0 1-1 1h-5v-6H10v6H5a1 1 0 0 1-1-1v-9.5Z" stroke="currentColor" stroke-width="1.8" stroke-linejoin="round"/></svg>
      <div class="lbl">Главная</div>
      <div class="underline"></div>
    </div>
    <div class="tab" data-go="instr">
      <svg viewBox="0 0 24 24" fill="none"><path d="M7 4h10a2 2 0 0 1 2 2v14l-4-2H7a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2Z" stroke="currentColor" stroke-width="1.8" stroke-linejoin="round"/><path d="M9 8h6M9 12h6" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/></svg>
      <div class="lbl">Инструкции</div>
      <div class="underline"></div>
    </div>
    <div class="tab" data-go="prof">
      <svg viewBox="0 0 24 24" fill="none"><path d="M12 12a4 4 0 1 0-4-4 4 4 0 0 0 4 4Z" stroke="currentColor" stroke-width="1.8"/><path d="M20 21a8 8 0 0 0-16 0" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/></svg>
      <div class="lbl">Профиль</div>
      <div class="underline"></div>
    </div>
  </div>

  <div class="toast" id="toast">Скопировано</div>

  <script>
    // === CONFIG ===
    const API = "https://api.45.133.251.210.nip.io:8443";
    const INBOUND_ID = 1;

    // === UI refs ===
    const dot = document.getElementById("dot");
    const statusTxt = document.getElementById("statusTxt");
    const apiPill = document.getElementById("apiPill");

    const uid = document.getElementById("uid");
    const uid2 = document.getElementById("uid2");
    const planPill = document.getElementById("planPill");

    const btnIssue = document.getElementById("btnIssue");
    const out = document.getElementById("out");
    const btnCopy = document.getElementById("btnCopy");
    const btnOpen = document.getElementById("btnOpen");

    const toast = document.getElementById("toast");

    const histEl = document.getElementById("hist");
    const histNote = document.getElementById("histNote");
    const copyId = document.getElementById("copyId");
    const newId = document.getElementById("newId");
    const copyLast = document.getElementById("copyLast");
    const clearHist = document.getElementById("clearHist");

    // === helpers ===
    function showToast(t){
      toast.textContent = t;
      toast.classList.add("show");
      setTimeout(()=>toast.classList.remove("show"), 1100);
    }

    function getUserKey(){
      let k = localStorage.getItem("porschevpn_user_key");
      if(!k){
        const raw = (crypto.randomUUID ? crypto.randomUUID() : (Math.random().toString(16).slice(2))).toString().replace(/-/g,'');
        k = "site-" + raw.slice(0,10);
        localStorage.setItem("porschevpn_user_key", k);
      }
      return k;
    }

    function setUserKey(newKey){
      localStorage.setItem("porschevpn_user_key", newKey);
    }

    function getHistory(){
      try{
        return JSON.parse(localStorage.getItem("porschevpn_history") || "[]");
      }catch{
        return [];
      }
    }

    function saveHistory(arr){
      localStorage.setItem("porschevpn_history", JSON.stringify(arr.slice(0, 30))); // keep last 30
    }

    function fmtTime(ts){
      const d = new Date(ts);
      const dd = String(d.getDate()).padStart(2,'0');
      const mm = String(d.getMonth()+1).padStart(2,'0');
      const hh = String(d.getHours()).padStart(2,'0');
      const mi = String(d.getMinutes()).padStart(2,'0');
      return `${dd}.${mm} ${hh}:${mi}`;
    }

    async function copyText(t){
      try{
        await navigator.clipboard.writeText(t);
        showToast("Скопировано");
      }catch{
        // fallback
        const ta = document.createElement("textarea");
        ta.value = t;
        document.body.appendChild(ta);
        ta.select();
        document.execCommand("copy");
        ta.remove();
        showToast("Скопировано");
      }
    }

    // === state ===
    apiPill.textContent = API.replace("https://","");
    let user_key = getUserKey();
    uid.textContent = user_key;
    uid2.textContent = user_key;

    let selectedDays = 30;

    // Plans UI
    const plans = document.getElementById("plans");
    plans.addEventListener("click", (e)=>{
      const p = e.target.closest(".plan");
      if(!p) return;
      [...plans.querySelectorAll(".plan")].forEach(x=>x.classList.remove("active"));
      p.classList.add("active");
      selectedDays = parseInt(p.dataset.days || "30", 10);
      planPill.textContent = `${selectedDays} дней`;
      renderHistory();
    });
    planPill.textContent = `${selectedDays} дней`;

    // Health check
    async function checkHealth(){
      try{
        const r = await fetch(API + "/health", {method:"GET"});
        if(!r.ok) throw new Error("bad");
        dot.classList.add("ok");
        statusTxt.textContent = "API online";
      }catch{
        dot.classList.remove("ok");
        statusTxt.textContent = "API offline";
      }
    }
    checkHealth();
    setInterval(checkHealth, 12000);

    // Issue config
    btnIssue.addEventListener("click", async ()=>{
      btnIssue.disabled = true;
      btnIssue.textContent = "Получаю…";
      out.value = "";
      btnCopy.disabled = true;
      btnOpen.disabled = true;

      try{
        const r = await fetch(API + "/issue-config", {
          method:"POST",
          headers: {"Content-Type":"application/json"},
          body: JSON.stringify({
            inbound_id: INBOUND_ID,
            user_key,
            days: selectedDays,
            limit_ip: 0
          })
        });

        const data = await r.json();
        if(!r.ok) throw new Error(data.detail || "Ошибка");

        const link = data.link || "";
        out.value = link;

        if(link){
          btnCopy.disabled = false;
          btnOpen.disabled = false;

          // save to history
          const hist = getHistory();
          hist.unshift({
            ts: Date.now(),
            days: selectedDays,
            key: user_key,
            link
          });
          saveHistory(hist);
          renderHistory();

          showToast("Конфиг готов");
        }
      }catch(err){
        alert("Ошибка: " + (err?.message || err));
      }finally{
        btnIssue.disabled = false;
        btnIssue.textContent = "Получить конфиг";
      }
    });

    btnCopy.addEventListener("click", ()=> out.value && copyText(out.value));
    btnOpen.addEventListener("click", ()=> { if(out.value) window.location.href = out.value; });

    // Profile actions
    copyId.addEventListener("click", ()=> copyText(user_key));
    newId.addEventListener("click", ()=>{
      const raw = (crypto.randomUUID ? crypto.randomUUID() : (Math.random().toString(16).slice(2))).toString().replace(/-/g,'');
      const k = "site-" + raw.slice(0,10);
      user_key = k;
      setUserKey(k);
      uid.textContent = k;
      uid2.textContent = k;
      out.value = "";
      btnCopy.disabled = true;
      btnOpen.disabled = true;
      showToast("Новый ID");
      renderHistory();
    });

    clearHist.addEventListener("click", ()=>{
      saveHistory([]);
      renderHistory();
      showToast("История очищена");
    });

    copyLast.addEventListener("click", ()=>{
      const hist = getHistory();
      if(hist[0]?.link) copyText(hist[0].link);
    });

    function renderHistory(){
      const hist = getHistory();
      histEl.innerHTML = "";

      if(hist.length === 0){
        histNote.textContent = "История пустая. Сначала получи конфиг на главном экране.";
        copyLast.disabled = true;
        return;
      }

      histNote.textContent = "Показываем последние выдачи (до 30).";
      copyLast.disabled = false;

      hist.slice(0, 10).forEach((h, idx)=>{
        const div = document.createElement("div");
        div.className = "item";

        const top = document.createElement("div");
        top.className = "itemTop";

        const title = document.createElement("div");
        title.className = "itemTitle";
        title.textContent = `${h.days} дней • ${h.key}`;

        const meta = document.createElement("div");
        meta.className = "itemMeta";
        meta.textContent = fmtTime(h.ts);

        top.appendChild(title);
        top.appendChild(meta);

        const link = document.createElement("div");
        link.className = "itemLink";
        link.textContent = h.link;

        div.appendChild(top);
        div.appendChild(link);

        div.addEventListener("click", ()=> copyText(h.link));
        histEl.appendChild(div);
      });
    }
    renderHistory();

    // Navigation
    const pages = {
      home: document.getElementById("page-home"),
      instr: document.getElementById("page-instr"),
      prof: document.getElementById("page-prof"),
    };

    function go(name){
      Object.values(pages).forEach(p=>p.classList.remove("active"));
      pages[name].classList.add("active");

      document.querySelectorAll(".tab").forEach(t=>{
        const on = t.dataset.go === name;
        t.classList.toggle("on", on);
        t.querySelector(".underline").style.background = on ? "rgba(213,0,28,.95)" : "transparent";
      });

      // update profile pills
      uid2.textContent = user_key;
      planPill.textContent = `${selectedDays} дней`;
    }

    document.querySelectorAll(".tab").forEach(t=>{
      t.addEventListener("click", ()=> go(t.dataset.go));
    });

    // Swipe instructions
    const swipeTrack = document.getElementById("swipeTrack");
    const dots = [...document.querySelectorAll("#dots .d")];
    const wrap = document.getElementById("swipeWrap");
    let slide = 0;

    function setSlide(i){
      slide = Math.max(0, Math.min(2, i));
      swipeTrack.style.transform = `translateX(${-slide * 100}%)`;
      dots.forEach((d, idx)=> d.classList.toggle("on", idx===slide));
    }

    document.getElementById("prev").addEventListener("click", ()=> setSlide(slide-1));
    document.getElementById("next").addEventListener("click", ()=> setSlide(slide+1));

    let startX = 0;
    let dx = 0;
    let active = false;

    wrap.addEventListener("touchstart", (e)=>{
      active = true;
      startX = e.touches[0].clientX;
      dx = 0;
    }, {passive:true});

    wrap.addEventListener("touchmove", (e)=>{
      if(!active) return;
      dx = e.touches[0].clientX - startX;
    }, {passive:true});

    wrap.addEventListener("touchend", ()=>{
      if(!active) return;
      active = false;
      if(Math.abs(dx) > 40){
        if(dx < 0) setSlide(slide+1);
        else setSlide(slide-1);
      }
      dx = 0;
    }, {passive:true});
  </script>
</body>
</html>
