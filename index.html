<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#05060A" />
  <title>ZEUSVPN</title>

  <style>
    :root{
      /* Black + deep blue accent (minimal) */
      --bg0:#05060A;
      --bg1:#070A11;
      --card:#0B0F18;
      --card2:#0A0D15;

      --stroke: rgba(255,255,255,.08);
      --stroke2: rgba(48,102,255,.16);

      --text:#F3F6FF;
      --muted:#A6B0C8;
      --muted2:#7B86A3;

      /* Accent: deep, not bright */
      --blue:#2B4BFF;
      --blue2:#3A66FF;
      --blueGlow: rgba(43,75,255,.22);

      --shadow: 0 18px 60px rgba(0,0,0,.65);
      --shadow2: 0 10px 26px rgba(0,0,0,.48);

      --r: 18px;
      --r2: 24px;

      --fast: 180ms;
      --med: 320ms;

      --safeTop: env(safe-area-inset-top, 0px);
      --safeBot: env(safe-area-inset-bottom, 0px);

      --max: 520px;
    }

    *{ box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
    html,body{ height:100%; margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial; color:var(--text); }
    body{
      background:
        radial-gradient(900px 520px at 50% -10%, rgba(43,75,255,.10) 0%, transparent 55%),
        radial-gradient(900px 600px at 85% 10%, rgba(43,75,255,.06) 0%, transparent 60%),
        linear-gradient(180deg, var(--bg1), var(--bg0));
      overflow-x:hidden;
    }

    /* subtle premium grain (less noisy, no “кривизны”) */
    body:before{
      content:"";
      position:fixed; inset:0;
      pointer-events:none;
      background:
        radial-gradient(900px 520px at 50% 0%, rgba(255,255,255,.05), transparent 60%),
        repeating-linear-gradient(0deg, rgba(255,255,255,.010) 0 1px, transparent 1px 4px);
      opacity:.22;
      mix-blend-mode: overlay;
    }

    .app{
      position:relative;
      max-width: var(--max);
      margin: 0 auto;
      min-height:100%;
      padding: calc(14px + var(--safeTop)) 14px calc(92px + var(--safeBot)) 14px;
    }

    /* HEADER */
    .topbar{
      border-radius: var(--r2);
      border: 1px solid var(--stroke);
      background:
        radial-gradient(700px 220px at 20% 0%, rgba(43,75,255,.10), transparent 60%),
        linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      box-shadow: var(--shadow2);
      padding: 14px 14px 12px 14px;
      display:flex;
      align-items:center;
      gap: 12px;
    }
    .logo{
      width: 52px; height: 52px;
      border-radius: 16px;
      border: 1px solid rgba(43,75,255,.16);
      background: rgba(0,0,0,.22);
      display:grid; place-items:center;
      box-shadow: 0 14px 24px rgba(0,0,0,.55);
      overflow:hidden;
      flex: 0 0 52px;
    }
    .logo img{ width: 46px; height:auto; display:block; opacity:.98; }
    .brand{
      min-width:0;
      display:flex;
      flex-direction:column;
      gap: 4px;
    }
    .brand h1{
      margin:0;
      font-size: 16px;
      letter-spacing:.10em;
      text-transform: uppercase;
      line-height:1.05;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .brand .sub{
      margin:0;
      font-size: 12px;
      color: var(--muted);
      line-height:1.35;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    .stack{ margin-top: 12px; display:grid; gap:12px; }

    .panel{
      border-radius: var(--r2);
      border: 1px solid var(--stroke);
      background:
        radial-gradient(900px 360px at 20% 0%, rgba(43,75,255,.08), transparent 60%),
        linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      box-shadow: var(--shadow2);
      overflow:hidden;
    }
    .panel .inner{ padding: 14px; }

    .section-title{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      margin-bottom: 10px;
    }
    .section-title .t{
      font-size: 13px;
      font-weight: 850;
      letter-spacing:.02em;
    }
    .section-title .hint{
      font-size: 12px;
      color: var(--muted2);
    }

    /* iOS-like transitions */
    .screens{ position:relative; min-height: 500px; }
    .screen{
      position:absolute; inset:0;
      opacity:0;
      transform: translateY(10px);
      transition: opacity var(--med) ease, transform var(--med) ease;
      pointer-events:none;
    }
    .screen.active{
      opacity:1;
      transform: translateY(0);
      pointer-events:auto;
    }

    /* BUTTONS */
    .cta{ display:flex; gap:10px; align-items:stretch; }
    .btn{
      appearance:none;
      border-radius: 16px;
      border: 1px solid var(--stroke);
      background: rgba(0,0,0,.16);
      color: var(--text);
      padding: 12px 14px;
      font-size: 14px;
      font-weight: 800;
      cursor:pointer;
      transition: transform var(--fast) ease, filter var(--fast) ease, background var(--fast) ease, border-color var(--fast) ease;
      box-shadow: 0 10px 18px rgba(0,0,0,.40);
      user-select:none;
    }
    .btn:active{ transform: scale(.985); }

    .btn.primary{
      flex:1;
      border-color: rgba(43,75,255,.22);
      background:
        radial-gradient(900px 240px at 15% 0%, rgba(43,75,255,.18), transparent 65%),
        linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.03));
      box-shadow: 0 16px 28px rgba(0,0,0,.60), 0 0 0 1px rgba(43,75,255,.10) inset;
    }
    .btn.primary:hover{ filter: brightness(1.03); }

    .btn.ghost{
      width: 54px;
      display:grid;
      place-items:center;
      border-color: rgba(255,255,255,.10);
      background: rgba(0,0,0,.20);
    }

    .btn[disabled]{ opacity:.55; cursor:not-allowed; }

    /* KPI cards aligned */
    .kpi{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-top: 10px;
    }
    .kpi .box{
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,.08);
      background:
        radial-gradient(500px 200px at 20% 0%, rgba(43,75,255,.06), transparent 60%),
        linear-gradient(180deg, rgba(0,0,0,.26), rgba(255,255,255,.02));
      padding: 12px;
      min-height: 66px;
      display:flex;
      flex-direction:column;
      justify-content:center;
      gap: 6px;
    }
    .kpi .label{ font-size: 12px; color: var(--muted2); }
    .kpi .value{ font-size: 13px; font-weight: 900; letter-spacing:.01em; }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; }

    .mini{
      margin-top: 12px;
      font-size: 11px;
      color: var(--muted2);
      line-height: 1.5;
    }

    /* NAV */
    .nav{
      position:fixed;
      left:0; right:0; bottom:0;
      padding: 10px 14px calc(10px + var(--safeBot)) 14px;
      z-index: 40;
    }
    .nav .bar{
      max-width: var(--max);
      margin: 0 auto;
      border-radius: 22px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(8,10,16,.64);
      box-shadow: 0 22px 70px rgba(0,0,0,.78);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      padding: 8px;
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 8px;
    }
    .tab{
      border-radius: 18px;
      border: 1px solid transparent;
      background: transparent;
      color: var(--muted);
      padding: 10px 10px;
      display:flex;
      flex-direction:column;
      gap: 4px;
      align-items:center;
      justify-content:center;
      cursor:pointer;
      transition: background var(--fast) ease, color var(--fast) ease, transform var(--fast) ease, border-color var(--fast) ease;
      font-size: 12px;
      font-weight: 850;
    }
    .tab:active{ transform: scale(.985); }
    .tab.active{
      color: var(--text);
      background:
        radial-gradient(420px 160px at 15% 0%, rgba(43,75,255,.14), transparent 70%),
        linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      border-color: rgba(43,75,255,.16);
    }
    .ico{ width: 20px; height: 20px; opacity:.92; display:block; }

    /* MODAL (bottom sheet) */
    .backdrop{
      position:fixed; inset:0;
      background: rgba(0,0,0,.72);
      display:none;
      align-items:flex-end;
      justify-content:center;
      padding: 14px;
      z-index: 60;
    }
    .backdrop.show{ display:flex; }
    .sheet{
      width: min(var(--max), 100%);
      border-radius: 26px;
      border: 1px solid rgba(255,255,255,.10);
      background:
        radial-gradient(900px 300px at 18% 0%, rgba(43,75,255,.12), transparent 65%),
        linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.02));
      box-shadow: var(--shadow);
      overflow:hidden;
      transform: translateY(16px);
      opacity:0;
      transition: transform var(--med) ease, opacity var(--med) ease;
    }
    .backdrop.show .sheet{ transform: translateY(0); opacity:1; }
    .sheet-head{
      padding: 14px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      border-bottom: 1px solid rgba(255,255,255,.06);
    }
    .sheet-head .ttl{
      font-size: 14px;
      font-weight: 900;
      letter-spacing:.02em;
    }
    .xbtn{
      width: 40px; height: 40px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.22);
      color: var(--text);
      display:grid;
      place-items:center;
      cursor:pointer;
    }
    .xbtn:active{ transform: scale(.985); }
    .sheet-body{ padding: 14px; display:grid; gap: 12px; }
    .row-title{
      display:flex; align-items:baseline; justify-content:space-between;
      gap: 10px;
      margin-bottom: 8px;
    }
    .row-title .l{ font-size: 13px; font-weight: 850; }
    .row-title .r{ font-size: 12px; color: var(--muted2); }

    .chips{ display:flex; flex-wrap:wrap; gap: 10px; }
    .chip{
      padding: 10px 12px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      color: var(--text);
      font-size: 13px;
      font-weight: 850;
      cursor:pointer;
      transition: transform var(--fast) ease, border-color var(--fast) ease, background var(--fast) ease;
      user-select:none;
    }
    .chip:active{ transform: scale(.985); }
    .chip.active{
      border-color: rgba(43,75,255,.26);
      background:
        radial-gradient(380px 140px at 15% 0%, rgba(43,75,255,.14), transparent 70%),
        linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.02));
      box-shadow: 0 0 0 1px rgba(43,75,255,.10) inset;
    }

    /* 3D selection card – clean */
    .selcard{
      border-radius: 22px;
      border: 1px solid rgba(43,75,255,.18);
      background:
        radial-gradient(700px 260px at 15% 0%, rgba(43,75,255,.14), transparent 70%),
        linear-gradient(180deg, rgba(255,255,255,.06), rgba(0,0,0,.20));
      box-shadow: 0 28px 60px rgba(0,0,0,.62);
      padding: 14px;
      position:relative;
      overflow:hidden;
      transform: perspective(900px) rotateX(5deg);
    }
    .selcard:after{
      content:"";
      position:absolute; inset:0;
      background: linear-gradient(110deg, transparent 0%, rgba(255,255,255,.10) 45%, transparent 70%);
      transform: translateX(-120%);
      animation: shimmer 5.6s ease-in-out infinite;
      opacity:.18;
      pointer-events:none;
    }
    @keyframes shimmer{
      0%,60%{ transform: translateX(-120%); }
      85%{ transform: translateX(120%); }
      100%{ transform: translateX(120%); }
    }

    .selcard .big{ margin:0; font-size: 15px; font-weight: 950; }
    .meta{ margin-top: 8px; display:flex; gap: 8px; flex-wrap:wrap; }
    .badge{
      display:inline-flex; align-items:center; gap:6px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.16);
      font-size: 12px;
      color: var(--muted);
    }
    .tag{
      display:inline-flex; align-items:center;
      padding: 5px 10px;
      border-radius: 999px;
      border: 1px solid rgba(43,75,255,.20);
      background: rgba(43,75,255,.10);
      color: var(--text);
      font-size: 12px;
      font-weight: 900;
    }

    .sheet-foot{
      padding: 14px;
      border-top: 1px solid rgba(255,255,255,.06);
      display:grid;
      gap: 10px;
    }
    .status{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap: 10px;
      color: var(--muted);
      font-size: 12px;
    }

    .codebox{
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.20);
      padding: 12px;
    }
    .code{
      font-size: 12px;
      line-height: 1.45;
      word-break: break-all;
      color: #EEF3FF;
    }
    .copyrow{ display:flex; gap:10px; margin-top: 10px; }
    .btn.small{ padding: 11px 12px; border-radius: 14px; font-size: 13px; }
    .btn.full{ width:100%; }

    /* Instructions swipe */
    .swipe{
      display:flex;
      gap: 12px;
      overflow:auto;
      scroll-snap-type: x mandatory;
      -webkit-overflow-scrolling: touch;
      padding-bottom: 2px;
    }
    .swipe::-webkit-scrollbar{ display:none; }
    .icard{
      min-width: 86%;
      scroll-snap-align: center;
      border-radius: 22px;
      border: 1px solid rgba(255,255,255,.10);
      background:
        radial-gradient(700px 260px at 15% 0%, rgba(43,75,255,.08), transparent 70%),
        linear-gradient(180deg, rgba(0,0,0,.26), rgba(255,255,255,.02));
      box-shadow: var(--shadow2);
      padding: 14px;
    }
    .icard h3{ margin:0; font-size: 14px; letter-spacing:.02em; }
    .icard p{ margin: 10px 0 0 0; font-size: 12px; color: var(--muted); line-height: 1.5; }
    .steps{ margin-top: 10px; display:grid; gap: 8px; }
    .step{ display:flex; gap: 10px; align-items:flex-start; font-size: 12px; color: var(--text); line-height: 1.45; }
    .dot{
      margin-top: 2px;
      width: 18px; height: 18px;
      border-radius: 8px;
      display:grid;
      place-items:center;
      background: rgba(43,75,255,.10);
      border: 1px solid rgba(43,75,255,.16);
      color: var(--text);
      font-weight: 900;
      font-size: 11px;
      flex: 0 0 18px;
    }

    /* Profile rows aligned */
    .pgrid{ display:grid; gap: 10px; }
    .row{
      display:flex;
      justify-content:space-between;
      gap: 12px;
      padding: 12px;
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
    }
    .row .l{ font-size: 12px; color: var(--muted2); }
    .row .v{ font-size: 13px; font-weight: 900; letter-spacing:.01em; color: var(--text); text-align:right; word-break:break-all; }

    /* Toast */
    .toast{
      position:fixed;
      left:50%;
      transform: translateX(-50%);
      bottom: calc(98px + var(--safeBot));
      background: rgba(8,10,16,.86);
      border:1px solid rgba(255,255,255,.10);
      border-radius: 16px;
      padding: 10px 12px;
      color: var(--text);
      font-size: 12px;
      opacity:0;
      pointer-events:none;
      transition: opacity var(--fast) ease, transform var(--fast) ease;
      z-index: 80;
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
    }
    .toast.show{ opacity:1; transform: translateX(-50%) translateY(-4px); }
  </style>
</head>

<body>
  <div class="app">
    <div class="topbar">
      <div class="logo">
        <img id="logoImg" alt="ZEUSVPN logo" />
      </div>
      <div class="brand">
        <h1>ZEUSVPN</h1>
        <p class="sub">Premium • Stars / USDT • конфиг после оплаты</p>
      </div>
    </div>

    <div class="stack">
      <div class="panel">
        <div class="inner screens">

          <!-- HOME -->
          <div class="screen active" id="screen-home">
            <div class="section-title">
              <div class="t">Главная</div>
              <div class="hint" id="subHint">готов к работе</div>
            </div>

            <div class="cta">
              <button class="btn primary" id="btnOpen">Приобрести подписку</button>
              <button class="btn ghost" id="btnRefresh" title="Новый ID">↻</button>
            </div>

            <div class="kpi">
              <div class="box">
                <div class="label">Ваш ID</div>
                <div class="value mono" id="userId">—</div>
              </div>
              <div class="box">
                <div class="label">Активна до</div>
                <div class="value" id="activeUntil">—</div>
              </div>
            </div>

            <div class="mini">
              В модалке выбираешь устройства и срок → оплата Stars → после оплаты появится конфиг и кнопка “Скопировать”.
            </div>
          </div>

          <!-- INSTRUCTIONS -->
          <div class="screen" id="screen-help">
            <div class="section-title">
              <div class="t">Инструкции</div>
              <div class="hint">свайпай →</div>
            </div>

            <div class="swipe">
              <div class="icard">
                <h3>iOS</h3>
                <p>Скопируй vless:// и импортируй в приложение.</p>
                <div class="steps">
                  <div class="step"><div class="dot">1</div><div>Скопируй конфиг.</div></div>
                  <div class="step"><div class="dot">2</div><div>Import / Add profile.</div></div>
                  <div class="step"><div class="dot">3</div><div>Save → Connect.</div></div>
                </div>
              </div>

              <div class="icard">
                <h3>Android</h3>
                <p>v2rayNG — импорт из буфера.</p>
                <div class="steps">
                  <div class="step"><div class="dot">1</div><div>Скопируй конфиг.</div></div>
                  <div class="step"><div class="dot">2</div><div>“+” → Import from clipboard.</div></div>
                  <div class="step"><div class="dot">3</div><div>Start.</div></div>
                </div>
              </div>

              <div class="icard">
                <h3>Desktop</h3>
                <p>Импорт по ссылке в v2rayN / Nekoray.</p>
                <div class="steps">
                  <div class="step"><div class="dot">1</div><div>Скопируй конфиг.</div></div>
                  <div class="step"><div class="dot">2</div><div>Import / Add profile.</div></div>
                  <div class="step"><div class="dot">3</div><div>Connect.</div></div>
                </div>
              </div>
            </div>
          </div>

          <!-- PROFILE -->
          <div class="screen" id="screen-profile">
            <div class="section-title">
              <div class="t">Профиль</div>
              <div class="hint">заглушка</div>
            </div>

            <div class="pgrid">
              <div class="row">
                <div class="l">ID</div>
                <div class="v mono" id="profileId">—</div>
              </div>
              <div class="row">
                <div class="l">Тариф</div>
                <div class="v" id="profilePlan">—</div>
              </div>
              <div class="row">
                <div class="l">Активна до</div>
                <div class="v" id="profileUntil">—</div>
              </div>

              <button class="btn full" id="btnResetId">Сбросить / новый ID</button>
              <div class="mini">История и лимиты подключим позже.</div>
            </div>
          </div>

        </div>
      </div>
    </div>

    <!-- Modal -->
    <div class="backdrop" id="backdrop">
      <div class="sheet" role="dialog" aria-modal="true">
        <div class="sheet-head">
          <div class="ttl" id="modalTitle">Выбор подписки</div>
          <button class="xbtn" id="btnClose" aria-label="close">✕</button>
        </div>

        <div class="sheet-body">
          <div>
            <div class="row-title">
              <div class="l">Устройства</div>
              <div class="r">выбери</div>
            </div>
            <div class="chips" id="chipsDevices"></div>
          </div>

          <div>
            <div class="row-title">
              <div class="l">Срок</div>
              <div class="r">дней</div>
            </div>
            <div class="chips" id="chipsDays"></div>
          </div>

          <div class="selcard" id="selcard" style="display:none;">
            <p class="big" id="selTitle">—</p>
            <div class="meta">
              <span class="badge">Устройства: <b id="selDev">—</b></span>
              <span class="badge">Срок: <b id="selDays">—</b> дней</span>
              <span class="tag" id="selTag" style="display:none;"></span>
            </div>
          </div>

          <div class="status">
            <div>Цена:</div>
            <div><b id="priceText">—</b></div>
          </div>
        </div>

        <div class="sheet-foot">
          <button class="btn primary full" id="btnPayStars" disabled>Оплатить Stars</button>

          <div id="payState" style="display:none;">
            <div class="status">
              <div>Статус:</div>
              <div id="orderStatus"><b>pending</b></div>
            </div>

            <div class="codebox" id="configBox" style="display:none;">
              <div class="mini" style="margin-top:0;">Ваш конфиг:</div>
              <div class="code mono" id="configText">—</div>
              <div class="copyrow">
                <button class="btn small primary" id="btnCopy">Скопировать</button>
                <button class="btn small" id="btnClose2">Закрыть</button>
              </div>
            </div>
          </div>

          <div class="mini" id="footHint">
            В Telegram invoice откроется внутри Mini App. В браузере — по ссылке. После оплаты конфиг появится автоматически.
          </div>
        </div>
      </div>
    </div>

    <div class="toast" id="toast">Скопировано</div>
  </div>

  <div class="nav">
    <div class="bar">
      <button class="tab active" id="tabHome">
        <svg class="ico" viewBox="0 0 24 24" fill="none"><path d="M4 10.5 12 4l8 6.5V20a1.5 1.5 0 0 1-1.5 1.5H5.5A1.5 1.5 0 0 1 4 20v-9.5Z" stroke="currentColor" stroke-width="1.6" stroke-linejoin="round"/></svg>
        Главная
      </button>
      <button class="tab" id="tabHelp">
        <svg class="ico" viewBox="0 0 24 24" fill="none"><path d="M12 18h.01M9.5 9.25a2.7 2.7 0 1 1 4.1 2.3c-.95.6-1.6 1.18-1.6 2.45v.5" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/></svg>
        Инструкции
      </button>
      <button class="tab" id="tabProfile">
        <svg class="ico" viewBox="0 0 24 24" fill="none"><path d="M20 21a8 8 0 0 0-16 0M12 12a4 4 0 1 0-4-4 4 4 0 0 0 4 4Z" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/></svg>
        Профиль
      </button>
    </div>
  </div>

  <script>
    // === CONFIG ===
    const DEFAULT_API = "https://api.45.133.251.210.nip.io:8443";

    // ЛОГО: положи рядом файл logo.jpg (или logo.png) и укажи имя здесь:
    const LOGO_SRC = "logo.jpg";

    const DEVICE_OPTIONS = [1,3,5,10];
    const DAY_OPTIONS = [30,90,180];
    const PRICE_MAP = { 30:199, 90:399, 180:599 };

    const $ = (id)=>document.getElementById(id);

    function toast(msg){
      const t = $("toast");
      t.textContent = msg;
      t.classList.add("show");
      setTimeout(()=>t.classList.remove("show"), 1100);
    }

    function getApiBase(){
      const url = new URL(location.href);
      const qp = url.searchParams.get("api");
      const fromStore = localStorage.getItem("zeusvpn_api");
      const api = (qp || fromStore || DEFAULT_API).trim();
      localStorage.setItem("zeusvpn_api", api);
      return api.replace(/\/$/, "");
    }

    function uuidLike(){
      const a = crypto.getRandomValues(new Uint8Array(16));
      a[6] = (a[6] & 0x0f) | 0x40;
      a[8] = (a[8] & 0x3f) | 0x80;
      const hex = [...a].map(b=>b.toString(16).padStart(2,"0")).join("");
      return `${hex.slice(0,8)}-${hex.slice(8,12)}-${hex.slice(12,16)}-${hex.slice(16,20)}-${hex.slice(20)}`;
    }

    function getUserKey(){
      let id = localStorage.getItem("zeusvpn_user_key");
      if(!id){
        id = "user-" + uuidLike().slice(0,8);
        localStorage.setItem("zeusvpn_user_key", id);
      }
      return id;
    }

    function resetUserKey(){
      const id = "user-" + uuidLike().slice(0,8);
      localStorage.setItem("zeusvpn_user_key", id);
      localStorage.removeItem("zeusvpn_last_order_id");
      return id;
    }

    function parseDateSafe(v){
      try{
        const d = new Date(v);
        if(String(d) === "Invalid Date") return null;
        return d;
      }catch(e){ return null; }
    }

    function formatUntil(v){
      if(!v) return "—";
      const d = parseDateSafe(v);
      if(!d) return String(v);
      const dd = d.toLocaleDateString("ru-RU",{year:"numeric",month:"2-digit",day:"2-digit"});
      const tt = d.toLocaleTimeString("ru-RU",{hour:"2-digit",minute:"2-digit"});
      return `${dd} ${tt}`;
    }

    function isActiveUntilFuture(v){
      if(!v) return false;
      const d = parseDateSafe(v);
      if(!d) return false;
      return d.getTime() > Date.now();
    }

    function haptic(type="light"){
      try{
        const tg = window.Telegram?.WebApp;
        if(tg?.HapticFeedback){
          if(type==="success") tg.HapticFeedback.notificationOccurred("success");
          else tg.HapticFeedback.impactOccurred("light");
        }
      }catch(e){}
    }

    let selectedDevices = null;
    let selectedDays = null;
    let currentOrderId = null;
    let pollTimer = null;

    function setScreen(name){
      const map = { home:$("screen-home"), help:$("screen-help"), profile:$("screen-profile") };
      for(const k in map) map[k].classList.toggle("active", k===name);
      $("tabHome").classList.toggle("active", name==="home");
      $("tabHelp").classList.toggle("active", name==="help");
      $("tabProfile").classList.toggle("active", name==="profile");
    }

    function openModal(){ $("backdrop").classList.add("show"); haptic("light"); }
    function closeModal(){
      $("backdrop").classList.remove("show");
      $("payState").style.display = "none";
      $("configBox").style.display = "none";
      $("orderStatus").innerHTML = "<b>pending</b>";
      stopPolling();
      currentOrderId = null;
      haptic("light");
    }

    function stopPolling(){
      if(pollTimer){ clearInterval(pollTimer); pollTimer=null; }
    }

    function renderChips(container, values, onPick){
      container.innerHTML = "";
      values.forEach(v=>{
        const b = document.createElement("button");
        b.className = "chip";
        b.textContent = v;
        b.onclick = ()=> onPick(v);
        container.appendChild(b);
      });
    }

    function setActiveChip(container, val){
      [...container.querySelectorAll(".chip")].forEach(ch=>{
        ch.classList.toggle("active", String(ch.textContent)===String(val));
      });
    }

    function updateSelectionCard(){
      const card = $("selcard");
      if(selectedDevices && selectedDays){
        card.style.display = "block";
        $("selTitle").textContent = `${selectedDays} дней • ${selectedDevices} устройство(а)`;
        $("selDev").textContent = selectedDevices;
        $("selDays").textContent = selectedDays;

        const tag = $("selTag");
        tag.style.display = "inline-flex";
        if(selectedDays === 30) tag.textContent = "Популярно";
        else if(selectedDays === 180) tag.textContent = "Выгоднее";
        else tag.textContent = "Оптимально";

        const price = PRICE_MAP[selectedDays] ?? "—";
        $("priceText").textContent = (price==="—") ? "—" : `${price} XTR`;
        $("btnPayStars").disabled = false;
      } else {
        card.style.display = "none";
        $("priceText").textContent = "—";
        $("btnPayStars").disabled = true;
      }
    }

    async function createStarsOrder(){
      const api = getApiBase();
      const body = { user_key: getUserKey(), days: selectedDays, devices: selectedDevices };
      const res = await fetch(`${api}/pay/stars/create`,{
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify(body)
      });
      if(!res.ok){
        const t = await res.text().catch(()=> "");
        throw new Error("create failed: " + res.status + " " + t);
      }
      return await res.json();
    }

    function openInvoice(invoiceLink){
      const tg = window.Telegram?.WebApp;
      if(tg?.openInvoice) tg.openInvoice(invoiceLink, ()=>{});
      else window.open(invoiceLink, "_blank", "noopener,noreferrer");
    }

    async function fetchOrder(orderId){
      const api = getApiBase();
      const res = await fetch(`${api}/pay/order/${encodeURIComponent(orderId)}`,{ method:"GET" });
      if(!res.ok) throw new Error("order fetch failed");
      return await res.json();
    }

    async function pollOrder(orderId){
      $("payState").style.display = "block";
      stopPolling();

      pollTimer = setInterval(async ()=>{
        try{
          const ord = await fetchOrder(orderId);
          const st = ord.status || "pending";
          $("orderStatus").innerHTML = `<b>${st}</b>`;

          const until = ord.active_until || null;
          if(until){
            $("activeUntil").textContent = formatUntil(until);
            $("profileUntil").textContent = formatUntil(until);
          }

          if(st === "paid" || st === "success"){
            stopPolling();
            haptic("success");
            localStorage.setItem("zeusvpn_last_order_id", orderId);

            if(ord.config_link){
              $("configText").textContent = ord.config_link;
              $("configBox").style.display = "block";
              refreshMainCta();
            }
          }
        }catch(e){}
      }, 1500);
    }

    async function refreshMainCta(){
      const last = localStorage.getItem("zeusvpn_last_order_id");
      if(!last){
        $("btnOpen").textContent = "Приобрести подписку";
        $("subHint").textContent = "подписка не активна";
        return;
      }
      try{
        const ord = await fetchOrder(last);
        const until = ord.active_until || null;

        if(until){
          $("activeUntil").textContent = formatUntil(until);
          $("profileUntil").textContent = formatUntil(until);
        }

        if((ord.status === "paid" || ord.status === "success") && isActiveUntilFuture(until)){
          $("btnOpen").textContent = "Продлить";
          $("subHint").textContent = "подписка активна";
        } else {
          $("btnOpen").textContent = "Приобрести подписку";
          $("subHint").textContent = "подписка не активна";
        }
      }catch(e){
        $("btnOpen").textContent = "Приобрести подписку";
        $("subHint").textContent = "проверка статуса…";
      }
    }

    async function copyText(txt){
      try{
        await navigator.clipboard.writeText(txt);
        toast("Скопировано");
      }catch(e){
        const ta = document.createElement("textarea");
        ta.value = txt;
        document.body.appendChild(ta);
        ta.select();
        document.execCommand("copy");
        ta.remove();
        toast("Скопировано");
      }
    }

    (function init(){
      $("logoImg").src = LOGO_SRC;

      const id = getUserKey();
      $("userId").textContent = id;
      $("profileId").textContent = id;

      $("tabHome").onclick = ()=>{ setScreen("home"); haptic("light"); };
      $("tabHelp").onclick = ()=>{ setScreen("help"); haptic("light"); };
      $("tabProfile").onclick = ()=>{ setScreen("profile"); haptic("light"); };

      $("btnOpen").onclick = openModal;
      $("btnClose").onclick = closeModal;
      $("btnClose2").onclick = closeModal;
      $("backdrop").addEventListener("click",(e)=>{ if(e.target === $("backdrop")) closeModal(); });

      const resetHandler = ()=>{
        const nid = resetUserKey();
        $("userId").textContent = nid;
        $("profileId").textContent = nid;
        $("activeUntil").textContent = "—";
        $("profileUntil").textContent = "—";
        $("profilePlan").textContent = "—";
        toast("Новый ID");
        haptic("light");
        refreshMainCta();
      };
      $("btnRefresh").onclick = resetHandler;
      $("btnResetId").onclick = resetHandler;

      renderChips($("chipsDevices"), DEVICE_OPTIONS, (v)=>{
        selectedDevices = v;
        setActiveChip($("chipsDevices"), v);
        updateSelectionCard();
        haptic("light");
      });

      renderChips($("chipsDays"), DAY_OPTIONS, (v)=>{
        selectedDays = v;
        setActiveChip($("chipsDays"), v);
        updateSelectionCard();
        haptic("light");
      });

      updateSelectionCard();

      $("btnPayStars").onclick = async ()=>{
        try{
          $("btnPayStars").disabled = true;
          $("btnPayStars").textContent = "Создаём счёт…";
          haptic("light");

          const data = await createStarsOrder();
          currentOrderId = data.order_id;

          $("profilePlan").textContent = `${selectedDays} дней • ${selectedDevices} устр.`;

          $("btnPayStars").textContent = "Открыть invoice";
          $("btnPayStars").disabled = false;

          if(data.invoice_link) openInvoice(data.invoice_link);
          await pollOrder(currentOrderId);
        }catch(err){
          $("btnPayStars").disabled = false;
          $("btnPayStars").textContent = "Оплатить Stars";
          alert("Ошибка оплаты: " + (err?.message || err));
        }
      };

      $("btnCopy").onclick = ()=>{
        const t = $("configText").textContent.trim();
        if(t && t !== "—") copyText(t);
      };

      try{
        const tg = window.Telegram?.WebApp;
        if(tg){ tg.ready?.(); tg.expand?.(); }
      }catch(e){}

      refreshMainCta();
    })();
  </script>
</body>
</html>
