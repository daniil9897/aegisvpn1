<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>ZEUSVPN</title>

  <!-- Telegram WebApp (–Ω–µ –ª–æ–º–∞–µ—Ç –æ–±—ã—á–Ω—ã–π –±—Ä–∞—É–∑–µ—Ä) -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <style>
    :root{
      --bg0:#06070b;
      --bg1:#070915;
      --card: rgba(10,14,26,.70);
      --card2: rgba(7,10,18,.70);
      --stroke: rgba(255,255,255,.09);

      --text:#eaf0ff;
      --muted:#9aa6c0;

      --gold:#ffd56a;
      --gold2:#ffb900;
      --blue:#4db9ff;
      --blue2:#2c6bff;
      --cyan:#38f9ff;

      --ok:#20d67b;
      --warn:#ffcc00;
      --bad:#ff3b3b;

      --radius: 18px;
      --shadow: 0 18px 50px rgba(0,0,0,.55);
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      color:var(--text);
      background:
        radial-gradient(900px 420px at 50% -10%, rgba(77,185,255,.16), transparent 60%),
        radial-gradient(720px 400px at 110% 10%, rgba(255,213,106,.12), transparent 60%),
        radial-gradient(900px 520px at 45% 110%, rgba(44,107,255,.14), transparent 55%),
        linear-gradient(180deg, var(--bg1), var(--bg0));
      overflow-x:hidden;
    }

    /* Ultra subtle grain */
    body:before{
      content:"";
      position:fixed; inset:0;
      pointer-events:none;
      background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='180' height='180'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.85' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='180' height='180' filter='url(%23n)' opacity='.08'/%3E%3C/svg%3E");
      mix-blend-mode:overlay;
      opacity:.35;
    }

    /* Lightning streaks */
    .storm{
      position:fixed; inset:0;
      pointer-events:none;
      opacity:.22;
      filter: blur(.2px);
      background:
        radial-gradient(240px 120px at 18% 12%, rgba(56,249,255,.22), transparent 60%),
        radial-gradient(220px 140px at 82% 16%, rgba(255,213,106,.18), transparent 60%),
        linear-gradient(115deg, transparent 0 40%, rgba(77,185,255,.10) 44%, transparent 48%),
        linear-gradient(65deg, transparent 0 58%, rgba(255,213,106,.10) 62%, transparent 66%);
    }

    .app{
      max-width:520px;
      margin:0 auto;
      padding:18px 14px 92px;
      position:relative;
      z-index:2;
    }

    .header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding:6px 4px 10px;
    }

    .brand{
      display:flex;
      align-items:center;
      gap:12px;
      min-width:0;
    }

    .logo{
      width:44px; height:44px;
      border-radius:16px;
      background:
        radial-gradient(18px 18px at 30% 30%, rgba(255,255,255,.22), transparent 70%),
        linear-gradient(145deg, rgba(255,213,106,.95), rgba(44,107,255,.95));
      box-shadow:
        0 14px 30px rgba(44,107,255,.18),
        0 10px 26px rgba(255,213,106,.12);
      position:relative;
      overflow:hidden;
      border:1px solid rgba(255,255,255,.10);
    }
    .logo:after{
      content:"";
      position:absolute; inset:-40%;
      background:linear-gradient(90deg, transparent, rgba(255,255,255,.26), transparent);
      transform:rotate(25deg);
      animation: shine 3.2s linear infinite;
    }
    @keyframes shine{
      0%{transform:translateX(-60%) rotate(25deg)}
      100%{transform:translateX(60%) rotate(25deg)}
    }

    .brand h1{
      margin:0;
      font-size:18px;
      letter-spacing:.8px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .brand small{
      display:block;
      color:var(--muted);
      margin-top:2px;
      font-size:12px;
      letter-spacing:.2px;
    }

    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 10px;
      border:1px solid rgba(255,255,255,.08);
      background:rgba(10,12,18,.55);
      border-radius:999px;
      box-shadow: 0 10px 30px rgba(0,0,0,.25);
      font-size:12px;
      color:var(--muted);
    }
    .dot{
      width:8px; height:8px; border-radius:50%;
      background:var(--ok);
      box-shadow: 0 0 14px rgba(32,214,123,.6);
    }

    .card{
      background:linear-gradient(180deg, var(--card), var(--card2));
      border:1px solid var(--stroke);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:14px;
      margin:12px 0;
      position:relative;
      overflow:hidden;
    }

    /* Zeus aura */
    .card:before{
      content:"";
      position:absolute; inset:0;
      background:
        radial-gradient(520px 220px at 14% 0%, rgba(77,185,255,.16), transparent 60%),
        radial-gradient(520px 240px at 88% 10%, rgba(255,213,106,.12), transparent 60%);
      pointer-events:none;
    }

    .section-title{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom:10px;
    }
    .section-title h2{
      margin:0;
      font-size:14px;
      letter-spacing:.3px;
    }
    .section-title span{
      color:var(--muted);
      font-size:12px;
    }

    /* ‚ÄúThunder line‚Äù separator */
    .accent-line{
      height:2px;
      background:linear-gradient(90deg, transparent, rgba(255,213,106,.55), rgba(77,185,255,.55), transparent);
      border-radius:999px;
      margin:10px 0 12px;
      box-shadow: 0 0 22px rgba(77,185,255,.12);
    }

    .btn{
      width:100%;
      border:none;
      border-radius:14px;
      padding:14px 14px;
      font-weight:800;
      letter-spacing:.3px;
      cursor:pointer;
      color:#08101f;
      background:
        radial-gradient(140px 50px at 30% 0%, rgba(255,255,255,.35), transparent 55%),
        linear-gradient(180deg, var(--gold), var(--gold2));
      box-shadow:
        0 16px 38px rgba(255,213,106,.14),
        0 10px 26px rgba(0,0,0,.30);
      transition:transform .08s ease, filter .2s ease;
      position:relative;
      overflow:hidden;
    }
    .btn:before{
      content:"";
      position:absolute; inset:-40%;
      background:linear-gradient(90deg, transparent, rgba(77,185,255,.22), transparent);
      transform:rotate(18deg);
      animation: bolt 2.8s linear infinite;
      opacity:.7;
      pointer-events:none;
    }
    @keyframes bolt{
      0%{transform:translateX(-55%) rotate(18deg)}
      100%{transform:translateX(55%) rotate(18deg)}
    }
    .btn:active{transform:translateY(1px)}
    .btn.secondary{
      color:var(--text);
      background:
        radial-gradient(140px 50px at 30% 0%, rgba(255,255,255,.12), transparent 55%),
        linear-gradient(180deg, rgba(77,185,255,.35), rgba(44,107,255,.35));
      border:1px solid rgba(77,185,255,.25);
      box-shadow: 0 16px 38px rgba(44,107,255,.10);
    }
    .btn.ghost{
      background:transparent;
      border:1px dashed rgba(255,255,255,.18);
      color:var(--muted);
      font-weight:700;
      box-shadow:none;
    }
    .btn[disabled]{
      opacity:.45;
      cursor:not-allowed;
      filter:saturate(.5);
    }

    .row{display:flex; gap:10px;}
    .row .btn{flex:1}

    .field{display:flex; gap:10px; align-items:center; margin:10px 0;}
    .input{
      flex:1;
      background:rgba(6,9,16,.65);
      border:1px solid rgba(255,255,255,.10);
      border-radius:14px;
      padding:12px 12px;
      color:var(--text);
      outline:none;
      font-size:14px;
    }
    .label{
      font-size:12px;
      color:var(--muted);
      margin-top:6px;
    }

    .box{
      background:rgba(6,8,14,.55);
      border:1px solid rgba(255,255,255,.10);
      border-radius:14px;
      padding:12px;
      margin-top:10px;
    }
    .mono{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size:12px;
      word-break:break-all;
      color:#dfe6ff;
      line-height:1.35;
    }
    .hint{
      font-size:12px;
      color:var(--muted);
      line-height:1.4;
    }

    .status{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      font-size:12px;
      color:var(--muted);
    }
    .badge{
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.06);
      color:var(--text);
      font-weight:750;
      font-size:12px;
      white-space:nowrap;
    }
    .badge.ok{border-color:rgba(32,214,123,.35); color:#bdf7d7; background:rgba(32,214,123,.08)}
    .badge.warn{border-color:rgba(255,204,0,.35); color:#fff2b3; background:rgba(255,204,0,.08)}
    .badge.bad{border-color:rgba(255,59,59,.35); color:#ffb3b3; background:rgba(255,59,59,.08)}

    /* bottom nav */
    .nav{
      position:fixed;
      left:0; right:0; bottom:0;
      padding:10px 12px calc(10px + env(safe-area-inset-bottom));
      background:rgba(6,7,10,.72);
      backdrop-filter: blur(12px);
      border-top:1px solid rgba(255,255,255,.08);
      z-index:5;
    }
    .nav-inner{
      max-width:520px;
      margin:0 auto;
      display:flex;
      gap:10px;
    }
    .tab{
      flex:1;
      padding:12px 10px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.05);
      color:var(--muted);
      font-weight:800;
      cursor:pointer;
    }
    .tab.active{
      color:var(--text);
      border-color: rgba(255,213,106,.28);
      background:
        radial-gradient(220px 60px at 50% 0%, rgba(255,213,106,.14), rgba(255,255,255,.05)),
        linear-gradient(180deg, rgba(77,185,255,.10), rgba(44,107,255,.06));
    }

    .hidden{display:none !important;}
  </style>
</head>

<body>
  <div class="storm"></div>

  <div class="app">
    <div class="header">
      <div class="brand">
        <div class="logo"></div>
        <div style="min-width:0">
          <h1>ZEUSVPN</h1>
          <small>Thunder-fast VLESS ‚Ä¢ Mobile-first</small>
        </div>
      </div>

      <div class="pill" id="apiPill">
        <span class="dot"></span>
        <span id="apiText">API: –ø—Ä–æ–≤–µ—Ä—è—é‚Ä¶</span>
      </div>
    </div>

    <!-- HOME -->
    <div id="screenHome">
      <div class="card">
        <div class="section-title">
          <h2>–ö–æ–Ω—Ñ–∏–≥</h2>
          <span>–±—ã—Å—Ç—Ä–æ ‚Ä¢ –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–æ</span>
        </div>
        <div class="accent-line"></div>

        <div class="field">
          <input class="input" id="userKey" placeholder="ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–º–æ–∂–Ω–æ –æ—Å—Ç–∞–≤–∏—Ç—å –∞–≤—Ç–æ)" />
        </div>
        <div class="hint">
          –û—Å—Ç–∞–≤—å –ø—É—Å—Ç—ã–º ‚Äî —Å–¥–µ–ª–∞–µ–º ID –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏. –ü–æ–∑–∂–µ –∑–¥–µ—Å—å –±—É–¥–µ—Ç Telegram ID/–ø—Ä–æ—Ñ–∏–ª—å.
        </div>

        <div style="height:12px"></div>
        <button class="btn" id="btnGetConfig">‚ö° –ü–æ–ª—É—á–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥</button>

        <div id="configBox" class="box hidden">
          <div class="status">
            <div>–¢–≤–æ–π VLESS</div>
            <button class="btn secondary" style="width:auto; padding:10px 12px" id="btnCopy">–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
          </div>
          <div class="accent-line"></div>
          <div class="mono" id="configText"></div>
        </div>

        <div id="errBox" class="box hidden" style="border-color: rgba(255,59,59,.35)">
          <div class="status">
            <div class="badge bad">–û—à–∏–±–∫–∞</div>
            <div class="hint" id="errText"></div>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="section-title">
          <h2>–û–ø–ª–∞—Ç–∞</h2>
          <span>Stars / USDT</span>
        </div>
        <div class="accent-line"></div>

        <div class="row">
          <button class="btn" id="btnPayStars">‚≠ê –û–ø–ª–∞—Ç–∏—Ç—å Stars</button>
          <button class="btn secondary" id="btnPayUsdt">üíé –û–ø–ª–∞—Ç–∏—Ç—å USDT</button>
        </div>

        <div id="payBox" class="box hidden">
          <div class="status">
            <div>–°—Ç–∞—Ç—É—Å –∑–∞–∫–∞–∑–∞</div>
            <div class="badge warn" id="payStatus">pending</div>
          </div>
          <div class="label" id="payMeta"></div>
          <div class="accent-line"></div>
          <div class="hint">–ü–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã –∂–¥—ë–º –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –∏ –ø–æ–∫–∞–∂–µ–º –∫–æ–Ω—Ñ–∏–≥ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.</div>
        </div>
      </div>
    </div>

    <!-- INSTRUCTIONS -->
    <div id="screenGuide" class="hidden">
      <div class="card">
        <div class="section-title">
          <h2>–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏</h2>
          <span>–ø–æ–¥ –º–æ–±–∏–ª–∫–∏</span>
        </div>
        <div class="accent-line"></div>

        <div class="box" style="margin-bottom:10px">
          <div class="badge">iOS</div>
          <div class="hint" style="margin-top:8px">
            1) –£—Å—Ç–∞–Ω–æ–≤–∏ V2Box / Shadowrocket<br/>
            2) –ò–º–ø–æ—Ä—Ç ‚Üí ‚Äú–í—Å—Ç–∞–≤–∏—Ç—å –∏–∑ –±—É—Ñ–µ—Ä–∞ / –ø–æ —Å—Å—ã–ª–∫–µ‚Äù<br/>
            3) –ü–æ–¥–∫–ª—é—á–∏—Å—å
          </div>
        </div>

        <div class="box" style="margin-bottom:10px">
          <div class="badge">Android</div>
          <div class="hint" style="margin-top:8px">
            1) –£—Å—Ç–∞–Ω–æ–≤–∏ v2rayNG<br/>
            2) –ò–º–ø–æ—Ä—Ç ‚Üí ‚Äú–ò–∑ –±—É—Ñ–µ—Ä–∞‚Äù<br/>
            3) –ü–æ–¥–∫–ª—é—á–∏—Å—å
          </div>
        </div>

        <div class="box">
          <div class="badge">Desktop</div>
          <div class="hint" style="margin-top:8px">
            Nekoray / v2rayN ‚Üí import ‚Üí connect
          </div>
        </div>
      </div>
    </div>

    <!-- PROFILE -->
    <div id="screenProfile" class="hidden">
      <div class="card">
        <div class="section-title">
          <h2>–ü—Ä–æ—Ñ–∏–ª—å</h2>
          <span>–ø–æ–¥ Telegram –ø–æ–∑–∂–µ</span>
        </div>
        <div class="accent-line"></div>

        <div class="status">
          <div>ID</div>
          <div class="badge" id="profileId">‚Äî</div>
        </div>

        <div style="height:10px"></div>

        <div class="status">
          <div>–ü–æ–¥–ø–∏—Å–∫–∞</div>
          <div class="badge warn" id="subStatus">–ù–µ –æ–ø–ª–∞—á–µ–Ω–æ</div>
        </div>

        <div class="label" id="activeUntil">–ê–∫—Ç–∏–≤–Ω–∞ –¥–æ: ‚Äî</div>

        <div class="accent-line"></div>

        <div class="row">
          <button class="btn secondary" id="btnResetId">–ù–æ–≤—ã–π ID</button>
          <button class="btn ghost" id="btnHistory" disabled>–ò—Å—Ç–æ—Ä–∏—è (—Å–∫–æ—Ä–æ)</button>
        </div>

        <div class="box" style="margin-top:12px">
          <div class="hint">
            –†–µ—Ñ–µ—Ä–∞–ª–∫–∞ (UI): ‚Äú–ü—Ä–∏–≥–ª–∞—Å–∏ –¥—Ä—É–≥–∞ ‚Äî +7 –¥–Ω–µ–π‚Äù
          </div>
          <div style="height:10px"></div>
          <button class="btn secondary" id="btnRefCreate">–°–æ–∑–¥–∞—Ç—å —Ä–µ—Ñ-–∫–æ–¥</button>
          <div class="label" id="refOut"></div>
        </div>
      </div>
    </div>
  </div>

  <div class="nav">
    <div class="nav-inner">
      <button class="tab active" id="tabHome">–ì–ª–∞–≤–Ω–∞—è</button>
      <button class="tab" id="tabGuide">–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏</button>
      <button class="tab" id="tabProfile">–ü—Ä–æ—Ñ–∏–ª—å</button>
    </div>
  </div>

<script>
  // === CONFIG ===
  const API_BASE = "https://api.45.133.251.210.nip.io:8443";

  // Telegram WebApp safe init
  const tg = window.Telegram?.WebApp;
  if (tg) {
    try { tg.ready(); } catch(e){}
    try { tg.expand(); } catch(e){}
  }

  // helpers
  const $ = (id)=>document.getElementById(id);
  const show = (el)=>el.classList.remove("hidden");
  const hide = (el)=>el.classList.add("hidden");

  function setError(msg){
    $("errText").textContent = msg;
    show($("errBox"));
  }
  function clearError(){
    hide($("errBox"));
    $("errText").textContent = "";
  }

  function genUserKey(){
    const n = Math.floor(Math.random()*9000)+1000;
    return "zeus-" + n;
  }
  function setProfileId(id){
    $("profileId").textContent = id || "‚Äî";
  }

  // API check
  async function pingApi(){
    try{
      const r = await fetch(API_BASE + "/health", { method:"GET" });
      if(!r.ok) throw new Error("health not ok");
      await r.json();
      $("apiText").textContent = "API: online";
      $("apiPill").querySelector(".dot").style.background = "var(--ok)";
      return true;
    }catch(e){
      $("apiText").textContent = "API: offline";
      $("apiPill").querySelector(".dot").style.background = "var(--bad)";
      return false;
    }
  }

  // issue config
  let lastConfig = "";

  $("btnGetConfig").addEventListener("click", async ()=>{
    clearError();
    hide($("configBox"));

    let user_key = $("userKey").value.trim();
    if(!user_key){
      user_key = genUserKey();
      $("userKey").value = user_key;
    }
    setProfileId(user_key);

    $("btnGetConfig").disabled = true;
    $("btnGetConfig").textContent = "‚ö° –ü–æ–ª—É—á–∞—é‚Ä¶";

    try{
      const r = await fetch(API_BASE + "/issue-config", {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({
          inbound_id: 1,
          user_key,
          days: 30,
          limit_ip: 0
        })
      });

      const txt = await r.text();
      let data;
      try{ data = JSON.parse(txt); } catch(e){ data = { raw: txt }; }

      if(!r.ok){
        throw new Error(data?.detail || ("HTTP " + r.status + ": " + txt));
      }

      lastConfig = data.link || "";
      if(!lastConfig) throw new Error("–ü—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç: –Ω–µ—Ç –ø–æ–ª—è link");

      $("configText").textContent = lastConfig;
      show($("configBox"));
    }catch(e){
      setError(e.message || String(e));
    }finally{
      $("btnGetConfig").disabled = false;
      $("btnGetConfig").textContent = "‚ö° –ü–æ–ª—É—á–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥";
    }
  });

  $("btnCopy").addEventListener("click", async ()=>{
    try{
      await navigator.clipboard.writeText(lastConfig);
      $("btnCopy").textContent = "–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ";
      setTimeout(()=> $("btnCopy").textContent="–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å", 1000);
    }catch(e){
      alert("–ù–µ —Å–º–æ–≥ —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å. –î–µ—Ä–∂–∏ –≤—Ä—É—á–Ω—É—é:\n\n" + lastConfig);
    }
  });

  // payments
  let pollTimer = null;

  async function pollOrder(orderId){
    if(pollTimer) clearInterval(pollTimer);
    pollTimer = setInterval(async ()=>{
      try{
        const r = await fetch(API_BASE + "/pay/order/" + orderId);
        const j = await r.json();

        $("payStatus").textContent = j.status;
        $("payStatus").className = "badge " + (j.status === "paid" ? "ok" : "warn");
        $("payMeta").textContent = `order: ${j.id} ‚Ä¢ ${j.amount || ""} ${j.currency || ""} ‚Ä¢ days: ${j.plan_days || ""}`;

        if(j.status === "paid"){
          clearInterval(pollTimer);
          pollTimer = null;

          if(j.config_link){
            lastConfig = j.config_link;
            $("configText").textContent = lastConfig;
            show($("configBox"));
          }

          $("subStatus").textContent = "–ê–∫—Ç–∏–≤–Ω–∞";
          $("subStatus").className = "badge ok";
          if(j.active_until){
            $("activeUntil").textContent = "–ê–∫—Ç–∏–≤–Ω–∞ –¥–æ: " + new Date(j.active_until).toLocaleString();
          }
        }
      }catch(e){
        // silent
      }
    }, 1200);
  }

  $("btnPayStars").addEventListener("click", async ()=>{
    clearError();
    show($("payBox"));
    $("payStatus").textContent = "creating‚Ä¶";
    $("payStatus").className = "badge warn";
    $("payMeta").textContent = "";

    let user_key = $("userKey").value.trim();
    if(!user_key){
      user_key = genUserKey();
      $("userKey").value = user_key;
    }
    setProfileId(user_key);

    try{
      const r = await fetch(API_BASE + "/pay/stars/create", {
        method:"POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({ user_key, days:30, devices:1 })
      });
      const j = await r.json();
      if(!r.ok) throw new Error(j?.detail || "Stars create error");

      $("payStatus").textContent = "pending";
      $("payMeta").textContent = `order: ${j.order_id}`;

      if(tg && tg.openInvoice){
        tg.openInvoice(j.invoice_link, (status)=>{});
      } else {
        window.open(j.invoice_link, "_blank");
      }

      pollOrder(j.order_id);
    }catch(e){
      setError(e.message || String(e));
      $("payStatus").textContent = "error";
      $("payStatus").className = "badge bad";
    }
  });

  $("btnPayUsdt").addEventListener("click", async ()=>{
    clearError();
    show($("payBox"));
    $("payStatus").textContent = "creating‚Ä¶";
    $("payStatus").className = "badge warn";
    $("payMeta").textContent = "";

    let user_key = $("userKey").value.trim();
    if(!user_key){
      user_key = genUserKey();
      $("userKey").value = user_key;
    }
    setProfileId(user_key);

    try{
      const r = await fetch(API_BASE + "/pay/crypto/create", {
        method:"POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({ user_key, days:30, devices:1 })
      });
      const j = await r.json();
      if(!r.ok) throw new Error(j?.detail || "Crypto create error");

      $("payStatus").textContent = "pending";
      $("payMeta").textContent = `order: ${j.order_id}`;

      if(j.invoice_url){
        window.open(j.invoice_url, "_blank");
      }

      pollOrder(j.order_id);
    }catch(e){
      setError(e.message || String(e));
      $("payStatus").textContent = "error";
      $("payStatus").className = "badge bad";
    }
  });

  // referrals
  $("btnRefCreate").addEventListener("click", async ()=>{
    clearError();
    $("refOut").textContent = "—Å–æ–∑–¥–∞—é‚Ä¶";

    let user_key = $("userKey").value.trim() || genUserKey();
    $("userKey").value = user_key;
    setProfileId(user_key);

    try{
      const r = await fetch(API_BASE + "/ref/create", {
        method:"POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({ user_key })
      });
      const j = await r.json();
      if(!r.ok) throw new Error(j?.detail || "ref create error");
      $("refOut").textContent = "–¢–≤–æ–π –∫–æ–¥: " + j.code;
    }catch(e){
      $("refOut").textContent = "";
      setError(e.message || String(e));
    }
  });

  $("btnResetId").addEventListener("click", ()=>{
    const id = genUserKey();
    $("userKey").value = id;
    setProfileId(id);
  });

  // tabs
  function setTab(tab){
    const tabs = [
      ["tabHome","screenHome"],
      ["tabGuide","screenGuide"],
      ["tabProfile","screenProfile"],
    ];
    tabs.forEach(([t,s])=>{
      const bt = $(t), sc = $(s);
      if(t === tab){
        bt.classList.add("active");
        sc.classList.remove("hidden");
      } else {
        bt.classList.remove("active");
        sc.classList.add("hidden");
      }
    });
  }
  $("tabHome").onclick = ()=>setTab("tabHome");
  $("tabGuide").onclick = ()=>setTab("tabGuide");
  $("tabProfile").onclick = ()=>setTab("tabProfile");

  // init
  (async ()=>{
    await pingApi();
    const saved = localStorage.getItem("zeus_user_key");
    if(saved){
      $("userKey").value = saved;
      setProfileId(saved);
    }
    $("userKey").addEventListener("change", ()=>{
      localStorage.setItem("zeus_user_key", $("userKey").value.trim());
    });
  })();
</script>
</body>
</html>
