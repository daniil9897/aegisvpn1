<!doctype html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>ZEUSVPN</title>

  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <style>
    :root{
      --bg:#070A10;
      --bg2:#0A0F18;

      --card: rgba(255,255,255,.06);
      --card2: rgba(255,255,255,.08);
      --stroke: rgba(255,255,255,.12);
      --stroke2: rgba(255,255,255,.16);

      --text:#F3F6FF;
      --muted: rgba(243,246,255,.65);

      /* темный сине-черный, НЕ яркий */
      --accent1: rgba(20,38,74,.95);
      --accent2: rgba(10,20,45,.95);

      --ok:#22c55e;
      --warn:#fbbf24;
      --bad:#ef4444;

      --r:18px;
      --shadow: 0 18px 70px rgba(0,0,0,.55);
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      color:var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background:
        radial-gradient(900px 520px at 80% -10%, rgba(20,38,74,.22), transparent 60%),
        radial-gradient(780px 520px at -20% 20%, rgba(20,38,74,.14), transparent 62%),
        linear-gradient(180deg, var(--bg2), var(--bg));
      overflow-x:hidden;
    }

    .wrap{
      max-width:520px;
      margin:0 auto;
      padding: 18px 16px 32px;
      padding-bottom: calc(32px + env(safe-area-inset-bottom));
    }

    /* top */
    .top{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:14px;
      margin-top: 6px;
    }
    .brand{
      display:flex; align-items:center; gap:12px; min-width:0;
    }
    .logo{
      width:44px;height:44px;border-radius:14px;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.06);
      overflow:hidden;
      box-shadow: 0 10px 30px rgba(0,0,0,.35);
      flex:0 0 auto;
      display:grid; place-items:center;
    }
    .logo img{width:100%;height:100%;object-fit:cover}
    .titlebox{min-width:0}
    .title{margin:0;font-weight:900;font-size:16px;letter-spacing:.2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .subtitle{margin:4px 0 0;font-size:12px;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

    .chip{
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.04);
      padding:10px 12px;
      border-radius: 999px;
      font-size:12px;
      color: var(--muted);
      display:flex;
      align-items:center;
      gap:8px;
      user-select:none;
      flex:0 0 auto;
    }
    .dot{width:8px;height:8px;border-radius:99px;background:rgba(255,255,255,.18);border:1px solid rgba(255,255,255,.18)}
    .dot.ok{background:rgba(34,197,94,.85);border-color:rgba(34,197,94,.9)}
    .dot.warn{background:rgba(251,191,36,.85);border-color:rgba(251,191,36,.9)}
    .dot.bad{background:rgba(239,68,68,.85);border-color:rgba(239,68,68,.9)}

    /* cards */
    .card{
      margin-top:14px;
      border-radius: var(--r);
      border:1px solid var(--stroke);
      background: linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.045));
      box-shadow: var(--shadow);
      overflow:hidden;
      position:relative;
    }
    .card::before{
      content:"";
      position:absolute; inset:0;
      background:
        radial-gradient(800px 180px at 20% 0%, rgba(20,38,74,.18), transparent 60%),
        radial-gradient(700px 220px at 90% 15%, rgba(255,255,255,.06), transparent 55%);
      pointer-events:none;
      opacity:.9;
    }
    .card > *{position:relative}
    .cardHead{
      padding: 16px 16px 12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }
    .cardTitle{margin:0;font-size:14px;font-weight:900;letter-spacing:.2px}
    .small{font-size:12px;color:var(--muted)}
    .divider{
      height:1px;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,.10), transparent);
      margin:0 16px;
    }
    .cardBody{padding: 12px 16px 16px}

    /* profile row */
    .profileRow{display:flex;align-items:center;gap:12px}
    .avatar{
      width:46px;height:46px;border-radius:16px;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.06);
      overflow:hidden;
      flex:0 0 auto;
    }
    .avatar img{width:100%;height:100%;object-fit:cover}
    .pmeta{min-width:0}
    .pname{margin:0;font-weight:900;font-size:14px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .pid{margin:4px 0 0;font-size:12px;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

    /* subscription line (ONLY on home) */
    .subStatus{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      margin-top:12px;
      padding: 12px 12px;
      border:1px solid var(--stroke);
      border-radius: 14px;
      background: rgba(255,255,255,.05);
    }
    .subLeft{min-width:0}
    .subLabel{margin:0;font-size:12px;color:var(--muted);font-weight:800}
    .subValue{margin:4px 0 0;font-size:14px;font-weight:950;letter-spacing:.2px}
    .pill{
      padding:8px 10px;
      border-radius: 999px;
      font-size:12px;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.05);
      color: var(--muted);
      white-space:nowrap;
    }
    .pill.active{border-color: rgba(34,197,94,.35); color: rgba(180,255,210,.92)}
    .pill.none{border-color: rgba(251,191,36,.25); color: rgba(255,235,180,.92)}

    /* buttons */
    .btnRow{display:flex;gap:10px;margin-top:14px}
    .btn{
      width:100%;
      appearance:none;
      border:none;
      border-radius: 16px;
      padding: 14px 14px;
      font-weight:950;
      font-size:14px;
      letter-spacing:.2px;
      color: var(--text);
      background: linear-gradient(180deg, var(--accent1), var(--accent2));
      border:1px solid rgba(255,255,255,.10);
      box-shadow: 0 16px 46px rgba(0,0,0,.45);
      cursor:pointer;
      transition: transform .12s ease;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
    }
    .btn:active{transform: scale(.985)}
    .btn.secondary{
      background: rgba(255,255,255,.06);
      border:1px solid var(--stroke);
      box-shadow:none;
      color: rgba(243,246,255,.86);
    }

    /* config box */
    .configBox{
      margin-top: 12px;
      border-radius: 18px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.30);
      padding: 12px;
      display:none;
    }
    .configBox.show{display:block}
    .configBox .label{margin:0 0 8px;font-size:12px;color:rgba(243,246,255,.65);font-weight:850}
    .configBox textarea{
      width:100%;
      min-height: 92px;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      color: rgba(243,246,255,.92);
      padding: 10px;
      font-size:12px;
      line-height:1.4;
      outline:none;
      resize:none;
    }

    /* modal overlay */
    .modal{
      position:fixed; inset:0;
      background: rgba(0,0,0,.58);
      display:none;
      align-items:flex-end;
      justify-content:center;
      padding: 16px 14px;
      padding-bottom: calc(16px + env(safe-area-inset-bottom));
      z-index: 50;
    }
    .modal.show{display:flex}

    /* FIXED modal sheet: does NOT auto-shrink weirdly */
    .sheet{
      width:100%;
      max-width:520px;
      height: min(74vh, 560px); /* фикс по сути — не режет текст, скролл внутри */
      border-radius: 22px;
      border:1px solid rgba(255,255,255,.12);
      background: linear-gradient(180deg, rgba(10,15,24,.94), rgba(7,9,13,.96));
      box-shadow: 0 26px 90px rgba(0,0,0,.7);
      overflow:hidden;
      display:flex;
      flex-direction:column;
    }
    .sheetHead{
      padding: 14px 14px 10px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      flex:0 0 auto;
    }
    .sheetTitle{margin:0;font-size:14px;font-weight:950}
    .xbtn{
      width:38px;height:38px;border-radius: 14px;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.06);
      color:var(--text);
      display:grid;place-items:center;
      cursor:pointer;
    }
    .sheetBody{
      padding: 12px 14px 14px;
      overflow:auto;
      flex:1 1 auto;
    }

    .row{
      display:flex;
      justify-content:space-between;
      align-items:flex-end;
      gap:12px;
      margin-bottom:10px;
    }
    .row h4{margin:0;font-size:12px;color:var(--muted);font-weight:900}
    .hint{font-size:12px;color:rgba(243,246,255,.50)}
    .chips{display:flex;flex-wrap:wrap;gap:10px;margin-top:10px}

    .chipBtn{
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.05);
      color: rgba(243,246,255,.85);
      padding: 10px 12px;
      border-radius: 999px;
      font-size:13px;
      font-weight:900;
      cursor:pointer;
      transition: transform .12s ease, background .12s ease, border-color .12s ease;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
      position:relative;
      white-space:nowrap;
    }
    .chipBtn:active{transform: scale(.985)}
    .chipBtn.selected{
      background: rgba(20,38,74,.34);
      border-color: rgba(255,255,255,.18);
      color: rgba(243,246,255,.96);
    }
    .badge{
      position:absolute;
      top:-8px; right:-6px;
      font-size:10px;
      padding:4px 7px;
      border-radius: 999px;
      background: rgba(255,255,255,.12);
      border:1px solid rgba(255,255,255,.16);
      color: rgba(243,246,255,.9);
      backdrop-filter: blur(10px);
    }

    .choiceCard{
      margin-top: 14px;
      border-radius: 18px;
      border:1px solid rgba(255,255,255,.12);
      background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.05));
      padding: 14px;
      position:relative;
      overflow:hidden;
    }
    .choiceTop{display:flex;align-items:center;justify-content:space-between;gap:10px}
    .choiceName{margin:0;font-weight:950;font-size:14px}
    .price{margin:0;font-weight:950;font-size:14px;color:rgba(243,246,255,.95)}
    .choiceDesc{margin:8px 0 0;font-size:12px;color:rgba(243,246,255,.70);line-height:1.35}

    .payGrid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:14px}
    .payBtn{
      border-radius: 16px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      padding: 13px 12px;
      text-align:left;
      cursor:pointer;
      transition: transform .12s ease;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
    }
    .payBtn:active{transform: scale(.985)}
    .payBtn strong{display:block;font-size:13px;font-weight:950}
    .payBtn span{display:block;font-size:12px;color:rgba(243,246,255,.60);margin-top:4px}
    .payBtn.primary{
      background: linear-gradient(180deg, rgba(20,38,74,.72), rgba(10,20,45,.86));
      border-color: rgba(255,255,255,.14);
    }

    .statusLine{
      margin-top: 12px;
      font-size:12px;
      color: rgba(243,246,255,.62);
      display:flex;
      justify-content:space-between;
      gap:10px;
      align-items:center;
    }
    .spin{
      width:14px;height:14px;border-radius:50%;
      border:2px solid rgba(255,255,255,.18);
      border-top-color: rgba(255,255,255,.75);
      animation: rot .85s linear infinite;
      display:none;
    }
    .spin.show{display:inline-block}
    @keyframes rot{to{transform:rotate(360deg)}}

    /* Instructions screen — swipe */
    .instWrap{margin-top:10px}
    .swipe{
      display:flex;
      gap:12px;
      overflow:auto;
      scroll-snap-type: x mandatory;
      -webkit-overflow-scrolling: touch;
      padding-bottom: 10px;
    }
    .swipe::-webkit-scrollbar{display:none}
    .instCard{
      flex: 0 0 86%;
      scroll-snap-align: start;
      border-radius: 18px;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.06);
      padding: 14px;
      min-height: 140px;
    }
    .instCard h3{margin:0;font-size:13px;font-weight:950;letter-spacing:.2px}
    .instCard p{margin:10px 0 0;font-size:12px;color:rgba(243,246,255,.70);line-height:1.45}
    .dots{display:flex;justify-content:center;gap:8px;margin: 2px 0 0}
    .dots span{width:6px;height:6px;border-radius:99px;background:rgba(255,255,255,.18);border:1px solid rgba(255,255,255,.18)}
    .dots span.on{background:rgba(255,255,255,.62);border-color:rgba(255,255,255,.55)}

    /* bottom nav */
    .nav{
      position:sticky;
      bottom: 12px;
      margin-top: 16px;
      border-radius: 18px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(10,15,24,.55);
      backdrop-filter: blur(14px);
      display:flex;
      overflow:hidden;
    }
    .tab{
      flex:1;
      padding: 12px 10px;
      text-align:center;
      font-size:12px;
      font-weight:950;
      color: rgba(243,246,255,.62);
      cursor:pointer;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
    }
    .tab.active{color: rgba(243,246,255,.95);background: rgba(255,255,255,.06)}

    .screen{display:none}
    .screen.show{display:block}
    .fadeSlideIn{animation: fsi .22s ease both}
    @keyframes fsi{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}

    .toast{
      position:fixed;
      left:50%;
      bottom: 20px;
      transform: translateX(-50%);
      background: rgba(0,0,0,.72);
      color: rgba(243,246,255,.92);
      border:1px solid rgba(255,255,255,.12);
      padding: 10px 12px;
      border-radius: 999px;
      font-size:12px;
      box-shadow: 0 18px 60px rgba(0,0,0,.55);
      display:none;
      z-index: 99;
      max-width: 92vw;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .toast.show{display:block}

    /* debug error block inside modal */
    .errBox{
      margin-top: 12px;
      border-radius: 14px;
      border:1px solid rgba(239,68,68,.25);
      background: rgba(239,68,68,.08);
      padding: 10px 10px;
      color: rgba(255,210,210,.92);
      font-size:12px;
      line-height:1.35;
      display:none;
      white-space:pre-wrap;
      word-break:break-word;
    }
    .errBox.show{display:block}
    .errTitle{font-weight:950;margin-bottom:6px;color:rgba(255,220,220,.96)}
  </style>
</head>

<body>
  <div class="wrap">
    <div class="top">
      <div class="brand">
        <div class="logo"><img id="logoImg" alt="ZEUSVPN"></div>
        <div class="titlebox">
          <p class="title">ZEUSVPN</p>
          <p class="subtitle" id="subtitle">Премиум доступ • стабильное подключение</p>
        </div>
      </div>

      <div class="chip">
        <span class="dot warn" id="apiDot"></span>
        <span id="apiText">API проверка…</span>
      </div>
    </div>

    <!-- HOME -->
    <div class="screen show fadeSlideIn" id="screenHome">
      <div class="card">
        <div class="cardHead">
          <p class="cardTitle">Главная</p>
          <span class="pill none" id="subPill">Подписки нет</span>
        </div>
        <div class="divider"></div>
        <div class="cardBody">

          <div class="profileRow">
            <div class="avatar"><img id="avatarImg" alt="avatar"></div>
            <div class="pmeta">
              <p class="pname" id="pName">—</p>
              <p class="pid" id="pId">TG ID: —</p>
            </div>
          </div>

          <!-- ONLY HERE "Активна до" -->
          <div class="subStatus">
            <div class="subLeft">
              <p class="subLabel">Подписка активна до</p>
              <p class="subValue" id="activeUntilText">—</p>
            </div>
            <div class="pill" id="planMini">—</div>
          </div>

          <div class="btnRow">
            <button class="btn" id="btnSubscribe">Приобрести подписку</button>
          </div>

          <div class="configBox" id="configBox">
            <p class="label">Ваш конфиг</p>
            <textarea id="configText" readonly></textarea>
            <div class="btnRow" style="margin-top:10px">
              <button class="btn" id="btnCopy">Скопировать</button>
              <button class="btn secondary" id="btnCloseConfig">Скрыть</button>
            </div>
          </div>

        </div>
      </div>
    </div>

    <!-- PROFILE -->
    <div class="screen" id="screenProfile">
      <div class="card">
        <div class="cardHead">
          <p class="cardTitle">Профиль</p>
          <span class="small">только нужное</span>
        </div>
        <div class="divider"></div>
        <div class="cardBody">

          <div class="profileRow">
            <div class="avatar"><img id="avatarImg2" alt="avatar2"></div>
            <div class="pmeta">
              <p class="pname" id="pName2">—</p>
              <p class="pid" id="pId2">TG ID: —</p>
            </div>
          </div>

          <!-- вернул кнопку Инструкции -->
          <div class="btnRow">
            <button class="btn secondary" id="btnGoInstructions">Инструкции</button>
          </div>
        </div>
      </div>
    </div>

    <!-- INSTRUCTIONS -->
    <div class="screen" id="screenInstructions">
      <div class="card">
        <div class="cardHead">
          <p class="cardTitle">Инструкции</p>
          <span class="small">свайпни →</span>
        </div>
        <div class="divider"></div>
        <div class="cardBody instWrap">
          <div class="swipe" id="swipe">
            <div class="instCard">
              <h3>iOS (V2Box / Streisand)</h3>
              <p>1) Установи клиент из App Store.<br>
                 2) Нажми “Добавить конфиг”.<br>
                 3) Вставь ссылку VLESS.<br>
                 4) Сохрани и подключи.</p>
            </div>
            <div class="instCard">
              <h3>Android (v2rayNG)</h3>
              <p>1) Установи v2rayNG.<br>
                 2) Нажми “+” → Import from clipboard.<br>
                 3) Вставь ссылку и включи.</p>
            </div>
            <div class="instCard">
              <h3>Desktop (Windows/macOS)</h3>
              <p>1) Установи Nekoray / v2rayN.<br>
                 2) Импортируй ссылку VLESS.<br>
                 3) Выбери профиль и включи.</p>
            </div>
          </div>
          <div class="dots" id="dots">
            <span class="on"></span><span></span><span></span>
          </div>

          <div class="btnRow">
            <button class="btn secondary" id="btnBackFromInstructions">Назад</button>
          </div>
        </div>
      </div>
    </div>

    <!-- NAV -->
    <div class="nav">
      <div class="tab active" data-tab="home">Главная</div>
      <div class="tab" data-tab="profile">Профиль</div>
    </div>
  </div>

  <!-- MODAL -->
  <div class="modal" id="modal">
    <div class="sheet">
      <div class="sheetHead">
        <p class="sheetTitle">Подписка</p>
        <div class="xbtn" id="closeModal">✕</div>
      </div>
      <div class="divider"></div>

      <div class="sheetBody">

        <div class="row">
          <h4>Устройства</h4>
          <div class="hint">выбери слот</div>
        </div>
        <div class="chips" id="deviceChips">
          <div class="chipBtn selected" data-dev="1">1</div>
          <div class="chipBtn" data-dev="3">3</div>
          <div class="chipBtn" data-dev="5">5</div>
          <div class="chipBtn" data-dev="10">10</div>
        </div>

        <div style="height:12px"></div>

        <div class="row">
          <h4>Срок</h4>
          <div class="hint">дней</div>
        </div>
        <div class="chips" id="dayChips">
          <div class="chipBtn selected" data-days="30">30 <span class="badge">Популярно</span></div>
          <div class="chipBtn" data-days="90">90</div>
          <div class="chipBtn" data-days="180">180 <span class="badge">Выгоднее</span></div>
        </div>

        <div class="choiceCard">
          <div class="choiceTop">
            <p class="choiceName" id="choiceName">30 дней • 1 устройство</p>
            <p class="price" id="choicePrice">199</p>
          </div>
          <p class="choiceDesc" id="choiceDesc">
            После оплаты статус изменится на “активна”, появится дата и конфиг.
          </p>
        </div>

        <div class="payGrid">
          <button class="payBtn primary" id="payStars">
            <strong>Оплатить Stars</strong>
            <span>в Telegram</span>
          </button>
          <button class="payBtn" id="payCrypto">
            <strong>Оплатить USDT</strong>
            <span>Crypto Bot</span>
          </button>
        </div>

        <div class="statusLine">
          <div style="display:flex;gap:10px;align-items:center;min-width:0">
            <span class="spin" id="spin"></span>
            <span id="statusText">Выбери параметры и способ оплаты</span>
          </div>
          <span class="small" id="orderHint"></span>
        </div>

        <div class="errBox" id="errBox">
          <div class="errTitle">Ошибка запроса</div>
          <div id="errText"></div>
        </div>

      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script>
    // ===== CONFIG =====
    const API_BASE = "https://api.45.133.251.210.nip.io:8443";
    const LOGO_URL = "./logo.png"; // положи logo.png рядом с index.html

    // ===== STATE =====
    const state = {
      user_key: "site-guest",
      tg: { id:null, username:null, name:"Гость", photo:null },
      devices: 1,
      days: 30,
      pollTimer: null,
      paidActiveUntil: null
    };

    // ===== DOM =====
    const $ = (id)=>document.getElementById(id);
    $("logoImg").src = LOGO_URL;

    const apiDot = $("apiDot");
    const apiText = $("apiText");

    const pName = $("pName"), pId = $("pId"), avatarImg = $("avatarImg");
    const pName2 = $("pName2"), pId2 = $("pId2"), avatarImg2 = $("avatarImg2");

    const subPill = $("subPill");
    const activeUntilText = $("activeUntilText");
    const planMini = $("planMini");

    const btnSubscribe = $("btnSubscribe");

    const modal = $("modal");
    const closeModal = $("closeModal");

    const deviceChips = $("deviceChips");
    const dayChips = $("dayChips");

    const choiceName = $("choiceName");
    const choicePrice = $("choicePrice");

    const payStars = $("payStars");
    const payCrypto = $("payCrypto");

    const statusText = $("statusText");
    const orderHint = $("orderHint");
    const spin = $("spin");

    const errBox = $("errBox");
    const errText = $("errText");

    const configBox = $("configBox");
    const configText = $("configText");
    const btnCopy = $("btnCopy");
    const btnCloseConfig = $("btnCloseConfig");

    const toast = $("toast");

    // nav screens
    const screenHome = $("screenHome");
    const screenProfile = $("screenProfile");
    const screenInstructions = $("screenInstructions");

    function showToast(msg){
      toast.textContent = msg;
      toast.classList.add("show");
      setTimeout(()=>toast.classList.remove("show"), 2200);
    }

    function hapticLight(){
      try{
        if(window.Telegram?.WebApp?.HapticFeedback){
          window.Telegram.WebApp.HapticFeedback.impactOccurred("light");
        }
      }catch(e){}
    }
    function hapticSuccess(){
      try{
        if(window.Telegram?.WebApp?.HapticFeedback){
          window.Telegram.WebApp.HapticFeedback.notificationOccurred("success");
        }
      }catch(e){}
    }
    function hapticError(){
      try{
        if(window.Telegram?.WebApp?.HapticFeedback){
          window.Telegram.WebApp.HapticFeedback.notificationOccurred("error");
        }
      }catch(e){}
    }

    function fmtDate(iso){
      if(!iso) return "—";
      const d = new Date(iso);
      if(isNaN(d)) return "—";
      const dd = String(d.getDate()).padStart(2,"0");
      const mm = String(d.getMonth()+1).padStart(2,"0");
      const yy = d.getFullYear();
      return `${dd}.${mm}.${yy}`;
    }

    function priceFor(days){
      if(days==30) return 199;
      if(days==90) return 399;
      if(days==180) return 599;
      return 0;
    }

    function clearError(){
      errBox.classList.remove("show");
      errText.textContent = "";
    }
    function showError(err, url){
      errBox.classList.add("show");
      const msg = (err && err.message) ? err.message : String(err);
      errText.textContent =
        `URL: ${url}\n` +
        `Ошибка: ${msg}\n\n` +
        `Если это "Failed to fetch" — значит браузер/Telegram не доверяет SSL на API:8443.`;
    }

    async function apiHealth(){
      try{
        const r = await fetch(`${API_BASE}/health`, { method:"GET", mode:"cors" });
        if(!r.ok) throw new Error("health not ok");
        apiDot.className = "dot ok";
        apiText.textContent = "API online";
        return true;
      }catch(e){
        apiDot.className = "dot bad";
        apiText.textContent = "API/SSL ошибка";
        return false;
      }
    }

    async function apiPost(path, body){
      const url = `${API_BASE}${path}`;
      const r = await fetch(url,{
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify(body),
        mode:"cors"
      });
      if(!r.ok){
        const t = await r.text().catch(()=> "");
        throw new Error(`HTTP ${r.status}: ${t}`);
      }
      return r.json();
    }

    async function apiGet(path){
      const url = `${API_BASE}${path}`;
      const r = await fetch(url,{ method:"GET", mode:"cors" });
      if(!r.ok){
        const t = await r.text().catch(()=> "");
        throw new Error(`HTTP ${r.status}: ${t}`);
      }
      return r.json();
    }

    function setSubUI(order){
      const isActive = order?.active_until && (order.status==="paid" || order.status==="active");
      if(isActive){
        subPill.classList.remove("none");
        subPill.classList.add("active");
        subPill.textContent = "Подписка активна";
        activeUntilText.textContent = fmtDate(order.active_until);
        planMini.textContent = `${order.plan_days}д • ${order.devices}устр`;
        state.paidActiveUntil = order.active_until;
        btnSubscribe.textContent = "Продлить";
      }else{
        subPill.classList.remove("active");
        subPill.classList.add("none");
        subPill.textContent = "Подписки нет";
        activeUntilText.textContent = "—";
        planMini.textContent = "—";
        state.paidActiveUntil = null;
        btnSubscribe.textContent = "Приобрести подписку";
      }
    }

    function updateChoiceUI(){
      [...deviceChips.querySelectorAll(".chipBtn")].forEach(b=>{
        b.classList.toggle("selected", Number(b.dataset.dev)===state.devices);
      });
      [...dayChips.querySelectorAll(".chipBtn")].forEach(b=>{
        b.classList.toggle("selected", Number(b.dataset.days)===state.days);
      });

      choiceName.textContent = `${state.days} дней • ${state.devices} устройство${state.devices===1?'':'(а)'}`;
      const p = priceFor(state.days);
      choicePrice.textContent = p ? `${p} XTR` : "—";
    }

    function showModal(){
      clearError();
      modal.classList.add("show");
      document.body.style.overflow = "hidden";
      updateChoiceUI();
    }
    function hideModal(){
      modal.classList.remove("show");
      document.body.style.overflow = "";
      spin.classList.remove("show");
      statusText.textContent = "Выбери параметры и способ оплаты";
      orderHint.textContent = "";
      clearError();
      clearInterval(state.pollTimer);
    }

    function openInvoiceTG(url){
      if(window.Telegram?.WebApp?.openInvoice){
        return new Promise((resolve)=>{
          window.Telegram.WebApp.openInvoice(url, (status)=> resolve(status));
        });
      }
      // browser fallback
      window.open(url, "_blank");
      return Promise.resolve("opened");
    }

    function startPolling(order_id){
      clearInterval(state.pollTimer);
      state.pollTimer = setInterval(async ()=>{
        try{
          const o = await apiGet(`/pay/order/${order_id}`);
          if(o.status === "paid" || o.status === "active"){
            clearInterval(state.pollTimer);
            spin.classList.remove("show");
            statusText.textContent = "Оплата подтверждена ✅";
            orderHint.textContent = "";

            setSubUI(o);

            if(o.config_link){
              configText.value = o.config_link;
              configBox.classList.add("show");
              hapticSuccess();
            }else{
              showToast("Оплата ок. Конфиг появится после выдачи.");
              hapticSuccess();
            }
          }else{
            statusText.textContent = `Ожидаю оплату… (${o.status})`;
          }
        }catch(e){
          // не убиваем polling из-за временной ошибки
          statusText.textContent = "Проверяю оплату…";
        }
      }, 1200);
    }

    function loadTelegramUser(){
      const tg = window.Telegram?.WebApp;
      if(tg){
        try{ tg.ready(); }catch(e){}
        try{ tg.expand(); }catch(e){}
      }
      const u = tg?.initDataUnsafe?.user;

      if(u){
        state.tg.id = u.id;
        state.tg.username = u.username ? "@"+u.username : "";
        state.tg.name = [u.first_name, u.last_name].filter(Boolean).join(" ").trim() || "Пользователь";
        state.tg.photo = u.photo_url || null;
        state.user_key = String(u.id);
      }else{
        state.user_key = "site-guest";
        state.tg = { id:null, username:"", name:"Гость (browser)", photo:null };
      }

      const nameLine = state.tg.name + (state.tg.username ? ` • ${state.tg.username}` : "");
      pName.textContent = nameLine;
      pId.textContent = `TG ID: ${state.tg.id ?? "—"}`;

      pName2.textContent = nameLine;
      pId2.textContent = `TG ID: ${state.tg.id ?? "—"}`;

      const img = state.tg.photo || "data:image/svg+xml;charset=utf-8,"+encodeURIComponent(`
        <svg xmlns='http://www.w3.org/2000/svg' width='120' height='120'>
          <rect width='100%' height='100%' fill='rgba(255,255,255,.08)'/>
          <circle cx='60' cy='52' r='22' fill='rgba(255,255,255,.22)'/>
          <rect x='24' y='80' width='72' height='24' rx='12' fill='rgba(255,255,255,.16)'/>
        </svg>
      `);
      avatarImg.src = img;
      avatarImg2.src = img;
    }

    function bindSwipeDots(){
      const swipe = $("swipe");
      const dots = [...$("dots").children];
      function update(){
        const cards = swipe.children;
        let best = 0;
        let bestDist = Infinity;
        for(let i=0;i<cards.length;i++){
          const rect = cards[i].getBoundingClientRect();
          const dist = Math.abs(rect.left - 16);
          if(dist < bestDist){ bestDist = dist; best = i; }
        }
        dots.forEach((d,i)=>d.classList.toggle("on", i===best));
      }
      swipe.addEventListener("scroll", ()=>requestAnimationFrame(update), {passive:true});
      update();
    }

    function showScreen(name){
      [screenHome, screenProfile, screenInstructions].forEach(s=>s.classList.remove("show","fadeSlideIn"));
      if(name==="home") screenHome.classList.add("show","fadeSlideIn");
      if(name==="profile") screenProfile.classList.add("show","fadeSlideIn");
      if(name==="instructions") screenInstructions.classList.add("show","fadeSlideIn");

      document.querySelectorAll(".tab").forEach(t=>{
        t.classList.toggle("active", t.dataset.tab===name);
      });
      // instructions screen is not in bottom tabs; keep last active tab
      if(name==="instructions"){
        document.querySelectorAll(".tab").forEach(t=>{
          if(t.dataset.tab==="home") t.classList.add("active");
          if(t.dataset.tab==="profile") t.classList.remove("active");
        });
      }
    }

    // ===== INIT =====
    (function init(){
      loadTelegramUser();
      bindSwipeDots();
      apiHealth();

      // default sub ui
      setSubUI(null);

      // nav
      document.querySelectorAll(".tab").forEach(t=>{
        t.addEventListener("click", ()=>{
          hapticLight();
          showScreen(t.dataset.tab);
        });
      });

      // instructions button in profile
      $("btnGoInstructions").addEventListener("click", ()=>{
        hapticLight();
        showScreen("instructions");
      });
      $("btnBackFromInstructions").addEventListener("click", ()=>{
        hapticLight();
        showScreen("profile");
      });

      // modal open/close
      btnSubscribe.addEventListener("click", ()=>{
        hapticLight();
        showModal();
      });
      closeModal.addEventListener("click", hideModal);
      modal.addEventListener("click", (e)=>{ if(e.target===modal) hideModal(); });

      // chips select
      deviceChips.addEventListener("click", (e)=>{
        const b = e.target.closest(".chipBtn"); if(!b) return;
        state.devices = Number(b.dataset.dev);
        updateChoiceUI();
        hapticLight();
      });
      dayChips.addEventListener("click", (e)=>{
        const b = e.target.closest(".chipBtn"); if(!b) return;
        state.days = Number(b.dataset.days);
        updateChoiceUI();
        hapticLight();
      });

      // config actions
      btnCopy.addEventListener("click", async ()=>{
        try{
          await navigator.clipboard.writeText(configText.value || "");
          showToast("Скопировано");
          hapticSuccess();
        }catch(e){
          showToast("Не удалось скопировать");
          hapticError();
        }
      });
      btnCloseConfig.addEventListener("click", ()=>configBox.classList.remove("show"));

      // PAY STARS
      payStars.addEventListener("click", async ()=>{
        clearError();
        spin.classList.add("show");
        statusText.textContent = "Создаю заказ (Stars)…";
        orderHint.textContent = "";

        const url = `${API_BASE}/pay/stars/create`;
        try{
          const res = await apiPost("/pay/stars/create", {
            user_key: state.user_key,
            days: state.days,
            devices: state.devices
          });

          orderHint.textContent = `#${res.order_id}`;
          statusText.textContent = "Открываю оплату…";

          await openInvoiceTG(res.invoice_link);

          statusText.textContent = "Ожидаю оплату…";
          spin.classList.add("show");
          startPolling(res.order_id);
        }catch(err){
          spin.classList.remove("show");
          statusText.textContent = "Не удалось создать заказ";
          showError(err, url);
          hapticError();
        }
      });

      // PAY USDT
      payCrypto.addEventListener("click", async ()=>{
        clearError();
        spin.classList.add("show");
        statusText.textContent = "Создаю инвойс (USDT)…";
        orderHint.textContent = "";

        const url = `${API_BASE}/pay/crypto/create`;
        try{
          const res = await apiPost("/pay/crypto/create", {
            user_key: state.user_key,
            days: state.days,
            devices: state.devices
          });

          orderHint.textContent = `#${res.order_id}`;
          statusText.textContent = "Открываю оплату USDT…";

          const invUrl = res.invoice_url || res.invoice_link || res.url;
          if(!invUrl) throw new Error("invoice_url missing in response");

          window.open(invUrl, "_blank");

          statusText.textContent = "Ожидаю оплату…";
          spin.classList.add("show");
          startPolling(res.order_id);
        }catch(err){
          spin.classList.remove("show");
          statusText.textContent = "Не удалось создать инвойс";
          showError(err, url);
          hapticError();
        }
      });

      updateChoiceUI();
    })();
  </script>
</body>
</html>
