
<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#07080c" />
  <title>ZEUSVPN</title>

  <style>
    :root{
      --bg:#07080c;
      --bg2:#0a0c12;

      --card:#0f121b;
      --card2:#101520;

      --stroke: rgba(255,255,255,.09);
      --stroke2: rgba(84,126,255,.18);

      --text:#f1f4ff;
      --muted: rgba(241,244,255,.70);
      --muted2: rgba(241,244,255,.48);

      --blue:#2f6bff;
      --blue2:#2556e7;

      --shadow: 0 18px 60px rgba(0,0,0,.65);
      --shadow2: 0 10px 28px rgba(0,0,0,.50);

      --r: 18px;
      --r2: 22px;

      --safeTop: env(safe-area-inset-top, 0px);
      --safeBot: env(safe-area-inset-bottom, 0px);

      --max: 520px;
      --fast: 160ms;
      --med: 300ms;
    }

    *{ box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
    html,body{ height:100%; margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial; color:var(--text); }
    body{
      background:
        radial-gradient(900px 520px at 50% -10%, rgba(47,107,255,.14) 0%, transparent 55%),
        linear-gradient(180deg, var(--bg2), var(--bg));
      overflow-x:hidden;
    }

    .app{
      max-width: var(--max);
      margin: 0 auto;
      min-height:100%;
      padding: calc(14px + var(--safeTop)) 14px calc(92px + var(--safeBot)) 14px;
    }

    /* ===== TOP HEADER (как на скрине) ===== */
    .header{
      border-radius: var(--r2);
      border: 1px solid rgba(255,255,255,.10);
      background:
        radial-gradient(700px 240px at 20% 0%, rgba(47,107,255,.18), transparent 62%),
        linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.03));
      box-shadow: var(--shadow2);
      padding: 14px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
    }
    .brand{
      display:flex;
      align-items:center;
      gap: 10px;
      min-width:0;
    }
    .bolt{
      width: 34px; height: 34px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.22);
      display:grid;
      place-items:center;
      flex: 0 0 34px;
      box-shadow: 0 10px 18px rgba(0,0,0,.45);
    }
    .bolt svg{ width: 18px; height: 18px; }
    .brand-text{ min-width:0; }
    .brand-text .name{
      font-weight: 900;
      letter-spacing:.06em;
      font-size: 14px;
      text-transform: uppercase;
      margin:0;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .brand-text .sub{
      margin:0;
      margin-top: 2px;
      font-size: 12px;
      color: var(--muted2);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    .status-pill{
      display:inline-flex;
      align-items:center;
      gap: 8px;
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      color: var(--muted);
      font-size: 12px;
      white-space:nowrap;
    }
    .dot{
      width: 9px; height: 9px;
      border-radius: 999px;
      background: #ff3b30;
      box-shadow: 0 0 0 4px rgba(255,59,48,.12);
    }

    /* ===== MAIN CARD ===== */
    .card{
      margin-top: 12px;
      border-radius: var(--r2);
      border: 1px solid rgba(255,255,255,.10);
      background:
        radial-gradient(900px 300px at 25% 0%, rgba(47,107,255,.12), transparent 65%),
        linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      box-shadow: var(--shadow2);
      overflow:hidden;
    }
    .card .inner{ padding: 16px; }

    h2{
      margin:0;
      font-size: 28px;
      letter-spacing: -0.02em;
      line-height: 1.08;
    }
    .lead{
      margin: 10px 0 0 0;
      font-size: 14px;
      color: var(--muted);
      line-height: 1.55;
    }

    /* KPI row like screenshot */
    .kpis{
      margin-top: 14px;
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 10px;
    }
    .kpi{
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.16);
      padding: 12px;
      min-height: 74px;
      display:flex;
      flex-direction:column;
      justify-content:center;
      gap: 6px;
    }
    .kpi .t{ font-size: 12px; color: var(--muted2); }
    .kpi .v{ font-size: 13px; font-weight: 900; color: var(--text); }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; }

    /* Divider line like in screenshot */
    .divider{
      height:1px;
      background: rgba(255,255,255,.08);
      margin: 16px 0;
    }

    /* Config block like screenshot */
    .cfg-head{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap: 12px;
      margin-bottom: 10px;
    }
    .cfg-head .l{
      font-weight: 900;
      letter-spacing:.14em;
      font-size: 14px;
      text-transform: uppercase;
      color: var(--muted);
    }
    .cfg-head .r{
      font-size: 12px;
      color: var(--muted2);
    }
    label{
      display:block;
      font-size: 12px;
      color: var(--muted);
      margin-bottom: 8px;
    }
    .input{
      width:100%;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      color: var(--text);
      padding: 14px 14px;
      font-size: 14px;
      outline:none;
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.02);
    }
    .help{
      margin-top: 10px;
      font-size: 12px;
      color: var(--muted2);
      line-height: 1.45;
    }

    /* Big blue button like screenshot */
    .bigbtn{
      margin-top: 14px;
      width:100%;
      border: 0;
      border-radius: 16px;
      padding: 14px 14px;
      font-size: 16px;
      font-weight: 900;
      color: white;
      background: linear-gradient(180deg, var(--blue), var(--blue2));
      box-shadow: 0 16px 30px rgba(47,107,255,.20), 0 12px 26px rgba(0,0,0,.55);
      cursor:pointer;
      transition: transform var(--fast) ease, filter var(--fast) ease;
    }
    .bigbtn:active{ transform: scale(.988); }
    .bigbtn[disabled]{ opacity:.55; cursor:not-allowed; }

    /* ===== SCREENS (iOS fade/slide) ===== */
    .screens{ position:relative; min-height: 420px; }
    .screen{
      position:absolute; inset:0;
      opacity:0;
      transform: translateY(10px);
      transition: opacity var(--med) ease, transform var(--med) ease;
      pointer-events:none;
    }
    .screen.active{
      opacity:1;
      transform: translateY(0);
      pointer-events:auto;
    }

    /* ===== BOTTOM NAV ===== */
    .nav{
      position:fixed;
      left:0; right:0; bottom:0;
      padding: 10px 14px calc(10px + var(--safeBot)) 14px;
      z-index: 40;
    }
    .bar{
      max-width: var(--max);
      margin: 0 auto;
      border-radius: 22px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(10,12,18,.72);
      box-shadow: 0 22px 70px rgba(0,0,0,.78);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      padding: 8px;
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 8px;
    }
    .tab{
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,.08);
      background: rgba(0,0,0,.12);
      color: rgba(241,244,255,.55);
      padding: 12px 10px;
      font-size: 13px;
      font-weight: 900;
      cursor:pointer;
      transition: transform var(--fast) ease, background var(--fast) ease, color var(--fast) ease, border-color var(--fast) ease;
    }
    .tab:active{ transform: scale(.988); }
    .tab.active{
      color: var(--text);
      border-color: rgba(47,107,255,.20);
      background:
        radial-gradient(420px 160px at 15% 0%, rgba(47,107,255,.16), transparent 70%),
        rgba(0,0,0,.14);
      box-shadow: 0 0 0 1px rgba(47,107,255,.08) inset;
    }

    /* ===== MODAL ===== */
    .backdrop{
      position:fixed; inset:0;
      background: rgba(0,0,0,.70);
      display:none;
      align-items:flex-end;
      justify-content:center;
      padding: 14px;
      z-index: 60;
    }
    .backdrop.show{ display:flex; }
    .sheet{
      width: min(var(--max), 100%);
      border-radius: 26px;
      border: 1px solid rgba(255,255,255,.10);
      background:
        radial-gradient(900px 300px at 18% 0%, rgba(47,107,255,.14), transparent 65%),
        linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.02));
      box-shadow: var(--shadow);
      overflow:hidden;
      transform: translateY(18px);
      opacity:0;
      transition: transform var(--med) ease, opacity var(--med) ease;
    }
    .backdrop.show .sheet{ transform: translateY(0); opacity:1; }

    .sheet-head{
      padding: 14px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      border-bottom: 1px solid rgba(255,255,255,.08);
    }
    .sheet-title{
      font-size: 14px;
      font-weight: 900;
      letter-spacing:.02em;
    }
    .xbtn{
      width: 40px; height: 40px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      color: var(--text);
      display:grid;
      place-items:center;
      cursor:pointer;
    }
    .xbtn:active{ transform: scale(.988); }

    .sheet-body{ padding: 14px; display:grid; gap: 12px; }

    .row-title{
      display:flex;
      justify-content:space-between;
      align-items:baseline;
      gap: 10px;
    }
    .row-title .l{ font-size: 13px; font-weight: 900; color: var(--text); }
    .row-title .r{ font-size: 12px; color: var(--muted2); }

    .chips{ display:flex; flex-wrap:wrap; gap: 10px; margin-top: 10px; }
    .chip{
      padding: 10px 12px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.16);
      color: var(--text);
      font-size: 13px;
      font-weight: 900;
      cursor:pointer;
      transition: transform var(--fast) ease, border-color var(--fast) ease, background var(--fast) ease;
      user-select:none;
    }
    .chip:active{ transform: scale(.988); }
    .chip.active{
      border-color: rgba(47,107,255,.22);
      background:
        radial-gradient(420px 160px at 15% 0%, rgba(47,107,255,.18), transparent 70%),
        rgba(0,0,0,.14);
      box-shadow: 0 0 0 1px rgba(47,107,255,.08) inset;
    }

    .selcard{
      margin-top: 6px;
      border-radius: 22px;
      border: 1px solid rgba(47,107,255,.18);
      background:
        radial-gradient(700px 260px at 15% 0%, rgba(47,107,255,.16), transparent 70%),
        linear-gradient(180deg, rgba(255,255,255,.06), rgba(0,0,0,.20));
      box-shadow: 0 28px 60px rgba(0,0,0,.62);
      padding: 14px;
      position:relative;
      overflow:hidden;
      transform: perspective(900px) rotateX(5deg);
    }
    .selcard .big{ margin:0; font-size: 15px; font-weight: 950; }
    .meta{ margin-top: 10px; display:flex; gap: 8px; flex-wrap:wrap; }
    .badge{
      display:inline-flex; gap:6px; align-items:center;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.14);
      font-size: 12px;
      color: var(--muted);
    }
    .tag{
      display:inline-flex;
      padding: 5px 10px;
      border-radius: 999px;
      border: 1px solid rgba(47,107,255,.22);
      background: rgba(47,107,255,.12);
      color: var(--text);
      font-size: 12px;
      font-weight: 900;
    }

    .sheet-foot{
      padding: 14px;
      border-top: 1px solid rgba(255,255,255,.08);
      display:grid;
      gap: 10px;
    }
    .small{
      font-size: 12px;
      color: var(--muted2);
      line-height: 1.5;
    }

    .btn{
      width:100%;
      border:0;
      border-radius: 16px;
      padding: 14px 14px;
      font-size: 15px;
      font-weight: 900;
      color: white;
      background: linear-gradient(180deg, var(--blue), var(--blue2));
      box-shadow: 0 16px 30px rgba(47,107,255,.20), 0 12px 26px rgba(0,0,0,.55);
      cursor:pointer;
      transition: transform var(--fast) ease;
    }
    .btn:active{ transform: scale(.988); }
    .btn[disabled]{ opacity:.55; cursor:not-allowed; }

    .codebox{
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      padding: 12px;
      margin-top: 10px;
    }
    .code{
      font-size: 12px;
      line-height: 1.45;
      word-break: break-all;
      color: #EEF3FF;
    }
    .row2{ display:flex; gap:10px; }
    .btn2{
      flex:1;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      color: var(--text);
      padding: 12px 12px;
      font-weight: 900;
      cursor:pointer;
    }
    .btn2:active{ transform: scale(.988); }
    .btn2.primary{
      border:0;
      background: linear-gradient(180deg, var(--blue), var(--blue2));
      color:#fff;
    }

    .toast{
      position:fixed;
      left:50%;
      transform: translateX(-50%);
      bottom: calc(98px + var(--safeBot));
      background: rgba(10,12,18,.86);
      border:1px solid rgba(255,255,255,.10);
      border-radius: 16px;
      padding: 10px 12px;
      color: var(--text);
      font-size: 12px;
      opacity:0;
      pointer-events:none;
      transition: opacity var(--fast) ease, transform var(--fast) ease;
      z-index: 80;
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
    }
    .toast.show{ opacity:1; transform: translateX(-50%) translateY(-4px); }
  </style>
</head>

<body>
  <div class="app">
    <!-- Header -->
    <div class="header">
      <div class="brand">
        <div class="bolt" aria-hidden="true">
          <svg viewBox="0 0 24 24" fill="none">
            <path d="M13 2 5 14h7l-1 8 8-12h-7l1-8Z" stroke="currentColor" stroke-width="1.7" stroke-linejoin="round"/>
          </svg>
        </div>
        <div class="brand-text">
          <p class="name">ZEUSVPN</p>
          <p class="sub">Minimal • Dark • Fast</p>
        </div>
      </div>
      <div class="status-pill"><span class="dot"></span><span id="apiStatus">offline</span></div>
    </div>

    <div class="card">
      <div class="inner screens">

        <!-- HOME -->
        <div class="screen active" id="screen-home">
          <h2>Премиум без лишнего.</h2>
          <p class="lead">Нажми “Приобрести подписку” → выбери срок и устройства → оплата → конфиг + Copy.</p>

          <div class="kpis">
            <div class="kpi">
              <div class="t">Подписка</div>
              <div class="v" id="kSub">не оплачено</div>
            </div>
            <div class="kpi">
              <div class="t">Устройства</div>
              <div class="v" id="kDev">—</div>
            </div>
            <div class="kpi">
              <div class="t">API</div>
              <div class="v" id="kApi">offline</div>
            </div>
          </div>

          <div class="divider"></div>

          <div class="cfg-head">
            <div class="l">КОНФИГ</div>
            <div class="r">после оплаты</div>
          </div>

          <label for="userKey">ID пользователя (позже Telegram ID)</label>
          <input class="input mono" id="userKey" placeholder="zeus-0000" />

          <div class="help" id="activeRow">
            Активна до: <b id="activeUntil">—</b>
          </div>

          <button class="bigbtn" id="btnBuy">Приобрести подписку</button>
        </div>

        <!-- INSTRUCTIONS -->
        <div class="screen" id="screen-help">
          <h2 style="font-size:22px;">Инструкции</h2>
          <p class="lead">Пока заглушка. Позже сделаем 3 свайп-карточки.</p>
          <div class="divider"></div>
          <p class="lead" style="margin-top:0;">После оплаты ты получишь vless:// — импортируй в своё приложение.</p>
        </div>

        <!-- PROFILE (без Active Until!) -->
        <div class="screen" id="screen-profile">
          <h2 style="font-size:22px;">Профиль</h2>
          <p class="lead">Заглушка под будущую интеграцию с ботом.</p>
          <div class="divider"></div>
          <p class="lead" style="margin-top:0;">
            ID: <b class="mono" id="pId">—</b>
          </p>
          <p class="lead" style="margin-top:8px;">
            Тариф: <b id="pPlan">—</b>
          </p>
          <!-- Active Until специально удалено -->
          <button class="bigbtn" id="btnReset" style="margin-top:14px;background:linear-gradient(180deg,#171c2a,#0f121b);box-shadow:0 14px 26px rgba(0,0,0,.55);">
            Сбросить / новый ID
          </button>
        </div>

      </div>
    </div>

    <!-- Modal -->
    <div class="backdrop" id="backdrop">
      <div class="sheet">
        <div class="sheet-head">
          <div class="sheet-title">Выбор подписки</div>
          <button class="xbtn" id="btnClose">✕</button>
        </div>

        <div class="sheet-body">
          <div>
            <div class="row-title"><div class="l">Устройства</div><div class="r">выбери</div></div>
            <div class="chips" id="chipsDevices"></div>
          </div>

          <div>
            <div class="row-title"><div class="l">Срок</div><div class="r">дней</div></div>
            <div class="chips" id="chipsDays"></div>
          </div>

          <div id="selcardWrap" style="display:none;">
            <div class="selcard">
              <p class="big" id="selTitle">—</p>
              <div class="meta">
                <span class="badge">Устройства: <b id="selDev">—</b></span>
                <span class="badge">Срок: <b id="selDays">—</b> дней</span>
                <span class="tag" id="selTag"></span>
              </div>
            </div>
          </div>

          <div class="small">
            Цена: <b id="priceText">—</b>
          </div>

          <button class="btn" id="btnPayStars" disabled>Оплатить Stars</button>

          <div id="payState" style="display:none;">
            <div class="small">Статус: <b id="orderStatus">pending</b></div>

            <div class="codebox" id="configBox" style="display:none;">
              <div class="small" style="margin-top:0;">Ваш конфиг:</div>
              <div class="code mono" id="configText">—</div>
              <div class="row2" style="margin-top:10px;">
                <button class="btn2 primary" id="btnCopy">Скопировать</button>
                <button class="btn2" id="btnClose2">Закрыть</button>
              </div>
            </div>
          </div>

          <div class="small">
            В Telegram invoice откроется внутри Mini App. В браузере — по ссылке.
          </div>
        </div>
      </div>
    </div>

    <div class="toast" id="toast">Скопировано</div>
  </div>

  <!-- Bottom nav -->
  <div class="nav">
    <div class="bar">
      <button class="tab active" id="tabHome">Главная</button>
      <button class="tab" id="tabHelp">Инструкции</button>
      <button class="tab" id="tabProfile">Профиль</button>
    </div>
  </div>

  <script>
    // === CONFIG ===
    const DEFAULT_API = "https://api.45.133.251.210.nip.io:8443";
    const DEVICE_OPTIONS = [1,3,5,10];
    const DAY_OPTIONS = [30,90,180];
    const PRICE_MAP = { 30:199, 90:399, 180:599 };

    const $ = (id)=>document.getElementById(id);

    function toast(msg){
      const t = $("toast");
      t.textContent = msg;
      t.classList.add("show");
      setTimeout(()=>t.classList.remove("show"), 1100);
    }

    function getApiBase(){
      const url = new URL(location.href);
      const qp = url.searchParams.get("api");
      const fromStore = localStorage.getItem("zeusvpn_api");
      const api = (qp || fromStore || DEFAULT_API).trim();
      localStorage.setItem("zeusvpn_api", api);
      return api.replace(/\/$/, "");
    }

    function uuidLike(){
      const a = crypto.getRandomValues(new Uint8Array(16));
      a[6] = (a[6] & 0x0f) | 0x40;
      a[8] = (a[8] & 0x3f) | 0x80;
      const hex = [...a].map(b=>b.toString(16).padStart(2,"0")).join("");
      return `${hex.slice(0,8)}-${hex.slice(8,12)}-${hex.slice(12,16)}-${hex.slice(16,20)}-${hex.slice(20)}`;
    }

    function getUserKey(){
      let id = localStorage.getItem("zeusvpn_user_key");
      if(!id){
        id = "zeus-" + Math.floor(1000 + Math.random()*9000);
        localStorage.setItem("zeusvpn_user_key", id);
      }
      return id;
    }

    function resetUserKey(){
      const id = "zeus-" + Math.floor(1000 + Math.random()*9000);
      localStorage.setItem("zeusvpn_user_key", id);
      localStorage.removeItem("zeusvpn_last_order_id");
      return id;
    }

    function parseDateSafe(v){
      try{
        const d = new Date(v);
        if(String(d) === "Invalid Date") return null;
        return d;
      }catch(e){ return null; }
    }

    function formatUntil(v){
      if(!v) return "—";
      const d = parseDateSafe(v);
      if(!d) return String(v);
      const dd = d.toLocaleDateString("ru-RU",{year:"numeric",month:"2-digit",day:"2-digit"});
      const tt = d.toLocaleTimeString("ru-RU",{hour:"2-digit",minute:"2-digit"});
      return `${dd} ${tt}`;
    }

    function isActiveUntilFuture(v){
      if(!v) return false;
      const d = parseDateSafe(v);
      if(!d) return false;
      return d.getTime() > Date.now();
    }

    function setScreen(name){
      const map = { home:$("screen-home"), help:$("screen-help"), profile:$("screen-profile") };
      for(const k in map) map[k].classList.toggle("active", k===name);
      $("tabHome").classList.toggle("active", name==="home");
      $("tabHelp").classList.toggle("active", name==="help");
      $("tabProfile").classList.toggle("active", name==="profile");
    }

    function setApiOnline(isOnline){
      const txt = isOnline ? "online" : "offline";
      $("apiStatus").textContent = txt;
      $("kApi").textContent = txt;
    }

    async function pingHealth(){
      try{
        const api = getApiBase();
        const r = await fetch(`${api}/health`, { method:"GET" });
        setApiOnline(r.ok);
      }catch(e){
        setApiOnline(false);
      }
    }

    // ===== Modal logic =====
    let selectedDevices = null;
    let selectedDays = null;
    let currentOrderId = null;
    let pollTimer = null;

    function openModal(){ $("backdrop").classList.add("show"); }
    function closeModal(){
      $("backdrop").classList.remove("show");
      $("payState").style.display = "none";
      $("configBox").style.display = "none";
      $("orderStatus").textContent = "pending";
      stopPolling();
      currentOrderId = null;
    }
    function stopPolling(){
      if(pollTimer){ clearInterval(pollTimer); pollTimer=null; }
    }

    function renderChips(container, values, onPick){
      container.innerHTML = "";
      values.forEach(v=>{
        const b = document.createElement("button");
        b.className = "chip";
        b.textContent = v;
        b.onclick = ()=> onPick(v);
        container.appendChild(b);
      });
    }

    function setActiveChip(container, val){
      [...container.querySelectorAll(".chip")].forEach(ch=>{
        ch.classList.toggle("active", String(ch.textContent)===String(val));
      });
    }

    function updateSelection(){
      if(selectedDevices && selectedDays){
        $("selcardWrap").style.display = "block";
        $("selTitle").textContent = `${selectedDays} дней • ${selectedDevices} устройство(а)`;
        $("selDev").textContent = selectedDevices;
        $("selDays").textContent = selectedDays;

        if(selectedDays === 30) $("selTag").textContent = "Популярно";
        else if(selectedDays === 180) $("selTag").textContent = "Выгоднее";
        else $("selTag").textContent = "Оптимально";

        const price = PRICE_MAP[selectedDays] ?? "—";
        $("priceText").textContent = (price==="—") ? "—" : `${price} XTR`;
        $("btnPayStars").disabled = false;
      } else {
        $("selcardWrap").style.display = "none";
        $("priceText").textContent = "—";
        $("btnPayStars").disabled = true;
      }
    }

    async function createStarsOrder(){
      const api = getApiBase();
      const body = { user_key: $("userKey").value.trim(), days: selectedDays, devices: selectedDevices };
      const res = await fetch(`${api}/pay/stars/create`,{
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify(body)
      });
      if(!res.ok){
        const t = await res.text().catch(()=> "");
        throw new Error("create failed: " + res.status + " " + t);
      }
      return await res.json();
    }

    function openInvoice(invoiceLink){
      const tg = window.Telegram?.WebApp;
      if(tg?.openInvoice) tg.openInvoice(invoiceLink, ()=>{});
      else window.open(invoiceLink, "_blank", "noopener,noreferrer");
    }

    async function fetchOrder(orderId){
      const api = getApiBase();
      const res = await fetch(`${api}/pay/order/${encodeURIComponent(orderId)}`,{ method:"GET" });
      if(!res.ok) throw new Error("order fetch failed");
      return await res.json();
    }

    async function pollOrder(orderId){
      $("payState").style.display = "block";
      stopPolling();

      pollTimer = setInterval(async ()=>{
        try{
          const ord = await fetchOrder(orderId);
          const st = ord.status || "pending";
          $("orderStatus").textContent = st;

          // active_until показываем только на главной
          if(ord.active_until){
            $("activeUntil").textContent = formatUntil(ord.active_until);
          }

          // KPI обновление
          if((st === "paid" || st === "success")){
            stopPolling();
            localStorage.setItem("zeusvpn_last_order_id", orderId);

            $("kSub").textContent = "оплачено";
            $("kDev").textContent = String(ord.devices ?? selectedDevices ?? "—");

            if(ord.active_until) $("activeUntil").textContent = formatUntil(ord.active_until);

            if(ord.config_link){
              $("configText").textContent = ord.config_link;
              $("configBox").style.display = "block";
              refreshMainCta();
            }
          }
        }catch(e){}
      }, 1500);
    }

    async function refreshMainCta(){
      const last = localStorage.getItem("zeusvpn_last_order_id");
      if(!last){
        $("btnBuy").textContent = "Приобрести подписку";
        $("kSub").textContent = "не оплачено";
        $("kDev").textContent = "—";
        $("activeUntil").textContent = "—";
        return;
      }
      try{
        const ord = await fetchOrder(last);
        const until = ord.active_until || null;

        if(until) $("activeUntil").textContent = formatUntil(until);

        const active = (ord.status === "paid" || ord.status === "success") && isActiveUntilFuture(until);
        $("btnBuy").textContent = active ? "Продлить" : "Приобрести подписку";

        $("kSub").textContent = active ? "активна" : "не оплачено";
        $("kDev").textContent = String(ord.devices ?? "—");

        // Профиль: без active_until (но тариф оставляем)
        $("pPlan").textContent = (ord.plan_days && ord.devices) ? `${ord.plan_days} дней • ${ord.devices} устр.` : "—";
      }catch(e){
        $("btnBuy").textContent = "Приобрести подписку";
      }
    }

    async function copyText(txt){
      try{
        await navigator.clipboard.writeText(txt);
        toast("Скопировано");
      }catch(e){
        const ta = document.createElement("textarea");
        ta.value = txt;
        document.body.appendChild(ta);
        ta.select();
        document.execCommand("copy");
        ta.remove();
        toast("Скопировано");
      }
    }

    // ===== INIT =====
    (function init(){
      // tabs
      $("tabHome").onclick = ()=> setScreen("home");
      $("tabHelp").onclick = ()=> setScreen("help");
      $("tabProfile").onclick = ()=> setScreen("profile");

      // modal controls
      $("btnBuy").onclick = openModal;
      $("btnClose").onclick = closeModal;
      $("btnClose2").onclick = closeModal;
      $("backdrop").addEventListener("click",(e)=>{ if(e.target === $("backdrop")) closeModal(); });

      // user id
      const id = getUserKey();
      $("userKey").value = id;
      $("pId").textContent = id;

      $("btnReset").onclick = ()=>{
        const nid = resetUserKey();
        $("userKey").value = nid;
        $("pId").textContent = nid;
        $("pPlan").textContent = "—";
        $("activeUntil").textContent = "—";
        $("kSub").textContent = "не оплачено";
        $("kDev").textContent = "—";
        toast("Новый ID");
        refreshMainCta();
      };

      // chips
      renderChips($("chipsDevices"), DEVICE_OPTIONS, (v)=>{
        selectedDevices = v;
        setActiveChip($("chipsDevices"), v);
        updateSelection();
      });
      renderChips($("chipsDays"), DAY_OPTIONS, (v)=>{
        selectedDays = v;
        setActiveChip($("chipsDays"), v);
        updateSelection();
      });
      updateSelection();

      // pay
      $("btnPayStars").onclick = async ()=>{
        try{
          $("btnPayStars").disabled = true;
          $("btnPayStars").textContent = "Создаём счёт…";

          const data = await createStarsOrder();
          currentOrderId = data.order_id;

          // профайл тариф (без active_until)
          $("pPlan").textContent = `${selectedDays} дней • ${selectedDevices} устр.`;

          $("btnPayStars").textContent = "Открыть invoice";
          $("btnPayStars").disabled = false;

          if(data.invoice_link) openInvoice(data.invoice_link);
          await pollOrder(currentOrderId);
        }catch(err){
          $("btnPayStars").disabled = false;
          $("btnPayStars").textContent = "Оплатить Stars";
          alert("Ошибка оплаты: " + (err?.message || err));
        }
      };

      $("btnCopy").onclick = ()=>{
        const t = $("configText").textContent.trim();
        if(t && t !== "—") copyText(t);
      };

      // telegram ready
      try{
        const tg = window.Telegram?.WebApp;
        if(tg){ tg.ready?.(); tg.expand?.(); }
      }catch(e){}

      pingHealth();
      refreshMainCta();
      setInterval(pingHealth, 6000);
    })();
  </script>
</body>
</html>
