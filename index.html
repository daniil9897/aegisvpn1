<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Porsche VPN</title>
  <style>
    :root{
      --bg:#07080b;
      --card:#0f1118;
      --card2:#0c0e14;
      --txt:#e9ecff;
      --muted:#a9b0d6;
      --line:rgba(255,255,255,.08);
      --red:#ff2a3d;
      --red2:#ff3b30;
      --ok:#2cff9a;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background: radial-gradient(1200px 600px at 30% -10%, rgba(255,42,61,.22), transparent 60%),
                  radial-gradient(900px 500px at 85% 0%, rgba(255,42,61,.18), transparent 55%),
                  linear-gradient(180deg, #05060a 0%, #07080b 100%);
      color:var(--txt);
    }
    .grain{
      position:fixed; inset:0; pointer-events:none; opacity:.06; mix-blend-mode:overlay;
      background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='180' height='180'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.9' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='180' height='180' filter='url(%23n)' opacity='.55'/%3E%3C/svg%3E");
    }
    .wrap{max-width:520px;margin:0 auto;padding:18px 14px 90px}
    .top{
      display:flex;align-items:center;justify-content:space-between;gap:12px;
      padding:12px 12px;border:1px solid var(--line);
      background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.01));
      border-radius:18px;
      box-shadow: 0 12px 40px rgba(0,0,0,.35);
    }
    .brand{display:flex;flex-direction:column;gap:2px}
    .brand b{font-size:16px;letter-spacing:.2px}
    .brand span{font-size:12px;color:var(--muted)}
    .pill{
      font-size:12px;color:#fff;padding:7px 10px;border-radius:999px;
      background:linear-gradient(90deg, rgba(255,42,61,.95), rgba(255,60,48,.85));
      border:1px solid rgba(255,255,255,.18);
      box-shadow: 0 12px 30px rgba(255,42,61,.22);
      white-space:nowrap;
    }

    .card{
      margin-top:14px;
      padding:14px;
      border-radius:20px;
      border:1px solid var(--line);
      background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.01));
      box-shadow: 0 12px 40px rgba(0,0,0,.35);
    }
    .card h2{margin:0 0 10px;font-size:14px;color:var(--muted);font-weight:600}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .btn{
      appearance:none; border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.04);
      color:var(--txt);
      padding:12px 12px;
      border-radius:16px;
      font-weight:700;
      cursor:pointer;
      transition:.15s transform,.15s filter,.15s background;
      flex:1;
      min-width: 140px;
    }
    .btn:active{transform:scale(.98)}
    .btn-primary{
      background:linear-gradient(180deg, rgba(255,42,61,.95), rgba(255,60,48,.75));
      border:1px solid rgba(255,255,255,.22);
    }
    .btn-secondary{
      background:linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.03));
    }
    .btn[disabled]{opacity:.45;cursor:not-allowed;filter:saturate(.3)}
    .divider{
      height:1px; background:linear-gradient(90deg, transparent, rgba(255,42,61,.65), transparent);
      margin:14px 0;
      opacity:.7;
    }
    .small{font-size:12px;color:var(--muted);line-height:1.35}
    .mono{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      font-size:12px;
      background:rgba(0,0,0,.35);
      border:1px solid rgba(255,255,255,.10);
      padding:10px;
      border-radius:14px;
      word-break:break-all;
      white-space:pre-wrap;
    }
    .status{
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      padding:10px 12px;border-radius:16px;
      background:rgba(255,255,255,.03);
      border:1px solid rgba(255,255,255,.08);
    }
    .dot{width:10px;height:10px;border-radius:50%;}
    .dot.pending{background:#ffd56a}
    .dot.paid{background:var(--ok)}
    .dot.err{background:#ff6a6a}
    .kv{display:flex;flex-direction:column;gap:2px}
    .kv b{font-size:13px}
    .kv span{font-size:12px;color:var(--muted)}
    .tabs{
      position:fixed;left:0;right:0;bottom:0;
      background:rgba(8,9,14,.75);
      backdrop-filter: blur(14px);
      border-top:1px solid rgba(255,255,255,.10);
      padding:10px 14px;
    }
    .tabs .twrap{max-width:520px;margin:0 auto;display:flex;gap:10px}
    .tab{
      flex:1; padding:12px 10px;border-radius:16px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.04);
      color:var(--txt); font-weight:800; cursor:pointer;
    }
    .tab.active{
      background:linear-gradient(180deg, rgba(255,42,61,.95), rgba(255,60,48,.70));
      border-color:rgba(255,255,255,.20);
    }
    .hide{display:none !important}
  </style>
</head>
<body>
<div class="grain"></div>

<div class="wrap">
  <div class="top">
    <div class="brand">
      <b>Porsche VPN</b>
      <span id="hello">Премиум доступ • быстрый старт</span>
    </div>
    <div class="pill" id="subPill">Подписка: —</div>
  </div>

  <!-- HOME -->
  <section id="screenHome" class="">
    <div class="card">
      <h2>Покупка</h2>

      <div class="status" id="payStatus">
        <div style="display:flex;align-items:center;gap:10px">
          <div class="dot pending" id="stDot"></div>
          <div class="kv">
            <b id="stTitle">Готово к оплате</b>
            <span id="stDesc">Выбери Stars или USDT</span>
          </div>
        </div>
        <div class="small" id="stHint">30 дней • 1 устройство</div>
      </div>

      <div class="divider"></div>

      <div class="row">
        <button class="btn btn-primary" id="btnStars">Оплатить Stars</button>
        <button class="btn btn-secondary" id="btnUSDT">Оплатить USDT</button>
      </div>

      <p class="small" style="margin-top:10px">
        После оплаты мы автоматически выдадим твой персональный VLESS-конфиг и покажем кнопку “Скопировать”.
      </p>
    </div>

    <div class="card">
      <h2>Твой конфиг</h2>

      <div class="mono" id="configBox">Пока нет конфига. Оплати — и он появится тут.</div>

      <div class="row" style="margin-top:10px">
        <button class="btn btn-secondary" id="btnCopy" disabled>Скопировать</button>
        <button class="btn btn-secondary" id="btnReset" title="Просто заглушка под будущий reset/new id">Сбросить/Новый ID</button>
      </div>

      <p class="small" style="margin-top:10px">
        Проверка: вставь конфиг в клиент (V2Box / v2rayN / Shadowrocket) и нажми подключить.
      </p>
    </div>
  </section>

  <!-- INSTRUCTIONS -->
  <section id="screenHow" class="hide">
    <div class="card">
      <h2>Инструкции (3 карточки)</h2>
      <div class="small">Листай: iOS → Android → Desktop. (Пока простая заглушка, можно сделать свайпом позже)</div>
      <div class="divider"></div>
      <div class="card" style="margin-top:0;background:rgba(255,255,255,.02)">
        <b>iOS</b>
        <p class="small">1) Установи V2Box/Shadowrocket<br>2) Вставь конфиг<br>3) Connect</p>
      </div>
      <div class="card" style="background:rgba(255,255,255,.02)">
        <b>Android</b>
        <p class="small">1) Установи v2rayNG<br>2) Import from clipboard<br>3) Start</p>
      </div>
      <div class="card" style="background:rgba(255,255,255,.02)">
        <b>Desktop</b>
        <p class="small">1) v2rayN (Windows) / Nekoray (macOS/Linux)<br>2) Import link<br>3) Run</p>
      </div>
    </div>
  </section>

  <!-- PROFILE -->
  <section id="screenProfile" class="hide">
    <div class="card">
      <h2>Профиль</h2>
      <div class="status">
        <div class="kv">
          <b>ID пользователя</b>
          <span id="userIdView">—</span>
        </div>
        <button class="btn btn-secondary" id="btnNewId">Новый ID</button>
      </div>

      <div class="divider"></div>

      <div class="status">
        <div class="kv">
          <b>Статус подписки</b>
          <span id="profileSub">—</span>
        </div>
        <div class="kv" style="text-align:right">
          <b>Устройства</b>
          <span id="slots">1/1</span>
        </div>
      </div>

      <div class="divider"></div>

      <div class="small">
        История выдач (заглушка): позже сюда добавим реальные записи из backend.
      </div>
    </div>

    <div class="card">
      <h2>Рефералка</h2>
      <div class="small">UI сейчас, логика потом. “Пригласи друга — +7 дней”.</div>
      <div class="divider"></div>
      <button class="btn btn-secondary" id="btnRef">Скопировать реф-ссылку</button>
      <p class="small" id="refOut" style="margin-top:10px"></p>
    </div>
  </section>
</div>

<div class="tabs">
  <div class="twrap">
    <button class="tab active" id="tabHome">Главная</button>
    <button class="tab" id="tabHow">Инструкции</button>
    <button class="tab" id="tabProfile">Профиль</button>
  </div>
</div>

<script>
  // === НАСТРОЙКИ ===
  const API_BASE = "https://api.45.133.251.210.nip.io:8443"; // <-- меняй только это если надо
  const PLAN_DAYS = 30;
  const DEVICES = 1;

  // === HELPERS ===
  const $ = (id)=>document.getElementById(id);

  function safeRandId(){
    return "site-" + Math.random().toString(16).slice(2,10);
  }

  function getUserKey(){
    let k = localStorage.getItem("pvpn_user_key");
    if(!k){
      k = safeRandId();
      localStorage.setItem("pvpn_user_key", k);
    }
    return k;
  }

  function setUserKey(k){
    localStorage.setItem("pvpn_user_key", k);
    $("userIdView").textContent = k;
  }

  function setConfig(link){
    localStorage.setItem("pvpn_config", link || "");
    $("configBox").textContent = link ? link : "Пока нет конфига. Оплати — и он появится тут.";
    $("btnCopy").disabled = !link;
  }

  function setSubUntil(unixSec){
    if(!unixSec){
      $("subPill").textContent = "Подписка: —";
      $("profileSub").textContent = "—";
      return;
    }
    const d = new Date(unixSec * 1000);
    const dd = String(d.getDate()).padStart(2,"0");
    const mm = String(d.getMonth()+1).padStart(2,"0");
    const yy = d.getFullYear();
    const txt = `до ${dd}.${mm}.${yy}`;
    $("subPill").textContent = "Подписка: " + txt;
    $("profileSub").textContent = "Активна " + txt;
  }

  function setStatus(state, title, desc){
    const dot = $("stDot");
    dot.classList.remove("pending","paid","err");
    dot.classList.add(state);
    $("stTitle").textContent = title;
    $("stDesc").textContent = desc;
  }

  async function api(path, opts={}){
    const url = API_BASE + path;
    const res = await fetch(url, {
      ...opts,
      headers: {
        "Content-Type":"application/json",
        ...(opts.headers || {})
      }
    });
    if(!res.ok){
      const t = await res.text().catch(()=> "");
      throw new Error(`${res.status} ${res.statusText} ${t}`.trim());
    }
    return res.json();
  }

  // === TELEGRAM WEBAPP ===
  function tg(){
    return window.Telegram && window.Telegram.WebApp ? window.Telegram.WebApp : null;
  }

  function openInvoiceSmart(invoiceLink, provider){
    const w = tg();

    // Telegram WebApp openInvoice (лучший вариант для Stars)
    if(w && typeof w.openInvoice === "function"){
      try{
        w.openInvoice(invoiceLink, (status)=>{
          // status: "paid" | "cancelled" | "failed" | etc
          // мы всё равно поллим order, поэтому просто лог.
          console.log("invoice status", provider, status);
        });
        return;
      }catch(e){
        console.warn("openInvoice failed, fallback to window.open", e);
      }
    }

    // fallback
    window.open(invoiceLink, "_blank");
  }

  // === PAYMENT FLOW ===
  let pollTimer = null;

  async function startPolling(orderId){
    localStorage.setItem("pvpn_last_order", orderId);

    if(pollTimer) clearInterval(pollTimer);
    pollTimer = setInterval(async ()=>{
      try{
        const o = await api(`/pay/order/${orderId}`, { method:"GET" });

        if(o.status === "paid"){
          setStatus("paid", "Оплачено", "Конфиг готов ✅");
          if(o.config_link) setConfig(o.config_link);
          if(o.active_until) setSubUntil(o.active_until);
          if(pollTimer){ clearInterval(pollTimer); pollTimer=null; }
          return;
        }

        setStatus("pending","Ждём оплату…","После оплаты конфиг появится автоматически");
      }catch(err){
        console.warn(err);
        setStatus("err","Ошибка","Не могу проверить заказ (backend недоступен?)");
      }
    }, 1200);
  }

  async function payStars(){
    const user_key = getUserKey();
    setStatus("pending","Создаю инвойс…","Stars");
    const data = await api("/pay/stars/create", {
      method:"POST",
      body: JSON.stringify({ user_key, days: PLAN_DAYS, devices: DEVICES })
    });

    // открыть инвойс
    openInvoiceSmart(data.invoice_link, "stars");

    // начинаем поллинг
    await startPolling(data.order_id);
  }

  async function payUSDT(){
    const user_key = getUserKey();
    setStatus("pending","Создаю инвойс…","USDT");
    const data = await api("/pay/crypto/create", {
      method:"POST",
      body: JSON.stringify({ user_key, days: PLAN_DAYS, devices: DEVICES })
    });

    // открыть ссылку на оплату (CryptoPay обычно просто URL)
    openInvoiceSmart(data.invoice_url, "cryptopay");

    await startPolling(data.order_id);
  }

  // === UI NAV ===
  function show(screen){
    ["screenHome","screenHow","screenProfile"].forEach(id=>$(id).classList.add("hide"));
    $(screen).classList.remove("hide");

    ["tabHome","tabHow","tabProfile"].forEach(id=>$(id).classList.remove("active"));
    if(screen==="screenHome") $("tabHome").classList.add("active");
    if(screen==="screenHow") $("tabHow").classList.add("active");
    if(screen==="screenProfile") $("tabProfile").classList.add("active");
  }

  // === INIT ===
  (function init(){
    const user_key = getUserKey();
    $("userIdView").textContent = user_key;
    $("slots").textContent = `${DEVICES}/${DEVICES}`;

    const savedCfg = localStorage.getItem("pvpn_config") || "";
    if(savedCfg) setConfig(savedCfg);

    const lastOrder = localStorage.getItem("pvpn_last_order");
    if(lastOrder){
      // при перезаходе продолжим проверять
      startPolling(lastOrder);
    }

    // пробуем подтянуть active_until из последнего заказа
    if(lastOrder){
      api(`/pay/order/${lastOrder}`, {method:"GET"})
        .then(o=>{
          if(o.active_until) setSubUntil(o.active_until);
          if(o.status==="paid" && o.config_link) setConfig(o.config_link);
        })
        .catch(()=>{});
    }
  })();

  // === EVENTS ===
  $("btnStars").addEventListener("click", ()=>payStars().catch(e=>{
    console.error(e);
    setStatus("err","Ошибка","Failed to fetch (проверь CORS/доступность API)");
  }));

  $("btnUSDT").addEventListener("click", ()=>payUSDT().catch(e=>{
    console.error(e);
    setStatus("err","Ошибка","USDT пока не настроен или CryptoPay token неверный");
  }));

  $("btnCopy").addEventListener("click", async ()=>{
    const text = $("configBox").textContent.trim();
    try{
      await navigator.clipboard.writeText(text);
      setStatus("paid","Скопировано","Вставь в VPN-клиент");
    }catch(e){
      alert("Не удалось скопировать. Выдели текст и скопируй вручную.");
    }
  });

  $("btnNewId").addEventListener("click", ()=>{
    const k = safeRandId();
    setUserKey(k);
    setConfig("");
    setSubUntil(null);
    localStorage.removeItem("pvpn_last_order");
    if(pollTimer){clearInterval(pollTimer); pollTimer=null;}
    setStatus("pending","Готово","Новый ID создан");
  });

  $("btnReset").addEventListener("click", ()=>{
    alert("Заглушка: позже сделаем реальный reset/new-id на backend.");
  });

  $("btnRef").addEventListener("click", async ()=>{
    const k = getUserKey();
    // UI-заглушка рефералки
    const link = `https://t.me/your_bot?start=ref_${k}`;
    try{
      await navigator.clipboard.writeText(link);
      $("refOut").textContent = "Ссылка скопирована: " + link;
    }catch(e){
      $("refOut").textContent = link;
    }
  });

  $("tabHome").addEventListener("click", ()=>show("screenHome"));
  $("tabHow").addEventListener("click", ()=>show("screenHow"));
  $("tabProfile").addEventListener("click", ()=>show("screenProfile"));
</script>

<!-- Telegram WebApp JS (не обязательно, но полезно) -->
<script src="https://telegram.org/js/telegram-web-app.js"></script>
</body>
</html>
