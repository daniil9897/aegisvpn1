<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#000000" />
  <title>ZEUSVPN</title>

  <style>
    :root{
      --bg:#000;
      --panel: rgba(255,255,255,.06);
      --panel2: rgba(255,255,255,.08);
      --stroke: rgba(255,255,255,.10);
      --stroke2: rgba(255,255,255,.16);

      --text: rgba(255,255,255,.98);
      --muted: rgba(255,255,255,.72);
      --muted2: rgba(255,255,255,.52);

      --blue:#0A84FF;     /* iOS blue */
      --cyan:#64D2FF;     /* iOS cyan */
      --good:#30D158;     /* iOS green */
      --warn:#FFD60A;     /* iOS yellow */
      --bad:#FF453A;      /* iOS red */

      --shadow: 0 18px 60px rgba(0,0,0,.65);
      --radius: 22px;
      --radius2: 16px;

      --safeTop: env(safe-area-inset-top, 0px);
      --safeBot: env(safe-area-inset-bottom, 0px);
      --tap: cubic-bezier(.2,.9,.2,1);
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:-apple-system,BlinkMacSystemFont,"SF Pro Display","SF Pro Text",Inter,Segoe UI,Roboto,Arial,sans-serif;
      background:
        radial-gradient(900px 600px at 15% -10%, rgba(10,132,255,.22), rgba(0,0,0,0) 55%),
        radial-gradient(700px 520px at 95% 5%, rgba(100,210,255,.14), rgba(0,0,0,0) 55%),
        linear-gradient(180deg, #000, #000);
      color:var(--text);
      overflow-x:hidden;
    }

    .app{
      max-width:520px;
      margin:0 auto;
      padding: calc(16px + var(--safeTop)) 14px calc(18px + var(--safeBot));
    }

    .topbar{
      display:flex; align-items:center; justify-content:space-between;
      margin-bottom: 14px;
    }
    .brand{
      display:flex; align-items:center; gap:12px;
      min-width:0;
    }
    .logo{
      width:46px; height:46px; border-radius:14px;
      background: rgba(255,255,255,.06);
      border:1px solid var(--stroke);
      box-shadow: 0 10px 30px rgba(0,0,0,.45);
      display:grid; place-items:center;
      overflow:hidden;
    }
    .logo img{width:100%; height:100%; object-fit:cover}
    .brand h1{
      margin:0;
      font-size:16px;
      letter-spacing:.2px;
      line-height:1.15;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .brand p{
      margin:4px 0 0;
      font-size:12px;
      color:var(--muted);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    .pill{
      display:flex; align-items:center; gap:8px;
      padding:10px 12px;
      border-radius:999px;
      background: rgba(255,255,255,.06);
      border:1px solid var(--stroke);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
      box-shadow: 0 12px 40px rgba(0,0,0,.35);
      max-width: 44%;
      min-width: 0;
    }
    .avatar{
      width:26px; height:26px; border-radius:999px;
      background: rgba(255,255,255,.10);
      border:1px solid rgba(255,255,255,.12);
      overflow:hidden;
      flex:0 0 auto;
    }
    .avatar img{width:100%; height:100%; object-fit:cover}
    .pill .name{
      font-size:12px;
      color:var(--text);
      overflow:hidden;
      white-space:nowrap;
      text-overflow:ellipsis;
    }

    .card{
      background: var(--panel);
      border:1px solid var(--stroke);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      backdrop-filter: blur(18px);
      -webkit-backdrop-filter: blur(18px);
    }
    .card + .card{ margin-top: 12px; }

    .hero{
      padding:16px;
      position:relative;
      overflow:hidden;
    }
    .hero:before{
      content:"";
      position:absolute; inset:-40% -30%;
      background:
        radial-gradient(closest-side at 20% 30%, rgba(10,132,255,.22), rgba(0,0,0,0) 55%),
        radial-gradient(closest-side at 80% 20%, rgba(100,210,255,.14), rgba(0,0,0,0) 60%);
      filter: blur(10px);
      opacity:.85;
      pointer-events:none;
    }
    .hero > *{ position:relative; z-index:1; }
    .heroRow{
      display:flex; gap:12px; align-items:flex-start; justify-content:space-between;
    }
    .heroTitle{
      margin:0 0 6px 0;
      font-size:18px;
      letter-spacing:.2px;
    }
    .heroDesc{
      margin:0;
      color:var(--muted);
      font-size:13px;
      line-height:1.35;
    }
    .status{
      margin-top:12px;
      display:flex; gap:10px; flex-wrap:wrap;
    }
    .chip{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:10px 12px;
      border-radius: 999px;
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
      color:var(--text);
      font-size:12px;
      line-height:1;
      user-select:none;
    }
    .dot{
      width:8px; height:8px; border-radius:999px;
      background: var(--good);
      box-shadow: 0 0 0 3px rgba(48,209,88,.18);
    }
    .dot.bad{ background: var(--bad); box-shadow: 0 0 0 3px rgba(255,69,58,.18); }

    .actions{
      padding:14px;
      display:flex;
      gap:10px;
    }
    .btn{
      appearance:none; border:0; cursor:pointer;
      width:100%;
      border-radius: 16px;
      padding:14px 14px;
      font-weight: 700;
      letter-spacing:.2px;
      background: rgba(255,255,255,.10);
      color: var(--text);
      border:1px solid rgba(255,255,255,.14);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      box-shadow: 0 16px 46px rgba(0,0,0,.45);
      transition: transform .15s var(--tap), filter .15s var(--tap);
    }
    .btn:active{ transform: scale(.98); }
    .btn.primary{
      background: linear-gradient(180deg, rgba(10,132,255,.95), rgba(10,132,255,.70));
      border:1px solid rgba(10,132,255,.35);
      box-shadow: 0 18px 54px rgba(10,132,255,.18);
    }
    .btn.ghost{
      background: rgba(255,255,255,.06);
    }
    .btn[disabled]{
      opacity:.55;
      cursor:not-allowed;
      filter: grayscale(.3);
    }

    /* Bottom nav */
    .nav{
      margin-top: 12px;
      display:flex;
      gap:10px;
    }
    .navBtn{
      width:100%;
      padding:12px 12px;
      border-radius: 16px;
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
      color: var(--muted);
      font-weight:700;
      letter-spacing:.15px;
      cursor:pointer;
      transition: transform .15s var(--tap), background .15s var(--tap);
    }
    .navBtn:active{ transform: scale(.98); }
    .navBtn.active{
      background: rgba(255,255,255,.10);
      color: var(--text);
      border-color: rgba(255,255,255,.14);
    }

    /* screens */
    .screen{
      margin-top: 12px;
      overflow:hidden;
    }
    .screenInner{ padding: 14px; }
    .row{
      display:flex; justify-content:space-between; align-items:center;
      padding: 12px 12px;
      border-radius: 16px;
      background: rgba(255,255,255,.05);
      border:1px solid rgba(255,255,255,.08);
      margin-bottom: 10px;
    }
    .row:last-child{ margin-bottom:0; }
    .k{ color:var(--muted); font-size:12px; }
    .v{ color:var(--text); font-size:12px; font-weight:700; }

    /* Instructions swipe */
    .swipeWrap{
      position:relative;
      overflow:hidden;
      border-radius: 18px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.05);
    }
    .swipeTrack{
      display:flex;
      width:300%;
      transform: translateX(0%);
      transition: transform .28s var(--tap);
    }
    .slide{
      width: 100%;
      padding: 14px;
      min-height: 160px;
    }
    .slide h3{ margin:2px 0 8px; font-size:14px; letter-spacing:.2px; }
    .slide p{ margin:0; color:var(--muted); font-size:12.5px; line-height:1.4; }
    .dots{
      display:flex; gap:8px; justify-content:center;
      padding: 10px 0 0;
    }
    .dot2{
      width:7px; height:7px; border-radius: 999px;
      background: rgba(255,255,255,.22);
    }
    .dot2.active{ background: rgba(255,255,255,.80); }

    /* Modal */
    .overlay{
      position:fixed; inset:0;
      background: rgba(0,0,0,.62);
      display:none;
      align-items:flex-end;
      justify-content:center;
      padding: 12px 10px calc(12px + var(--safeBot));
      z-index: 999;
    }
    .overlay.show{ display:flex; }
    .sheet{
      width:100%;
      max-width: 520px;
      border-radius: 26px;
      background: rgba(22,22,22,.75);
      border:1px solid rgba(255,255,255,.12);
      backdrop-filter: blur(22px);
      -webkit-backdrop-filter: blur(22px);
      box-shadow: 0 24px 90px rgba(0,0,0,.75);
      overflow:hidden;

      /* IMPORTANT: фиксируем высоту, чтобы НИЧЕГО не резало */
      max-height: min(78vh, 560px);
      display:flex;
      flex-direction:column;
    }
    .sheetHeader{
      padding: 14px 14px 10px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      border-bottom:1px solid rgba(255,255,255,.10);
    }
    .sheetTitle{ margin:0; font-size:14px; letter-spacing:.2px; }
    .close{
      width:34px; height:34px;
      border-radius: 12px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      color: var(--text);
      cursor:pointer;
    }
    .sheetBody{
      padding: 12px 14px 14px;
      overflow:auto; /* скролл внутри */
    }

    .sectionLabel{
      margin: 8px 0 8px;
      font-size:12px;
      color: var(--muted);
      letter-spacing:.2px;
    }
    .chips{
      display:flex; flex-wrap:wrap; gap:10px;
      margin-bottom: 10px;
    }
    .sel{
      padding:10px 12px;
      border-radius: 999px;
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
      color: var(--text);
      font-weight:800;
      font-size:12px;
      cursor:pointer;
      user-select:none;
      transition: transform .12s var(--tap), background .12s var(--tap), border-color .12s var(--tap);
    }
    .sel:active{ transform: scale(.98); }
    .sel.active{
      background: rgba(10,132,255,.18);
      border-color: rgba(10,132,255,.40);
      box-shadow: 0 0 0 4px rgba(10,132,255,.10);
    }

    .previewCard{
      margin-top: 10px;
      padding: 14px;
      border-radius: 20px;
      border:1px solid rgba(255,255,255,.12);
      background:
        linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.04));
      box-shadow: 0 22px 70px rgba(0,0,0,.55);
      position:relative;
      overflow:hidden;
    }
    .previewCard:before{
      content:"";
      position:absolute; inset:-40% -25%;
      background:
        radial-gradient(closest-side at 30% 30%, rgba(10,132,255,.22), rgba(0,0,0,0) 55%),
        radial-gradient(closest-side at 80% 20%, rgba(100,210,255,.14), rgba(0,0,0,0) 60%);
      filter: blur(12px);
      opacity:.9;
      pointer-events:none;
    }
    .previewCard > *{ position:relative; z-index:1; }
    .pcTop{
      display:flex; justify-content:space-between; gap:12px; align-items:flex-start;
    }
    .pcName{ font-size:13px; font-weight:900; letter-spacing:.2px; margin:0; }
    .pcBadge{
      font-size:11px; font-weight:900;
      color: rgba(255,255,255,.88);
      background: rgba(255,255,255,.08);
      border:1px solid rgba(255,255,255,.12);
      padding:7px 10px;
      border-radius: 999px;
      white-space:nowrap;
    }
    .pcLine{ margin-top:10px; color:var(--muted); font-size:12px; line-height:1.35; }
    .payRow{
      display:flex; gap:10px; margin-top: 12px;
    }

    .toast{
      position:fixed;
      left:50%;
      bottom: calc(18px + var(--safeBot));
      transform: translateX(-50%) translateY(20px);
      opacity:0;
      background: rgba(255,255,255,.10);
      border:1px solid rgba(255,255,255,.14);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      color: var(--text);
      padding: 10px 12px;
      border-radius: 999px;
      box-shadow: 0 18px 60px rgba(0,0,0,.55);
      transition: opacity .22s var(--tap), transform .22s var(--tap);
      font-size:12px;
      z-index: 1000;
    }
    .toast.show{ opacity:1; transform: translateX(-50%) translateY(0px); }

    .hidden{ display:none !important; }
    a{ color: var(--text); text-decoration:none; }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; }
  </style>
</head>

<body>
  <div class="app">
    <!-- TOP -->
    <div class="topbar">
      <div class="brand">
        <div class="logo" aria-label="ZEUSVPN logo">
          <img src="logo.png" alt="ZEUSVPN" />
        </div>
        <div style="min-width:0">
          <h1>ZEUSVPN</h1>
          <p id="subtitle">Private access • Premium tunnel</p>
        </div>
      </div>

      <div class="pill" title="Профиль Telegram">
        <div class="avatar" id="avatar">
          <img id="avatarImg" class="hidden" alt="avatar" />
        </div>
        <div class="name" id="tgName">Гость</div>
      </div>
    </div>

    <!-- HERO -->
    <div class="card hero">
      <div class="heroRow">
        <div style="min-width:0">
          <h2 class="heroTitle">Подписка</h2>
          <p class="heroDesc" id="heroDesc">Выберите параметры — оплатите — получите конфиг.</p>
        </div>
      </div>

      <div class="status">
        <div class="chip" id="subChip">
          <span class="dot bad" id="subDot"></span>
          <span id="subText">Не активна</span>
        </div>
        <div class="chip">
          <span style="opacity:.8">ID</span>
          <span class="mono" id="userKey">—</span>
        </div>
      </div>

      <div class="actions">
        <button class="btn primary" id="openBuyBtn">Приобрести подписку</button>
        <button class="btn ghost" id="openProfileBtn">Профиль</button>
      </div>
    </div>

    <!-- NAV -->
    <div class="nav">
      <button class="navBtn active" id="navMain">Главная</button>
      <button class="navBtn" id="navInstr">Инструкция</button>
      <button class="navBtn" id="navProfile">Профиль</button>
    </div>

    <!-- MAIN SCREEN -->
    <div class="card screen" id="screenMain">
      <div class="screenInner">
        <div class="row">
          <div>
            <div class="k">Быстрый старт</div>
            <div class="v">Оплата → Конфиг → Вставить в V2Box/V2Ray</div>
          </div>
        </div>
        <div class="row">
          <div>
            <div class="k">Оплата</div>
            <div class="v">Stars / USDT</div>
          </div>
          <div class="k">в модалке</div>
        </div>
        <div class="row">
          <div>
            <div class="k">Конфиг</div>
            <div class="v">Выдаётся после оплаты</div>
          </div>
          <div class="k">автомат</div>
        </div>
      </div>
    </div>

    <!-- INSTRUCTIONS SCREEN -->
    <div class="card screen hidden" id="screenInstr">
      <div class="screenInner">
        <div class="swipeWrap" id="swipeWrap">
          <div class="swipeTrack" id="swipeTrack">
            <div class="slide">
              <h3>iOS (V2Box)</h3>
              <p>Открой V2Box → “+” → Import from clipboard → вставь ссылку vless → Save → Connect.</p>
            </div>
            <div class="slide">
              <h3>Android (v2rayNG)</h3>
              <p>v2rayNG → “+” → Import from clipboard/URL → вставь vless → OK → подключись.</p>
            </div>
            <div class="slide">
              <h3>Desktop</h3>
              <p>Windows/Mac: v2rayN / Nekoray → Import → вставь vless → запусти профиль.</p>
            </div>
          </div>
        </div>

        <div class="dots">
          <div class="dot2 active" data-dot="0"></div>
          <div class="dot2" data-dot="1"></div>
          <div class="dot2" data-dot="2"></div>
        </div>
      </div>
    </div>

    <!-- PROFILE SCREEN -->
    <div class="card screen hidden" id="screenProfile">
      <div class="screenInner">
        <div class="row">
          <div>
            <div class="k">Telegram</div>
            <div class="v" id="profileTg">—</div>
          </div>
          <div class="k mono" id="profileTgId">—</div>
        </div>

        <div class="row">
          <div>
            <div class="k">Ваш ID (user_key)</div>
            <div class="v mono" id="profileUserKey">—</div>
          </div>
          <button class="btn ghost" id="regenIdBtn" style="width:auto;padding:10px 12px;border-radius:14px">Новый</button>
        </div>

        <div class="row">
          <div>
            <div class="k">Статус</div>
            <div class="v" id="profileStatus">—</div>
          </div>
        </div>
      </div>
    </div>

  </div>

  <!-- BUY MODAL -->
  <div class="overlay" id="overlay">
    <div class="sheet" role="dialog" aria-modal="true" aria-label="Оплата">
      <div class="sheetHeader">
        <div>
          <p class="sheetTitle">Выбор подписки</p>
          <div style="font-size:12px;color:var(--muted);margin-top:4px">Выбери устройства и срок — кнопка оплаты обновится</div>
        </div>
        <button class="close" id="closeModalBtn">✕</button>
      </div>

      <div class="sheetBody">
        <div class="sectionLabel">Устройства</div>
        <div class="chips" id="devicesChips">
          <div class="sel active" data-dev="1">1</div>
          <div class="sel" data-dev="3">3</div>
          <div class="sel" data-dev="5">5</div>
          <div class="sel" data-dev="10">10</div>
        </div>

        <div class="sectionLabel">Срок</div>
        <div class="chips" id="daysChips">
          <div class="sel active" data-days="30">30 дней <span style="opacity:.7;font-weight:900">•</span> <span style="color:var(--warn);font-weight:900">Популярно</span></div>
          <div class="sel" data-days="90">90 дней</div>
          <div class="sel" data-days="180">180 дней <span style="opacity:.7;font-weight:900">•</span> <span style="color:var(--good);font-weight:900">Выгоднее</span></div>
        </div>

        <div class="previewCard" id="previewCard">
          <div class="pcTop">
            <p class="pcName">ZEUSVPN • Подписка</p>
            <div class="pcBadge" id="priceBadge">199 XTR</div>
          </div>
          <div class="pcLine" id="previewLine">1 устройство • 30 дней</div>
          <div class="payRow">
            <button class="btn primary" id="payStarsBtn">Оплатить Stars</button>
            <button class="btn ghost" id="payUsdtBtn">Оплатить USDT</button>
          </div>

          <div id="afterPay" class="hidden" style="margin-top:12px">
            <div class="sectionLabel">Ваш конфиг</div>
            <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
              <button class="btn ghost" id="copyConfigBtn" style="flex:1">Скопировать</button>
              <button class="btn ghost" id="closeAfterBtn" style="flex:1">Закрыть</button>
            </div>
            <div style="margin-top:10px;color:var(--muted2);font-size:12px;line-height:1.35">
              Если не открылось приложение — скопируй ссылку и вставь в V2Box/v2rayNG вручную.
            </div>
            <textarea id="configBox" class="mono" readonly
              style="margin-top:10px;width:100%;min-height:88px;max-height:160px;resize:none;
              padding:12px;border-radius:16px;background:rgba(0,0,0,.35);
              border:1px solid rgba(255,255,255,.12);color:var(--text);"></textarea>
          </div>

          <div id="loaderArea" class="hidden" style="margin-top:12px;color:var(--muted);font-size:12px">
            Оплата создаётся… затем ждём подтверждение.
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast">Готово</div>

  <script>
    /* ======================
       CONFIG
    ====================== */
    const API_BASE = "https://api.45.133.251.210.nip.io:8443";

    // price map (дальше можешь подстроить под devices тоже)
    const STARS_PRICE = { 30: 199, 90: 399, 180: 599 };

    /* ======================
       SIMPLE STATE
    ====================== */
    const state = {
      user_key: null,
      tg: { id: null, name: "Гость", username: null, photo_url: null },
      sub: { active: false, active_until: null },
      plan: { devices: 1, days: 30, price: STARS_PRICE[30] },
      lastOrderId: null,
      lastConfig: null,
      swipeIndex: 0
    };

    /* ======================
       HELPERS
    ====================== */
    const $ = (id) => document.getElementById(id);
    const toast = (msg) => {
      const t = $("toast");
      t.textContent = msg;
      t.classList.add("show");
      setTimeout(()=>t.classList.remove("show"), 1600);
    };
    const randKey = () => ("u_" + Math.random().toString(16).slice(2,10) + Math.random().toString(16).slice(2,10)).slice(0, 18);

    function isTelegram() {
      return !!(window.Telegram && window.Telegram.WebApp);
    }

    function safeHaptic() {
      try{
        if(isTelegram()){
          window.Telegram.WebApp.HapticFeedback.impactOccurred("light");
        }
      }catch(e){}
    }

    function setActive(active, untilIso) {
      state.sub.active = !!active;
      state.sub.active_until = untilIso || null;

      const dot = $("subDot");
      const txt = $("subText");
      if(active){
        dot.classList.remove("bad");
        txt.textContent = "Активна до " + formatDate(untilIso);
        $("openBuyBtn").textContent = "Продлить";
      } else {
        dot.classList.add("bad");
        txt.textContent = "Не активна";
        $("openBuyBtn").textContent = "Приобрести подписку";
      }
      $("profileStatus").textContent = active ? ("Активна до " + formatDate(untilIso)) : "Не активна";
    }

    function formatDate(iso){
      if(!iso) return "—";
      try{
        const d = new Date(iso);
        return d.toLocaleDateString("ru-RU", { day:"2-digit", month:"2-digit", year:"numeric" });
      }catch(e){ return iso; }
    }

    function updatePlanUI(){
      state.plan.price = STARS_PRICE[state.plan.days] || 199;

      $("previewLine").textContent = `${state.plan.devices} устройство${state.plan.devices>1 ? "а" : ""} • ${state.plan.days} дней`;
      $("priceBadge").textContent = `${state.plan.price} XTR`;

      // highlight chips
      [...$("devicesChips").querySelectorAll(".sel")].forEach(el=>{
        el.classList.toggle("active", Number(el.dataset.dev)===state.plan.devices);
      });
      [...$("daysChips").querySelectorAll(".sel")].forEach(el=>{
        el.classList.toggle("active", Number(el.dataset.days)===state.plan.days);
      });
    }

    function setScreen(name){
      const map = { main:"screenMain", instr:"screenInstr", profile:"screenProfile" };
      Object.values(map).forEach(id => $(id).classList.add("hidden"));
      $(map[name]).classList.remove("hidden");

      $("navMain").classList.toggle("active", name==="main");
      $("navInstr").classList.toggle("active", name==="instr");
      $("navProfile").classList.toggle("active", name==="profile");
    }

    function showModal(show){
      $("overlay").classList.toggle("show", !!show);
      document.body.style.overflow = show ? "hidden" : "";
    }

    function setSwipe(idx){
      state.swipeIndex = Math.max(0, Math.min(2, idx));
      $("swipeTrack").style.transform = `translateX(${-state.swipeIndex*100}%)`;
      document.querySelectorAll(".dot2").forEach(d=>{
        d.classList.toggle("active", Number(d.dataset.dot)===state.swipeIndex);
      });
    }

    async function api(path, opts={}){
      const url = API_BASE + path;
      const res = await fetch(url, {
        ...opts,
        headers: {
          "Content-Type": "application/json",
          ...(opts.headers||{})
        }
      });
      let data = null;
      try{ data = await res.json(); } catch(e){}
      if(!res.ok){
        const msg = (data && (data.detail || data.error)) ? (data.detail || data.error) : (`HTTP ${res.status}`);
        throw new Error(msg);
      }
      return data;
    }

    /* ======================
       PAYMENT FLOW
    ====================== */
    async function createStarsOrder(){
      $("loaderArea").classList.remove("hidden");
      $("afterPay").classList.add("hidden");

      const body = {
        user_key: state.user_key,
        days: state.plan.days,
        devices: state.plan.devices
      };
      const data = await api("/pay/stars/create", { method:"POST", body: JSON.stringify(body) });
      state.lastOrderId = data.order_id;

      // open invoice
      if(isTelegram()){
        try{
          window.Telegram.WebApp.openTelegramLink(data.invoice_link);
        }catch(e){
          window.open(data.invoice_link, "_blank");
        }
      } else {
        window.open(data.invoice_link, "_blank");
      }

      // poll order
      await pollOrder(state.lastOrderId);
    }

    async function createUsdtOrder(){
      $("loaderArea").classList.remove("hidden");
      $("afterPay").classList.add("hidden");

      const body = {
        user_key: state.user_key,
        days: state.plan.days,
        devices: state.plan.devices
      };
      const data = await api("/pay/crypto/create", { method:"POST", body: JSON.stringify(body) });
      state.lastOrderId = data.order_id;

      const invoiceUrl = data.invoice_url || data.invoice_link || data.pay_url;
      if(invoiceUrl){
        if(isTelegram()){
          try{ window.Telegram.WebApp.openLink(invoiceUrl); }
          catch(e){ window.open(invoiceUrl, "_blank"); }
        } else {
          window.open(invoiceUrl, "_blank");
        }
      }

      await pollOrder(state.lastOrderId);
    }

    async function pollOrder(orderId){
      const started = Date.now();
      const timeoutMs = 120000; // 2 min
      while(Date.now() - started < timeoutMs){
        await new Promise(r=>setTimeout(r, 1200));
        let order;
        try{
          order = await api(`/pay/order/${orderId}`, { method:"GET" });
        }catch(e){
          // не падаем моментально, продолжаем
          continue;
        }

        if(order && order.active_until){
          setActive(true, order.active_until);
        }

        if(order && order.status === "paid" && order.config_link){
          state.lastConfig = order.config_link;
          $("configBox").value = order.config_link;
          $("loaderArea").classList.add("hidden");
          $("afterPay").classList.remove("hidden");
          toast("Оплата подтверждена");
          safeHaptic();
          return;
        }

        if(order && order.status === "paid" && !order.config_link){
          // если paid но конфиг ещё генерится — подождём
          continue;
        }
      }
      $("loaderArea").classList.add("hidden");
      toast("Не дождались оплаты (проверьте позже)");
    }

    /* ======================
       INIT TELEGRAM PROFILE
    ====================== */
    function initTelegramProfile(){
      if(!isTelegram()){
        // browser
        state.tg.name = "Гость";
        state.tg.id = null;
        $("tgName").textContent = state.tg.name;
        $("profileTg").textContent = "Открыто в браузере";
        $("profileTgId").textContent = "—";
        return;
      }

      const tg = window.Telegram.WebApp;
      tg.ready();
      tg.expand();

      const u = tg.initDataUnsafe?.user;
      if(u){
        state.tg.id = u.id;
        state.tg.username = u.username || null;
        state.tg.name = [u.first_name, u.last_name].filter(Boolean).join(" ").trim() || (u.username ? "@"+u.username : "Пользователь");
        state.tg.photo_url = u.photo_url || null;
      } else {
        state.tg.name = "Telegram";
      }

      $("tgName").textContent = state.tg.name;
      $("profileTg").textContent = state.tg.username ? ("@"+state.tg.username) : state.tg.name;
      $("profileTgId").textContent = state.tg.id ? String(state.tg.id) : "—";

      if(state.tg.photo_url){
        $("avatarImg").src = state.tg.photo_url;
        $("avatarImg").classList.remove("hidden");
      }
    }

    /* ======================
       USER KEY
    ====================== */
    function loadUserKey(){
      // Если в Telegram — можно привязать к tg.id
      if(isTelegram() && state.tg.id){
        state.user_key = "tg_" + String(state.tg.id);
      } else {
        // браузер — из localStorage
        const saved = localStorage.getItem("zeusvpn_user_key");
        state.user_key = saved || randKey();
        localStorage.setItem("zeusvpn_user_key", state.user_key);
      }

      $("userKey").textContent = state.user_key;
      $("profileUserKey").textContent = state.user_key;
    }

    /* ======================
       OPTIONAL: quick config issue (если хочешь тестом выдавать без оплаты)
       Сейчас НЕ вызываем автоматом, чтобы логика была "после оплаты".
    ====================== */
    async function issueConfigNow(){
      const body = { inbound_id: 1, user_key: state.user_key, days: state.plan.days, limit_ip: 0 };
      const data = await api("/issue-config", { method:"POST", body: JSON.stringify(body) });
      return data.link;
    }

    /* ======================
       EVENTS
    ====================== */
    $("openBuyBtn").addEventListener("click", ()=>{ safeHaptic(); showModal(true); updatePlanUI(); });
    $("openProfileBtn").addEventListener("click", ()=>{ safeHaptic(); setScreen("profile"); });

    $("navMain").addEventListener("click", ()=>{ safeHaptic(); setScreen("main"); });
    $("navInstr").addEventListener("click", ()=>{ safeHaptic(); setScreen("instr"); });
    $("navProfile").addEventListener("click", ()=>{ safeHaptic(); setScreen("profile"); });

    $("closeModalBtn").addEventListener("click", ()=> showModal(false));
    $("overlay").addEventListener("click", (e)=>{ if(e.target.id==="overlay") showModal(false); });

    $("devicesChips").addEventListener("click", (e)=>{
      const el = e.target.closest(".sel"); if(!el) return;
      state.plan.devices = Number(el.dataset.dev);
      safeHaptic();
      updatePlanUI();
    });

    $("daysChips").addEventListener("click", (e)=>{
      const el = e.target.closest(".sel"); if(!el) return;
      state.plan.days = Number(el.dataset.days);
      safeHaptic();
      updatePlanUI();
    });

    $("payStarsBtn").addEventListener("click", async ()=>{
      safeHaptic();
      try{
        await createStarsOrder();
      }catch(err){
        $("loaderArea").classList.add("hidden");
        toast("Ошибка оплаты: " + err.message);
      }
    });

    $("payUsdtBtn").addEventListener("click", async ()=>{
      safeHaptic();
      try{
        await createUsdtOrder();
      }catch(err){
        $("loaderArea").classList.add("hidden");
        toast("Ошибка USDT: " + err.message);
      }
    });

    $("copyConfigBtn").addEventListener("click", async ()=>{
      try{
        await navigator.clipboard.writeText($("configBox").value);
        toast("Скопировано");
        safeHaptic();
      }catch(e){
        toast("Не удалось скопировать");
      }
    });

    $("closeAfterBtn").addEventListener("click", ()=> showModal(false));

    $("regenIdBtn").addEventListener("click", ()=>{
      safeHaptic();
      if(isTelegram() && state.tg.id){
        toast("В Telegram ID фиксированный");
        return;
      }
      state.user_key = randKey();
      localStorage.setItem("zeusvpn_user_key", state.user_key);
      $("userKey").textContent = state.user_key;
      $("profileUserKey").textContent = state.user_key;
      toast("Новый ID");
    });

    /* Swipe (touch) for instructions */
    (function initSwipe(){
      const wrap = $("swipeWrap");
      let startX=0, curX=0, dragging=false;

      const onStart = (x)=>{ dragging=true; startX=x; curX=x; };
      const onMove = (x)=>{
        if(!dragging) return;
        curX=x;
      };
      const onEnd = ()=>{
        if(!dragging) return;
        dragging=false;
        const dx = curX - startX;
        if(Math.abs(dx) > 40){
          if(dx < 0) setSwipe(state.swipeIndex+1);
          else setSwipe(state.swipeIndex-1);
          safeHaptic();
        }
      };

      wrap.addEventListener("touchstart", (e)=> onStart(e.touches[0].clientX), {passive:true});
      wrap.addEventListener("touchmove", (e)=> onMove(e.touches[0].clientX), {passive:true});
      wrap.addEventListener("touchend", onEnd);

      // dots click
      document.querySelectorAll(".dot2").forEach(d=>{
        d.addEventListener("click", ()=>{ setSwipe(Number(d.dataset.dot)); safeHaptic(); });
      });
    })();

    /* ======================
       INIT
    ====================== */
    (async function init(){
      initTelegramProfile();
      loadUserKey();
      updatePlanUI();
      setScreen("main");
      setSwipe(0);

      // по умолчанию считаем что не активна (позже можно подтягивать последний order)
      setActive(false, null);
    })();
  </script>
</body>
</html>
