<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>AEGISVPN</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    body{margin:0;background:#0b0f17;color:#fff;font-family:system-ui;padding:16px}
    .card{background:#121a2a;border:1px solid rgba(255,255,255,.08);border-radius:14px;padding:14px}
    button{width:100%;padding:14px;border:0;border-radius:12px;background:#6d5efc;color:#fff;font-size:16px;font-weight:700}
    .muted{opacity:.7;font-size:13px}
    textarea{width:100%;height:140px;background:#0b1222;color:#fff;border:1px solid rgba(255,255,255,.1);border-radius:12px;padding:10px}
  </style>
</head>
<body>
  <div class="card">
    <div id="user" class="muted">Загрузка профиля Telegram…</div>
    <div style="height:12px"></div>

    <button id="btn">Получить конфиг</button>

    <div style="height:12px"></div>
    <textarea id="out" placeholder="Тут появится vless://..." readonly></textarea>

    <div style="height:10px"></div>
    <button id="copy" style="background:#20c997;display:none">Скопировать</button>
  </div>

  <script>
    const tg = window.Telegram?.WebApp;
    if (tg) tg.ready();

   const API = "https://api.45.133.251.210.nip.io:8443";

    const user = tg?.initDataUnsafe?.user;
    document.getElementById("user").textContent =
      user ? `Привет, ${user.first_name} (id: ${user.id})` : "Открой это внутри Telegram";

    const btn = document.getElementById("btn");
    const out = document.getElementById("out");
    const copy = document.getElementById("copy");

    btn.onclick = async () => {
      if (!user) { alert("Открой Mini App внутри Telegram"); return; }

      btn.disabled = true;
      btn.textContent = "Получаю…";

      try {
        const user_key = "tg" + user.id;
        const res = await fetch(API_BASE + "/issue-config", {
          method: "POST",
          headers: {"Content-Type": "application/json"},
          body: JSON.stringify({ inbound_id: 1, user_key, days: 30, limit_ip: 0 })
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.detail || "Ошибка");

        out.value = data.link;
        copy.style.display = "block";
      } catch (e) {
        alert("Ошибка: " + e.message);
      } finally {
        btn.disabled = false;
        btn.textContent = "Получить конфиг";
      }
    };

    copy.onclick = async () => {
      try {
        await navigator.clipboard.writeText(out.value);
        alert("Скопировано");
      } catch {
        out.select();
        document.execCommand("copy");
        alert("Скопировано");
      }
    };
  </script>
</body>
</html>
