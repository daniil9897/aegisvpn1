<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>AEGISVPN</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <!-- QR для конфига -->
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>

  <style>
    :root {
      --bg: #0f0f17;
      --card: rgba(30, 30, 50, 0.38);
      --card-border: rgba(120, 120, 160, 0.22);
      --accent: #8b5cf6;
      --accent-dark: #7c3aed;
      --text: #f1f5f9;
      --text-sec: #94a3b8;
      --blur: blur(24px);
      --nav-bg: rgba(15, 15, 23, 0.82);
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background: linear-gradient(145deg, #0f0f17 0%, #1a1a2e 100%);
      color: var(--text);
      min-height: 100vh;
      overflow-x: hidden;
    }

    .container {
      max-width: 580px;
      margin: 0 auto;
      padding: 16px;
      padding-bottom: 100px;
    }

    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px 0 16px;
    }

    .logo-wrap {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .shield-icon {
      width: 38px;
      height: 38px;
      filter: drop-shadow(0 0 8px rgba(139,92,246,0.5));
    }

    .logo {
      font-size: 2.2rem;
      font-weight: 800;
      background: linear-gradient(90deg, #a78bfa, #c084fc);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .user-info {
      font-size: 1rem;
      color: var(--text-sec);
    }

    .subtitle {
      text-align: center;
      font-size: 0.98rem;
      color: var(--text-sec);
      opacity: 0.85;
      margin: -4px 0 24px;
    }

    .test-btn {
      width: 100%;
      padding: 18px;
      font-size: 1.18rem;
      font-weight: 700;
      background: linear-gradient(135deg, #10b981, #059669);
      color: white;
      border: none;
      border-radius: 20px;
      margin: 0 0 32px;
      box-shadow: 0 6px 20px rgba(16,185,129,0.35);
      cursor: pointer;
    }

    .section-title {
      font-size: 1.38rem;
      font-weight: 700;
      margin: 28px 0 16px;
    }

    .tariff-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 18px;
    }

    @media (min-width: 460px) { .tariff-grid { grid-template-columns: repeat(2, 1fr); } }

    .tariff-card {
      background: var(--card);
      backdrop-filter: var(--blur);
      border: 1px solid var(--card-border);
      border-radius: 26px;
      padding: 22px 18px;
      box-shadow: 0 8px 28px rgba(0,0,0,0.3);
      position: relative;
    }

    .popular-badge {
      position: absolute;
      top: -10px;
      right: 16px;
      background: linear-gradient(135deg, var(--accent), #c084fc);
      color: white;
      font-size: 0.72rem;
      font-weight: 700;
      padding: 4px 14px;
      border-radius: 16px;
    }

    .tariff-name {
      font-size: 1.6rem;
      font-weight: 800;
      margin-bottom: 6px;
    }

    .tariff-price {
      font-size: 2.2rem;
      font-weight: 900;
      color: var(--accent);
      margin: 4px 0 12px;
    }

    .tariff-price small {
      font-size: 1rem;
      color: var(--text-sec);
    }

    .features li {
      display: flex;
      align-items: center;
      gap: 10px;
      margin: 10px 0;
      color: var(--text-sec);
      font-size: 1rem;
    }

    .btn {
      width: 100%;
      padding: 15px;
      font-size: 1.08rem;
      font-weight: 700;
      background: linear-gradient(135deg, var(--accent), var(--accent-dark));
      color: white;
      border: none;
      border-radius: 18px;
      margin-top: 12px;
      cursor: pointer;
    }

    .bottom-nav {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      height: 78px;
      background: var(--nav-bg);
      backdrop-filter: var(--blur);
      border-top: 1px solid var(--card-border);
      display: flex;
      justify-content: space-around;
      align-items: center;
      z-index: 999;
    }

    .nav-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      color: var(--text-sec);
      font-size: 0.76rem;
      font-weight: 500;
      padding: 6px 12px;
      border-radius: 12px;
      transition: all 0.18s;
    }

    .nav-item.active {
      color: var(--accent);
      background: rgba(139,92,246,0.14);
    }

    .nav-item svg { width: 26px; height: 26px; margin-bottom: 3px; stroke: currentColor; stroke-width: 2; }

    /* Убирание подчёркивания */
    .bottom-nav a {
      text-decoration: none !important;
      color: inherit;
    }

    .bottom-nav a:hover, .bottom-nav a:active, .bottom-nav a:visited {
      text-decoration: none !important;
    }

    #status {
      text-align: center;
      padding: 16px;
      border-radius: 12px;
      background: #1a1a2e;
      margin: 24px 0;
      font-size: 1.1rem;
      font-weight: 600;
    }
  </style>
</head>
<body>

<div class="container">

  <header>
    <div class="logo-wrap">
      <svg class="shield-icon" viewBox="0 0 24 24" fill="none" stroke="#8b5cf6" stroke-width="2.2">
        <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>
      </svg>
      <div class="logo">AEGIS</div>
    </div>
    <div class="user-info" id="userInfo">Загрузка...</div>
  </header>

  <div class="subtitle">Надёжный VPN · Reality / VLESS · Без логов</div>

  <button class="test-btn">Тест 24 часа — БЕСПЛАТНО</button>

  <div class="section-title">Выберите тариф</div>

  <div class="tariff-grid">
    <div class="tariff-card">
      <div class="tariff-name">Basic</div>
      <div class="tariff-price">99 <small>XTR</small></div>
      <ul class="features">
        <li>7 дней</li>
        <li>50 ГБ трафика</li>
        <li>3 устройства</li>
      </ul>
      <button class="btn">Выбрать</button>
    </div>

    <div class="tariff-card">
      <div class="popular-badge">ПОПУЛЯРНЫЙ</div>
      <div class="tariff-name">Standard</div>
      <div class="tariff-price">249 <small>XTR</small></div>
      <ul class="features">
        <li>30 дней</li>
        <li>200 ГБ трафика</li>
        <li>5 устройств</li>
      </ul>
      <button class="btn">Выбрать</button>
    </div>

    <div class="tariff-card">
      <div class="tariff-name">Premium</div>
      <div class="tariff-price">399 <small>XTR</small></div>
      <ul class="features">
        <li>30 дней</li>
        <li>∞ Безлимит</li>
        <li>8 устройств</li>
      </ul>
      <button class="btn">Выбрать</button>
    </div>

    <div class="tariff-card">
      <div class="tariff-name">Unlimited</div>
      <div class="tariff-price">999 <small>XTR</small></div>
      <ul class="features">
        <li>90 дней</li>
        <li>∞ Безлимит</li>
        <li>10 устройств</li>
      </ul>
      <button class="btn">Выбрать</button>
    </div>
  </div>

  <!-- Добавленный div для статуса -->
  <div id="status"></div>

</div>

<div class="bottom-nav">
  <div class="nav-item active">
    <svg viewBox="0 0 24 24"><path d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2z"/></svg>
    Главный
  </div>
  <a href="guide.html" class="nav-item">
    <svg viewBox="0 0 24 24"><path d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"/></svg>
    Как подключить
  </a>
  <a href="profile.html" class="nav-item">
    <svg viewBox="0 0 24 24"><path d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 0 00-7-7z"/></svg>
    Профиль
  </a>
</div>

<script>
const tg = Telegram.WebApp;
tg.ready();
tg.expand();

const user = tg.initDataUnsafe.user;
document.getElementById('userInfo').textContent = user ? `@${user.username || user.first_name}` : 'Гость';

function showStatus(text, color = '#0f0') {
  const statusEl = document.getElementById('status');
  statusEl.innerHTML = text;
  statusEl.style.color = color;
  statusEl.style.display = 'block';
}

document.querySelectorAll('.btn').forEach(btn => {
  btn.addEventListener('click', () => {
    const card = btn.closest('.tariff-card');
    const name = card.querySelector('.tariff-name').textContent.trim();
    const priceText = card.querySelector('.tariff-price').textContent.trim();
    const amount = parseInt(priceText) || 99;

    tg.showPopup({
      title: 'Подтверждение',
      message: `Оплатить тариф "${name}" за ${amount} Stars?`,
      buttons: [
        {id: 'pay', type: 'default', text: `Оплатить ${amount} Stars`},
        {type: 'cancel'}
      ]
    }, (btnId) => {
      if (btnId === 'pay') {
        showStatus('Запускаем оплату...');

        tg.requestPayment({
          title: `AEGISVPN — ${name}`,
          description: `Подписка на ${name}`,
          payload: `aegis_${name.toLowerCase()}_${Date.now()}`,
          currency: 'XTR',
          prices: [{ label: `Тариф ${name}`, amount: amount * 100 }]
        }, (status) => {
          if (status === 'paid') {
            showStatus('Оплата прошла! Получаем конфиг...', '#0f0');
            tg.sendData(JSON.stringify({
              action: 'payment_success',
              plan: name.toLowerCase(),
              amount: amount
            }));
          } else {
            showStatus('Оплата отменена или ошибка', '#ff4444');
          }
        });
      }
    });
  });
});

tg.onEvent('web_app_data', (event) => {
  try {
    const data = JSON.parse(event.data);
    if (data.action === 'config_ready') {
      showStatus('Конфигурация готова!', '#0f0');

      const configDiv = document.createElement('div');
      configDiv.innerHTML = `
        <h3 style="margin:24px 0 12px;">Ваш VLESS:</h3>
        <div style="background:#111; padding:16px; border-radius:12px; word-break:break-all; font-family:monospace;">
          ${data.vless_url || 'Ссылка загружается...'}
        </div>
        <h3 style="margin:24px 0 12px;">Subscription URL:</h3>
        <div style="background:#111; padding:16px; border-radius:12px; word-break:break-all;">
          ${data.sub_url || 'Загружается...'}
        </div>
      `;
      document.querySelector('.container').appendChild(configDiv);

      if (data.vless_url) {
        const qrDiv = document.createElement('div');
        qrDiv.id = 'qr';
        qrDiv.style.margin = '24px auto';
        qrDiv.style.background = 'white';
        qrDiv.style.padding = '16px';
        qrDiv.style.borderRadius = '12px';
        qrDiv.style.display = 'inline-block';
        document.querySelector('.container').appendChild(qrDiv);

        QRCode.toCanvas(qrDiv, data.vless_url, { width: 280 }, (err) => {
          if (err) console.error(err);
        });
      }
    }
  } catch (e) {
    showStatus('Ошибка получения конфига', '#ff4444');
  }
});



  document.querySelector('.test-btn').addEventListener('click', () => {
  showStatus('Запрос теста отправлен...');

  // Отправляем callback боту вместо sendData
  tg.sendData(JSON.stringify({ action: 'test_24h' })); // оставляем на всякий случай
  tg.MainButton.setText("Тест 24 часа"); // если хочешь использовать главную кнопку
  tg.MainButton.show();
  tg.MainButton.onClick(() => {
    tg.sendData(JSON.stringify({ action: 'test_24h' }));
  });

  // Основной способ — callback через бота
  tg.sendData(JSON.stringify({ action: 'test_24h' })); // повтор для надёжности
});



  tg.onEvent('mainButtonClicked', () => {
  // Если хочешь использовать главную кнопку Telegram
});

tg.onEvent('web_app_data', (event) => {
  try {
    const data = JSON.parse(event.data);
    if (data.action === 'config_ready') {
      showStatus('Конфигурация готова!', '#0f0');

      const configDiv = document.createElement('div');
      configDiv.innerHTML = `
        <h3 style="margin:24px 0 12px;">Ваш VLESS:</h3>
        <div style="background:#111; padding:16px; border-radius:12px; word-break:break-all; font-family:monospace;">
          ${data.vless_url || 'Ссылка загружается...'}
        </div>
        <button onclick="navigator.clipboard.writeText('${data.vless_url}').then(()=>tg.showAlert('Скопировано!'))" style="margin:12px 0; padding:12px; background:#333; color:white; border:none; border-radius:12px; width:100%;">
          Скопировать VLESS
        </button>

        <h3 style="margin:24px 0 12px;">Subscription URL:</h3>
        <div style="background:#111; padding:16px; border-radius:12px; word-break:break-all;">
          ${data.sub_url || 'Загружается...'}
        </div>
      `;
      document.querySelector('.container').appendChild(configDiv);

      if (data.vless_url) {
        const qrDiv = document.createElement('div');
        qrDiv.id = 'qr';
        qrDiv.style.margin = '24px auto';
        qrDiv.style.background = 'white';
        qrDiv.style.padding = '16px';
        qrDiv.style.borderRadius = '12px';
        qrDiv.style.display = 'inline-block';
        document.querySelector('.container').appendChild(qrDiv);

        QRCode.toCanvas(qrDiv, data.vless_url, { width: 280 }, (err) => {
          if (err) console.error(err);
        });
      }
    }
  } catch (e) {
    showStatus('Ошибка получения конфига', '#ff4444');
  }
});















  tg.onEvent('web_app_data', (event) => {
  showStatus('Данные от бота получены!', '#0f0');
  console.log('Данные от бота:', event.data);
  alert('Данные от бота: ' + event.data); // временно, чтобы увидеть в окне
});


</script>

</body>
</html>
